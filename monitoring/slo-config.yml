# æœåŠ¡ç­‰çº§ç›®æ ‡ (SLO) é…ç½®
# ADR-008å®æ–½çš„å…³é”®æ€§èƒ½æŒ‡æ ‡å’Œè´¨é‡é—¨ç¦

apiVersion: v1
kind: ConfigMap
metadata:
  name: organization-api-slo
  namespace: monitoring
data:
  slo-config.yml: |
    # ç»„ç»‡å¯åœAPIçš„SLOå®šä¹‰
    slos:
      # æ ¸å¿ƒä¸šåŠ¡SLO
      activate-endpoint:
        name: "ç»„ç»‡å¯ç”¨APIå¯ç”¨æ€§"
        description: "POST /activateç«¯ç‚¹çš„æˆåŠŸç‡å’Œå»¶è¿ŸSLO"
        sli_config:
          success_rate:
            query: 'rate(activate_success_total[5m]) / rate(activate_requests_total[5m])'
            threshold: 0.999  # 99.9%
            window: "28d"     # 4å‘¨æ»šåŠ¨çª—å£
          latency_p95:
            query: 'histogram_quantile(0.95, rate(activate_duration_seconds_bucket[5m]))'
            threshold: 0.15   # 150ms
            window: "7d"      # 1å‘¨æ»šåŠ¨çª—å£
        error_budget_burn_rate:
          fast_burn_rate: 2     # 2å°æ—¶å†…æ¶ˆè€—10%è¯¯å·®é¢„ç®—è§¦å‘
          slow_burn_rate: 0.1   # 24å°æ—¶å†…ç¨³å®šæ¶ˆè€—1%è§¦å‘
      
      suspend-endpoint:
        name: "ç»„ç»‡åœç”¨APIå¯ç”¨æ€§"
        description: "POST /suspendç«¯ç‚¹çš„æˆåŠŸç‡å’Œå»¶è¿ŸSLO"
        sli_config:
          success_rate:
            query: 'rate(suspend_success_total[5m]) / rate(suspend_requests_total[5m])'
            threshold: 0.999  # 99.9%
            window: "28d"     # 4å‘¨æ»šåŠ¨çª—å£
          latency_p95:
            query: 'histogram_quantile(0.95, rate(suspend_duration_seconds_bucket[5m]))'
            threshold: 0.15   # 150ms  
            window: "7d"      # 1å‘¨æ»šåŠ¨çª—å£
        error_budget_burn_rate:
          fast_burn_rate: 2
          slow_burn_rate: 0.1

      # åˆè§„æ€§SLO
      api-compliance:
        name: "APIåˆè§„æ€§æŒ‡æ ‡"
        description: "ADR-008åˆè§„çŠ¶æ€ç›‘æ§"
        sli_config:
          deprecated_endpoint_usage:
            query: 'sum(rate(deprecated_endpoint_used_total[5m]))'
            threshold: 0      # ç»å¯¹é›¶å®¹å¿
            window: "24h"     # æ¯æ—¥æ£€æŸ¥
          audit_write_success:
            query: 'rate(audit_write_success_total[5m]) / rate(audit_write_attempts_total[5m])'
            threshold: 1.0    # 100%æˆåŠŸç‡
            window: "24h"     # æ¯æ—¥æ£€æŸ¥
        error_budget_burn_rate:
          fast_burn_rate: 1     # ç«‹å³è§¦å‘
          slow_burn_rate: 0.01  # æä½å®¹å¿åº¦

      # æƒé™ç³»ç»ŸSLO  
      authorization:
        name: "æƒé™éªŒè¯ç³»ç»Ÿå¯ç”¨æ€§"
        description: "org:activateå’Œorg:suspendæƒé™éªŒè¯"
        sli_config:
          permission_check_success:
            query: 'rate(permission_check_success_total[5m]) / rate(permission_check_total[5m])'
            threshold: 0.9999 # 99.99%
            window: "7d"
          permission_check_latency:
            query: 'histogram_quantile(0.99, rate(permission_check_duration_seconds_bucket[5m]))'
            threshold: 0.05   # 50ms
            window: "24h"
        error_budget_burn_rate:
          fast_burn_rate: 5
          slow_burn_rate: 0.5

    # å‘Šè­¦é…ç½®
    alerts:
      slo_violation:
        - name: "ActivateAPISuccessRateSLOViolation"
          condition: 'activate_success_rate_slo < 0.999'
          for: "2m"
          severity: "P1"
          annotations:
            summary: "ç»„ç»‡å¯ç”¨APIæˆåŠŸç‡ä½äºSLO"
            description: "å½“å‰æˆåŠŸç‡: {{ $value | humanizePercentage }}, SLOè¦æ±‚: 99.9%"
            runbook: "https://wiki.company.com/runbooks/organization-api-slo"
            
        - name: "SuspendAPISuccessRateSLOViolation"
          condition: 'suspend_success_rate_slo < 0.999'
          for: "2m"
          severity: "P1"
          annotations:
            summary: "ç»„ç»‡åœç”¨APIæˆåŠŸç‡ä½äºSLO"
            description: "å½“å‰æˆåŠŸç‡: {{ $value | humanizePercentage }}, SLOè¦æ±‚: 99.9%"

        - name: "ActivateAPILatencySLOViolation"
          condition: 'activate_p95_latency_slo > 0.15'
          for: "5m"
          severity: "P2"
          annotations:
            summary: "ç»„ç»‡å¯ç”¨APIå»¶è¿Ÿè¶…è¿‡SLO"
            description: "å½“å‰P95å»¶è¿Ÿ: {{ $value }}s, SLOè¦æ±‚: â‰¤150ms"

      compliance_violation:
        - name: "DeprecatedEndpointUsageSLOViolation"
          condition: 'deprecated_endpoint_usage_slo > 0'
          for: "0s"
          severity: "P2"
          annotations:
            summary: "æ£€æµ‹åˆ°å¼ƒç”¨ç«¯ç‚¹è®¿é—® - åˆè§„æ€§SLOè¿è§„"
            description: "å¼ƒç”¨ç«¯ç‚¹è®¿é—®é¢‘ç‡: {{ $value }}/ç§’"
            action_required: "ç«‹å³åˆ†æ410å“åº”æ¥æºï¼Œæ¨è¿›å®¢æˆ·ç«¯è¿ç§»"

        - name: "AuditWriteFailureSLOViolation"
          condition: 'audit_write_success_slo < 1.0'
          for: "0s"
          severity: "P0"
          annotations:
            summary: "å®¡è®¡æ—¥å¿—å†™å…¥å¤±è´¥ - æ•°æ®å®Œæ•´æ€§SLOè¿è§„"
            description: "å®¡è®¡å†™å…¥æˆåŠŸç‡: {{ $value | humanizePercentage }}"
            immediate_action: "ç«‹å³æ£€æŸ¥å®¡è®¡ç³»ç»Ÿï¼Œç¡®ä¿operatedByå­—æ®µè®°å½•"

    # é”™è¯¯é¢„ç®—ç­–ç•¥
    error_budget_policy:
      # å¿«é€Ÿæ¶ˆè€—ç­–ç•¥
      fast_burn:
        window: "1h"
        consumption_rate: 0.02  # 1å°æ—¶æ¶ˆè€—2%é¢„ç®—è§¦å‘
        action: "page_on_call"
        
      # æ…¢é€Ÿæ¶ˆè€—ç­–ç•¥  
      slow_burn:
        window: "24h"
        consumption_rate: 0.1   # 24å°æ—¶æ¶ˆè€—10%é¢„ç®—è§¦å‘
        action: "create_ticket"
        
      # é¢„ç®—è€—å°½ç­–ç•¥
      budget_exhausted:
        action: "block_non_critical_deploys"
        notify: "engineering_leads"

    # SLOæŠ¥å‘Šé…ç½®
    reporting:
      dashboard_refresh_interval: "30s"
      monthly_report:
        enabled: true
        recipients: ["sre-team@company.com", "api-team@company.com"]
        include_sections:
          - "slo_compliance_summary"
          - "error_budget_burn_rate"
          - "top_error_sources"
          - "compliance_violations"
      
      weekly_review:
        enabled: true
        format: "slack"
        channel: "#api-slo-review"
        template: |
          ğŸ“Š **ç»„ç»‡APIå‘¨åº¦SLOæŠ¥å‘Š**
          
          **æˆåŠŸç‡SLO**
          â€¢ Activate: {{.activate_success_rate}}% (ç›®æ ‡: 99.9%)
          â€¢ Suspend: {{.suspend_success_rate}}% (ç›®æ ‡: 99.9%)
          
          **å»¶è¿ŸSLO**  
          â€¢ Activate P95: {{.activate_p95_latency}}ms (ç›®æ ‡: â‰¤150ms)
          â€¢ Suspend P95: {{.suspend_p95_latency}}ms (ç›®æ ‡: â‰¤150ms)
          
          **åˆè§„æ€§çŠ¶æ€**
          â€¢ å¼ƒç”¨ç«¯ç‚¹è®¿é—®: {{.deprecated_usage_count}} (ç›®æ ‡: 0)
          â€¢ å®¡è®¡å®Œæ•´æ€§: {{.audit_success_rate}}% (ç›®æ ‡: 100%)
          
          **é”™è¯¯é¢„ç®—ä½™é¢**
          â€¢ å½“å‰å¯ç”¨: {{.error_budget_remaining}}%
          â€¢ æ¶ˆè€—è¶‹åŠ¿: {{.budget_burn_trend}}
          
          {{if .slo_violations}}
          âš ï¸ **SLOè¿è§„äº‹ä»¶**: {{.slo_violations}}
          {{end}}