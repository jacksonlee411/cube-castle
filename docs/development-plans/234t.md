# Plan 234T — 验证要求与操作手册

## 环境前置
- 已执行 `make docker-up`，确保 `postgres`、`rest-service`、`graphql-service` 等容器处于 healthy 状态。
- `.env` 中的 `DATABASE_URL=postgresql://user:password@postgres:5432/cubecastle?sslmode=disable` 与 `DATABASE_URL_HOST_TOOLS=postgresql://user:password@localhost:5432/cubecastle?sslmode=disable` 保持默认值，禁止改动端口映射。

## 验证步骤
1. **在容器网络内执行 Goose 迁移**
   ```bash
   docker compose -f docker-compose.dev.yml exec -T rest-service \
     /bin/sh -lc "cd /workspace && make db-migrate-all"
   ```
   - 目的：使用容器内的 `DATABASE_URL`（指向 `postgres:5432`）应用 `20251110110000_234_remove_org_unit_triggers.sql`。

2. **运行审计一致性脚本（信息输出）**
   ```bash
   docker compose -f docker-compose.dev.yml exec -T postgres \
     psql -U user -d cubecastle \
     -f /workspace/scripts/validate-audit-recordid-consistency.sql
   ```
   - 预期：`TRIGGERS ON organization_units` 部分返回空结果。

3. **运行断言脚本（CI 门禁）**
   ```bash
   docker compose -f docker-compose.dev.yml exec -T postgres \
     psql -U user -d cubecastle \
     -f /workspace/scripts/validate-audit-recordid-consistency-assert.sql
   ```
   - 预期：无 `OU_TRIGGERS_PRESENT_GT_ZERO` 或其他异常抛出。

4. **记录证据**
   - 将上述命令的关键输出（成功提示或 0 结果）保存到 `logs/Plan234/validate-audit-recordid-consistency.log`（路径可自定义但需纳入 PR 描述）。

## 回滚提示
- 若迁移需回滚，使用同一容器网络执行：
  ```bash
  docker compose -f docker-compose.dev.yml exec -T rest-service \
    /bin/sh -lc "cd /workspace && goose -dir database/migrations postgres $DATABASE_URL down"
  ```
  - 注意：回滚后必须重新运行两份验证脚本，确认触发器按预期恢复或再次删除。

## 责任说明
- 以上步骤为 Plan 234 的强制验证要求，提交 PR 时需在描述中附上命令输出或日志，证明：
  1. Goose 迁移成功。
  2. 两份审计脚本均无触发器残留。
