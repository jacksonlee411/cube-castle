# 62号文档：后端观测与运维巩固计划（Phase 2 精简版）

**版本**: v2.0
**创建日期**: 2025-10-10
**维护团队**: 全栈工程师（单人执行）
**状态**: 进行中
**遵循原则**: CLAUDE.md 资源唯一性与跨层一致性原则
**关联计划**: 60号总体计划、61号执行计划第一阶段验收、06号推进记录

---

## 1. 背景与目标

### 1.1 背景
- Phase 1 已完成契约与类型统一，后端服务当前运行稳定。
- 评审确认响应封装、事务/审计逻辑、中间件均已具备成熟实现（详见 `internal/utils/response.go`、`internal/audit/logger.go` 等）。
- 现阶段真正缺口集中在 **观测指标补充**、**运维开关梳理** 与 **操作手册更新**。需以最小成本巩固后端服务的可观测性与日常运维体验。

### 1.2 目标
1. **指标完善**：对命令服务补充与 Phase 1 契约成果相关的 Prometheus 指标，并验证 Query/Command 监控一致性。
2. **运维开关梳理**：为 Dev/Operational Handler 提供显式开关与白名单示例，避免误发布到生产环境。
3. **策略文档更新**：沉淀运维操作、监控告警及回滚步骤到手册，形成长期可依赖的运维指引。

---

## 2. 范围

### 2.1 涉及模块
- `cmd/organization-command-service/internal/middleware/*.go`
- `cmd/organization-command-service/internal/handlers/devtools.go`
- `cmd/organization-command-service/internal/handlers/operational.go`
- `docs/reference/` 中与监控/运维相关的章节（若缺少则新增小节）

### 2.2 明确不在范围
- 事务/审计封装、统一响应结构、双写机制等已存在能力，此阶段不再重复实现。
- 数据库结构调整与大规模后端重构。
- 前端或 Query 服务的大型改造（另有阶段覆盖）。

---

## 3. 时间线（预估 1 周）

| 周次 | 里程碑 | 交付物 |
|------|--------|--------|
| Week 3 | 指标补充与运维开关梳理 | Prometheus 指标、Dev/Operational 开关、运维手册更新 |

---

## 4. 详细任务清单

### 4.1 指标补充
- [ ] 盘点命令服务现有指标（`/metrics`）与 Query 服务差异。
- [ ] 增补与契约执行相关的指标，例如：
  - 契约同步调用时长/成功率（参考 `scripts/contract/sync.sh`）
  - Dev/Operational Handler 调用次数、错误率
- [ ] 更新 `scripts/quality` 相关脚本/README，说明如何采集和验证指标。

### 4.2 运维开关梳理
- [ ] 为 Dev/Operational Handler 增加显式开关（环境变量或配置，默认仅在 dev/staging 启用）。
- [ ] 提供白名单示例（如允许的管理用户或 CIDR）。
- [ ] 新增回滚策略说明：如何快速关闭 Dev/Operational 端点、如何恢复默认配置。

### 4.3 文档与验收
- [ ] 更新 60-execution-tracker 第二阶段进展。
- [ ] 更新或新增 `docs/reference/03-API-AND-TOOLS-GUIDE.md` 中监控/运维章节。
- [ ] 编写 Phase 2 验收报告草稿（计划 63号文档），记录指标验证与运维开关配置。

---

## 5. 验收标准与测试

1. **指标验证**：
   - Prometheus 中能看到新增指标，执行 `curl /metrics` 出现对应字段。
   - 指标说明文档中记录含义与参考阈值。
2. **开关验证**：
   - 通过环境变量/配置关闭 Dev/Operational Handler 后，接口返回 403 或 404。
   - 白名单生效示例（白名单用户可访问，其他用户被拒绝）。
3. **文档更新**：
   - 60-execution-tracker 第二阶段进度勾选。
   - 63号验收报告草稿完成。
   - 若对外行为变更，更新 `docs/reference` 中相关章节。

---

## 6. 风险与缓解

| 风险 | 说明 | 缓解措施 |
|------|------|----------|
| 指标过多影响性能 | 新增指标可能带来额外开销 | 控制指标粒度，仅保留关键指标，并在文档注明采样策略 |
| 运维开关默认异常 | 默认配置可能阻止合法访问 | 提供默认配置模板，保留安全兜底（例如仅对生产环境启用严格限制） |
| 文档滞后 | 新能力未同步至手册 | 在任务中明确文档更新步骤，并纳入验收标准 |

---

## 7. 交付物
- 更新后的 Prometheus 指标及收集脚本说明
- Dev/Operational Handler 开关与白名单示例配置
- 运维/监控手册更新（或新增章节）
- Phase 2 验收报告草稿（63号文档）

---

## 8. 追踪与后续
- 计划文档：62号本文件（v2.0）。
- 执行跟踪：`docs/development-plans/60-execution-tracker.md`（第二阶段条目）。
- 验收报告：63号文档（待创建）。
- 若后续发现新的后端缺口，再另立专题计划，避免与现有能力重复。

