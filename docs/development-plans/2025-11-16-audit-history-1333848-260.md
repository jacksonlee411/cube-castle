# 组织详情「1333848」审计历史页签总是显示“暂无变更数据”——260 调查文档

## 1) 结论（可执行摘要）
- 前端渲染分支错误：将 `SUSPEND/REACTIVATE` 作为“删除前快照”渲染，导致无 `beforeData` 时返回空表，从而显示“暂无变更数据”。见 frontend/src/features/audit/components/FieldChangeTable.tsx:331。
- 操作类型不一致：历史/部分路径产出 `ACTIVATE` 事件，但契约与前端使用 `REACTIVATE`；未识别的操作类型落入默认分支为 null，仍显示“暂无变更数据”。
- 未覆盖 `DEACTIVATE`：未在表格分支中处理，落入默认分支为 null。

## 2) 影响范围与表现
- 受影响页面：组织详情 → 审计历史页签（选中某版本后）。
- 主要受影响记录：停用、重新启用、作废等状态类操作的审计记录（即使有 `changes` 也被错误为空处理）。
- 现象：展开记录详情后，字段变更表格区域显示“暂无变更数据”。

## 3) 证据与单一事实来源（SSoT 对齐）
- 前端渲染分支与空态提示：
  - `SUSPEND/REACTIVATE` 被送往删除表格渲染：frontend/src/features/audit/components/FieldChangeTable.tsx:331
  - 未处理 `DEACTIVATE`，落入 default→null：frontend/src/features/audit/components/FieldChangeTable.tsx:334
  - 无表格内容即显示空态文案“暂无变更数据”：frontend/src/features/audit/components/FieldChangeTable.tsx:359
- 停用/激活审计写入仅有 afterData（且含 changes）：
  - 停用事件写入：internal/organization/audit/logger.go:471（AfterData/Changes，未写 BeforeData）
  - 激活事件写入：internal/organization/audit/logger.go:520（AfterData/Changes，未写 BeforeData）
- 统一状态变更路径（新）：查询层/调度器将状态变更写成 UPDATE 并附带 `changes` 与 `before/after`：internal/organization/scheduler/organization_temporal_service.go:436
- GraphQL 契约（唯一事实来源）：docs/api/schema.graphql:1152（OperationType 包含 REACTIVATE/DEACTIVATE，不包含 ACTIVATE）；AuditLogDetail 字段定义见 docs/api/schema.graphql:461
- 前端数据适配未归一化 operation 字符串：frontend/src/features/audit/components/AuditHistorySection.tsx:142

## 4) 根因分析（跨层一致性）
- 契约-实现命名偏差：历史产出的 `ACTIVATE` 未在 GraphQL 枚举与前端分支中定义，导致前端无法正确匹配操作类型。
- 前端表格组件对状态类操作的语义判断错误：将 `SUSPEND/REACTIVATE` 当作“删除”类仅依赖 `beforeData` 的展示，忽略了这些事件真实的可视化应以 `changes` 为主（如 `status` 变更）。
- 漏处理 `DEACTIVATE` 分支，进一步放大该问题的覆盖面。

## 5) 解决方案（先契约后实现；给出默认落地方案）
- 短期（默认执行，低风险，前端改动）：
  1. 统一状态类操作走“更新表格”渲染，直接展示 `changes`：
     - 修改 FieldChangeTable 的渲染分支：`SUSPEND/REACTIVATE/DEACTIVATE` → 使用 `renderUpdateTable()`。
     - 同时兼容历史字符串 `ACTIVATE`（即使它不在枚举中），同样走 `renderUpdateTable()`，避免落入默认空分支。
  2. 临时归一化 operation（仅前端适配层，标注 TODO-TEMPORARY）：
     - 在 AuditHistorySection 将后端返回的 `operation: 'ACTIVATE'` 归一为 `REACTIVATE` 再下发给 UI，避免不识别。
  3. 不改动 GraphQL 查询与权限；保持与 docs/api/schema.graphql 一致。

  注：该方案不修改数据与后端，只纠正展示逻辑；即便记录只有 `changes` 而没有 `beforeData`，也能正确显示“字段变更详情”。

- 中期（一致性整改，服务端/数据迁移）：
  1. 审计写入统一：命令侧与调度器一致化，状态变更事件统一采用契约枚举（`REACTIVATE`），或统一写 `UPDATE` 并含 `changes`/`before/after`（已在调度器路径实现）。
  2. 历史数据迁移（迁移即真源）：新增 goose 迁移，将 `audit_logs.event_type='ACTIVATE'` 统一更正为 `REACTIVATE`；不调整 `action_name`。
  3. 作为过渡，也可在查询层 SELECT 时用 `CASE` 将 `ACTIVATE` 归一化为 `REACTIVATE`，但最终仍需迁移落盘。

## 6) 验收标准与验证步骤
- 验收标准：
  - 状态类审计记录（停用/重新启用/作废）展开后展示“字段变更详情 (1 项)”，包含 `status` 字段由 A→B 的变化。
  - CREATE 展示“创建记录 - 初始数据”（afterData）；DELETE 展示“删除记录 - 删除前状态”（beforeData）。
  - 审计历史计数与 GraphQL 返回条数一致；空列表时仅在无记录情况下显示“暂无审计记录”。
- 验证步骤（本地/CI 一致）：
  1. 选择组织 1333848 的某个版本 → 切到“审计历史”页签（frontend/src/features/temporal/components/TemporalMasterDetailView.tsx:300）。
  2. 展开任一状态类操作的卡片，确认字段表格显示 `status` 变更。
  3. 通过 GraphQL 控制台/脚本查询 `auditHistory(recordId: <版本recordId>)`，确认返回包含 `changes` 与 `modifiedFields`（docs/api/schema.graphql:262）。
  4. 运行前端 E2E（Playwright）增加或复用一条跨状态操作的断言，确保文案不再是“暂无变更数据”。

## 7) 风险与回滚
- 前端改动仅影响渲染分支，低风险；若出现异常可回滚到改动前版本。
- 服务端/数据迁移需按流程评审与在 Docker Compose 环境执行；若仅做查询层 CASE 归一可先行，迁移安排二期。

## 8) 变更清单（建议）
- 前端（立即）：
  - frontend/src/features/audit/components/FieldChangeTable.tsx:324 调整 `SUSPEND/REACTIVATE/DEACTIVATE/ACTIVATE` → `renderUpdateTable()`；对应标题 `getTableTitle()` 可优化为“状态变更详情”。
  - frontend/src/features/audit/components/AuditHistorySection.tsx:142 为 `operation` 增加临时归一化（`ACTIVATE`→`REACTIVATE`）。
  - 标注 `// TODO-TEMPORARY(2025-12-01): 移除本地归一化，待后端/迁移完成后回收`。
- 后端（计划项）：
  - 新增 Goose 迁移：`UPDATE audit_logs SET event_type='REACTIVATE' WHERE event_type='ACTIVATE';`
  - 统一命令侧写入路径或确保与调度器一致（仅 `REACTIVATE`，或统一 `UPDATE` + `changes`/`before/after`）。

## 9) 附：契约索引与关键代码引用
- 契约（唯一事实来源）：
  - OperationType：docs/api/schema.graphql:1152
  - 审计查询：docs/api/schema.graphql:262；AuditLogDetail：docs/api/schema.graphql:461
- 查询实现：
  - internal/organization/repository/postgres_audit.go:420（processAuditRowsStrict 片段起始附近，含空记录过滤、数据清洗）
  - internal/organization/repository/postgres_audit.go:733（AuditHistory 解析与返回 DTO）
- 审计写入（状态类）：
  - 停用：internal/organization/audit/logger.go:471
  - 激活：internal/organization/audit/logger.go:520
  - 新统一路径：internal/organization/scheduler/organization_temporal_service.go:436
- 前端渲染：
  - 表格分支：frontend/src/features/audit/components/FieldChangeTable.tsx:324
  - 空态文案：frontend/src/features/audit/components/FieldChangeTable.tsx:359
  - 数据适配：frontend/src/features/audit/components/AuditHistorySection.tsx:142

---

备注：本报告遵循“资源唯一性与跨层一致性”为最高优先级，不引入第二事实来源；修复方案默认优先前端渲染纠正（不改契约），中期以迁移对齐历史数据与命名一致性。

## 10) 评审对齐与约束补充（据审阅意见修订）

- 单一兜底策略（禁止双兜底并行）
  - 临时阶段仅启用“前端适配层归一化”（ACTIVATE→REACTIVATE），查询层 CASE 归一不启用；待历史数据迁移完成后，回收前端归一化。
  - 若团队决定短期改为“查询层 CASE 归一”以便统一多端，则必须先移除前端归一化，避免跨层双重转换引入第二事实来源。
- 临时方案治理（明确白名单与回收）
  - 在引入前端临时归一化的具体代码处添加：`// TODO-TEMPORARY(2025-12-01): ACTIVATE→REACTIVATE 归一化，待历史迁移完成后删除。负责人：<Owner>`
  - 将该条目标记加入 `scripts/todo-temporary-allowlist.txt`，确保 `scripts/check-temporary-tags.sh` 通过。
  - 回收触发条件：历史数据迁移（ACTIVATE→REACTIVATE）上线并完成验证，或查询层 CASE 归一化正式启用并对外生效；以先到者为准。
- 执行登记与对外通告
  - 执行与证据登记：在 `docs/development-plans/215-phase2-execution-log.md` 登记本次修复（提交哈希、截图/视频、GraphQL 结果、测试报告路径）。
  - 变更通告：如启用查询层 CASE 或进行历史数据迁移，必须在 `CHANGELOG.md` 登记，并在 `docs/reference/01-DEVELOPER-QUICK-REFERENCE.md` 增补“审计 operation 历史值解释与回收期”。
- 与 256/258（SSoT 生成与契约漂移门禁）的对齐说明
  - 保持 `AuditLogDetail.operation: String` 不变（兼容历史值），`Query.auditHistory(operation: OperationType)` 仍使用枚举过滤；此设计需在 258 门禁侧做“operation 字段允许历史字符串”的豁免说明，避免误判为漂移。
  - 长期可评估新增 `operationType: OperationType`（与 `operation: String` 并存）以增强 UI 稳定性；如执行，属于契约演进，需提 256/258 子计划并走门禁。
- 范围声明（本次仅组织域）
  - 本次迁移与展示修复以 ORGANIZATION 域为范围；POSITION/JOB_CATALOG 如存在历史 `ACTIVATE` 值，应在数据巡检后补立子任务，或在 260 文档中维持“范围仅限组织”的声明（当前选择：仅组织）。
- 测试与门禁
  - 前端：在 Vitest 增加组件级单测（FieldChangeTable 渲染分支、AuditHistorySection 归一化）；在 Playwright 增加跨状态操作的 E2E 断言；运行 `npm run lint` 与现有守卫。
  - CI：不新增后端门禁；若后续引入查询层 CASE 或迁移，应确保 221 集成测试与 232/244 E2E 烟测通过，并在 215 登记证据。

## 11) 落实项清单（执行者与路径）

- 前端（立即）
  - 代码改动：
    - FieldChangeTable：`SUSPEND/REACTIVATE/DEACTIVATE/ACTIVATE` → `renderUpdateTable()`；标题文案“状态变更详情”。
    - AuditHistorySection：在 transform 前对 `operation` 做临时归一化（ACTIVATE→REACTIVATE），并添加 `// TODO-TEMPORARY(2025-12-01): ...`。
  - 临时清单：`scripts/todo-temporary-allowlist.txt` 增加对应条目。
  - 测试：新增/更新 Vitest 单测与 Playwright E2E；在 215 登记执行证据。
- 服务端/数据（计划项）
  - 历史迁移（仅组织域）：`UPDATE audit_logs SET event_type='REACTIVATE' WHERE resource_type='ORGANIZATION' AND event_type='ACTIVATE';`
  - 查询层 CASE（若采纳，则替代前端临时归一化）：在 SELECT 中将 `event_type='ACTIVATE'` 归一为 `REACTIVATE` 返回；上线前先删除前端归一化。
  - 文档化：补充 CHANGELOG 与开发者速查指引；在 215 登记上线与验证证据。

## 12) 里程碑与回收期限

- M1（T+2 天内）：前端渲染修复与临时归一化合入，E2E/单测通过，215 登记完成。
- M2（T+1 周内）：完成组织域历史迁移方案评审与脚本；择时在 Docker 环境执行，落盘证据并更新 CHANGELOG。
- M3（M2+2 天）：迁移验证通过后，移除前端临时归一化，更新 allowlist，215 登记回收完成。

> 注：回收期限不晚于 2025-12-01；若 M2 延期，需在 215 与 06 文档同步延期说明与风险。
