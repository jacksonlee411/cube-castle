# 214-Phase1 Baseline Extraction Plan

**ç¼–å·**: 214  
**æ ‡é¢˜**: æ•°æ®åº“åŸºçº¿é‡å»º Â· Phase1 åŸºçº¿èƒå–æ‰§è¡Œæ–¹æ¡ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-05  
**æœ€è¿‘æ›´æ–°**: 2025-11-05  
**çŠ¶æ€**: ğŸŸ¡ å¾…æ‰§è¡Œ  
**å…³è”æ–‡æ¡£**:
- `210-database-baseline-reset-plan.md`ï¼ˆæ¯è®¡åˆ’ï¼‰
- `212-shared-architecture-alignment-plan.md`ï¼ˆæ¶æ„ç›®å½•ä¸å¤ç”¨å†³è®®ï¼‰  
- `213-go-toolchain-baseline-plan.md`ï¼ˆGo 1.24 å·¥å…·é“¾åŸºçº¿ç¡®è®¤ï¼‰  
- `reports/phase1-regression.md`ï¼ˆGo å·¥å…·é“¾éªŒè¯è®°å½•ï¼‰

---

## 1. èŒƒå›´ä¸ç›®æ ‡

**èŒƒå›´**ï¼šè½å® 210 å·è®¡åˆ’ä¸­çš„ Phase1 åŸºçº¿èƒå–å·¥ä½œï¼Œèšç„¦ä»¥ä¸‹äº‹é¡¹ï¼š
1. ç”Ÿæˆå½“å‰æ•°æ®åº“ Schema å¿«ç…§å¹¶æ¯”å¯¹å·®å¼‚ã€‚
2. æ•´ç†å£°æ˜å¼ Schemaï¼ˆ`database/schema.sql`ï¼‰å¹¶å½¢æˆå”¯ä¸€äº‹å®æ¥æºã€‚
3. åŸºäº Schema äº§å‡ºå¸¦ `-- +goose Up/Down` æ ‡è®°çš„åŸºçº¿è¿ç§»ã€‚
4. å®Œæˆ DBAã€æ¶æ„ç»„è”åˆå®¡é˜…ä¸ç­¾å­—ã€‚

**ç›®æ ‡**ï¼šåœ¨ Week1 ç»“æŸå‰äº¤ä»˜å¯å¤ç”¨çš„åŸºçº¿è¿ç§»æ–‡ä»¶ï¼Œä¸º Phase2 ç›®å½•é‡æ„ä¸ Goose/Atlas è½åœ°æä¾›å‰ææ¡ä»¶ã€‚

---

## 2. å…³é”®äº¤ä»˜ç‰©

| ç¼–å· | äº¤ä»˜ç‰© | å†…å®¹æè¿° | å½’æ¡£ä½ç½® | éªŒæ”¶æ–¹ |
|------|--------|----------|----------|--------|
| D1 | `schema/current_schema.sql` | é€šè¿‡ `pg_dump --schema-only` è·å–çš„å®æ—¶ Schema å¿«ç…§ | `database/schema/current_schema.sql` | DBA |
| D2 | å£°æ˜å¼ Schema | ç»Ÿä¸€çš„ `database/schema.sql`ï¼ˆæˆ– `schema.hcl` é™„ä»¶ï¼‰ | `database/schema.sql` | æ¶æ„ç»„ |
| D3 | åŸºçº¿è¿ç§»æ–‡ä»¶ | `database/migrations/20251105000000_base_schema.sql`ï¼ˆå« Up/Downï¼‰ | migrations ç›®å½• | æ¶æ„ç»„ + DBA |
| D4 | å®¡é˜…è®°å½• | å®¡æ ¸æ„è§ä¸ç­¾å­—çºªè¦ | `docs/archive/development-plans/214-signoff-*.md` | æ¶æ„ç»„ + DBA |
| D5 | æ‰§è¡Œæ—¥å¿— | æŠ½å–ã€å¯¹æ¯”ã€ç”Ÿæˆè„šæœ¬æ‰§è¡Œè®°å½• | `logs/214-phase1-baseline/` | PM/QA |

---

## 3. å·¥ä½œåˆ†è§£ä¸æ—¶é—´çº¿

| æ—¥æœŸ | ä»»åŠ¡ | è´Ÿè´£äºº | è¾“å‡º |
|------|------|--------|------|
| Day1 ä¸Šåˆ | å†»ç»“/ç¡®è®¤å½“å‰æ•°æ®åº“çŠ¶æ€ï¼ˆä¾èµ– 210 Phase0 å·²å®Œæˆï¼‰ | åŸºç¡€è®¾æ–½ç»„ | çŠ¶æ€è®°å½• |
| Day1 ä¸‹åˆ | ä½¿ç”¨ Docker Postgres ç”Ÿæˆ `current_schema.sql`ï¼›atlas schema inspect ç”Ÿæˆ diff | DBA | D1 |
| Day2 ä¸Šåˆ | æ•´ç† `database/schema.sql`ï¼ˆæŒ‰ 203/205 çº¦å®šå‘½åã€çº¦æŸï¼‰ | æ¶æ„ç»„ | D2 draft |
| Day2 ä¸‹åˆ | é€šè¿‡ Atlas æˆ–æ‰‹å·¥ç”ŸæˆåŸºçº¿è¿ç§»ï¼›è¡¥å…¨ Down è„šæœ¬ | DBA + æ¶æ„ç»„ | D3 draft |
| Day3 ä¸Šåˆ | Up/Down æœ¬åœ°å›æ”¾éªŒè¯ï¼ˆ`goose up/down` + `go test ./...`ï¼‰ | DBA | éªŒè¯æ—¥å¿— |
| Day3 ä¸‹åˆ | æ¶æ„ç»„/DBA è”åˆè¯„å®¡ï¼Œæ”¶é›†æ„è§å¹¶ä¿®è®¢ | æ¶æ„ç»„ + DBA | D3 æœ€ç»ˆç‰ˆ |
| Day4 ä¸Šåˆ | ç”Ÿæˆç­¾å­—çºªè¦ï¼Œå½’æ¡£æ—¥å¿—ã€è„šæœ¬ï¼›æ›´æ–° 210/06/Plan 214 æ–‡æ¡£çŠ¶æ€ | PM + Codex | D4, D5 |

> æ‰€æœ‰å‘½ä»¤éœ€åœ¨ Docker å®¹å™¨å†…æ‰§è¡Œï¼Œç¦æ­¢ä½¿ç”¨å®¿ä¸»æœºæ•°æ®åº“æœåŠ¡ã€‚

---

## 4. æ‰§è¡Œæ­¥éª¤ä¸å‘½ä»¤æŒ‡å¼•

### 4.1 Schema å¿«ç…§
```bash
export PG_BASELINE_DSN="postgres://user:password@postgres:5432/cubecastle?sslmode=disable"
docker compose exec -T postgres \
  pg_dump --schema-only --no-owner --no-privileges "$PG_BASELINE_DSN" \
  > database/schema/current_schema.sql
```
- è¡¥å……æ‰§è¡Œ `atlas schema inspect --url "$PG_BASELINE_DSN"`ï¼Œç”Ÿæˆ `database/schema/schema-inspect.hcl` ä¾› diff ä½¿ç”¨ã€‚
- ç»“æœå­˜æ”¾äº `database/schema/`ï¼Œæ¯”å¯¹æ–‡ä»¶ç”± DBA è®°å½•è‡³ `logs/214-phase1-baseline/schema-diff.txt`ã€‚

### 4.2 å£°æ˜å¼ Schema æ•´ç†
- ä»¥ `current_schema.sql` ä¸ºåŸºç¡€ï¼Œåˆå¹¶ä¸šåŠ¡å‘½åè§„èŒƒã€æ³¨é‡Šã€ç´¢å¼•å®šä¹‰ã€‚
- ç¡®ä¿ä¸ 203/205 è®¡åˆ’ä¸­çš„æ•°æ®æ¨¡å‹ä¿æŒä¸€è‡´ï¼ˆå‘½åã€å¤–é”®ã€ç´¢å¼•ï¼‰ã€‚
- è‹¥éœ€è¦ `schema.hcl` ä»¥ä¾¿ Atlas diffï¼Œæ”¾ç½®äºåŒç›®å½•å¹¶åœ¨æ–‡æ¡£ä¸­å¼•ç”¨ã€‚

### 4.3 åŸºçº¿è¿ç§»ç”Ÿæˆ
- é¦–é€‰ Atlas:
  ```bash
  atlas migrate diff \
    --dir "file://database/migrations" \
    --dev "$PG_BASELINE_DSN" \
    --to "file://database/schema.sql" \
    --format goose
  ```
- è‹¥ Atlas ä¸é€‚ç”¨ï¼Œåˆ™æ‰‹å·¥æ‹†åˆ† Schemaï¼Œé€å¯¹è±¡ç¼–å†™ Up/Downã€‚
- è¿ç§»æ–‡ä»¶å‘½åï¼š`database/migrations/20251105000000_base_schema.sql`ï¼Œéœ€åŒ…å«ï¼š
  ```sql
  -- +goose Up
  ...
  -- +goose Down
  ...
  ```

### 4.4 æœ¬åœ°éªŒè¯
```bash
make docker-up
make db-migrate-all      # goose up
make db-rollback-last    # goose down
go test ./... -count=1   # ç¡®è®¤æ–°åŸºçº¿ä¸ç ´åç°æœ‰æµ‹è¯•
```
- å°†æ‰§è¡Œæ—¥å¿—ä¿å­˜åˆ° `logs/214-phase1-baseline/`ã€‚

### 4.5 å®¡é˜…ä¸ç­¾å­—
- é€šè¿‡ PR æˆ–çº¿ä¸‹ä¼šè®®æ”¶é›†æ„è§ï¼ŒæŒ‰ç…§â€œé—®é¢˜-å¤„ç†-ç¡®è®¤äººâ€è®°å½•ã€‚
- ç”Ÿæˆ `docs/archive/development-plans/214-signoff-YYYYMMDD.md`ï¼ŒåŒ…å«æœ€ç»ˆç‰ˆæœ¬æ‘˜è¦ã€é“¾æ¥ã€ç­¾å­—äººã€‚

---

## 5. ä¾èµ–ä¸å‰ç½®æ¡ä»¶

| ä¾èµ–é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| Plan 212 Day6-7 æ¶æ„å®¡æŸ¥ | âœ… å®Œæˆ | ç›®å½•ä¸å…±äº«å¤ç”¨å†³è®®æ˜ç¡®ï¼Œå¯æŒ‰ç»Ÿä¸€ç»“æ„æ•´ç† Schema |
| Plan 213 Go å·¥å…·é“¾åŸºçº¿ | âœ… å®Œæˆ | Go 1.24.9 å·¥å…·é“¾å·²ç¡®è®¤ï¼Œå¯ä½¿ç”¨æœ€æ–° `goose`/`atlas` ç‰ˆæœ¬ |
| Plan 210 Phase0 å†»ç»“ä¸å¤‡ä»½ | âœ… å®Œæˆ | å¤‡ä»½ä¸ä¿æŠ¤åˆ†æ”¯å·²å½’æ¡£ï¼Œå¯å®‰å…¨è¿›è¡Œèƒå–å·¥ä½œ |
| Docker Compose ç¯å¢ƒå¯ç”¨ | âœ… | éœ€ä½¿ç”¨å®¹å™¨å†…çš„ PostgreSQL å®ä¾‹ |

---

## 6. é£é™©ä¸å¯¹ç­–

| é£é™© | ç­‰çº§ | è¯´æ˜ | å¯¹ç­– |
|------|------|------|------|
| Atlas ç”Ÿæˆè¿ç§»ä¸å®Œæ•´ | ä¸­ | è‡ªå®šä¹‰å‡½æ•°/è§¦å‘å™¨å¯èƒ½æœªå®Œå…¨å¯¼å‡º | é¢„å¤‡æ‰‹å·¥æ–¹æ¡ˆï¼›å®¡é˜…ç¯èŠ‚é€é¡¹å¯¹ç…§ Schema |
| Down è„šæœ¬é—æ¼å¯¹è±¡ | é«˜ | å½±å“å›æ»šèƒ½åŠ› | æ‰‹å·¥å®¡æ ¸ + `goose down` å®æµ‹éªŒè¯ |
| Schema ä¸ä¸šåŠ¡å‘½åä¸ä¸€è‡´ | ä¸­ | å½±å“åç»­æ¨¡å—å¼€å‘ | å‚è€ƒ 203/205 æ–‡æ¡£é€å­—æ®µæ ¸å¯¹ |
| æ‰§è¡Œæ—¥å¿—ç¼ºå¤± | ä½ | å½±å“å®¡è®¡ä¸å¤ç›˜ | æ‰€æœ‰å‘½ä»¤ä¿ç•™è„šæœ¬ä¸è¾“å‡ºï¼›æäº¤ PR æ—¶é™„é“¾æ¥ |

---

## 7. éªŒæ”¶æ ‡å‡†

- `database/schema/current_schema.sql`ã€`database/schema.sql`ã€åŸºçº¿è¿ç§»æ–‡ä»¶å‡å…¥åº“ï¼Œä¸”é€šè¿‡ä»£ç å®¡æŸ¥ã€‚
- `make db-migrate-all`ã€`make db-rollback-last`ã€`go test ./...` å‡åœ¨ Go 1.24 ç¯å¢ƒä¸‹é€šè¿‡ã€‚
- `docs/archive/development-plans/214-signoff-*.md` ä¿å­˜è”åˆç­¾å­—çºªè¦ã€‚
- `docs/development-plans/210-database-baseline-reset-plan.md` ä¸ `06-integrated-teams-progress-log.md` æ›´æ–° Phase1 å®ŒæˆçŠ¶æ€ã€‚

---

**ç‰ˆæœ¬å†å²**
- v1.0 (2025-11-05)ï¼šåˆç¨¿ï¼Œç­‰å¾…è¯„å®¡ã€‚  
- åç»­æ›´æ–°ï¼šè®°å½•æ‰§è¡Œè¿›å±•ä¸è°ƒæ•´ã€‚
