# Plan 07 â€” å®¡è®¡å†å²é¡µç­¾â€œåŠ è½½å®¡è®¡å†å²å¤±è´¥â€ä¿®å¤è®¡åˆ’

**è®¡åˆ’ç±»å‹**: æŸ¥è¯¢æœåŠ¡ç¨³å®šæ€§ / æ•°æ®ä¸€è‡´æ€§æ²»ç†  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-06  
**ä¼˜å…ˆçº§**: P1ï¼ˆç”Ÿäº§å¯è§åŠŸèƒ½å¼‚å¸¸ï¼‰  
**è´£ä»»å›¢é˜Ÿ**: æŸ¥è¯¢æœåŠ¡å›¢é˜Ÿï¼ˆOwnerï¼‰ / QA å›¢é˜Ÿï¼ˆéªŒè¯ï¼‰  
**å…³è”æ–‡æ¡£**: `CLAUDE.md`ã€`AGENTS.md`ã€`docs/api/schema.graphql`ã€`sql/inspection/audit-history-nullability.sql`ã€`reports/temporal/audit-history-nullability.md`

---

## 1. è§¦å‘èƒŒæ™¯
- Playwright ä¸æ‰‹åŠ¨å›å½’åœ¨ç»„ç»‡è¯¦æƒ…é¡µå®¡è®¡å†å²æ ‡ç­¾è§‚å¯Ÿåˆ° â€œåŠ è½½å®¡è®¡å†å²å¤±è´¥â€ æç¤ºï¼ŒGraphQL è¿”å›ç©ºæ•°ç»„æˆ– 500ã€‚
- `docs/api/schema.graphql` å®šä¹‰ `auditHistory(recordId: ID!): [AuditEntry!]!` ä¸ºéç©ºè¿”å›ï¼Œå½“å‰è¡Œä¸ºä¸å¥‘çº¦ä¸ç¬¦ã€‚
- `sql/inspection/audit-history-nullability.sql` ä¸ `reports/temporal/audit-history-nullability.md` ä¸ºè¯¥ç¼ºé™·æä¾›ç°æˆçš„æ•°æ®å·¡æ£€è„šæœ¬ä¸æ¨¡æ¿ï¼Œè¯æ˜é—®é¢˜çœŸå®å­˜åœ¨ä½†ç¼ºå°‘è®¡åˆ’æ–‡æ¡£æ”¯æ’‘ã€‚

## 2. ç›®æ ‡ä¸éªŒæ”¶æ ‡å‡†
| ç›®æ ‡ | éªŒæ”¶æ ‡å‡† |
| --- | --- |
| æ¢å¤å¥‘çº¦ä¸€è‡´æ€§ | `auditHistory` è¯·æ±‚è¿”å› 200 ä¸”ç¬¦åˆ GraphQL schema éç©ºçº¦æŸï¼›ç©ºç»“æœéœ€é€šè¿‡æ˜ç¡®ä¸šåŠ¡è§„åˆ™è§£é‡Šå¹¶æ›´æ–°å¥‘çº¦ã€‚ |
| æ•°æ®å®Œæ•´æ€§ | å·¡æ£€è„šæœ¬ç»“æœä¸­ `modified_fields`ã€`changes` ä¸å†å‡ºç° NULL / é JSON æ•°ç»„è®°å½•ï¼›`reports/temporal/audit-history-nullability.md` å¡«å†™æœ€æ–°ç»Ÿè®¡å¹¶æ ‡æ³¨â€œ0 æ¡å¼‚å¸¸â€ã€‚ |
| ç«¯åˆ°ç«¯éªŒè¯ | Playwright åœºæ™¯ï¼ˆ`tests/e2e/business-flow-e2e.spec.ts` ä¸­å®¡è®¡æ­¥éª¤æˆ–å•ç‹¬è„šæœ¬ï¼‰é€šè¿‡ï¼›è‹¥æ— è‡ªåŠ¨åŒ–å‰§æœ¬ï¼Œè‡³å°‘ä¿ç•™æ‰‹åŠ¨éªŒè¯è®°å½•ã€‚ |
| æ–‡æ¡£åŒæ­¥ | æœ¬è®¡åˆ’ã€06 å·æ—¥å¿—ã€å®ç°æ¸…å•ï¼ˆè‹¥æ¶‰åŠè°ƒæ•´ï¼‰ä¿æŒä¿¡æ¯ä¸€è‡´ï¼›è‹¥å¥‘çº¦éœ€æ›´æ–°é¡»å…ˆä¿®æ”¹ `docs/api/schema.graphql`ã€‚ |

## 3. å½“å‰å·²çŸ¥äº‹å®
- GraphQL æŸ¥è¯¢ä½äº `cmd/organization-query-service/internal/resolvers/audit_resolver.go`ï¼ˆé€šè¿‡ç»“æ„åŒ–æ£€ç´¢ç¡®è®¤ï¼‰ï¼›è°ƒç”¨é“¾åŒ…å«æœåŠ¡ä¸ä»“å‚¨å±‚ã€‚
- å®¡è®¡æ•°æ®æºè‡ªå‘½ä»¤æœåŠ¡è§¦å‘å™¨ `log_audit_changes()` åŠ `organization_audit` è¡¨ï¼›Plan 18 Phase B è¿ç§»å¯èƒ½å·²è°ƒæ•´éƒ¨åˆ†å­—æ®µã€‚
- ç°æœ‰æŠ¥å‘Šæ¨¡æ¿ `reports/temporal/audit-history-nullability.md` ä»ä¸ºç©ºç™½ï¼Œéœ€åœ¨æœ¬è®¡åˆ’æ‰§è¡ŒæœŸé—´å¡«å……å®é™…ç»“æœã€‚

## 4. è¡ŒåŠ¨è®¡åˆ’

### Phase 0 â€” ç«‹é¡¹ä¸å¤ç°ï¼ˆ0.5 å¤©ï¼‰âœ… å·²å®Œæˆï¼ˆ2025-10-06ï¼‰
1. âœ… åœ¨æœ¬è®¡åˆ’è®°å½•é—®é¢˜æè¿°ã€å®æ—¶è¿›å±•ä¸éªŒæ”¶æ ‡å‡†ã€‚
2. âœ… å¤ç°å®ä¾‹ä¸ GraphQL æŸ¥è¯¢éªŒè¯ï¼š
   - ç¯å¢ƒå‡†å¤‡ï¼šé€šè¿‡ `make docker-up` å¯åŠ¨ Postgres
   - ç”Ÿæˆæœ‰æ•ˆ JWTï¼š`go run scripts/cmd/generate-dev-jwt/main.go -audience cube-castle-users`
   - æ‰§è¡Œ GraphQL æŸ¥è¯¢ï¼š
   ```graphql
   query($id: String!) {
     auditHistory(recordId: $id) {
       auditId recordId operation timestamp modifiedFields
       changes { field oldValue newValue dataType }
     }
   }
   ```
   - **æŸ¥è¯¢ç»“æœ**ï¼šæˆåŠŸè¿”å› 2 æ¡è®°å½•ï¼Œä½†å‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼ˆè¯¦è§æŠ¥å‘Šï¼‰
   - å®Œæ•´å“åº”å·²è®°å½•äº `reports/temporal/audit-history-nullability.md` ç¬¬ 6 èŠ‚
3. âœ… æ‰§è¡Œ SQL å·¡æ£€ï¼š
   - è¿è¡Œ `sql/inspection/audit-history-nullability.sql`
   - è¾“å‡ºä¿å­˜äº `reports/temporal/audit-history-nullability-20251006.log`
   - **å…³é”®å‘ç°**ï¼š
     - æ€»å®¡è®¡è®°å½•æ•°ï¼š2 æ¡ (ç§Ÿæˆ· 3b99930c-4dc6-4cc9-8e4d-7d960a931cb9)
     - changes NULL/éæ•°ç»„ï¼š0 æ¡ âœ…
     - ç¼ºå¤± dataType çš„æ¡ç›®ï¼š1 æ¡ âš ï¸
     - ç©ºå˜æ›´çš„ UPDATE è®°å½•ï¼š1 æ¡ âš ï¸
   - å®Œæ•´ç»Ÿè®¡ä¸æ ·æœ¬å·²è®°å½•äº `reports/temporal/audit-history-nullability.md`

**Phase 0 æ€»ç»“**ï¼š
- âœ… éªŒè¯ GraphQL ç«¯ç‚¹å¯æ­£å¸¸è¿”å›æ•°æ®ï¼ˆéç©ºæ•°ç»„ï¼‰ï¼Œä¸å­˜åœ¨"åŠ è½½å®¡è®¡å†å²å¤±è´¥"çš„ 500 é”™è¯¯
- âš ï¸ å‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼šdataType ç¼ºå¤±ï¼ˆè¿”å› "unknown"ï¼‰å’Œç©ºå˜æ›´è®°å½•
- ğŸ“‹ åˆæ­¥æ ¹å› ï¼šå®¡è®¡è§¦å‘å™¨ `log_audit_changes()` é€»è¾‘ä¸å®Œå–„
- â¡ï¸ ä¸‹ä¸€æ­¥ï¼šPhase 1 å®šä½è§¦å‘å™¨ä»£ç ï¼Œåˆ†æ dataType å¡«å……é€»è¾‘

### Phase 1 â€” æ ¹å› å®šä½ï¼ˆ1 å¤©ï¼‰
1. âœ… 2025-10-07 è·Ÿè¸ªæŸ¥è¯¢æœåŠ¡é“¾è·¯ï¼šç¡®è®¤ GraphQL Resolver â†’ Repository æ— é¢å¤–è¿‡æ»¤ï¼Œ`processAuditRowsStrict` ä»…å‰”é™¤ç©ºå˜æ›´è®°å½•ï¼Œæœªå¯¼è‡´ 500/ç©ºæ•°ç»„ã€‚
2. âœ… 2025-10-07 å¯¹ç…§å‘½ä»¤æœåŠ¡è§¦å‘å™¨ä¸è¿‘æœŸè¿ç§»ï¼šå®šä½ `database/migrations/031_cleanup_temporal_triggers.sql` ç‰ˆæœ¬çš„ `log_audit_changes()` ç§»é™¤å­—æ®µå·®å¼‚è®¡ç®—ï¼Œå¯¼è‡´ `changes`/`dataType` ä¸¢å¤±ã€‚
3. âœ… 2025-10-07 æ ¹å› è®°å½•å·²è¡¥å……è‡³æœ¬æ–‡ç¬¬ 5 èŠ‚ä¸ `docs/development-plans/06-integrated-teams-progress-log.md`ï¼ˆå¾…åŒæ­¥é˜¶æ®µè§ä¸‹æ–‡ï¼‰ã€‚

### Phase 2 â€” ä¿®å¤ä¸éªŒè¯ï¼ˆ1-2 å¤©ï¼‰
1. æ ¹æ®æ ¹å› é€‰æ‹©ä¿®å¤ç­–ç•¥ï¼ˆç¤ºä¾‹ï¼‰ï¼š
   - SQL å±‚ï¼šè°ƒæ•´æŸ¥è¯¢æˆ–è¡¥æ•°æ®ï¼Œç¡®ä¿ `changes`ã€`modified_fields` å§‹ç»ˆä¸ºæœ‰æ•ˆ JSONã€‚
   - ä»£ç å±‚ï¼šè¡¥å……é”™è¯¯å¤„ç†/é™çº§é€»è¾‘ï¼ŒåŒæ—¶ä¿æŒ GraphQL å¥‘çº¦ã€‚
     - âœ… 2025-10-06 æ›´æ–° `postgres_audit.go/sanitizeChanges`ï¼Œåœ¨ `dataType` ç¼ºå¤±æˆ–ä¸º `"unknown"` æ—¶æ ¹æ® old/new å€¼æ¨æ–­ç±»å‹ã€‚
     - âœ… `processAuditRowsStrict` å¿½ç•¥ `changes`/`modifiedFields` å‡ä¸ºç©ºçš„æ—§æ—¥å¿—è®°å½•ï¼Œé¿å… GraphQL è¿”å›ç©ºå˜æ›´æ¡ç›®ã€‚
   - æ•°æ®å±‚ï¼šé€šè¿‡è¿ç§»æˆ–è„šæœ¬è¡¥é½å†å²æ•°æ®ã€‚
     - âœ… 2025-10-06 æ–°å¢ `database/migrations/033_cleanup_audit_empty_changes.sql` æ¸…ç†æ—§è§¦å‘å™¨å†™å…¥çš„ç©º UPDATE è®°å½•ã€‚
     - âœ… 2025-10-07 æ–°å¢å¹¶æ‰§è¡Œ `database/migrations/034_rebuild_audit_trigger_with_diff.sql`ï¼Œé‡å»º `log_audit_changes()`ï¼Œæ¢å¤å­—æ®µå·®å¼‚ä¸ `dataType` å†™å…¥ã€‚
     - âœ… 2025-10-07 ä½¿ç”¨ `jsonb_set` è¡¥é½å†å²å®¡è®¡è®°å½• `5a380d66-e581-4700-b7f3-803042babd7c` çš„ç¼ºå¤± `dataType`ã€‚
2. è¡¥å……å•å…ƒæµ‹è¯• / é›†æˆæµ‹è¯•ï¼š
   - Goï¼š`cmd/organization-query-service/internal/.../_test.go`
   - GraphQLï¼šæ–°å¢å¥‘çº¦æµ‹è¯•éªŒè¯éç©ºçº¦æŸã€‚
     - âœ… 2025-10-07 æŸ¥è¯¢æœåŠ¡é‡å¯åé€šè¿‡ `curl` è°ƒç”¨ GraphQL `auditHistory`ï¼Œè¿”å› 3 æ¡è®°å½•ä¸” `changes[].dataType` å‡ç¬¦åˆå¥‘çº¦ï¼ˆè¯¦è§ `reports/temporal/audit-history-nullability-20251007.log` ä¸åŒåæŠ¥å‘Šï¼‰ã€‚
3. æ‰§è¡ŒéªŒè¯å‘½ä»¤ï¼š
   - `make test`
   - `make test-integration`
   - `npm --prefix frontend run test:e2e -- --grep "audit"`ï¼ˆå¦‚å‰§æœ¬å­˜åœ¨ï¼‰
   - âœ… `go test ./cmd/organization-query-service/internal/repository`ï¼ˆ2025-10-07ï¼‰éªŒè¯è§¦å‘å™¨é‡å»ºåä»“å‚¨è§£æä»é€šè¿‡å•æµ‹ã€‚
   - âœ… `make db-migrate-all`ï¼ˆ2025-10-07ï¼‰ç¡®ä¿æ‰€æœ‰è¿ç§»è½åœ°ï¼Œå¹¶é€šè¿‡ `psql` æ‰‹åŠ¨è§¦å‘ä¸¤æ¬¡ UPDATE éªŒè¯æ–°è§¦å‘å™¨è¾“å‡ºã€‚
4. æ›´æ–° `reports/temporal/audit-history-nullability.md`ï¼Œæ³¨æ˜ä¿®å¤åå·¡æ£€ç»“æœï¼›é™„ Playwright æˆ–æ‰‹åŠ¨éªŒè¯è¯æ®ã€‚
   - âœ… 2025-10-07 å¤è·‘ SQL å·¡æ£€ï¼ˆ3 æ¡ UPDATE å®¡è®¡ / ç¼ºå¤± dataType=0ï¼‰ï¼Œå¹¶è®°å½•æ–°æ ·æœ¬ã€‚
   - âœ… 2025-10-07 GraphQL å“åº”æ ·æœ¬å·²è¡¥å……ï¼ˆPlaywright è¦†ç›–ç§»äº¤ Phase 3 æ”¶å°¾ï¼‰ã€‚

### Phase 3 â€” å½’æ¡£ä¸å›æº¯ï¼ˆ0.5 å¤©ï¼‰
1. åœ¨ `docs/development-plans/06-integrated-teams-progress-log.md` æ ‡è®°ä»»åŠ¡å®Œæˆå¹¶æ€»ç»“é£é™©ã€‚
2. è‹¥éœ€ï¼Œæ›´æ–° `docs/reference/01-DEVELOPER-QUICK-REFERENCE.md` æˆ–å®ç°æ¸…å•ä¸­çš„ç›¸å…³æ¡ç›®ã€‚
3. æ±‡æ€»æ‰§è¡Œè®°å½•è‡³ `reports/iig-guardian/plan07-audit-history-<date>.md`ï¼ˆè‹¥åˆ›å»ºï¼‰ã€‚
4. éªŒæ”¶å®Œæˆåå°†æœ¬è®¡åˆ’ç§»å…¥ `docs/archive/development-plans/`ï¼Œå¹¶åœ¨ 00-README.md æ ‡è®°çŠ¶æ€ã€‚

## 5. é£é™©ä¸ä¾èµ–
| é£é™© | æè¿° | ç¼“è§£æªæ–½ |
| --- | --- | --- |
| æ•°æ®å—æ±¡æŸ“ | å†å²å®¡è®¡è®°å½•å­˜åœ¨ä¸å¯æ¢å¤ç©ºå€¼ | åœ¨è¡¥æ•°æ®å‰å¤‡ä»½å—å½±å“è®°å½•ï¼›å¿…è¦æ—¶ä¸æ•°æ®åº“å›¢é˜Ÿåä½œã€‚ |
| æŸ¥è¯¢æ€§èƒ½é€€åŒ– | ä¿®å¤å¯èƒ½å¼•å…¥é¢å¤– JOIN/è½¬æ¢ | é€šè¿‡ `EXPLAIN ANALYZE` éªŒè¯ï¼Œå¿…è¦æ—¶å»ºç«‹ç´¢å¼•ã€‚ |
| å¥‘çº¦å˜æ›´é£é™© | è‹¥éœ€è°ƒæ•´ GraphQL å¥‘çº¦éœ€è·¨å›¢é˜Ÿè¯„å®¡ | åšæŒâ€œå…ˆå¥‘çº¦åå®ç°â€ï¼Œæ›´æ–° `docs/api/schema.graphql` å¹¶é€šçŸ¥å‰ç«¯ã€‚ |

## 6. é‡Œç¨‹ç¢‘
| é‡Œç¨‹ç¢‘ | å†…å®¹ | æˆªæ­¢ |
| --- | --- | --- |
| Phase 0 å®Œæˆ | å¤ç°ã€å·¡æ£€ç»“æœè®°å½•ã€æ ¹å› å‡è®¾ | 2025-10-07 |
| Phase 1 å®Œæˆ | æ ¹å› æŠ¥å‘Š & ä¿®å¤æ–¹æ¡ˆè¯„å®¡ | 2025-10-09 |
| Phase 2 å®Œæˆ | ä¿®å¤åˆå…¥ã€æµ‹è¯•é€šè¿‡ã€æŠ¥å‘Šæ›´æ–° | 2025-10-11 |
| Phase 3 å®Œæˆ | æ–‡æ¡£å½’æ¡£ã€æ—¥å¿—æ›´æ–°ã€è®¡åˆ’æ”¶å°¾ | 2025-10-12 |

## 7. å‚è€ƒèµ„æ–™
- `docs/api/schema.graphql` â€” GraphQL å¥‘çº¦å”¯ä¸€äº‹å®æ¥æºã€‚
- `sql/inspection/audit-history-nullability.sql` â€” å·¡æ£€è„šæœ¬ã€‚
- `reports/temporal/audit-history-nullability.md` â€” å·¡æ£€è¾“å‡ºæ¨¡æ¿ã€‚
- `reports/iig-guardian/p1-crud-issue-analysis-20251002.md` â€” ç›¸å…³æ•…éšœåˆ†æèƒŒæ™¯ã€‚
- `docs/development-plans/15-database-triggers-diagnostic-report.md`ï¼ˆå½’æ¡£ï¼‰â€” å®¡è®¡è§¦å‘å™¨å†å²é—®é¢˜ï¼Œä¾›å‚è€ƒã€‚

---

**æ‰§è¡ŒçŠ¶æ€**: âœ… Phase 2 å®Œæˆï¼ˆæ•°æ®åº“ & GraphQL åŒçº¿éªŒè¯é€šè¿‡ï¼ŒPlaywright è¦†ç›–ç§»äº¤ Phase 3ï¼‰

**è¿›åº¦è·Ÿè¸ª**ï¼š
- âœ… 2025-10-06: Phase 0 å®Œæˆ - SQL å·¡æ£€ä¸ GraphQL æŸ¥è¯¢éªŒè¯å®Œæˆï¼ŒæŠ¥å‘Šå·²æ›´æ–°
- âœ… 2025-10-07: Phase 1 å®Œæˆ - æ˜ç¡®æ ¹å› ç³» `log_audit_changes()` ç§»é™¤å­—æ®µå·®å¼‚è®¡ç®—å¹¶è¾“å‡ºä¿®å¤æ–¹æ¡ˆ
- âœ… 2025-10-07: Phase 2ï¼ˆæ•°æ®åº“ä¾§ï¼‰- æ‰§è¡Œè¿ç§» 034ã€è¡¥é½å†å²è®°å½•å¹¶å¤è·‘å·¡æ£€ï¼Œç¡®è®¤ç¼ºå¤± `dataType` æ¸…é›¶
- âœ… 2025-10-07: Phase 2ï¼ˆåº”ç”¨ä¾§ï¼‰- æ‰‹åŠ¨ GraphQL è°ƒç”¨éªŒè¯é€šè¿‡ï¼ŒPlaywright è‡ªåŠ¨åŒ–å¾…åœ¨ Phase 3 ä¸­è¡¥å……

**Phase 0 å…³é”®æˆæœ**ï¼š
1. ç¡®è®¤ GraphQL ç«¯ç‚¹å¯æ­£å¸¸è¿”å›æ•°æ®ï¼Œä¸å­˜åœ¨ 500 é”™è¯¯æˆ–ç©ºæ•°ç»„é—®é¢˜
2. è¯†åˆ« 2 ä¸ªæ•°æ®è´¨é‡é—®é¢˜ï¼šdataType ç¼ºå¤±å’Œç©ºå˜æ›´è®°å½•
3. åˆæ­¥æ ¹å› å®šä½åˆ°å®¡è®¡è§¦å‘å™¨ `log_audit_changes()`
4. å®Œæ•´è¯æ®å·²è®°å½•äº `reports/temporal/audit-history-nullability.md` å’Œå·¡æ£€æ—¥å¿—

è¿›å±•ä¸è¯æ®è¯·åœ¨æœ¬è®¡åˆ’ä¸ 06 å·æ—¥å¿—ä¿æŒåŒæ­¥ï¼Œç¡®ä¿èµ„æºå”¯ä¸€æ€§ä¸è·¨å±‚ä¸€è‡´æ€§ã€‚
