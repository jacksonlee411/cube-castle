# 219C2 修改清单 – 快速参考

**状态**：P0 修改项已合并至 `219C2-validator-framework.md`，P1 建议在启动会议中复核
**优先级**：P0 改进启动前必做（已完成），P1 改进启动时可做

---

## P0 修改项（启动前必须，预算 2-4 小时）

### 修改 1：§1.1 前置条件补充 PoC

**位置**：第 19-25 行

**当前**：4 项前置条件

**修改为**：
```markdown
## 1.1 前置条件（P0 必须满足）

- 219C1 审计基础设施已验收 ✓
- 规则矩阵与错误码已冻结 ✓
- OpenAPI 错误码已补齐 ✓
- README 已预留小节 ✓
- **NEW: 架构 PoC 在 Day 21 早晨完成并通过** ✓
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §1.1）

**理由**：确保关键假设（链式执行、工厂模式、性能）在启动前验证

---

### 修改 2：新增 §3.0 架构 PoC 与假设验证

**位置**：插入 §3.1 前面

**新增内容**：
```markdown
## 3.0 架构 PoC 与假设验证（Day 21 早晨，预算 30 分钟）

在启动正式实施前，需通过 PoC 验证以下关键假设：

1. 链式验证执行器可支持优先级排序 + 短路 + 错误聚合
2. 工厂模式可在现有 DI 框架下集成
3. 链式执行 10 条规则的耗时 < 10ms

### PoC 实施范围
- 创建临时 PoC 代码：single rule chain execution + factory DI
- 使用 mock 仓储
- 运行 benchmark

### PoC 验收标准
- [ ] 链式执行正确识别规则违反
- [ ] 错误序列化为 JSON
- [ ] 工厂函数成功注入多个仓储实例
- [ ] 性能基准 < 10ms

### 失败处理
若 PoC 失败，中止其他任务，与架构组评审 30 分钟，允许调整计划。
不允许带着不确定性进入 A1。

### PoC 输出
- `internal/organization/validator/validator_chain_poc_test.go`
- `logs/219C2/poc-perf.log`
- `logs/219C2/poc-review.md`（若失败）
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §3.0）

**理由**：验证架构假设，降低高风险决策

---

### 修改 3：§3.1 合并子任务为 4 个关键节点

**位置**：第 43-62 行

**当前**：11 个子任务（219C2A1-E2）

**修改为**：
```markdown
### 3.1 子任务拆分（精简版）

为降低协调成本，本计划将任务拆分为 4 个关键节点。

| 子编号 | 日期 | 范围 | 依赖 |
| --- | --- | --- | --- |
| **A – 框架基座** | Day 21 | 接口定义、handler 集成、规则冻结 | 219C1 + PoC |
| **B – 组织域规则** | Day 22 | 规则实现 + REST/GraphQL 接入 + 单测 | A |
| **C – 职位与跨域** | Day 23 | 职位规则 + Assignment 基础 + 跨域 + 单测 | B |
| **D – 扩展与验收** | Day 24 | Job Catalog + 端到端测试 + 文档同步 + 归档 | C |

### 关键路径与并行机会

```
A → B → C → D
    (关键路径，串行)
```

- Day 21：PoC(0.5h) + A(3.5h) + A2-A3 并行(3h) = 1 天
- Day 22：B 规则实现 + 单测(8h) = 1 天
- Day 23：C1-C2 + D1(8h) = 1 天
- Day 24：D2(2h) + E1(2h) + 端到端(2h) + 文档(2h) = 1 天，预留缓冲

**同步点从 11 次降到 4 次，协调成本减少 70%。**
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §3.1）

**理由**：减少任务碎片化，控制协调成本，符合"简洁优先"

---

### 修改 4：§3.2 规则矩阵改为引用

**位置**：第 66-89 行

**当前**：复制整个规则矩阵到计划文档

**修改为**：
```markdown
### 3.2 规则实现矩阵（冻结版）

规则矩阵为唯一事实来源，最终结果须记录在 `internal/organization/README.md#validators`。

**详见 README 对应章节**。下表为快速参考，本计划中的规则表格仅作为执行清单参考，任何规则变更需同步更新 README 并提交评审。

[保留当前的规则表格作为快速参考]
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §3.2）

**理由**：符合"唯一事实来源"原则，减少同步成本

---

### 修改 5：§3.4 测试矩阵优先级化

**位置**：第 105-110 行

**当前**：平铺的测试要求（单元 + 端到端 + 集成 + 回归）

**修改为**：
```markdown
### 3.4 测试矩阵（优先级化）

#### 第 1 层：单元测试（必须）

**P0 规则**（8 条）
- 每条规则：正向 1 + 反向 2-3 样例
- 目标覆盖率：≥ 85%
- 时间：Day 22-23 约 2-3 天

**P1 规则**（3 条）
- 每条规则：正向 1 + 反向 1 样例
- 目标覆盖率：≥ 70%
- 时间：若 P0 提前，Day 23 PM；否则延迟至 219E

**P2 规则**（1 条）
- 基本覆盖
- 时间：可延迟至 219E

#### 第 2 层：集成测试（REST/GraphQL 一致性，P0 优先）

仅为 P0 规则中的 3 个关键命令编写端到端测试：
- CreateOrganization（3 个错误场景）
- CreatePosition（2 个错误场景）
- FillPosition（3 个错误场景）

共 8 个端到端测试，Day 24 早晨 2-4 小时。

#### 第 3 层：服务层回归（可选）

若有时间在 Day 24 PM 执行（非关键路径）。

**测试总工作量**：
- 单元：~16-20 小时
- 端到端：~4-6 小时
- 回归（可选）：~2-3 小时
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §3.4）

**理由**：控制范围，确保 P0 规则质量，P1/P2 可延迟

---

## P1 修改项（启动时可做，预算 1-2 小时）

### 修改 6：明确 A 的工作范围

**位置**：§3.1 中 219C2A 的描述

**补充**：
```markdown
### 子任务 A – 框架基座（工作范围澄清）

现有的 `BusinessRuleValidator` 与 `ValidationResult` 结构已在代码中实现。
A 的工作**不是重新设计**，而是：

1. **验证**现有框架是否可直接复用
2. **补充**缺失的仓储接口（仅定义接口，不实现 SQL）
3. **冻结**规则矩阵与错误码映射

**目的**：避免返工，明确增量改造范围在 1-2 个文件内。
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §3.1 节“节点说明”）

**理由**：澄清 A1 的实际工作，避免期望偏差

---

### 修改 7：依赖关系与风险预警

**位置**：§5 风险与缓修

**补充**：
```markdown
## 5. 风险与缓修

| 风险 | 影响 | 缓修 |
|---|---|---|
| **PoC 失败** | 高 | Day 21 早晨立即评审，允许调整计划，不允许继续 |
| 任务粒度导致协调成本 | 中 | 已合并为 4 个关键节点，同步点 < 5 次/天 |
| 关键路径延迟级联 | 高 | A/B 延迟 > 4h → 调整 C-D；B-C 延迟 > 1d → 合并或延迟规则 |
| ...（其他风险保持原样）|
```

**完成情况**：✅ 已合并（见 `219C2-validator-framework.md` §5）

**理由**：明确监控指标，提前预警

---

## 执行步骤

### Step 1：评审与批准（预算 30-45 分钟）

1. 架构组审阅本评审报告
2. 讨论 7 项改进的可行性
3. 决议：批准改进，指派修改责任人
4. 记录评审纪要

### Step 2：更新计划文档（预算 3-4 小时）

1. 合并子任务（1 小时）
2. 新增 §3.0 PoC（30 分钟）
3. 修改 §3.2 引用 README（30 分钟）
4. 重写 §3.4 优先级化（1 小时）
5. 补充风险与依赖关系（30 分钟）
6. PR 评审与合并（1 小时）

### Step 3：PoC 验证（Day 21 早晨，30 分钟）

1. 执行 PoC（15-20 分钟）
2. 验收结果（5-10 分钟）
3. 记录输出（5 分钟）
4. **若失败**：立即评审，允许调整，不继续

### Step 4：正式启动

PoC 通过 + 文档通过 = 可启动 Day 21 正式实施

---

## 修改前后效果对比

### 修改前的问题

✗ 11 个子任务，4 天内协调成本高
✗ 关键假设（链式执行、工厂模式）无验证
✗ 规则矩阵重复出现，同步成本高
✗ 测试范围过宽（单元 + 端到端 + 集成 + 回归）
✗ 超期风险 40-50%

### 修改后的改进

✅ 4 个关键节点，协调成本 -70%
✅ PoC 前置，验证关键假设
✅ 规则矩阵去重，唯一来源明确
✅ 测试分优先级，P0 必须 P1/P2 可延迟
✅ 超期风险降至 10-20%

---

## 修改时间表

| 活动 | 日期 | 预算 | 负责人 |
|------|------|------|--------|
| 评审报告编写 | 2025-11-05 | 已完成 | 架构评审 |
| 架构组评审 | 2025-11-06（启动前 1 天） | 45 分钟 | 架构组 |
| 文档更新与 PR | 2025-11-06 PM | 3-4 小时 | 指派的开发者 |
| 文档 PR 评审 | 2025-11-06 PM | 1 小时 | Reviewer |
| PoC 验证 | Week 4 Day 21 早晨 | 30 分钟 | 主要实施者 |
| 正式启动 | Week 4 Day 21 AM | - | 后端团队 |

---

## 相关文档

- 完整评审报告：`docs/development-plans/219C2-review-findings.md`
- 当前计划：`docs/development-plans/219C2-validator-framework.md`
- 项目原则：`CLAUDE.md`
- 组织模块：`internal/organization/README.md`

---

**建议**：在正式启动前完成上述 P0 修改（共 5 项），确保计划质量和执行可行性。
