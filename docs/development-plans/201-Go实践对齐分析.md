# 201 · 项目Go技术栈与《200号文档》最佳实践对比

**版本**: v4.0  
**更新日期**: 2025-11-24  
**评审状态**: ♻️ 基于 Plan 203 / Plan 215 完整交付重新评估

---

## 1. 背景与信息来源

- **对标文档**：`docs/development-plans/200-Go语言ERP系统最佳实践.md`（简称“200号文档”），关注模块化单体、sqlc/Atlas、事务性发件箱、Docker 化测试、权限治理等章节。
- **阶段性计划**：
  - `docs/development-plans/203-hrms-module-division-plan.md`：定义 Core HR 域的阶段化目标与模块矩阵，Phase2 已归档且 Phase3（workforce）即将启动。
  - `docs/development-plans/215-phase2-summary-overview.md`、`docs/development-plans/215-phase2-execution-log.md`：记录 Phase2 七个子计划（216-222）的交付结果，是本次评估的主要对照。
- **现场代码 / 工具**：`cmd/hrms-server/command/main.go`、`cmd/hrms-server/query/internal/app/app.go`、`pkg/eventbus/*`、`pkg/database/{connection,outbox}.go`、`pkg/logger/*.go`、`cmd/hrms-server/command/internal/outbox/dispatcher.go`、`internal/organization/repository/postgres_positions.go`、`database/migrations/20251107090000_create_outbox_events.sql`、`database/schema.sql`、`scripts/generate-migration.sh`、`scripts/run-integration-tests.sh`、`docker-compose.test.yml`、`Makefile:test-db` 以及 Plan 252/255/259 的守卫脚本。

---

## 2. 当前技术栈概览（事实陈述）

### 2.1 服务与模块形态

- 命令/查询服务统一位于 `cmd/hrms-server/command` 与 `cmd/hrms-server/query`，共用同一个 Go Module，并在 `internal/` 下共享鉴权、缓存、GraphQL、监控等中间件，符合 203 计划提出的“模块化单体 + PostgreSQL 原生 CQRS”定位。
- 虽仍以两个进程部署（9090/8090），但 `internal/organization` 已按 Plan 219 重构为标准模块：`api.go` 暴露 `CommandModule`、`QueryRepository`、`AssignmentFacade` 等接口；`internal/organization/README.md` 列出了目录结构，为 Phase3 workforce/contract 模块提供模板。

### 2.2 共享基础设施（Plan 216-218）

- `pkg/eventbus` 定义 `EventBus` 接口和 `MemoryEventBus` 并发安全实现，可聚合处理器错误并输出指标；命令服务默认注入该实现，未来可替换为 Redis/Faktory/Asynq 适配器。
- `pkg/database/connection.go` 封装 `database/sql`，统一设置 `MaxOpenConns=25`、`MaxIdleConns=5`、`ConnMaxLifetime=30m`，并提供 `RecordConnectionStats`、`ObserveQueryDuration` 供 Prometheus 暴露；命令/查询服务均在启动时注册指标。
- `pkg/database/outbox.go` + `cmd/hrms-server/command/internal/outbox/dispatcher.go` 实现事务性发件箱：业务数据与 outbox 同事务写入，dispatcher 通过 `FOR UPDATE SKIP LOCKED` 轮询、带重试与 backoff。
- `pkg/logger`（Plan 218）提供结构化 JSON 日志和 `WithFields`，命令/查询服务、PBAC、outbox dispatcher 均复用同一实现，方便跨模块关联。

### 2.3 数据访问与仓储

- 组织模块仓储仍以手写 SQL + `rows.Scan` 为主（示例：`internal/organization/repository/postgres_positions.go`、`postgres_assignment_repository.go`），一次查询动辄 30+ 字段，维护成本高。
- 尚未引入 sqlc/pgx 代码生成；`go.mod` 仍依赖 `github.com/lib/pq`。Plan 203 将 sqlc 设为 Phase3 的基线，但目前仅完成模板与工具链准备。

### 2.4 数据库迁移与 SSoT

- 迁移文件全部迁移到 `database/migrations/*.sql`，采用 Goose 时间戳命名并包含 `-- +goose Up/Down`（如 `20251107090000_create_outbox_events.sql`）。`database/schema.sql` 与 `database/schema/` 的 Atlas schema 作为唯一事实来源。
- `scripts/generate-migration.sh` 默认调用 Atlas `migrate diff` 生成 Goose 迁移，若 atlas 不可用则导出 schema 以便手工补齐。
- `Makefile` 提供 `db-migrate-all`/`db-rollback-last`，Plan 221 的 `scripts/run-integration-tests.sh` 会在 Docker 中执行 Goose up → `go test -tags=integration` → Goose down，验证迁移可回滚。

### 2.5 异步可靠性与事件分发

- 命令服务写入聚合时通过 `database.WithTx` 同步插入 `outbox_events`，dispatcher 拉取事件后调用 eventbus，具备 Retry、指数退避、幂等及 Prometheus 指标（`command_outbox_*`）。
- 事件总线目前仍使用内存实现，但接口层已解耦，Plan 215 执行日志也标注“可替换 Redis/Asynq adapter”。203 计划中 workforce/contract 模块将依赖此机制进行跨模块事件通知。

### 2.6 权限策略与门禁

- 查询服务使用 `internal/auth/pbac.go` 中的 `GraphQLQueryPermissions` 与 `RolePermissions` Go map，策略更新需重新编译部署。
- Plan 252/259 在 CI 中引入 `auth-permission-contract-validator`、`protocol-duplication-matrix` 等脚本确保契约一致，并由 Plan 255 将相关检查纳入 Required Checks；但策略仍硬编码，距离 200 号文档要求的“模型/策略分离”尚有差距。

### 2.7 测试与 CI 门禁

- Plan 221 交付 `docker-compose.test.yml` + `scripts/run-integration-tests.sh`，`make test-db` 会拉起专用 PostgreSQL → Goose up → `go test -tags=integration ./...` → Goose down，满足 200 号文档“Docker 化真实数据库测试”的要求。
- Plan 222 在 `logs/plan222/` 落盘 REST/GraphQL/E2E 证据；Plan 255/258/259 将 ESLint 架构守卫、golangci-lint（depguard/tagliatelle）、OpenAPI Spectral、权限契约、协议重复矩阵、root audit 纳入 Required Checks，确保“先契约后实现”。
- 组织模块历史单测仍大量使用 `sqlmock`（`internal/organization/repository/*_test.go`），Docker 基座尚未覆盖全部关键路径，Phase3 需继续迁移。

### 2.8 可观测性

- `pkg/logger` 输出 JSON 日志（含 `service/component/operation`），命令/查询服务、dispatcher、PBAC 均复用，便于交叉排障。
- `pkg/database/metrics.go` 暴露查询耗时与连接池统计；命令/查询服务在启动时调用 `RecordConnectionStats` 并注册 `/metrics`。
- 命令服务保留 `cmd/hrms-server/command/internal/utils/metrics.go` 中 HTTP/时态操作/审计日志指标，配合 Plan 221/222 的日志落盘，形成“日志 + 指标 + 测试证据”闭环。

---

## 3. 与200号文档的对齐项（Phase2 后）

| 维度 | 200号文档期望 | 项目现状（2025-11-24） | 评估 |
| --- | --- | --- | --- |
| Go + chi + CQRS | 使用 Go + chi/Gin 构建轻量 REST，并以 CQRS 划分命令/查询（200:493-500, 478-487） | `cmd/hrms-server/command` 与 `cmd/hrms-server/query` 共用 module 与中间件；203 计划以此骨架扩展其它模块 | ✅ |
| Docker-first 基础设施 | Postgres/Redis 必须由 Docker Compose 管理（AGENTS, 200:250） | `make run-dev`/`make test-db` 强制拉起容器；Plan 215 日志记录了卸载宿主 Redis 释放 6379 | ✅ |
| 事务性发件箱 | Outbox + 中继 + 事件总线（200:301-399） | `pkg/database/outbox.go` + dispatcher 已上线，具备 Retry/幂等/指标 | ✅ |
| 迁移与回滚 | Atlas 生成 Goose 迁移并保留 Down（200:243-257） | `scripts/generate-migration.sh` 默认使用 Atlas diff，所有迁移含 Up/Down；`db-rollback-last` 常态化 | ✅ |
| 结构化日志 + Prometheus | JSON 日志与指标监控（200:514） | `pkg/logger`、`pkg/database/metrics.go`、命令/查询服务 `/metrics` 均到位 | ✅ |
| Docker 化集成测试 | 真实数据库测试代替 sqlmock（200:428-456） | Plan 221 的 `make test-db`/`scripts/run-integration-tests.sh` 在 Docker 中执行 Goose + `go test -tags=integration` | ✅ 基座就绪 |
| 连接池治理 | 显式设置 `SetMaxOpenConns/IdleConns`（200:261-270） | `pkg/database/connection.go` 统一配置，命令/查询服务复用 | ✅ |

---

## 4. 差异、影响与优先级

| 领域 | 200号文档主张 | 当前状态 | 影响 | 优先级 | 建议 |
| --- | --- | --- | --- | --- | --- |
| 数据访问层（sqlc） | 使用 sqlc/ent 获得编译期类型安全（200:207-241） | 仓储仍以手写 SQL + `rows.Scan` 为主，Phase3 才计划引入 sqlc | 维护 30+ 字段映射风险高，难以复用到 workforce/contract | P1 | 以 workforce 模块为试点建立 `sqlc.yaml` + `make sqlc-generate` 守卫，逐步替换组织模块关键查询 |
| 权限策略外部化 | 使用 Casbin/配置分离策略与实现（200:403-417） | `internal/auth/pbac.go` 硬编码 scope/role；Plan 252/259 仅校验契约 | 策略变更需编译部署，合规审计困难，无法满足多模块共享需求 | P1 | 设计策略存储（PostgreSQL + Casbin Adapter 或自研表），Plan 252/259 输出作为同步源，命令/查询服务注入策略读取器 |
| 事件总线传输层 | Outbox + Redis/Faktory/Asynq 等持久队列（200:301-399） | Dispatcher 已上线，但 EventBus 仍为内存实现 | 无法跨进程广播，命令服务重启时仅当前进程可消费 | P2 | 在 `pkg/eventbus` 上实现 Redis/Asynq Adapter，并为 dispatcher 注入，提供指标与配置开关 |
| 端口/适配器模式 | 领域层定义 port，基础设施实现 adapter（200:142-196） | `internal/organization` 虽模块化，但 service 仍直接依赖具体仓储/Redis | 模块耦合偏高，Phase3 workforce/contract 难以插拔 | P2 | 按 203 模板在 `internal/<module>/api.go` 定义 port，adapter 放至 infra 层，并在 `cmd/hrms-server` 入口集中注入 |
| 集成测试覆盖 vs sqlmock | Docker 实库测试应取代 sqlmock（200:428-456） | `make test-db` 已上线，但 `internal/organization/repository/*_test.go` 大量依赖 sqlmock | Mock 无法发现 SQL 语法/索引/事务问题，Plan 221 基座价值未充分发挥 | P1 | 制定迁移清单，将 positions/assignments/audit 等仓储改写为 Docker 集成测试，保留 sqlmock 仅覆盖错误分支，并在 PR 模板/CI 中要求 `make test-db` |

### 4.2 差异详解

1. **sqlc 试点缺失**：`internal/organization/repository/postgres_positions.go` 等依旧手写 SQL + Scan，一旦字段顺序或类型发生变更，编译期无法感知，也无法在 Phase3 中复用。应以 workforce 模块为试点，引入 sqlc 生成器并建立 `make sqlc-generate` 守卫，再逐步迁移组织模块。
2. **权限策略仍硬编码**：Plan 252/259 的契约守卫保障了 OpenAPI/GraphQL 与运行时映射一致，但 `internal/auth/pbac.go` 仍以 Go map 存放 scope/role。需要将策略迁移到数据库/配置文件，并通过 Casbin/自研适配器加载，才能满足 200 号文档强调的“模型/策略分离”。
3. **事件总线尚未接入持久传输**：Outbox + dispatcher 已经可靠落地，但 Publish 仍调用 `eventbus.NewMemoryEventBus`。要让 workforce/contract 等模块订阅事件，需要在 `pkg/eventbus` 基础上提供 Redis Stream/Asynq Adapter，并让 dispatcher 通过接口注入，保证跨进程可靠投递。
4. **端口/适配器模式尚待固化**：`organization.NewCommandModule` 直接返回具体的仓储/Redis/outbox 实例，领域层没有清晰的 port。按照 203 模板应在 `internal/<module>/api.go` 暴露接口、在 adapter 层实现基础设施逻辑，并在 `cmd/hrms-server` 入口集中依赖注入。
5. **Docker 集成测试覆盖不足**：Plan 221 的基座已满足 200 号文档要求，但大量仓储测试依旧使用 `sqlmock`。需要制定迁移计划，将关键仓储迁移到 Docker 集成测试，保留 sqlmock 仅用于错误路径或不可控依赖。

---

## 5. 补充发现

- **Atlas + Goose 流程闭环**：`scripts/generate-migration.sh` 默认调用 Atlas `migrate diff` 生成 Goose 迁移，若 atlas 缺失则导出 `database/schema.sql`，杜绝“直接在数据库调试 SQL”的风险。Plan 215 执行日志已多次记录 Goose up/down 结果，可复用到后续阶段。
- **门禁矩阵成熟**：Plan 255/258/259 已将 ESLint 架构守卫、golangci-lint（depguard/tagliatelle）、OpenAPI Spectral、权限契约、协议重复矩阵、root audit 纳入 Required Checks。Phase3 新模块只需复用现有门禁即可，无需重新搭建。

---

## 6. 行动建议（与 203/215 对齐）

| 优先级 | 行动 | 说明与验收 |
| --- | --- | --- |
| P1 | 引入 sqlc 并建立生成门禁 | 在仓库根创建 `sqlc.yaml`，以 workforce 模块或现有组织查询为试点，`make sqlc-generate` + CI diff 守卫必须通过；完成后逐步替换手写仓储。 |
| P1 | 外部化 PBAC 策略 | 设计 `permissions`/`role_scopes` 表或 Casbin Adapter，将 `GraphQLQueryPermissions`/`RolePermissions` 迁移到配置；Plan 252/259 的 validator 读取新源，命令/查询服务注入策略读取器。 |
| P1 | 扩大 Docker 集成测试覆盖 | 将 positions/assignments/audit 等关键仓储改写为 `go test -tags=integration`，在 PR 模板中要求提供 `make test-db` 结果，确保 CI 与本地一致。 |
| P2 | 实现事件总线持久化适配器 | 在 `pkg/eventbus` 增加 Redis/Asynq Adapter，dispatcher 通过接口注入，提供指标与配置开关，满足多进程消费者需求。 |
| P2 | 固化端口/适配器模板 | 依照 Plan 220 模板在 `internal/<module>/api.go` 声明 port，adapter（数据库/Redis/事件）放到 infra 层，并在 `cmd/hrms-server` 入口集中注入，为 Phase3 workforce/contract 做准备。 |

---

## 7. 总结

- Phase2 (Plan 215) 已补齐事务性发件箱、连接池、Goose 迁移、Docker 集成测试、结构化日志等“硬指标”，整体与 200 号文档的对齐度显著提升。
- 当前技术债集中在“类型安全数据访问（sqlc）”、“权限策略外部化”、“事件总线持久化适配器”、“端口/适配器模式”以及“将 Docker 集成测试覆盖到关键仓储”。这些亦是 203 计划阶段性目标的前置条件。
- 建议以 workforce 模块为载体，同步推进 sqlc + 端口/适配器 + 集成测试，并在平台层交付权限外部化与事件总线 adapter，确保后续模块直接复用。

---

## 附录：关键路径索引

| 组件 | 文件 | 说明 |
| --- | --- | --- |
| 命令服务入口 | `cmd/hrms-server/command/main.go` | 初始化数据库/Redis/eventbus/outbox dispatcher/organization 模块 |
| 查询服务入口 | `cmd/hrms-server/query/internal/app/app.go` | 初始化 GraphQL、PBAC、Prometheus 指标 |
| 共享基础设施 | `pkg/eventbus/*`, `pkg/database/{connection,transaction,outbox}.go`, `pkg/logger/*.go` | Plan 216-218 产物 |
| 组织模块骨架 | `internal/organization/api.go`, `internal/organization/repository/*.go` | Phase2 模块化示例 |
| 事务性发件箱 | `database/migrations/20251107090000_create_outbox_events.sql`, `cmd/hrms-server/command/internal/outbox/*.go` | Plan 217/217B |
| 迁移与测试脚本 | `scripts/generate-migration.sh`, `Makefile:db-migrate-all`, `scripts/run-integration-tests.sh` | Atlas + Goose + Docker 集成测试 |
| 权限契约守卫 | `scripts/quality/auth-permission-contract-validator.js`, `scripts/quality/protocol-duplication-matrix.js`, `reports/permissions/*` | Plan 252/259 基础设施 |

**维护责任**：项目架构团队  
**下次评审建议**：2026-Q1（依据 Phase3 workforce 进度）
