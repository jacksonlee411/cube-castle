# Plan 219C2Z – 验证链问题跟踪

**文档编号**: 219C2Z  
**上级计划**: [219C2 – Business Validator 框架扩展](./219C2-validator-framework.md)  
**目标周期**: Week 4 Day 22-23（滚动）  
**负责人**: Team 06 + 架构组联合排查

---

## 1. 目标

1. 修复 REST 自测报告中暴露的循环检测错误码问题，确保自引用返回 `ORG_CYCLE_DETECTED`。  
2. 诊断并解决组织更新 400、暂停 500 的异常，明确错误码与处理逻辑。  
3. 形成复盘总结，若需新增错误码或文档调整，回填到主计划与相关文档。

---

## 2. 问题列表

| 编号 | 问题描述 | 当前表现 | 预期行为 | 责任人 | 计划修复时间 | 状态 |
|------|----------|----------|----------|--------|----------------|------|
| Z-01 | 自引用循环返回 `INVALID_PARENT` | HTTP 400 / error.code=`INVALID_PARENT` | 返回 `ORG_CYCLE_DETECTED`，并在响应 details/审计中记录该 Rule | Team 06 | 2025-11-07 AM | 进行中 |
| Z-02 | 普通更新请求返回 400 | HTTP 400（缺少错误码详情） | 成功返回 200，或提供明确的验证错误码 | Team 06 + 仓储组 | 2025-11-07 PM | 进行中 |
| Z-03 | `SuspendOrganization` 返回 500 | HTTP 500 + 日志报错 | 返回业务错误码或明确冲突原因；不应产生 500 | 架构组 | 2025-11-08 | 待启动 |

---

## 3. 详细任务

### 3.1 Z-01 循环检测错误码
- 检查 `BusinessRuleValidator` 的循环规则执行顺序，确保 `ORG-CIRC` 在父存在性判断后生效。  
- 调整 `organization_update.go`/`organization_rules.go` 中的错误处理，明确 `ORG_CYCLE_DETECTED` 的返回。  
- 更新单元测试，新增自引用、祖先循环等反向场景。  
- 如需新增错误码枚举，更新 OpenAPI、README、Implementation Inventory。

### 3.2 Z-02 组织更新 400
- 捕获 REST update 的响应 body 和服务端日志，定位是验证链错误还是仓储返回。  
- 如为验证链问题，补充字段校验或调整规则；如为仓储层，确保错误转换成统一结构。  
- 添加对应的单元/集成测试用例，保证回归。  
- 在文档中记录诊断结论与修复方案。

### 3.3 Z-03 暂停 500
- 重现 `SuspendOrganization` 的失败场景，收集 request/response 与日志。  
- 检查 timeline manager、仓储调用与错误映射，确保返回业务错误码而非 500。  
- 为暂停/激活操作补充验证链或操作前置校验，避免异常透传。  
- 更新自测脚本与报告，确认修复有效。

---

## 4. 交付物

- 修复后的代码、单元测试、集成/自测结果。  
- 更新后的自测报告或附录，说明问题诊断与结论。  
- 如有错误码或文档改动，提交对应的 README / Implementation Inventory 更新。  
- 在 219C 主计划中记录完成状态。

---

## 5. 风险与缓解

| 风险 | 影响 | 缓解 |
|------|------|------|
| 问题定位耗时 | 中 | 优先使用自测报告与日志定位，必要时报架构组协助。 |
| OpenAPI 变更审批 | 中 | 若需新增错误码，提前与安全/架构沟通，使用 219C2D 时间窗口同步提交。 |
| 复现难度高 | 中 | 编写复现脚本，使用自测脚本自动化执行并记录。 |

---

## 6. 追踪日志

- `logs/219C2/219C2B-SELF-TEST-REPORT.md` – 原始自测报告。  
- 后续若有新增日志/截图，请存放在 `logs/219C2/z-followups/` 下。

> 文档更新完成后，请在主计划与 Team 06 进展日志中同步状态。
