# 前端组织管理页面重构方案

## 重构背景

基于 Cube Castle 项目的 CQRS 架构重构，前端组织管理页面需要适配新的 API 结构，优化用户体验，并提升代码质量和维护性。

## 现状分析

### 当前实现优点
✅ **现代化技术栈**: Next.js + TypeScript + SWR + Tailwind CSS  
✅ **API 集成良好**: 已对齐后端 organization_adapter.go  
✅ **UI 组件完整**: 使用 shadcn/ui 组件系统  
✅ **错误处理**: RESTErrorBoundary 提供错误恢复  
✅ **数据获取**: SWR 实现缓存和自动重新验证  

### 主要问题
❌ **CQRS 支持不完整**: 仅使用传统 REST API，未集成 CQRS 端点  
❌ **性能优化空间**: 组织树渲染和大数据处理可优化  
❌ **交互体验**: 缺少拖拽重组、批量操作等高级功能  
❌ **移动端适配**: 组织图在移动设备上显示效果不佳  
❌ **测试覆盖**: 缺少单元测试和端到端测试  

## 重构目标

### 1. 完整 CQRS 集成
- 写操作使用 Command API (`/api/v1/commands/*`)
- 读查询使用 Query API (`/api/v1/queries/*`)
- 实现读写分离的状态管理

### 2. 性能优化
- 虚拟化大型组织树
- 智能分页和懒加载
- 组件级别的缓存策略

### 3. 用户体验增强
- 拖拽式组织架构调整
- 批量操作和权限管理
- 移动端响应式设计

### 4. 代码质量提升
- 组件解耦和复用
- 完整的 TypeScript 类型安全
- 单元测试和集成测试

## 详细重构方案

### 1. 架构重构

#### 1.1 CQRS 状态管理
```typescript
// 新增 CQRS 状态管理层
interface CQRSOrganizationState {
  // 命令状态 (写操作)
  commands: {
    creating: boolean
    updating: boolean
    deleting: boolean
    errors: Record<string, string>
  }
  
  // 查询状态 (读操作)
  queries: {
    organizations: Organization[]
    orgChart: OrganizationChartData
    stats: OrganizationStats
    loading: boolean
    lastUpdated: Date
  }
  
  // 乐观更新缓存
  optimisticUpdates: Map<string, Organization>
}
```

#### 1.2 API 层重构
```typescript
// hooks/useOrganizationCQRS.ts
export const useOrganizationCQRS = () => {
  // 命令操作 (写)
  const createOrganization = useMutation(organizationCommands.create)
  const updateOrganization = useMutation(organizationCommands.update)
  const deleteOrganization = useMutation(organizationCommands.delete)
  
  // 查询操作 (读)
  const { data: organizations } = useSWR('orgs', organizationQueries.list)
  const { data: orgChart } = useSWR('org-chart', organizationQueries.getChart)
  
  // 实时数据同步
  const { data: events } = useSSE('/api/v1/events/organizations')
  
  return {
    // 命令
    createOrganization,
    updateOrganization, 
    deleteOrganization,
    
    // 查询
    organizations,
    orgChart,
    
    // 状态
    isLoading: organizations.isLoading || orgChart.isLoading,
    error: organizations.error || orgChart.error
  }
}
```

### 2. 组件架构重构

#### 2.1 组件层次结构
```
OrganizationManagementPage
├── OrganizationHeader (统计 + 操作按钮)
├── OrganizationFilters (筛选和搜索)
├── OrganizationChart (主要内容区)
│   ├── VirtualizedOrgTree (大数据虚拟化)
│   ├── DragDropProvider (拖拽功能)
│   └── OrganizationNode (单个组织节点)
│       ├── NodeContent (节点内容)
│       ├── NodeActions (操作菜单)
│       └── NodeMetrics (指标显示)
├── OrganizationModal (创建/编辑弹窗)
└── BulkOperationsPanel (批量操作)
```

#### 2.2 核心组件重构

##### VirtualizedOrgTree (性能优化)
```typescript
// components/organization/VirtualizedOrgTree.tsx
import { FixedSizeTree as Tree } from 'react-window'

interface VirtualizedOrgTreeProps {
  nodes: OrganizationTreeNode[]
  height: number
  onNodeClick: (node: OrganizationTreeNode) => void
  onNodeExpand: (nodeId: string) => void
}

export const VirtualizedOrgTree: React.FC<VirtualizedOrgTreeProps> = ({
  nodes,
  height,
  onNodeClick,
  onNodeExpand
}) => {
  const flattenedNodes = useMemo(() => flattenTree(nodes), [nodes])
  
  const Row = ({ index, style }: { index: number, style: React.CSSProperties }) => {
    const node = flattenedNodes[index]
    return (
      <div style={style}>
        <OrganizationNode
          node={node}
          onClick={() => onNodeClick(node)}
          onExpand={() => onNodeExpand(node.id)}
        />
      </div>
    )
  }
  
  return (
    <Tree
      height={height}
      itemCount={flattenedNodes.length}
      itemSize={80}
      width="100%"
    >
      {Row}
    </Tree>
  )
}
```

##### DragDropOrganizationTree (交互增强)
```typescript
// components/organization/DragDropOrganizationTree.tsx
import { DndProvider, useDrag, useDrop } from 'react-dnd'

export const DragDropOrganizationTree: React.FC = () => {
  const [{ draggedItem }, drag] = useDrag({
    type: 'ORGANIZATION_NODE',
    collect: (monitor) => ({
      draggedItem: monitor.getItem()
    })
  })
  
  const [{ isOver }, drop] = useDrop({
    accept: 'ORGANIZATION_NODE',
    drop: (item: OrganizationDragItem, monitor) => {
      handleOrganizationMove(item.id, targetParentId)
    },
    collect: (monitor) => ({
      isOver: monitor.isOver()
    })
  })
  
  const handleOrganizationMove = async (orgId: string, newParentId: string) => {
    // 乐观更新
    optimisticallyUpdateOrgStructure(orgId, newParentId)
    
    try {
      // CQRS 命令
      await organizationCommands.updateParent({
        organizationId: orgId,
        newParentId: newParentId
      })
    } catch (error) {
      // 回滚乐观更新
      revertOptimisticUpdate(orgId)
      toast.error('组织结构调整失败')
    }
  }
  
  return (
    <DndProvider backend={HTML5Backend}>
      {/* 拖拽树组件 */}
    </DndProvider>
  )
}
```

### 3. 状态管理优化

#### 3.1 Zustand 状态存储
```typescript
// stores/organizationStore.ts
import { create } from 'zustand'
import { subscribeWithSelector } from 'zustand/middleware'

interface OrganizationStore {
  // 数据状态
  organizations: Organization[]
  orgChart: OrganizationChartData | null
  selectedOrg: Organization | null
  
  // UI 状态
  expandedNodes: Set<string>
  searchQuery: string
  filters: OrganizationFilters
  viewMode: 'tree' | 'grid' | 'list'
  
  // 操作状态
  isLoading: boolean
  optimisticUpdates: Map<string, Organization>
  
  // Actions
  setOrganizations: (orgs: Organization[]) => void
  updateOrganization: (id: string, updates: Partial<Organization>) => void
  toggleNodeExpansion: (nodeId: string) => void
  setSearchQuery: (query: string) => void
  setFilters: (filters: OrganizationFilters) => void
  
  // 乐观更新
  addOptimisticUpdate: (id: string, org: Organization) => void
  removeOptimisticUpdate: (id: string) => void
}

export const useOrganizationStore = create<OrganizationStore>()(
  subscribeWithSelector((set, get) => ({
    // 初始状态
    organizations: [],
    orgChart: null,
    selectedOrg: null,
    expandedNodes: new Set(),
    searchQuery: '',
    filters: {},
    viewMode: 'tree',
    isLoading: false,
    optimisticUpdates: new Map(),
    
    // Actions 实现
    setOrganizations: (orgs) => set({ organizations: orgs }),
    
    updateOrganization: (id, updates) => set((state) => ({
      organizations: state.organizations.map(org => 
        org.id === id ? { ...org, ...updates } : org
      )
    })),
    
    toggleNodeExpansion: (nodeId) => set((state) => {
      const newExpanded = new Set(state.expandedNodes)
      if (newExpanded.has(nodeId)) {
        newExpanded.delete(nodeId)
      } else {
        newExpanded.add(nodeId)
      }
      return { expandedNodes: newExpanded }
    }),
    
    // 乐观更新实现
    addOptimisticUpdate: (id, org) => set((state) => {
      const newUpdates = new Map(state.optimisticUpdates)
      newUpdates.set(id, org)
      return { optimisticUpdates: newUpdates }
    })
  }))
)
```

#### 3.2 实时数据同步
```typescript
// hooks/useOrganizationSync.ts
export const useOrganizationSync = () => {
  const { organizations, updateOrganization } = useOrganizationStore()
  
  // SSE 事件监听
  useEffect(() => {
    const eventSource = new EventSource('/api/v1/events/organizations')
    
    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data)
      
      switch (data.type) {
        case 'ORGANIZATION_CREATED':
          handleOrganizationCreated(data.payload)
          break
        case 'ORGANIZATION_UPDATED':
          handleOrganizationUpdated(data.payload)
          break
        case 'ORGANIZATION_DELETED':
          handleOrganizationDeleted(data.payload)
          break
      }
    }
    
    return () => eventSource.close()
  }, [])
  
  const handleOrganizationUpdated = (org: Organization) => {
    updateOrganization(org.id, org)
    toast.success(`组织"${org.name}"已更新`)
  }
}
```

### 4. 性能优化策略

#### 4.1 虚拟化渲染
- 大型组织树（>1000节点）使用 react-window
- 按需渲染可见节点
- 智能预加载相邻节点

#### 4.2 缓存策略
```typescript
// 多级缓存策略
const cacheConfig = {
  // SWR 缓存
  swr: {
    revalidateOnFocus: false,
    revalidateOnReconnect: true,
    dedupingInterval: 5000
  },
  
  // 组件级缓存
  component: {
    orgNodeMemo: React.memo,
    orgTreeCallback: useCallback,
    chartDataMemo: useMemo
  },
  
  // 状态缓存
  state: {
    persistExpandedNodes: localStorage,
    persistFilters: sessionStorage
  }
}
```

#### 4.3 懒加载
```typescript
// 按需加载组织子树
const useOrganizationSubtree = (parentId: string, enabled: boolean) => {
  return useSWR(
    enabled ? `orgs-subtree-${parentId}` : null,
    () => organizationQueries.getSubtree(parentId),
    {
      revalidateOnFocus: false,
      dedupingInterval: 10000
    }
  )
}
```

### 5. 移动端适配

#### 5.1 响应式设计
```typescript
// 移动端组织视图
const MobileOrganizationView: React.FC = () => {
  const [viewMode, setViewMode] = useState<'tree' | 'list'>('list')
  
  return (
    <div className="md:hidden">
      {/* 移动端顶部导航 */}
      <MobileHeader viewMode={viewMode} onViewModeChange={setViewMode} />
      
      {/* 条件渲染 */}
      {viewMode === 'tree' ? (
        <MobileOrganizationTree />
      ) : (
        <MobileOrganizationList />
      )}
      
      {/* 浮动操作按钮 */}
      <FloatingActionButton />
    </div>
  )
}
```

#### 5.2 手势交互
```typescript
// 手势支持
import { useSwipeable } from 'react-swipeable'

const swipeHandlers = useSwipeable({
  onSwipedLeft: () => expandNode(),
  onSwipedRight: () => collapseNode(),
  onTap: () => selectNode(),
  preventDefaultTouchmoveEvent: true,
  trackMouse: true
})
```

### 6. 测试策略

#### 6.1 单元测试
```typescript
// __tests__/OrganizationChart.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'
import { OrganizationChart } from '../OrganizationChart'

describe('OrganizationChart', () => {
  const mockOrganizations = [
    { id: '1', name: 'Root Org', unit_type: 'COMPANY', level: 0 }
  ]
  
  it('renders organization tree correctly', () => {
    render(<OrganizationChart organizations={mockOrganizations} />)
    expect(screen.getByText('Root Org')).toBeInTheDocument()
  })
  
  it('handles node expansion', async () => {
    render(<OrganizationChart organizations={mockOrganizations} />)
    const expandButton = screen.getByRole('button', { name: /expand/i })
    fireEvent.click(expandButton)
    
    // 验证展开状态
    expect(screen.getByLabelText('collapse')).toBeInTheDocument()
  })
})
```

#### 6.2 集成测试
```typescript
// e2e/organization-management.spec.ts
import { test, expect } from '@playwright/test'

test('organization CRUD operations', async ({ page }) => {
  await page.goto('/organization/chart')
  
  // 创建组织
  await page.click('[data-testid="create-org-button"]')
  await page.fill('[data-testid="org-name-input"]', 'Test Organization')
  await page.selectOption('[data-testid="org-type-select"]', 'DEPARTMENT')
  await page.click('[data-testid="submit-button"]')
  
  // 验证创建成功
  await expect(page.locator('text=Test Organization')).toBeVisible()
  
  // 编辑组织
  await page.click('[data-testid="org-action-menu-test-org-id"]')
  await page.click('[data-testid="edit-org-test-org-id"]')
  await page.fill('[data-testid="org-name-input"]', 'Updated Organization')
  await page.click('[data-testid="submit-button"]')
  
  // 验证更新成功
  await expect(page.locator('text=Updated Organization')).toBeVisible()
})
```

### 7. 部署和监控

#### 7.1 构建优化
```typescript
// next.config.js
module.exports = {
  experimental: {
    optimizeCss: true,
    bundlePagesExternals: true
  },
  
  // 代码分割
  webpack: (config) => {
    config.optimization.splitChunks = {
      chunks: 'all',
      cacheGroups: {
        organization: {
          test: /[\\/]components[\\/]organization[\\/]/,
          name: 'organization',
          priority: 10
        }
      }
    }
    return config
  }
}
```

#### 7.2 性能监控
```typescript
// 性能指标收集
const usePerformanceMetrics = () => {
  useEffect(() => {
    // 组织树渲染时间
    const startTime = performance.now()
    
    return () => {
      const endTime = performance.now()
      analytics.track('org_tree_render_time', {
        duration: endTime - startTime,
        nodeCount: organizations.length
      })
    }
  }, [organizations])
}
```

## 实施计划

### 阶段一：核心重构 (2-3周)
1. CQRS API 集成
2. 状态管理重构
3. 主要组件优化

### 阶段二：功能增强 (2-3周)
1. 拖拽功能实现
2. 虚拟化渲染
3. 批量操作

### 阶段三：体验优化 (1-2周)
1. 移动端适配
2. 性能优化
3. 错误处理增强

### 阶段四：测试和发布 (1周)
1. 完整测试覆盖
2. 性能基准测试
3. 生产环境部署

## 风险评估

### 技术风险
- **CQRS 集成复杂性**: 读写分离可能增加状态同步复杂度
- **性能优化**: 虚拟化可能影响某些交互功能
- **向后兼容**: 重构可能影响现有功能

### 缓解策略
- 分阶段迁移，保持旧 API 兼容
- 充分的测试覆盖
- 性能基准测试和监控
- 功能开关控制新特性发布

## 总结

这个重构方案将显著提升组织管理页面的性能、用户体验和维护性，同时完整支持 CQRS 架构。通过分阶段实施和充分的测试，可以确保重构的成功和系统的稳定性。