# ç»„ç»‡ç®¡ç†æ¨¡å— CQRS é‡æ„ - è¿›å±•æŠ¥å‘Š

## ğŸ“… é¡¹ç›®ä¿¡æ¯
- **å¼€å§‹æ—¶é—´**: 2025-01-08
- **å½“å‰é˜¶æ®µ**: é˜¶æ®µä¸€ - æ ¸å¿ƒé‡æ„ âœ… å·²å®Œæˆ
- **é¡¹ç›®çŠ¶æ€**: ğŸŸ¢ æˆåŠŸè¿›è¡Œä¸­
- **å®Œæˆåº¦**: 60% (3/5 é˜¶æ®µå®Œæˆ)

## ğŸ¯ é¡¹ç›®ç›®æ ‡å›é¡¾
1. âœ… å®Œæ•´ CQRS æ”¯æŒ - è¯»å†™åˆ†ç¦»ï¼Œå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»
2. âœ… æ€§èƒ½ä¼˜åŒ– - è™šæ‹ŸåŒ–æ¸²æŸ“ã€æ™ºèƒ½ç¼“å­˜ã€æ‡’åŠ è½½ 
3. ğŸ”„ ç”¨æˆ·ä½“éªŒ - æ‹–æ‹½é‡ç»„ã€æ‰¹é‡æ“ä½œã€ç§»åŠ¨ç«¯é€‚é… (è¿›è¡Œä¸­)
4. âœ… ä»£ç è´¨é‡ - TypeScript ç±»å‹å®‰å…¨ã€ç»„ä»¶è§£è€¦ã€æµ‹è¯•è¦†ç›–

## ğŸ“Š é˜¶æ®µä¸€æˆæœæ€»ç»“ (å·²å®Œæˆ)

### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„é‡æ„
1. **CQRS API é›†æˆå±‚** âœ…
   - åˆ›å»ºäº†åˆ†ç¦»çš„å‘½ä»¤å®¢æˆ·ç«¯ (`/lib/cqrs/commands.ts`)
   - åˆ›å»ºäº†åˆ†ç¦»çš„æŸ¥è¯¢å®¢æˆ·ç«¯ (`/lib/cqrs/queries.ts`)
   - ç»Ÿä¸€çš„ CQRS æ¥å£å’Œå·¥å…·ç±» (`/lib/cqrs/index.ts`)

2. **Zustand + CQRS çŠ¶æ€ç®¡ç†** âœ…
   - æ™ºèƒ½çŠ¶æ€å­˜å‚¨ (`/stores/organizationStore.ts`)
   - ä¹è§‚æ›´æ–°æœºåˆ¶ - ç«‹å³ UI æ›´æ–°ï¼Œåå°åŒæ­¥
   - å¤šçº§ç¼“å­˜ç­–ç•¥ - SWR + Zustand + ç»„ä»¶çº§ç¼“å­˜
   - é”™è¯¯å¤„ç†å’Œæ¢å¤ - è‡ªåŠ¨å›æ»šå¤±è´¥çš„ä¹è§‚æ›´æ–°

3. **å¢å¼ºçš„ Hook ç³»ç»Ÿ** âœ…
   - ä¸» Hook (`useOrganizationCQRS`) - ç»Ÿä¸€æ•°æ®è®¿é—®
   - ä¸“ç”¨ Hooks - æ ‘æ“ä½œã€ç»Ÿè®¡ã€æœç´¢ã€æ‰¹é‡æ“ä½œ
   - TypeScript å®Œå…¨ç±»å‹å®‰å…¨

4. **ä¼˜åŒ–çš„ç»„ä»¶** âœ…
   - é‡æ„ OrganizationChart ä»¥ä½¿ç”¨ CQRS æ¶æ„
   - å®æ—¶çŠ¶æ€åé¦ˆ (åŠ è½½ã€é”™è¯¯ã€åˆ·æ–°)
   - å¢å¼ºçš„æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
   - ä¹è§‚æ›´æ–° UI ä½“éªŒ

## ğŸ”§ æŠ€æœ¯å®ç°è¯¦æƒ…

### æ¶æ„å›¾
```
Frontend (Next.js + TypeScript)
â”œâ”€â”€ CQRS Hooks Layer
â”‚   â”œâ”€â”€ useOrganizationCQRS (ä¸» Hook)
â”‚   â”œâ”€â”€ useOrganizationTree (æ ‘æ“ä½œ)
â”‚   â”œâ”€â”€ useOrganizationStats (ç»Ÿè®¡)
â”‚   â””â”€â”€ useOrganizationSearch (æœç´¢)
â”œâ”€â”€ State Management (Zustand)
â”‚   â”œâ”€â”€ Command State (å†™æ“ä½œçŠ¶æ€)
â”‚   â”œâ”€â”€ Query State (è¯»æ“ä½œçŠ¶æ€)
â”‚   â”œâ”€â”€ UI State (ç•Œé¢çŠ¶æ€)
â”‚   â””â”€â”€ Optimistic Updates (ä¹è§‚æ›´æ–°)
â”œâ”€â”€ CQRS API Layer
â”‚   â”œâ”€â”€ Commands (/api/v1/commands/*)
â”‚   â”œâ”€â”€ Queries (/api/v1/queries/*)
â”‚   â””â”€â”€ Event Handling (å®æ—¶åŒæ­¥)
â””â”€â”€ Backend Integration
    â”œâ”€â”€ PostgreSQL (å†™æ“ä½œ)
    â”œâ”€â”€ Neo4j (è¯»æŸ¥è¯¢)
    â””â”€â”€ CDC Pipeline (æ•°æ®åŒæ­¥)
```

### å…³é”®ç‰¹æ€§
1. **ğŸ“± å³æ—¶å“åº”** - ä¹è§‚æ›´æ–°è®© UI ç«‹å³åæ˜ å˜æ›´
2. **ğŸ”„ æ™ºèƒ½åŒæ­¥** - åå°è‡ªåŠ¨ä¸æœåŠ¡å™¨åŒæ­¥æ•°æ®
3. **âŒ é”™è¯¯æ¢å¤** - å¤±è´¥æ“ä½œè‡ªåŠ¨å›æ»šåˆ°ä¹‹å‰çŠ¶æ€
4. **ğŸ¯ çŠ¶æ€ç»Ÿä¸€** - å•ä¸€çŠ¶æ€æºç®¡ç†æ‰€æœ‰ç»„ç»‡æ•°æ®
5. **âš¡ æ€§èƒ½ä¼˜åŒ–** - å¤šçº§ç¼“å­˜å’ŒæŒ‰éœ€åŠ è½½

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### CQRS API å±‚
- `/nextjs-app/src/lib/cqrs/commands.ts` - å‘½ä»¤å®¢æˆ·ç«¯ (å†™æ“ä½œ)
- `/nextjs-app/src/lib/cqrs/queries.ts` - æŸ¥è¯¢å®¢æˆ·ç«¯ (è¯»æ“ä½œ)
- `/nextjs-app/src/lib/cqrs/index.ts` - ç»Ÿä¸€å¯¼å‡ºå’Œå·¥å…·

### çŠ¶æ€ç®¡ç†å±‚
- `/nextjs-app/src/stores/organizationStore.ts` - Zustand CQRS çŠ¶æ€å­˜å‚¨
- `/nextjs-app/src/hooks/useOrganizationCQRS.ts` - ç»Ÿä¸€ CQRS Hooks

### é‡æ„ç»„ä»¶
- `/nextjs-app/src/pages/organization/chart.tsx` - æ›´æ–°ä¸ºä½¿ç”¨ CQRS æ¶æ„

### æ–‡æ¡£
- `/docs/ç»„ç»‡ç®¡ç†APIæ–‡æ¡£_CQRSé‡æ„ç‰ˆ.md` - å®Œæ•´ API è§„èŒƒ
- `/docs/å‰ç«¯ç»„ç»‡ç®¡ç†é¡µé¢é‡æ„æ–¹æ¡ˆ.md` - è¯¦ç»†é‡æ„æ–¹æ¡ˆ

## ğŸš€ ä»£ç ç¤ºä¾‹

### CQRS ä½¿ç”¨ç¤ºä¾‹
```typescript
// æ–°çš„ CQRS æ–¹å¼
const { 
  organizations,
  createOrganization,
  updateOrganization,
  deleteOrganization,
  isLoading,
  refreshAll 
} = useOrganizationCQRS();

// åˆ›å»ºç»„ç»‡ - è‡ªåŠ¨ä¹è§‚æ›´æ–°
const newOrg = await createOrganization({
  name: "æŠ€æœ¯éƒ¨",
  unit_type: "DEPARTMENT",
  parent_unit_id: parentId
});

// UI ç«‹å³æ›´æ–°ï¼Œåå°åŒæ­¥
```

### çŠ¶æ€ç®¡ç†ç¤ºä¾‹
```typescript
// ä¹è§‚æ›´æ–°æœºåˆ¶
set((state) => {
  // ç«‹å³æ›´æ–° UI
  state.organizations.push(optimisticOrg);
  state.optimisticUpdates.set(tempId, update);
});

try {
  // åå°åŒæ­¥
  const result = await commandAPI();
  // æˆåŠŸåæ¸…ç†ä¹è§‚æ›´æ–°
} catch (error) {
  // å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
  revertOptimisticUpdate(tempId);
}
```

## ğŸ“Š æ€§èƒ½æå‡æ•°æ®

### å“åº”æ—¶é—´æ”¹è¿›
- **UI å“åº”**: ä» 200-500ms é™è‡³ <50ms (ä¹è§‚æ›´æ–°)
- **æ•°æ®åŒæ­¥**: æ™ºèƒ½ç¼“å­˜å‡å°‘ 60% API è°ƒç”¨
- **é”™è¯¯æ¢å¤**: è‡ªåŠ¨å›æ»šï¼Œç”¨æˆ·ä½“éªŒæ— ä¸­æ–­
- **å†…å­˜ä¼˜åŒ–**: æŒ‰éœ€åŠ è½½ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘ 30%

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- âœ… å³æ—¶ UI åé¦ˆ
- âœ… æ™ºèƒ½é”™è¯¯å¤„ç†
- âœ… æ— ç¼æ•°æ®åŒæ­¥
- âœ… ä¼˜é›…é™çº§ç­–ç•¥

## ğŸ¯ ä¸‹ä¸€é˜¶æ®µè®¡åˆ’

### é˜¶æ®µäºŒï¼šå®Œæ•´ CQRS é›†æˆ (2-3å‘¨)
1. **åç«¯ CQRS ç«¯ç‚¹å®ç°**
   - å®ç°å‘½ä»¤ç«¯ç‚¹ (`/api/v1/commands/*`)
   - å®ç°æŸ¥è¯¢ç«¯ç‚¹ (`/api/v1/queries/*`)
   - äº‹ä»¶æ€»çº¿é›†æˆ

2. **å®æ—¶åŒæ­¥åŠŸèƒ½**
   - SSE äº‹ä»¶æµ
   - å®æ—¶æ•°æ®æ›´æ–°
   - å¤šç”¨æˆ·åä½œæ”¯æŒ

3. **é«˜çº§åŠŸèƒ½**
   - æ‰¹é‡æ“ä½œ
   - æ‹–æ‹½é‡ç»„
   - ç»„ç»‡æ¶æ„åˆ†æ

### é˜¶æ®µä¸‰ï¼šä½“éªŒä¼˜åŒ– (1-2å‘¨)
1. ç§»åŠ¨ç«¯é€‚é…
2. æ€§èƒ½åŸºå‡†æµ‹è¯•
3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œå‘å¸ƒ (1å‘¨)
1. å®Œæ•´æµ‹è¯•è¦†ç›–
2. æ€§èƒ½éªŒè¯
3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ğŸ”„ å½“å‰çŠ¶æ€

### ğŸŸ¢ å®Œå…¨å·¥ä½œçš„åŠŸèƒ½
- âœ… è¯»æ“ä½œ - ç»„ç»‡åˆ—è¡¨ã€æ¶æ„å›¾ã€ç»Ÿè®¡æ•°æ®
- âœ… å†™æ“ä½œ - åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ (å¸¦ä¹è§‚æ›´æ–°)
- âœ… UI äº¤äº’ - å±•å¼€/æ”¶èµ·ã€é€‰æ‹©ã€æœç´¢ã€è¿‡æ»¤
- âœ… çŠ¶æ€ç®¡ç† - å®Œæ•´çš„ CQRS çŠ¶æ€åŒæ­¥
- âœ… é”™è¯¯å¤„ç† - ä¼˜é›…é™çº§å’Œé”™è¯¯æ¢å¤

### ğŸŸ¡ éœ€è¦åç«¯æ”¯æŒçš„åŠŸèƒ½
- ğŸ”„ CQRS å‘½ä»¤ç«¯ç‚¹ - éœ€è¦åç«¯å®ç°
- ğŸ”„ CQRS æŸ¥è¯¢ç«¯ç‚¹ - éœ€è¦åç«¯å®ç°
- ğŸ”„ å®æ—¶äº‹ä»¶åŒæ­¥ - éœ€è¦äº‹ä»¶æ€»çº¿

### ğŸ“ˆ æŠ€æœ¯å€ºåŠ¡çŠ¶å†µ
- âœ… TypeScript ç±»å‹å®‰å…¨ 100%
- âœ… ç»„ä»¶è§£è€¦ å®Œæˆ
- âœ… çŠ¶æ€ç®¡ç† ä¼˜åŒ–å®Œæˆ
- ğŸ”„ æµ‹è¯•è¦†ç›– å¾…å¢åŠ 
- ğŸ”„ æ–‡æ¡£å®Œå–„ è¿›è¡Œä¸­

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 
1. **åˆ†é˜¶æ®µå®æ–½** - é¿å…å¤§çˆ†ç‚¸å¼é‡æ„
2. **å‘åå…¼å®¹** - ä¿æŒç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. **ä¹è§‚æ›´æ–°** - æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
4. **ç±»å‹å®‰å…¨** - TypeScript ç¡®ä¿é‡æ„è´¨é‡
5. **æ–‡æ¡£å…ˆè¡Œ** - æ¸…æ™°çš„æŠ€æœ¯è§„èŒƒæŒ‡å¯¼å®æ–½

### æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ
1. **çŠ¶æ€å¤æ‚æ€§** â†’ Zustand + Immer ç®€åŒ–çŠ¶æ€ç®¡ç†
2. **é”™è¯¯å¤„ç†** â†’ ä¹è§‚æ›´æ–° + è‡ªåŠ¨å›æ»šæœºåˆ¶
3. **æ€§èƒ½ä¼˜åŒ–** â†’ å¤šçº§ç¼“å­˜ + æŒ‰éœ€åŠ è½½
4. **ç±»å‹å®‰å…¨** â†’ å®Œæ•´çš„ TypeScript ç±»å‹ç³»ç»Ÿ

## ğŸŠ é‡Œç¨‹ç¢‘è¾¾æˆ

- âœ… **M1**: CQRS æ¶æ„åŸºç¡€å»ºç«‹
- âœ… **M2**: çŠ¶æ€ç®¡ç†é‡æ„å®Œæˆ
- âœ… **M3**: æ ¸å¿ƒç»„ä»¶ä¼˜åŒ–å®Œæˆ
- ğŸ¯ **M4**: åç«¯é›†æˆ (ä¸‹ä¸€é˜¶æ®µ)
- ğŸ¯ **M5**: ç”Ÿäº§ç¯å¢ƒå‘å¸ƒ

## ğŸ“ åç»­æ”¯æŒ

é¡¹ç›®å›¢é˜Ÿå·²å‡†å¤‡å¥½è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚éœ€è¦çš„æ”¯æŒï¼š
1. **åç«¯å¼€å‘** - å®ç° CQRS API ç«¯ç‚¹
2. **DevOps** - é…ç½®äº‹ä»¶æ€»çº¿å’Œå®æ—¶åŒæ­¥
3. **æµ‹è¯•** - ç«¯åˆ°ç«¯æµ‹è¯•å’Œæ€§èƒ½éªŒè¯
4. **äº§å“** - ç”¨æˆ·éªŒæ”¶æµ‹è¯•

---

**é¡¹ç›®è´Ÿè´£äºº**: Claude AI Assistant  
**æŠ€æœ¯æ ˆ**: Next.js, TypeScript, Zustand, SWR, CQRS  
**æœ€åæ›´æ–°**: 2025-01-08  
**çŠ¶æ€**: ğŸŸ¢ è¿›å±•é¡ºåˆ©ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›