# Organization Units Management GraphQL Schema
# Version: 4.6.0
# Architecture: CQRS Query Layer (Read Operations Only)
# Data Source: PostgreSQL with temporal data support
# Authentication: OAuth 2.0 Bearer Token required
#
# Features:
# - Temporal data queries with asOfDate parameter
# - 17-level hierarchy depth support with intelligent caching
# - Precise audit trail tracking individual temporal versions (record_id)
# - Multi-tenant isolation and security
# - Index-optimized for common filters and access patterns
#
# Permission Requirements:
# - organizations, organization: org:read
# - organizationAtDate, organizationHistory, organizationVersions: org:read:history  
# - organizationHierarchy, organizationSubtree: org:read:hierarchy
# - organizationStats: org:read:stats
# - auditHistory: org:read:audit
#
# Recent Changes (v4.6.0):
# - BREAKING: Audit system redesigned for precise record_id tracking
# - Removed organizationAuditHistory query (replaced with auditHistory)
# - AuditLogDetail now tracks specific temporal versions via recordId field only
# - Simplified audit queries: single auditHistory(recordId) for precise tracking
# - Removed businessEntityId field from AuditLogDetail (replaced by recordId)
# - Enhanced audit precision: each temporal version has independent audit lifecycle

"""
Root Query type providing all organization management query operations.
All queries require appropriate OAuth 2.0 permissions and support multi-tenant isolation.
"""
type Query {
  # Basic Organization Queries
  
  """
  Get paginated list of organization units with advanced filtering and temporal support.
  
  Permissions Required: org:read
  Performance: Optimized with specialized indexes, typical response < 50ms
  """
  organizations(
    filter: OrganizationFilter
    pagination: PaginationInput
  ): OrganizationConnection!
  
  """
  Get single organization unit by business code with temporal support.
  
  Permissions Required: org:read
  Performance: Index-optimized single record retrieval < 10ms
  """
  organization(
    code: String!
    asOfDate: String
  ): Organization
  
  """
  Get comprehensive organization statistics with temporal breakdown.
  
  Permissions Required: org:read:stats
  Performance: Cached aggregation queries < 100ms
  """
  organizationStats(
    asOfDate: String
    includeHistorical: Boolean = false
  ): OrganizationStats!
  
  # Advanced Hierarchy Queries
  
  """
  Get complete hierarchy information for an organization including paths and relationships.
  
  Permissions Required: org:read:hierarchy
  Performance: Path-optimized queries with hierarchy cache < 30ms
  """
  organizationHierarchy(
    code: String!
    tenantId: String!
  ): OrganizationHierarchy
  
  """
  Get organization subtree with configurable depth limits and relationship details.
  Use this for multi-level hierarchy display (depth >= 2).
  For direct children only, use organizations(filter: {parentCode: "code"}) instead.
  
  Permissions Required: org:read:hierarchy
  Performance: Recursive CTE queries, optimized for display < 200ms
  """
  organizationSubtree(
    code: String!
    tenantId: String!
    maxDepth: Int = 10
    includeInactive: Boolean = false
  ): [OrganizationHierarchy!]!
  
  """
  Get hierarchy distribution statistics and integrity analysis.
  
  Permissions Required: org:read:hierarchy
  Performance: Aggregation with hierarchy statistics < 150ms
  """
  hierarchyStatistics(
    tenantId: String!
    includeIntegrityCheck: Boolean = false
  ): HierarchyStatistics!
  
  # Audit and Analysis Queries
  
  """
  Get complete audit history for a specific organization record (temporal version).
  This query returns audit records for a specific record_id, allowing precise tracking
  of individual temporal version lifecycle changes.
  
  Permissions Required: org:read:audit
  Performance: Record-specific audit queries with optimized indexing < 50ms
  """
  auditHistory(
    recordId: String!
    startDate: String
    endDate: String
    operation: OperationType
    userId: String
    limit: Int = 50
  ): [AuditLogDetail!]!
  
  """
  Get detailed audit record with before/after data snapshots and field-level changes.
  
  Permissions Required: org:read:audit
  Performance: Single audit record retrieval < 20ms
  """
  auditLog(
    auditId: String!
  ): AuditLogDetail

  """
  Return all temporal versions for an organization code (ascending by effectiveDate).
  Requires scope: org:read:history
  """
  organizationVersions(
    code: String!
    includeDeleted: Boolean
  ): [Organization!]!


  # System Maintenance and Monitoring

# Hierarchy consistency check temporarily removed for startup
}

# Core Data Types

"""
Organization unit entity with complete temporal and audit information.
Represents the current state based on asOfDate parameter or latest effective record.
"""
type Organization {
  # Business Identifiers
  code: String!
  parentCode: String!  # Parent organization code. Use "0" for root organizations, or valid 7-digit code for child organizations
  tenantId: String!
  
  # Basic Information
  name: String!
  unitType: UnitType!
  # Business status (one-dimensional): ACTIVE | INACTIVE
  # Note: No lifecycle status is exposed. "planned"/"historical" are derived via
  # asOf-based computation: isCurrent/isFuture fields below.
  # ADR-008: 一维业务状态模型，INACTIVE等价于停用/暂停语义
  status: Status!
  
  # Hierarchy Information
  level: Int!
  sortOrder: Int
  
  # Configuration
  description: String
  profile: String
  
  # Temporal Information
  # Notes:
  # - isTemporal is a derived concept (NOT a stored column): endDate != null
  # - isFuture is derived using Beijing business day (UTC+8): effectiveDate > today(CN)
  effectiveDate: String!
  endDate: String
  
  # Audit Information
  createdAt: String!
  updatedAt: String!
  recordId: String!
  
  # Temporal Status Information (derived)
  # Derived using Beijing time (UTC+8): effectiveDate > today(CN)
  isFuture: Boolean!
  hierarchyDepth: Int!
}

"""
Connection type for paginated organization results with metadata.
"""
type OrganizationConnection {
  data: [Organization!]!
  pagination: PaginationInfo!
  temporal: TemporalInfo!
}

"""
Hierarchy-specific organization information with relationship context.
"""
type OrganizationHierarchy {
  code: String!
  name: String!
  level: Int!
  hierarchyDepth: Int!
  codePath: String!
  namePath: String!
  parentChain: [String!]!
  childrenCount: Int!
  isRoot: Boolean!
  isLeaf: Boolean!
  children: [OrganizationHierarchy!]!
}

"""
Comprehensive organization statistics with temporal breakdown.
"""
type OrganizationStats {
  totalCount: Int!
  activeCount: Int!
  inactiveCount: Int!
  plannedCount: Int!
  deletedCount: Int!
  byType: [TypeStatistic!]!
  byStatus: [StatusStatistic!]!
  byLevel: [LevelStatistic!]!
  temporalStats: TemporalStatistics!
}

"""
Hierarchy distribution statistics and integrity analysis.
"""
type HierarchyStatistics {
  tenantId: String!
  totalOrganizations: Int!
  maxDepth: Int!
  avgDepth: Float!
  depthDistribution: [DepthDistribution!]!
  rootOrganizations: Int!
  leafOrganizations: Int!
  integrityIssues: [IntegrityIssue!]!
  lastAnalyzed: String!
}


"""
Comprehensive audit log entry with complete change tracking information.
Each audit record tracks changes to a specific organization temporal version (record_id).
"""
type AuditLogDetail {
  auditId: String!
  recordId: String!                  # Specific organization temporal version being audited
  operation: String!
  timestamp: String!
  operationReason: String

  # Change tracking data
  beforeData: String                 # Organization state before the change (JSON string)
  afterData: String                  # Organization state after the change (JSON string)
  modifiedFields: [String!]!         # List of field names that were modified
  changes: [FieldChange!]!           # Detailed field-level changes
}

"""
Detailed field-level change information for audit tracking.
"""
type FieldChange {
  field: String!                     # Name of the changed field
  oldValue: String                   # Previous value as string (null for CREATE operations)
  newValue: String                   # New value as string (null for DELETE operations)
  dataType: String!                  # Data type of the field (string, int, date, boolean, etc.)
}


"""
Hierarchy consistency check report with detailed findings and repair suggestions.
"""
type HierarchyConsistencyReport {
  checkId: String!
  tenantId: String!
  executedAt: DateTime!
  executionTimeMs: Int!
  totalChecked: Int!
  issuesFound: Int!
  checkMode: ConsistencyCheckMode!
  consistencyReport: ConsistencyFindings!
  repairSuggestions: [RepairSuggestion!]!
  healthScore: Float!
  recommendedActions: [String!]!
}

# Supporting Types

"""
Standard operator information with ID and display name.
"""
type OperatedBy {
  id: String!
  name: String!
}

"""
Pagination information for connection types.
"""
type PaginationInfo {
  total: Int!
  page: Int!
  pageSize: Int!
  hasNext: Boolean!
  hasPrevious: Boolean!
}

"""
Temporal context information for queries.
"""
type TemporalInfo {
  asOfDate: String!
  currentCount: Int!
  futureCount: Int!
  historicalCount: Int!
}

"""
Statistics by organization unit type.
"""
type TypeStatistic {
  unitType: UnitType!
  count: Int!
}

"""
Statistics by organization status.
"""
type StatusStatistic {
  status: Status!
  count: Int!
}

"""
Statistics by hierarchy level.
"""
type LevelStatistic {
  level: Int!
  count: Int!
}

"""
Temporal statistics breakdown.
"""
type TemporalStatistics {
  totalVersions: Int!
  averageVersionsPerOrg: Float!
  oldestEffectiveDate: String!
  newestEffectiveDate: String!
}

"""
Hierarchy depth distribution analysis.
"""
type DepthDistribution {
  depth: Int!
  count: Int!
}

"""
Hierarchy integrity issue detection.
"""
type IntegrityIssue {
  type: String!
  count: Int!
  affectedCodes: [String!]!
}


"""
User information for audit trails.
"""
type UserInfo {
  userId: String!
  userName: String!
  role: String
}


"""
Simplified data changes with before/after comparison.
"""
type DataChanges {
  beforeData: JSON
  afterData: JSON
  modifiedFields: [String!]!
}







"""
Date range specification.
"""
type DateRange {
  earliest: DateTime!
  latest: DateTime!
}

"""
Operations summary statistics.
"""
type OperationsSummary {
  create: Int!
  update: Int!
  suspend: Int!
  reactivate: Int!
  delete: Int!
}

"""
Consistency check findings with detailed issues.
"""
type ConsistencyFindings {
  pathMismatches: [PathMismatch!]!
  levelInconsistencies: [LevelInconsistency!]!
  orphanedNodes: [OrphanedNode!]!
  circularReferences: [CircularReference!]!
  depthViolations: [DepthViolation!]!
  cacheInconsistencies: [CacheInconsistency!]!
}

"""
Path mismatch detection result.
"""
type PathMismatch {
  code: String!
  expectedCodePath: String!
  actualCodePath: String!
  expectedNamePath: String!
  actualNamePath: String!
  severity: String!
}

"""
Level inconsistency detection result.
"""
type LevelInconsistency {
  code: String!
  expectedLevel: Int!
  actualLevel: Int!
  parentCode: String!
  reason: String!
}

"""
Orphaned node detection result.
"""
type OrphanedNode {
  code: String!
  name: String!
  parentCode: String!
  reason: String!
}

"""
Circular reference detection result.
"""
type CircularReference {
  affectedCodes: [String!]!
  circularPath: [String!]!
  severity: String!
}

"""
Depth violation detection result.
"""
type DepthViolation {
  code: String!
  currentDepth: Int!
  maxAllowedDepth: Int!
  parentChain: [String!]!
}

"""
Cache inconsistency detection result.
"""
type CacheInconsistency {
  code: String!
  fieldName: String!
  cachedValue: String!
  calculatedValue: String!
  impactLevel: String!
}

"""
Repair suggestion with automation capability.
"""
type RepairSuggestion {
  issueType: String!
  affectedCodes: [String!]!
  suggestedAction: String!
  automatable: Boolean!
  riskLevel: String!
}

# Input Types

"""
Comprehensive filter for organization queries with temporal support.
"""
input OrganizationFilter {
  # Temporal Filtering
  asOfDate: String
  includeFuture: Boolean = false
  onlyFuture: Boolean = false
  
  # Business Filtering
  unitType: UnitType
  status: Status
  parentCode: String
  codes: [String!]
  excludeCodes: [String!]
  excludeDescendantsOf: String
  
  # Hierarchy Filtering
  level: Int
  minLevel: Int
  maxLevel: Int
  rootsOnly: Boolean = false
  leavesOnly: Boolean = false
  
  # Text Search
  searchText: String
  searchFields: [SearchField!] = [NAME, DESCRIPTION]
  
  # Advanced Filtering
  hasChildren: Boolean
  hasProfile: Boolean
  profileContains: JSON
  
  # Audit Filtering
  operationType: OperationType
  operatedBy: String
  operationDateRange: DateRangeInput
}

"""
Pagination configuration for result sets.
"""
input PaginationInput {
  page: Int = 1
  pageSize: Int = 50  # Max 1000
  sortBy: String = "code"
  sortOrder: String = "asc"
}

"""
Date range input for filtering.
"""
input DateRangeInput {
  from: String
  to: String
}

# Enums

"""
Organization unit types with specific business semantics.
"""
enum UnitType {
  DEPARTMENT      # Regular business department
  ORGANIZATION_UNIT  # Generic organizational unit
  COMPANY        # Legal entity company
  PROJECT_TEAM   # Temporary project team
}

"""
Organization business status (ADR-008: 一维业务状态模型).
"""
enum Status {
  ACTIVE         # Actively operating unit
  INACTIVE       # Non-active but existing unit (等价于停用/暂停)
  PLANNED        # Planned unit (未来计划单位)
  DELETED        # Deleted unit (已删除单位)
}

"""
Operation types for audit and temporal tracking.
"""
enum OperationType {
  CREATE         # New organization creation
  UPDATE         # Data modification (PUT/PATCH)  
  SUSPEND        # Suspension operation (endpoint: POST /suspend)
  REACTIVATE     # Reactivation operation (endpoint: POST /activate)
  DELETE         # Deletion operation
  
  # ADR-008注释：REACTIVATE作为操作类型保持审计语义精确性
  # 对应端点为/activate（用户友好），这是领域概念与HTTP路径的合理分离
}


"""
Consistency check modes with different performance characteristics.
"""
enum ConsistencyCheckMode {
  FAST          # Cache field consistency only (< 5s)
  DEEP          # Full recursive validation (30s-5min)
  TARGETED      # Specific area focus (< 30s)
}

"""
Search fields for text-based filtering.
"""
enum SearchField {
  NAME
  DESCRIPTION
  CODE_PATH
  NAME_PATH
}

"""
Sorting field options.
"""
enum SortField {
  CODE
  NAME
  CREATED_AT
  UPDATED_AT
  EFFECTIVE_DATE
  LEVEL
  SORT_ORDER
}

"""
Sorting order options.
"""
enum SortOrder {
  ASC
  DESC
}

# Scalar Types

"""
Date scalar for date-only values (YYYY-MM-DD format).
"""
scalar Date

"""
DateTime scalar for timestamp values (ISO 8601 format).
"""
scalar DateTime

"""
UUID scalar for universally unique identifiers.
"""
scalar UUID

"""
JSON scalar for arbitrary JSON data structures.
"""
scalar JSON

# Schema Directives and Documentation

"""
This schema represents the complete query interface for the Organization Units Management system.
It follows GraphQL best practices and provides comprehensive temporal data access with
performance optimization through specialized PostgreSQL indexes.

Key Features:
- Temporal queries with asOfDate parameter for historical data access
- Comprehensive hierarchy management with 17-level depth support
- Complete audit trail with essential change analysis (v4.3.0 simplified)
- Performance-optimized with response times < 200ms for most queries
- Multi-tenant security with permission-based access control

Design Principles (v4.4.0):
- API-first development: remove unused/over-engineered endpoints
- Focus on essential audit information for practical decision-making
- Maintain small, focused API surface area for better maintainability

Authentication:
All queries require OAuth 2.0 Bearer token with appropriate permissions.
Refer to the API documentation for detailed permission requirements.

Performance Guidelines:
- Use pagination for large result sets (default pageSize: 50, max: 1000)
- Leverage temporal filtering to reduce query scope
- Use specific field selection to minimize response payload
- Consider using organizationSubtree only for multi-level hierarchies (depth >= 2)
"""

# Schema Metadata
schema {
  query: Query
}
