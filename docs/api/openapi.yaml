openapi: 3.0.3
info:
  title: Organization Units Management API
  description: |
    Enterprise-grade organization units management API with strict CQRS architecture.
    
    **Architecture Features:**
    - **Command Operations**: REST API (Port 9090) - All data modifications
    - **Query Operations**: GraphQL (Port 8090) - All data retrieval
    - **Single Data Source**: PostgreSQL with temporal data support
    - **Authentication**: OAuth 2.0 Client Credentials Flow
    - **Authorization**: Permission-Based Access Control (PBAC) with 19 fine-grained permissions
    - **Multi-Tenant Security**: Mandatory X-Tenant-ID header for data isolation
    
    **Key Capabilities:**
    - 17-level hierarchy depth support
    - Temporal data management with effective/end dates
    - Intelligent cascade updates for hierarchy changes
    - Comprehensive audit trail with operation history
    - Multi-tenant isolation and security
    
    **Multi-Tenant Usage Guide:**
    - **MANDATORY Header**: All API requests MUST include `X-Tenant-ID` header
    - **UUID Format**: Tenant ID must be a valid UUID v4 format
    - **Data Isolation**: Each tenant's data is completely isolated from others
    - **Security Risk**: Missing tenant header may result in default tenant access
    - **Example**: `X-Tenant-ID: 987fcdeb-51a2-43d7-8f9e-123456789012`
    
    **Business Operation Types:**
    - **SUSPEND**: 因业务调整而暂时停用部门，支持后续重新启用，用于组织架构临时调整
    - **REACTIVATE**: 重新启用已停用的组织（对应端点 POST /api/v1/organization-units/{code}/activate）
    - **DEACTIVATE**: 停用特定版本记录，用于时态数据纠错（通过 /events 端点）
    
    **Permission System:**
    - **Basic CRUD**: org:read, org:create, org:update
    - **State Management**: org:suspend, org:activate
    - **Hierarchy Operations**: org:read:hierarchy, org:move, org:create:child
    - **Temporal Data**: org:read:history, org:read:future, org:create:planned, org:modify:history, org:cancel:planned
    - **Audit & Analytics**: org:read:audit, org:read:stats, org:read:timeline
    - **System Management**: org:validate, org:maintenance, org:batch-operations
    
    **Response Format**: All endpoints use unified enterprise envelope structure
    with `success`, `data`, `message`, `timestamp`, and `requestId` fields.
  version: 4.7.0
  contact:
    name: System Architecture Team
    email: api-support@yourcompany.com
  license:
    name: Proprietary
    url: https://yourcompany.com/license

servers:
  - url: http://localhost:9090
    description: Development - Command Service (REST API)
  - url: https://api.yourcompany.com
    description: Production - Command Service (REST API)

security:
  - OAuth2ClientCredentials: []

tags:
  - name: organization-units
    description: Standard CRUD operations for organization units
  - name: business-operations
    description: Specialized business operations (suspend/activate)
  - name: data-validation
    description: Data validation and business rule checking
  - name: maintenance
    description: System maintenance and hierarchy management tools
  - name: corehr-compatibility
    description: CoreHR system compatibility endpoints
  - name: auth
    description: Authentication and session management (BFF for frontend)
  - name: operational
    description: System operational monitoring and scheduler management
  - name: temporal-operations
    description: Temporal timeline governance and lifecycle event processing endpoints
  - name: positions
    description: Position management and lifecycle operations
  - name: job-catalog
    description: Job catalog maintenance and synchronization endpoints

paths:
  /api/v1/operational/health:
    get:
      operationId: getOperationalHealth
      tags: [operational]
      summary: Get system health overview (per-tenant by default)
      description: |
        Returns health score, status, summary counts and issue counters for the current tenant.
        Platform admin with proper scopes may request global scope via future extension.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:monitor:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                health:
                  value:
                    success: true
                    message: 'Health check completed successfully'
                    timestamp: '2025-09-15T10:00:00Z'
                    requestId: 'req_operational_health_001'
                    data:
                      status: 'HEALTHY'
                      healthScore: 96.5
                      summary:
                        totalOrganizations: 125
                        currentRecords: 125
                        futureRecords: 4
                        historicalRecords: 39
                      issues:
                        duplicateCurrentCount: 0
                        missingCurrentCount: 0
                        timelineOverlapCount: 0
                        inconsistentFlagCount: 1
                        orphanRecordCount: 0
                      lastCheckTime: '2025-09-15T09:59:30Z'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/metrics:
    get:
      operationId: getOperationalMetrics
      tags: [operational]
      summary: Get detailed monitoring metrics (per-tenant)
      description: Returns full MonitoringMetrics fields in data.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:monitor:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/alerts:
    get:
      operationId: getOperationalAlerts
      tags: [operational]
      summary: Get current alerts
      description: Returns current alert list and count based on thresholds.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:monitor:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/rate-limit/stats:
    get:
      operationId: getRateLimitStats
      tags: [operational]
      summary: Get rate limit statistics
      description: Returns total/blocked requests, active clients and block rate.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:monitor:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/tasks:
    get:
      operationId: getOperationalTasks
      tags: [operational]
      summary: List scheduled operational tasks
      description: Returns all configured operational tasks with cron schedule, last run metadata, and enablement status for operational dashboards.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:ops:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/tasks/status:
    get:
      operationId: getOperationalTasksStatus
      tags: [operational]
      summary: Get scheduler status and task summary
      description: Provides scheduler heartbeat information plus aggregated counts of pending, running, and failed tasks to support operational readiness checks.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:ops:read']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/tasks/{taskName}/trigger:
    post:
      operationId: triggerOperationalTask
      tags: [operational]
      summary: Trigger an operational task by name
      description: Immediately enqueues the specified operational task for execution, bypassing its cron schedule while preserving idempotency safeguards.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: taskName
          in: path
          required: true
          schema:
            type: string
          description: Task name to trigger
      security:
        - OAuth2ClientCredentials: ['system:ops:write']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/cutover:
    post:
      operationId: triggerCutover
      tags: [operational]
      summary: Trigger daily cutover immediately
      description: Forces the nightly temporal cutover workflow to run on demand, recomputing hierarchy snapshots and cache materializations for the tenant.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:ops:write']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/v1/operational/consistency-check:
    post:
      operationId: triggerConsistencyCheck
      tags: [operational]
      summary: Trigger data consistency check
      description: Launches the full consistency validation job that compares command and query projections, emitting a report to the audit log stream.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - OAuth2ClientCredentials: ['system:ops:write']
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /auth/login:
    get:
      operationId: authLogin
      tags: [auth]
      summary: Start OIDC login (redirect)
      description: Redirects to the IdP authorization endpoint with PKCE.
      parameters:
        - in: query
          name: redirect
          schema:
            type: string
          description: Client return path after successful login
      responses:
        '302':
          description: Redirect to IdP authorization endpoint

  /auth/callback:
    get:
      operationId: authCallback
      tags: [auth]
      summary: OIDC callback endpoint
      description: Handles IdP callback, exchanges code for tokens, creates server-side session.
      parameters:
        - in: query
          name: code
          required: true
          schema: { type: string }
        - in: query
          name: state
          required: true
          schema: { type: string }
      responses:
        '302':
          description: Redirect to client redirect url with HttpOnly session cookie set

  /auth/session:
    get:
      operationId: getAuthSession
      tags: [auth]
      summary: Get current session & short-lived access token
      description: Returns a fresh short-lived access token and session info bound to HttpOnly cookie.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                session:
                  summary: Session detail
                  value:
                    success: true
                    message: "Session active"
                    data:
                      accessToken: "eyJhbGciOi..."
                      expiresIn: 600
                      tenantId: "3b99930c-4dc6-4cc9-8e4d-7d960a931cb9"
                      user:
                        id: "user-123"
                        name: "张三"
                        email: "zhangsan@example.com"
                      scopes: ["org:read", "org:update"]
                    timestamp: "2025-09-14T10:00:00Z"
                    requestId: "req_auth_session_001"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      operationId: refreshAuthToken
      tags: [auth]
      summary: Refresh access token via server-side refresh token
      description: Rotates refresh token and returns a new short-lived access token.
      security:
        - CSRFToken: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                refreshed:
                  summary: Refreshed access token
                  value:
                    success: true
                    message: "Access token refreshed"
                    data:
                      accessToken: "eyJhbGciOi...new"
                      expiresIn: 600
                    timestamp: "2025-09-14T10:05:00Z"
                    requestId: "req_auth_refresh_001"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/logout:
    post:
      operationId: authLogoutPost
      tags: [auth]
      summary: Logout & revoke session
      description: Destroys server-side session and clears cookies. Optionally triggers IdP logout.
      security:
        - CSRFToken: []
      responses:
        '204':
          description: No Content
        '401':
          $ref: '#/components/responses/Unauthorized'
    get:
      operationId: authLogoutGet
      tags: [auth]
      summary: RP-initiated logout (redirect)
      description: Clears local session and redirects user agent to IdP end_session_endpoint.
      parameters:
        - in: query
          name: redirect
          schema: { type: string }
          description: Client return URL after successful IdP logout (overrides configured POST_LOGOUT_REDIRECT_URI)
      responses:
        '302':
          description: Redirect to IdP end_session_endpoint
        '200':
          description: OK (fallback when IdP not configured)
  /.well-known/oidc:
    get:
      operationId: getOidcDiscovery
      tags: [auth]
      summary: OIDC discovery (BFF subset)
      description: |
        Returns OIDC discovery information required by the frontend to start the login flow.
        This endpoint exposes a subset of standard OIDC discovery in camelCase to comply with
        API naming rules. Values are derived from configured IdP and BFF settings.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                x-cube-envelope-exempt: true
                type: object
                required: [issuer, authorizationEndpoint, tokenEndpoint]
                properties:
                  issuer:
                    type: string
                    example: "https://idp.example.com"
                  authorizationEndpoint:
                    type: string
                    example: "https://idp.example.com/oauth2/v1/authorize"
                  tokenEndpoint:
                    type: string
                    example: "https://idp.example.com/oauth2/v1/token"
                  endSessionEndpoint:
                    type: string
                    example: "https://idp.example.com/oauth2/v1/logout"
                  jwksUri:
                    type: string
                    description: BFF JWKS for verifying RS256-minted access tokens
                    example: "http://localhost:9090/.well-known/jwks.json"
                additionalProperties: false
              examples:
                basic:
                  summary: Minimal discovery
                  value:
                    issuer: "https://idp.example.com"
                    authorizationEndpoint: "https://idp.example.com/oauth2/v1/authorize"
                    tokenEndpoint: "https://idp.example.com/oauth2/v1/token"
                    endSessionEndpoint: "https://idp.example.com/oauth2/v1/logout"
                    jwksUri: "http://localhost:9090/.well-known/jwks.json"
        '501':
          description: Not Implemented (OIDC not configured)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_configured:
                  summary: OIDC not configured
                  value:
                    success: false
                    error:
                      code: "OIDC_NOT_CONFIGURED"
                      message: "OIDC未配置"
                    timestamp: "2025-09-14T10:30:00Z"
                    requestId: "req_oidc_not_configured_001"
  /.well-known/jwks.json:
    get:
      operationId: getJwks
      tags: [auth]
      summary: BFF JWKS (when RS256 is enabled)
      description: Returns the JSON Web Key Set (JWKS) for verifying BFF-minted access tokens when RS256 is enabled.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                x-cube-envelope-exempt: true
                type: object
        '404':
          description: Not available
  /api/v1/organization-units:
    post:
      operationId: createOrganizationUnit
      tags:
        - organization-units
      summary: Create new organization unit
      description: |
        Creates a new organization unit with automatic code generation and hierarchy setup.
        
        **Business Rules:**
        - Automatically generates 7-digit code (1000000-9999999)
        - Sets operationType=CREATE and status=ACTIVE by default
        - Triggers intelligent cascade update for hierarchy paths
        - Validates parent unit exists and is active
        
        **Temporal Note:**
        - This endpoint creates the initial record for a new organization code.
        - It does not perform temporal backfilling across versions.
        - For temporal version management (adjacent boundary updates, backfilling), use
          `POST /api/v1/organization-units/{code}/versions` or temporal event endpoints.
        
        **Required Permissions:** `org:create`
      security:
        - OAuth2ClientCredentials: ['org:create']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationUnitRequest'
            examples:
              basic_department:
                summary: Basic Department Creation
                value:
                  name: "技术部"
                  unitType: "DEPARTMENT"
                  parentCode: "1000000"
                  description: "负责产品研发和技术创新"
                  effectiveDate: "2025-08-23"
                  operationReason: "业务扩展需要"
              future_effective:
                summary: Future Effective Organization
                value:
                  name: "AI研发中心"
                  unitType: "DEPARTMENT"
                  parentCode: "1000001"
                  description: "人工智能技术研发中心"
                  effectiveDate: "2025-12-01"
                  profile:
                    budget: 10000000
                    headCountLimit: 50
                  operationReason: "战略业务扩展"
      responses:
        '201':
          description: Organization unit created successfully
          headers:
            Location:
              description: URL of the created organization unit
              schema:
                type: string
                example: "/api/v1/organization-units/1000008"
          content:
            application/json:
              schema:
                x-cube-envelope-validated: true
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/OrganizationUnit'
              examples:
                success_creation:
                  summary: Successful Creation
                  value:
                    success: true
                    message: "Organization unit created successfully"
                    data:
                      code: "1000008"
                      parentCode: "1000000"
                      tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                      name: "技术部"
                      unitType: "DEPARTMENT"
                      status: "ACTIVE"
                      version: 1
                      deletedAt: null
                      level: 2
                      hierarchyDepth: 2
                      codePath: "/1000000/1000008"
                      namePath: "/高谷集团/技术部"
                      sortOrder: 0
                      description: "负责产品研发和技术创新"
                      profile: {}
                      createdAt: "2025-08-23T15:00:00Z"
                      updatedAt: "2025-08-23T15:00:00Z"
                      operationType: "CREATE"
                      operatedBy:
                        id: "789e0123-e89b-12d3-a456-426614174003"
                        name: "Zhang San"
                      operationReason: "业务扩展需要"
                      effectiveDate: "2025-08-23"
                      endDate: null
                      isCurrent: true
                      isFuture: false
                      recordId: "456e7890-e89b-12d3-a456-426614174008"
                    timestamp: "2025-08-23T15:00:00Z"
                    requestId: "req_create_1000008"
        '200':
          description: Idempotent replay - resource already created for the same Idempotency-Key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                idempotent_replay:
                  summary: Idempotent Replay
                  value:
                    success: true
                    message: "Idempotent replay"
                    data:
                      code: "1000008"
                      isCurrent: true
                    timestamp: "2025-08-23T15:00:10Z"
                    requestId: "req_replay_1000008"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}:
    put:
      operationId: updateOrganizationUnit
      tags:
        - organization-units
      summary: Complete replacement of organization unit
      description: |
        Completely replaces an organization unit with new data. Follows HTTP PUT semantics
        where all fields must be provided and missing fields are reset to defaults.
        
        **Important Notes:**
        - **Complete Resource Replacement**: Must provide all required and optional fields
        - **Missing Fields**: Will be reset to default values or null
        - **Idempotent**: Multiple calls with same data produce same result
        - **Use Cases**: Complete resource rebuild, bulk standardization
        
        **Temporal Behavior:**
        - **Field Restrictions**: Cannot modify temporal fields (effectiveDate, endDate, isCurrent)
        - **Version Immutability**: PUT updates the current version in-place, does not create new versions
        - **Temporal Integration**: For temporal modifications, use dedicated temporal endpoints
        - **Constraint Validation**: Validates that changes don't violate existing temporal sequences
        
        **Required Permissions:** `org:update`
      security:
        - OAuth2ClientCredentials: ['org:update']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceOrganizationUnitRequest'
            examples:
              complete_replacement:
                summary: Complete Resource Replacement
                value:
                  name: "技术研发部"
                  unitType: "DEPARTMENT"
                  parentCode: "1000000"
                  description: "负责产品研发、技术创新和系统架构设计"
                  status: "ACTIVE"
                  sortOrder: 0
                  profile:
                    budget: 6000000
                    managerPositionCode: "POS-789e0123"
                    costCenterCode: "CC001"
                    headCountLimit: 60
                    establishedDate: "2024-01-01"
                  effectiveDate: "2025-08-23"
                  endDate: null
                  operationReason: "组织架构全面重构"
      responses:
        '200':
          description: Organization unit replaced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

    # PATCH removed in v4.6.x contract alignment – use PUT and specialized endpoints instead.


  /api/v1/organization-units/{code}/versions:
    post:
      operationId: createOrganizationUnitVersion
      tags:
        - organization-units
      summary: Create new temporal version for existing organization
      description: |
        Creates a new temporal version for an existing organization unit.
        Extends standard CRUD operations with temporal data management.
        
        **Business Rules:**
        - Organization must exist with the specified code
        - New effectiveDate must not conflict with existing versions
        - Application transaction manages is_current and end_date transitions
        - Previous current version gets end_date = new effectiveDate - 1 day
        - Supports both historical and future-effective versions
        
        **End Date Automatic Update Rules (Temporal Versions):**
        - **INSERT (new version)**: Previous record end_date = new effective_date - 1; new record end_date = next effective_date - 1 (if any)
        - **UPDATE (change effectiveDate)**: Recalculate adjacent boundaries to maintain continuity
        - **DELETE (remove a version)**: Bridge adjacent records by setting previous end_date = next effective_date - 1
        - **TAIL BEHAVIOR**: Last record has open end (`end_date = null`) and current flag recomputed when applicable
        - **SCOPE**: Only non-deleted records (status ≠ 'DELETED') participate in sequencing
        - **ORDERING/CONSTRAINTS**: Chronological by `effective_date`; prevents overlaps and gaps
        
        **Required Permissions:** `org:create:planned`
      security:
        - OAuth2ClientCredentials: ['org:create:planned']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVersionRequest'
            examples:
              future_version:
                summary: Future Effective Version
                value:
                  name: "技术研发部"
                  unitType: "DEPARTMENT" 
                  description: "重组后的技术部门"
                  parentCode: "1000001"
                  effectiveDate: "2024-04-01"
                  operationReason: "组织架构调整"
              historical_correction:
                summary: Historical Version Correction
                value:
                  name: "原始技术部"
                  unitType: "DEPARTMENT"
                  description: "历史记录补正"
                  parentCode: "1000001"
                  effectiveDate: "2023-01-01"
                  endDate: "2023-12-31"
                  operationReason: "历史数据补正"
      responses:
        '201':
          description: Temporal version created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                data:
                  recordId: "550e8400-e29b-41d4-a716-446655440000"
                  code: "1000028"
                  name: "技术研发部"
                  effectiveDate: "2024-04-01"
                  isCurrent: false
                message: "Temporal version created successfully"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '200':
          description: Idempotent replay - version already exists for the same Idempotency-Key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ORGANIZATION_NOT_FOUND"
                  message: "Organization unit not found"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '409':
          description: Version conflict or date overlap
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "VERSION_CONFLICT"
                  message: "Effective date conflicts with existing version"
                  details:
                    conflictingVersion: "2024-03-01 to 2024-06-30"
                    requestedDate: "2024-04-01"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/events:
    post:
      operationId: createOrganizationUnitEvent
      tags:
        - temporal-operations
      summary: Process organization events
      description: |
        Processes temporal and lifecycle events for organization units.
        This endpoint supports temporal version management operations and full-entity governance.
        
        **Event Types:**
        - DEACTIVATE: Soft delete a specific temporal version by setting status to DELETED (requires `recordId`)
        - DELETE_ORGANIZATION: Soft delete the entire organization (requires `If-Match`, checks child units)
        
        **Temporal Behavior:**
        - Runs full timeline recomputation in a single transaction after event application
          (bridges adjacent records, opens tail end, recomputes `is_current`)
        - Deleted versions do not participate in temporal continuity checks
        - Returns the latest non-deleted timeline in response to avoid read-cache delays
        
        **Required Permissions:** `org:modify:history`
      security:
        - OAuth2ClientCredentials: ['org:modify:history']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IfMatchHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - eventType
                - effectiveDate
              properties:
                eventType:
                  type: string
                  enum: [DEACTIVATE, DELETE_ORGANIZATION]
                  description: Type of event to process (governs required payload fields)
                  example: "DELETE_ORGANIZATION"
                recordId:
                  type: string
                  format: uuid
                  description: UUID of the specific record to deactivate (required when `eventType=DEACTIVATE`)
                  example: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                effectiveDate:
                  type: string
                  format: date
                  description: Effective date applied to the event (used for audit timeline)
                  example: "2026-01-01"
                changeReason:
                  type: string
                  maxLength: 500
                  description: Optional reason for the operation (recorded in audit trail)
                  example: "合规清理：组织撤销"
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                x-cube-envelope-validated: true
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    required: [success, data, message, timestamp, requestId]
                    properties:
                      success:
                        type: boolean
                        description: Indicates operation success (always true when HTTP 200 returned)
                      message:
                        type: string
                        description: Human-readable operation message
                      timestamp:
                        type: string
                        format: date-time
                        description: Response timestamp in ISO 8601 format
                      requestId:
                        type: string
                        description: Request identifier for tracing
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                            example: "1000028"
                          status:
                            type: string
                            example: "DELETED"
                          operationType:
                            type: string
                            example: "DELETE_ORGANIZATION"
                          recordId:
                            type: string
                            format: uuid
                            nullable: true
                            example: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                  description: ACTIVE/INACTIVE/PLANNED (non-DELETED)
                                level:
                                  type: integer
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
                                createdAt:
                                  type: string
                                  format: date-time
                                updatedAt:
                                  type: string
                                  format: date-time
                                parentCode:
                                  type: string
                                  nullable: true
                                description:
                                  type: string
                                  nullable: true
              examples:
                delete_success:
                  summary: Successful organization delete
                  value:
                    success: true
                    data:
                      code: "1000028"
                      status: "DELETED"
                      operationType: "DELETE_ORGANIZATION"
                      record_id: null
                      timeline: []
                    message: "Organization deleted successfully"
                    timestamp: "2025-09-30T10:00:00Z"
                    requestId: "req_delete_org_1000028"
                deactivate_success:
                  summary: Successful version deactivation
                  value:
                    success: true
                    data:
                      code: "1000028"
                      status: "ACTIVE"
                      operationType: "DEACTIVATE"
                      record_id: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                      timeline:
                        - recordId: "11111111-1111-1111-1111-111111111111"
                          code: "1000028"
                          name: "AI治理办公室"
                          unitType: "DEPARTMENT"
                          status: "ACTIVE"
                          level: 2
                          effectiveDate: "2024-11-01"
                          endDate: "2025-07-31"
                          isCurrent: false
                          createdAt: "2025-08-31T09:00:00Z"
                          updatedAt: "2025-09-06T06:00:00Z"
                        - recordId: "22222222-2222-2222-2222-222222222222"
                          code: "1000028"
                          name: "AI治理办公室"
                          unitType: "DEPARTMENT"
                          status: "ACTIVE"
                          level: 2
                          effectiveDate: "2025-08-01"
                          endDate: null
                          isCurrent: true
                          createdAt: "2025-09-01T09:00:00Z"
                          updatedAt: "2025-09-06T06:05:00Z"
                    message: "版本作废成功"
                    timestamp: "2025-08-31T09:17:43Z"
                    requestId: "3f975f9b-6cf9-4e14-956b-2435d1a802bd"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Organization unit or record not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ORGANIZATION_NOT_FOUND"
                  message: "Organization unit not found"
                timestamp: "2025-08-31T09:17:43Z"
                requestId: "req-123456"
        '409':
          description: Conflict - temporal or hierarchy constraint violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                version_conflict:
                  summary: Temporal version conflict
                  value:
                    success: false
                    error:
                      code: "VERSION_CONFLICT"
                      message: "Effective date conflicts with existing version"
                      details:
                        conflictingVersion: "2024-03-01 to 2024-06-30"
                        requestedDate: "2024-04-01"
                    timestamp: "2025-08-31T06:30:00Z"
                    requestId: "req-123456"
                has_children:
                  summary: Delete blocked due to child units
                  value:
                    success: false
                    error:
                      code: "HAS_CHILD_UNITS"
                      message: "Cannot delete organization unit with child units"
                      details:
                        childUnits: ["1000011", "1000012"]
                        affectedCount: 2
                        resolution: "Delete or reassign child units first"
                    timestamp: "2025-09-30T10:00:00Z"
                    requestId: "req_delete_conflict_001"
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/suspend:
    post:
      operationId: suspendOrganizationUnit
      tags:
        - business-operations
      summary: Suspend organization unit
      description: |
        Suspends an organization unit by setting status=INACTIVE and operationType=SUSPEND.
        This is a specialized business operation with dedicated endpoint to ensure clear intent.
        
        **Business Use Case:** 用于因业务调整而暂时停用部门，支持后续重新启用。
        这是业务流程层面的操作，用于组织架构的临时调整，预期会在适当时机重新启用。
        
        **Business Logic:**
        - Forces status=INACTIVE regardless of request body
        - Sets operationType=SUSPEND automatically
        - Supports future-effective suspension planning
        - Records complete audit trail
        - Does **not** cascade to child organization units; 子组织需要单独处理
        
        **Temporal Behavior:**
        - Inserts a temporal version with status=INACTIVE at the specified effectiveDate
        - Recomputes adjacent boundaries in a single transaction (prev.end_date = new.effective_date - 1; tail open)
        - Recomputes `is_current` according to the latest effectiveDate ≤ today
        - Returns latest non-deleted timeline in response to avoid read-cache delays
        
        **Required Permissions:** `org:suspend`
      security:
        - OAuth2ClientCredentials: ['org:suspend']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/IfMatchHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuspendOrganizationRequest'
            examples:
              immediate_suspension:
                summary: Immediate Suspension
                value:
                  operationReason: "业务调整需要"
                  effectiveDate: "2025-08-23"
              planned_suspension:
                summary: Future Planned Suspension
                value:
                  operationReason: "业务重组，部门合并"
                  effectiveDate: "2025-09-01"
      responses:
        '200':
          description: Organization unit suspended successfully
          headers:
            ETag:
              description: Latest version identifier for optimistic concurrency control.
              schema:
                type: string
          content:
            application/json:
              schema:
                x-cube-envelope-validated: true
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    required: [success, data, message, timestamp, requestId]
                    properties:
                      success:
                        type: boolean
                      message:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      requestId:
                        type: string
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                          status:
                            type: string
                          operationType:
                            type: string
                          operationReason:
                            type: string
                          effectiveDate:
                            type: string
                            format: date
                          updatedAt:
                            type: string
                            format: date-time
                          isCurrent:
                            type: boolean
                          isFuture:
                            type: boolean
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
              examples:
                suspension_success:
                  summary: Successful Suspension (with timeline)
                  value:
                    success: true
                    message: "Organization unit suspended successfully"
                    data:
                      code: "1000001"
                      status: "INACTIVE"
                      operationType: "SUSPEND"
                      operationReason: "业务调整需要"
                      effectiveDate: "2025-08-23"
                      updatedAt: "2025-08-23T10:30:00Z"
                      isCurrent: true
                      isFuture: false
                      timeline:
                        - recordId: "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
                          code: "1000001"
                          name: "某组织"
                          unitType: "DEPARTMENT"
                          status: "INACTIVE"
                          effectiveDate: "2025-08-23"
                          endDate: null
                          isCurrent: true
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_suspend_1000001"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '412':
          $ref: '#/components/responses/PreconditionFailed'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/activate:
    post:
      operationId: activateOrganizationUnit
      tags:
        - business-operations
      summary: Activate organization unit
      description: |
        Activates an organization unit by setting status=ACTIVE and operationType=REACTIVATE.
        This is the symmetric operation to suspend, ensuring clear business intent.
        
        **Business Use Case:** 用于重新启用已停用的组织，恢复业务运营。
        与停用操作形成完整的业务循环，是业务流程恢复操作，用于重新投入组织运营。
        
        **Business Logic:**
        - Forces status=ACTIVE regardless of request body
        - Sets operationType=REACTIVATE automatically
        - Supports future-effective activation planning
        - Can cancel planned suspension operations
        - Does **not**自动恢复子组织状态，若有子组织需单独处理
        
        **Temporal Behavior:**
        - Inserts a temporal version with status=ACTIVE at the specified effectiveDate
        - Recomputes adjacent boundaries in a single transaction; tail remains open
        - Recomputes `is_current` and returns latest non-deleted timeline
        
        **Required Permissions:** `org:activate`
      security:
        - OAuth2ClientCredentials: ['org:activate']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/IfMatchHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivateOrganizationRequest'
            examples:
              immediate_activation:
                summary: Immediate Activation
                value:
                  operationReason: "恢复业务运营"
                  effectiveDate: "2025-08-23"
              cancel_planned_suspension:
                summary: Cancel Planned Suspension
                value:
                  operationReason: "计划变更，继续运营"
                  effectiveDate: "2025-09-01"
      responses:
        '200':
          description: Organization unit activated successfully
          headers:
            ETag:
              description: Latest version identifier for optimistic concurrency control.
              schema:
                type: string
          content:
            application/json:
              schema:
                x-cube-envelope-validated: true
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    required: [success, data, message, timestamp, requestId]
                    properties:
                      success:
                        type: boolean
                      message:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      requestId:
                        type: string
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                          status:
                            type: string
                          operationType:
                            type: string
                          operationReason:
                            type: string
                          effectiveDate:
                            type: string
                            format: date
                          updatedAt:
                            type: string
                            format: date-time
                          isCurrent:
                            type: boolean
                          isFuture:
                            type: boolean
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '412':
          $ref: '#/components/responses/PreconditionFailed'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/validate:
    post:
      operationId: validateOrganizationUnits
      tags:
        - data-validation
      summary: Validate organization unit data
      description: |
        Validates organization unit data without actually creating or modifying records.
        Uses the same validation logic as actual operations to ensure consistency.
        
        **Validation Layers:**
        1. **Database Constraints**: Time logic, immutable fields
        2. **Business Rules**: Parent-child relationships, operation sequences
        3. **Configurable Rules**: Temporal constraints, hierarchy limits
        
        **Required Permissions:** `org:validate`
      security:
        - OAuth2ClientCredentials: ['org:validate']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateOrganizationRequest'
            examples:
              create_validation:
                summary: Validate New Organization
                value:
                  operation: "create"
                  data:
                    name: "测试部门"
                    unitType: "DEPARTMENT"
                    parentCode: "1000000"
                    effectiveDate: "2025-08-23"
                  dryRun: true
              suspend_validation:
                summary: Validate Suspension Operation
                value:
                  operation: "suspend"
                  data:
                    code: "1000001"
                    status: "INACTIVE"
                    effectiveDate: "2025-09-01"
                  dryRun: true
      responses:
        '200':
          description: Validation completed
          content:
            application/json:
              schema:
                x-cube-envelope-validated: true
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    required: [success, data, message, timestamp, requestId]
                    properties:
                      success:
                        type: boolean
                      message:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      requestId:
                        type: string
                      data:
                        $ref: '#/components/schemas/ValidationResult'
              examples:
                validation_success:
                  summary: Validation Passed
                  value:
                    success: true
                    message: "Validation completed successfully"
                    data:
                      valid: true
                      warnings: ["父组织将在6个月后过期"]
                      errors: []
                      suggestions: ["建议设置结束日期以明确停用期限"]
                      validationDetails:
                        temporalCheck: "PASS"
                        parentChildCheck: "PASS"
                        operationSequenceCheck: "PASS"
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_validate_001"
                validation_failure:
                  summary: Validation Failed
                  value:
                    success: true
                    message: "Validation completed with errors"
                    data:
                      valid: false
                      warnings: []
                      errors: 
                        - "Parent organization unit does not exist"
                        - "Effective date cannot be more than 365 days in future"
                      suggestions: 
                        - "Verify parent code '1000999' exists"
                        - "Adjust effective date to within policy limits"
                      validationDetails:
                        temporalCheck: "FAIL"
                        parentChildCheck: "FAIL"
                        operationSequenceCheck: "PASS"
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_validate_002"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/refresh-hierarchy:
    post:
      operationId: refreshOrganizationUnitHierarchy
      tags:
        - maintenance
      summary: Manual hierarchy refresh for single organization
      description: |
        Manually refreshes hierarchy data (paths, levels, depths) for a specific organization
        and its subtree. This is a maintenance tool for data repair scenarios.
        
        **Use Cases:**
        - Data migration recovery
        - Database direct modification repair
        - System exception recovery
        - Performance optimization
        
        **⚠️ Important:** This is NOT for normal business operations. Use business
        endpoints (POST/PUT/PATCH) for regular operations which trigger automatic cascade updates.
        
        **Required Permissions:** `org:maintenance`
      security:
        - OAuth2ClientCredentials: ['org:maintenance']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshHierarchyRequest'
            examples:
              single_refresh:
                summary: Single Organization Refresh
                value:
                  reason: "数据迁移后的路径修复"
                  force: false
                  dryRun: false
              dry_run_check:
                summary: Dry Run Preview
                value:
                  reason: "检查修复范围"
                  force: false
                  dryRun: true
      responses:
        '200':
          description: Hierarchy refresh completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                refresh_success:
                  summary: Successful Refresh
                  value:
                    success: true
                    message: "Hierarchy refresh completed successfully"
                    data:
                      processedUnits: 12
                      updatedPaths: 12
                      updatedLevels: 12
                      executionTimeMs: 245
                      affectedCodes: ["1000001", "1000011", "1000012"]
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_refresh_1000001"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/batch-refresh-hierarchy:
    post:
      operationId: batchRefreshOrganizationUnitHierarchy
      tags:
        - maintenance
      summary: Batch hierarchy refresh for multiple organizations
      description: |
        Batch refreshes hierarchy data for multiple organizations or entire tenant.
        This is a powerful maintenance tool requiring special permissions and careful use.
        
        **⚠️ Critical Operation:** This operation can affect large amounts of data and impact
        system performance. Always test with dryRun=true first.
        
        **Required Permissions:** `org:batch-operations`
      security:
        - OAuth2ClientCredentials: ['org:batch-operations']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRefreshHierarchyRequest'
            examples:
              tenant_refresh:
                summary: Full Tenant Refresh
                value:
                  tenantFilter: "987fcdeb-51a2-43d7-8f9e-123456789012"
                  reason: "系统迁移后的全量路径重建"
                  dryRun: true
                  maxUnits: 1000
              selective_refresh:
                summary: Selective Units Refresh
                value:
                  targetCodes: ["1000000", "2000000"]
                  reason: "特定组织的层级修复"
                  dryRun: false
                  maxUnits: 100
      responses:
        '200':
          description: Batch hierarchy refresh completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/corehr/organizations:
    post:
      operationId: createCoreHROrganization
      tags:
        - corehr-compatibility
      summary: Create organization (CoreHR compatible)
      description: |
        CoreHR-compatible organization creation endpoint that maps to OrganizationUnit entity.
        Provides compatibility layer for existing CoreHR frontend modules.
        
        **Note:** Query operations for CoreHR compatibility now use GraphQL endpoints
        as per strict CQRS compliance. Use GraphQL queries for data retrieval.
        
        **Required Permissions:** `org:create`
      security:
        - OAuth2ClientCredentials: ['org:create']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationUnitRequest'
      responses:
        '201':
          description: Organization created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/positions:
    post:
      operationId: createPosition
      tags: [positions]
      summary: Create position
      description: Create a new position with temporal metadata and job catalog linkage.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - position:create
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePositionRequest'
      responses:
        '201':
          description: Position created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}:
    put:
      operationId: replacePosition
      tags: [positions]
      summary: Replace position (full update)
      description: Performs a full replacement of the position resource with concurrency control.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IfMatchHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
          description: Position code (P + 7 digits)
      security:
        - OAuth2ClientCredentials:
            - position:update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePositionRequest'
      responses:
        '200':
          description: Position updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '412': { $ref: '#/components/responses/PreconditionFailed' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/versions:
    post:
      operationId: createPositionVersion
      tags: [positions]
      summary: Insert position version
      description: Inserts a temporal position version at a specific effective date.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
      security:
        - OAuth2ClientCredentials:
            - position:modify:history
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePositionVersionRequest'
      responses:
        '201':
          description: Position version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/events:
    post:
      operationId: postPositionEvent
      tags: [positions]
      summary: Apply position event
      description: Applies lifecycle events such as suspend, reactivate, or delete to a position.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
      security:
        - OAuth2ClientCredentials:
            - position:modify:history
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionEventRequest'
      responses:
        '200':
          description: Event applied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/fill:
    post:
      operationId: fillPosition
      tags: [positions]
      summary: Fill position
      description: Assigns a worker to the position and creates a new position assignment record with temporal tracking.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
      security:
        - OAuth2ClientCredentials:
            - position:fill
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FillPositionRequest'
      responses:
        '200':
          description: Position filled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/vacate:
    post:
      operationId: vacatePosition
      tags: [positions]
      summary: Vacate position
      description: Closes an active position assignment and releases capacity back to the position.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
      security:
        - OAuth2ClientCredentials:
            - position:vacate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VacatePositionRequest'
      responses:
        '200':
          description: Position vacated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/transfer:
    post:
      operationId: transferPosition
      tags: [positions]
      summary: Transfer position
      description: Transfers a position to a different organization and optionally re-aligns active assignments.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^P[0-9]{7}$
      security:
        - OAuth2ClientCredentials:
            - position:transfer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferPositionRequest'
      responses:
        '200':
          description: Position transferred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionSuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/assignments:
    get:
      operationId: listPositionAssignments
      tags: [positions]
      summary: List position assignments
      description: Returns current and historical assignments for a position with optional filters.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
        - name: assignmentTypes
          in: query
          description: Comma-separated assignment types to include (PRIMARY, SECONDARY, ACTING)
          schema:
            type: array
            items:
              $ref: '#/components/schemas/PositionAssignmentType'
          style: form
          explode: false
        - name: status
          in: query
          description: Filter by assignment status
          schema:
            $ref: '#/components/schemas/PositionAssignmentStatus'
        - name: asOfDate
          in: query
          description: Return only assignments active on the specified date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: includeHistorical
          in: query
          description: Include ended assignments in the response
          schema:
            type: boolean
            default: true
        - name: includeActingOnly
          in: query
          description: When true, only acting assignments are returned
          schema:
            type: boolean
            default: false
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 25
      security:
        - OAuth2ClientCredentials: ['position:assignments:read']
      responses:
        '200':
          description: Assignments returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionAssignmentListResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

    post:
      operationId: createPositionAssignment
      tags: [positions]
      summary: Create a new position assignment
      description: Creates a primary, secondary or acting assignment for the specified position.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
      security:
        - OAuth2ClientCredentials: ['position:assignments:write']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePositionAssignmentRequest'
      responses:
        '201':
          description: Assignment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionAssignmentResource'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/assignments/{assignmentId}:
    patch:
      operationId: updatePositionAssignment
      tags: [positions]
      summary: Update an existing assignment
      description: Adjust FTE, acting window or notes for an assignment.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
        - name: assignmentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      security:
        - OAuth2ClientCredentials: ['position:assignments:write']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePositionAssignmentRequest'
      responses:
        '200':
          description: Assignment updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionAssignmentResource'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/positions/{code}/assignments/{assignmentId}/close:
    post:
      operationId: closePositionAssignment
      tags: [positions]
      summary: Close an assignment
      description: Marks an assignment as ended and updates position headcount.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
        - name: assignmentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      security:
        - OAuth2ClientCredentials: ['position:assignments:write']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClosePositionAssignmentRequest'
      responses:
        '200':
          description: Assignment closed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionAssignmentResource'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-family-groups:
    post:
      operationId: createJobFamilyGroup
      tags: [job-catalog]
      summary: Create job family group
      description: Creates the first version of a job family group with the provided effective date.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobFamilyGroupRequest'
      responses:
        '201':
          description: Job family group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-family-groups/{code}:
    put:
      operationId: updateJobFamilyGroup
      tags: [job-catalog]
      summary: Update job family group
      description: Updates the current version of a job family group.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobFamilyGroupRequest'
      responses:
        '200':
          description: Job family group updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '412': { $ref: '#/components/responses/PreconditionFailed' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-family-groups/{code}/versions:
    post:
      operationId: createJobFamilyGroupVersion
      tags: [job-catalog]
      summary: Insert job family group version
      description: Inserts a temporal version for an existing job family group.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCatalogVersionRequest'
      responses:
        '201':
          description: Job family group version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-families:
    post:
      operationId: createJobFamily
      tags: [job-catalog]
      summary: Create job family
      description: Creates a new job family under an existing job family group.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobFamilyRequest'
      responses:
        '201':
          description: Job family created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-families/{code}:
    put:
      operationId: updateJobFamily
      tags: [job-catalog]
      summary: Update job family
      description: Updates the current version of a job family.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobFamilyRequest'
      responses:
        '200':
          description: Job family updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '412': { $ref: '#/components/responses/PreconditionFailed' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-families/{code}/versions:
    post:
      operationId: createJobFamilyVersion
      tags: [job-catalog]
      summary: Insert job family version
      description: Inserts a temporal version for an existing job family.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCatalogVersionRequest'
      responses:
        '201':
          description: Job family version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-roles:
    post:
      operationId: createJobRole
      tags: [job-catalog]
      summary: Create job role
      description: Creates a new job role under an existing job family.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRoleRequest'
      responses:
        '201':
          description: Job role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-roles/{code}:
    put:
      operationId: updateJobRole
      tags: [job-catalog]
      summary: Update job role
      description: Updates the current version of a job role.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobRoleRequest'
      responses:
        '200':
          description: Job role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '412': { $ref: '#/components/responses/PreconditionFailed' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-roles/{code}/versions:
    post:
      operationId: createJobRoleVersion
      tags: [job-catalog]
      summary: Insert job role version
      description: Inserts a temporal version for an existing job role.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCatalogVersionRequest'
      responses:
        '201':
          description: Job role version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-levels:
    post:
      operationId: createJobLevel
      tags: [job-catalog]
      summary: Create job level
      description: Creates a job level under a job role with ranking information.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobLevelRequest'
      responses:
        '201':
          description: Job level created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-levels/{code}:
    put:
      operationId: updateJobLevel
      tags: [job-catalog]
      summary: Update job level
      description: Updates the current version of a job level.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z][0-9]{1,2}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobLevelRequest'
      responses:
        '200':
          description: Job level updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '412': { $ref: '#/components/responses/PreconditionFailed' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-levels/{code}/versions:
    post:
      operationId: createJobLevelVersion
      tags: [job-catalog]
      summary: Insert job level version
      description: Inserts a temporal version for an existing job level.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - name: code
          in: path
          required: true
          schema:
            type: string
            pattern: ^[A-Z][0-9]{1,2}$
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCatalogVersionRequest'
      responses:
        '201':
          description: Job level version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v1/job-catalog/sync:
    post:
      operationId: syncJobCatalog
      tags: [job-catalog]
      summary: Synchronize job catalog from external system
      description: Ingests job catalog changes from external systems in chronological order.
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      security:
        - OAuth2ClientCredentials:
            - job-catalog:write
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCatalogSyncRequest'
      responses:
        '202':
          description: Synchronization accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/InternalError' }

components:
  securitySchemes:
    OAuth2ClientCredentials:
      type: oauth2
      description: |
        OAuth 2.0 Client Credentials Flow for machine-to-machine authentication.

        **Token Endpoint:** `POST /oauth/token`
        **Grant Type:** `client_credentials`
        **Token Type:** Bearer JWT
        **Expiration:** 1-4 hours (configurable)
      flows:
        clientCredentials:
          tokenUrl: /oauth/token
          scopes:
            # 基础CRUD权限
            'org:read': Read organization unit information
            'org:create': Create organization units
            'org:update': Update organization unit basic information
            
            # 状态管理权限
            'org:suspend': Suspend organization units
            'org:activate': Activate organization units
            
            # 层级结构权限
            'org:read:hierarchy': Read organization hierarchy structure
            'org:move': Move organization units in hierarchy
            'org:create:child': Create child organization units
            
            # 时态数据权限 (Temporal Data Permissions)
            'org:read:history': Read organization historical data
            'org:read:future': Read organization future-effective data
            'org:create:planned': Create planned/future-effective changes
            'org:modify:history': Modify historical data (temporal correction)
            'org:cancel:planned': Cancel planned/future-effective changes
            
            # 审计和统计权限
            'org:read:audit': Read audit history records
            'org:read:stats': Get organization statistics
            'org:read:timeline': View organization operation timeline

            # 系统管理权限
            'org:validate': Data validity validation
            'org:maintenance': Hierarchy consistency check and repair
            'org:batch-operations': Batch operations permission
            # Operational monitoring & ops
            'system:monitor:read': Read operational health/metrics/alerts
            'system:ops:read': Read scheduler and tasks status
            'system:ops:write': Trigger operational tasks and actions
            # Position management permissions
            'position:read': Read position information
            'position:create': Create positions
            'position:update': Update positions
            'position:fill': Fill positions with assignments (temporary implementation)
            'position:vacate': Vacate positions (temporary implementation)
            'position:suspend': Suspend positions
            'position:activate': Activate positions
            'position:transfer': Transfer positions across organizations (temporary implementation)
            'position:delete': Delete or retire positions
            'position:read:history': Read historical position versions
            'position:read:future': Read future-effective position data
            'position:create:planned': Create planned/future-effective positions
            'position:modify:history': Modify historical position versions
            'position:read:stats': Read position headcount statistics
            'position:read:headcount': Read detailed headcount utilization data
            # Job catalog permissions
            'job-catalog:read': Read job catalog classifications
            'job-catalog:write': Manage job catalog classifications and versions
    CSRFToken:
      type: apiKey
      in: header
      name: X-CSRF-Token
      description: Anti-CSRF token required for state-changing auth routes

  parameters:
    CodePathParam:
      name: code
      in: path
      required: true
      schema:
        type: string
        pattern: '^[1-9][0-9]{6}$'
        example: "1000001"
      description: |
        7-digit organization unit code (1000000-9999999).
        This is the primary business identifier for organization units.
    TenantIdHeader:
      name: X-Tenant-ID
      in: header
      required: true
      schema:
        type: string
        format: uuid
        example: "987fcdeb-51a2-43d7-8f9e-123456789012"
      description: |
        **REQUIRED** Tenant isolation identifier for multi-tenant data security.
        
        **Security Warning**: This header is MANDATORY for all API operations. 
        Missing this header may result in data access issues or operations 
        being performed against the default tenant.
        
        **Format**: Must be a valid UUID v4 format.
        **Usage**: Include in all API requests to ensure proper data isolation.
    IfMatchHeader:
      name: If-Match
      in: header
      required: false
      schema:
        type: string
      example: 'W/"3b2a7d54"'
      description: |
        Optional optimistic concurrency control header.
        Provide the latest ETag value returned by the API to ensure the
        operation only proceeds if the resource has not been modified since
        it was last fetched. If the ETag does not match, the API returns 412
        PRECONDITION_FAILED.
    IdempotencyKeyHeader:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
        maxLength: 128
        pattern: '^[A-Za-z0-9._:-]{8,128}$'
        example: 'org-activate-1000001-20250823-abc123'
      description: |
        Optional idempotency key to make POST operations idempotent within a 24h window.
        When provided, repeated requests with the same key return 200 with the original result.

  schemas:
    OrganizationUnit:
      type: object
      description: Complete organization unit model with temporal and audit data
      required:
        - code
        - tenantId
        - name
        - unitType
        - parentCode
        - status
        - version
        - level
        - hierarchyDepth
        - codePath
        - namePath
        - sortOrder
        - createdAt
        - updatedAt
        - operationType
        - operatedBy
        - effectiveDate
        - isCurrent
        - isFuture
        - recordId
      properties:
        code:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          description: 7-digit organization code (primary business identifier)
          example: "1000001"
        parentCode:
          type: string
          pattern: '^(0|[1-9][0-9]{6})$'
          description: "Parent organization code. Use '0' for root organizations, or valid 7-digit code for child organizations"
          example: "1000000"
        tenantId:
          type: string
          format: uuid
          description: Tenant isolation identifier
          example: "987fcdeb-51a2-43d7-8f9e-123456789012"
        name:
          type: string
          maxLength: 255
          description: Organization unit name
          example: "技术部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        status:
          $ref: '#/components/schemas/Status'
        deletedAt:
          type: string
          format: date-time
          nullable: true
          readOnly: true
          description: "软删除时间（仅审计用途）；当 status=DELETED 时写入，其他情况下为空"
        level:
          type: integer
          minimum: 1
          maximum: 17
          description: Hierarchy level (1-17)
          example: 2
        hierarchyDepth:
          type: integer
          minimum: 1
          maximum: 17
          description: Hierarchy depth cache (synchronized with level)
          example: 2
        codePath:
          type: string
          maxLength: 2000
          description: Hierarchy path using codes (/1000000/1000001)
          example: "/1000000/1000001"
        namePath:
          type: string
          maxLength: 4000
          description: Human-readable hierarchy path (/Company/Department)
          example: "/高谷集团/技术部"
        sortOrder:
          type: integer
          description: Sorting order within same level
          default: 0
          example: 0
        description:
          type: string
          nullable: true
          maxLength: 1000
          description: Organization unit description
          example: "技术研发部门"
        profile:
          type: object
          description: |
            Flexible JSON configuration for organization-specific data.
            Structure is defined by business requirements rather than predefined schemas.
            
            **Common usage:**
            - Custom business attributes
            - Integration identifiers  
            - Type-specific metadata
          default: {}
          example:
            budget: 5000000
            costCenter: "CC001"
            customField1: "value1"
        createdAt:
          type: string
          format: date-time
          description: Record creation timestamp
          example: "2025-08-05T11:23:01.426455Z"
        updatedAt:
          type: string
          format: date-time
          description: Last operation timestamp (meaning defined by operationType)
          example: "2025-08-23T06:13:47.072807Z"
        operationType:
          $ref: '#/components/schemas/OperationType'
        operatedBy:
          $ref: '#/components/schemas/OperatedBy'
        operationReason:
          type: string
          nullable: true
          maxLength: 500
          description: Reason for the operation
          example: "预算调整和人员编制优化"
        effectiveDate:
          type: string
          format: date
          description: Record effective date (supports future operations)
          example: "2025-08-05"
        isCurrent:
          type: boolean
          description: Dynamic field - whether record is effective on specified date
          example: true
        isFuture:
          type: boolean
          description: Dynamic field - whether record is future effective
          example: false
        recordId:
          type: string
          format: uuid
          description: Global unique record identifier for audit
          example: "123e4567-e89b-12d3-a456-426614174000"

    UnitType:
      type: string
      enum:
        - DEPARTMENT
        - ORGANIZATION_UNIT
        - COMPANY
        - PROJECT_TEAM
      description: |
        Organization unit types:
        - **DEPARTMENT**: Regular business department
        - **ORGANIZATION_UNIT**: Generic organizational unit
        - **COMPANY**: Legal entity company
        - **PROJECT_TEAM**: Temporary project team
      example: "DEPARTMENT"

    Status:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
        - PLANNED
        - DELETED
      description: |
        Business status of organization unit:
        - **ACTIVE**: Actively operating unit
        - **INACTIVE**: Temporarily inactive (suspended) unit
        - **PLANNED**: Future planned unit (not yet active)
        - **DELETED**: Soft-deleted unit（所有业务判定以该状态为准）
      default: "ACTIVE"
      example: "ACTIVE"

    OperationType:
      type: string
      enum:
        - CREATE
        - UPDATE
        - SUSPEND
        - REACTIVATE
        - DEACTIVATE
        - DELETE
      description: |
        Operation types (automatically set by API endpoints):
        - **CREATE**: New organization creation
        - **UPDATE**: Data modification (PUT/PATCH)
        - **SUSPEND**: Suspension operation (/suspend endpoint)
        - **REACTIVATE**: Reactivation operation (/activate endpoint)
        - **DEACTIVATE**: Version deactivation operation (/events endpoint)
        - **DELETE**: Permanent deletion operation for legacy cleanup
      readOnly: true
      example: "UPDATE"

    OperatedBy:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
          description: Operator user ID
          example: "456e7890-e89b-12d3-a456-426614174002"
        name:
          type: string
          description: Operator display name (English)
          example: "Li Si"
      description: |
        Standard operator information structure used across all endpoints.
        Provides both machine-readable ID and human-readable name for audit trails.

    CreateOrganizationUnitRequest:
      type: object
      required:
        - name
        - unitType
        - parentCode
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 255
          description: Organization unit name
          example: "新部门"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^(0|[1-9][0-9]{6})$'
          description: "Parent organization code. Use '0' for root organizations, or valid 7-digit code for child organizations"
          example: "1000000"
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Organization description
          example: "新创建的部门"
        sortOrder:
          type: integer
          default: 0
          description: Sorting order within same level
        profile:
          type: object
          default: {}
          description: Type-specific configuration
          example:
            budget: 5000000
            costCenterCode: "CC001"
        effectiveDate:
          type: string
          format: date
          description: Record effective date
          example: "2025-08-23"
        operationReason:
          type: string
          maxLength: 500
          description: Optional reason for creation; when omitted the service records an empty reason
          example: "业务扩展需要"

    CreateVersionRequest:
      type: object
      description: |
        Request to create a new temporal version for an existing organization unit.
        Supports both historical corrections and future-effective versions.
      required:
        - name
        - unitType
        - parentCode
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 255
          description: Organization unit name for this version
          example: "技术研发部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^(0|[1-9][0-9]{6})$'
          description: "Parent organization code. Use '0' for root organizations, or valid 7-digit code for child organizations"
          example: "1000001"
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Version-specific description
          example: "重组后的技术部门，专注人工智能研发"
        sortOrder:
          type: integer
          default: 0
          description: Sorting order within same level
        profile:
          type: object
          default: {}
          description: Version-specific configuration
          example:
            budget: 8000000
            headCountLimit: 45
            costCenterCode: "CC-TECH-2024"
        effectiveDate:
          type: string
          format: date
          description: When this version becomes effective
          example: "2024-04-01"
        operationReason:
          type: string
          maxLength: 500
          description: Optional reason for creating this version; when omitted the change is recorded without a textual reason
          example: "组织架构调整，加强技术研发能力"

    ReplaceOrganizationUnitRequest:
      type: object
      description: |
        Complete resource replacement request. All fields must be provided as
        missing fields will be reset to defaults (HTTP PUT semantics).
      required:
        - name
        - unitType
        - parentCode
        - status
        - sortOrder
        - profile
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 255
          example: "技术研发部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^(0|[1-9][0-9]{6})$'
          description: "Parent organization code. Use '0' for root organizations, or valid 7-digit code for child organizations"
          example: "1000000"
        description:
          type: string
          maxLength: 1000
          nullable: true
          example: "负责产品研发、技术创新和系统架构设计"
        status:
          $ref: '#/components/schemas/Status'
        sortOrder:
          type: integer
          example: 0
        profile:
          type: object
          description: Complete profile configuration
          example:
            budget: 6000000
            managerPositionCode: "POS-789e0123"
            costCenterCode: "CC001"
            headCountLimit: 60
            establishedDate: "2024-01-01"
        effectiveDate:
          type: string
          format: date
          example: "2025-08-23"
        endDate:
          type: string
          format: date
          nullable: true
        operationReason:
          type: string
          maxLength: 500
          description: Optional reason for the operation; omitted values are recorded as empty
          example: "组织架构全面重构"

    SuspendOrganizationRequest:
      type: object
      required:
        - effectiveDate
      properties:
        operationReason:
          type: string
          maxLength: 500
          description: Optional reason for suspension
          example: "业务调整需要"
        effectiveDate:
          type: string
          format: date
          description: Suspension effective date (supports future dates)
          example: "2025-08-23"

    ActivateOrganizationRequest:
      type: object
      required:
        - effectiveDate
      properties:
        operationReason:
          type: string
          maxLength: 500
          description: Optional reason for activation
          example: "恢复业务运营"
        effectiveDate:
          type: string
          format: date
          description: Activation effective date
          example: "2025-08-23"

    ValidateOrganizationRequest:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          description: Organization data to validate (basic format validation)
          example:
            name: "测试部门"
            unitType: "DEPARTMENT"
            parentCode: "1000000"
            effectiveDate: "2025-08-23"
        dryRun:
          type: boolean
          default: true
          description: Whether this is a dry run validation
          example: true

    RefreshHierarchyRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          maxLength: 500
          description: Reason for manual refresh
          example: "数据迁移后的路径修复"
        force:
          type: boolean
          default: false
          description: Force refresh even if operations are in progress
          example: false
        dryRun:
          type: boolean
          default: false
          description: Preview mode - don't actually execute changes
          example: false

    BatchRefreshHierarchyRequest:
      type: object
      required:
        - reason
      properties:
        tenantFilter:
          type: string
          format: uuid
          nullable: true
          description: Limit refresh to specific tenant
          example: "987fcdeb-51a2-43d7-8f9e-123456789012"
        targetCodes:
          type: array
          items:
            type: string
            pattern: '^[1-9][0-9]{6}$'
          nullable: true
          description: Specific organization codes to refresh
          example: ["1000000", "2000000"]
        reason:
          type: string
          maxLength: 500
          description: Reason for batch refresh
          example: "系统迁移后的全量路径重建"
        dryRun:
          type: boolean
          default: true
          description: Preview mode (always recommended first)
          example: true
        maxUnits:
          type: integer
          minimum: 1
          maximum: 10000
          default: 1000
          description: Maximum units to process (safety limit)
          example: 1000

    ValidationResult:
      type: object
      properties:
        valid:
          type: boolean
          description: Whether validation passed overall
        warnings:
          type: array
          items:
            type: string
          description: Non-blocking warnings
        errors:
          type: array
          items:
            type: string
          description: Validation errors that must be fixed
        suggestions:
          type: array
          items:
            type: string
          description: Recommended improvements
        validationDetails:
          type: object
          properties:
            temporalCheck:
              type: string
              enum: [PASS, FAIL]
            parentChildCheck:
              type: string
              enum: [PASS, FAIL]
            operationSequenceCheck:
              type: string
              enum: [PASS, FAIL]

    SuccessResponse:
      x-cube-envelope-validated: true
      type: object
      description: |
        Unified enterprise envelope for successful responses.
        All successful API responses use this consistent structure.
      required:
        - success
        - data
        - message
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Always true for successful responses
          example: true
        data:
          type: object
          description: Actual business data (varies by endpoint)
        message:
          type: string
          description: Human-readable success message (English)
          example: "Organization unit created successfully"
        timestamp:
          type: string
          format: date-time
          description: Response timestamp (ISO 8601)
          example: "2025-08-23T15:00:00Z"
        requestId:
          type: string
          description: Unique request identifier for tracing
          example: "req_create_1000008"

    ErrorResponse:
      type: object
      description: |
        Unified enterprise envelope for error responses.
        All error responses use this consistent structure for easier client handling.
      required:
        - success
        - error
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: >
                Machine-readable error code. Business Validator violations use values from
                `ValidatorErrorCode`.
              example: "ORG_UNIT_NOT_FOUND"
            message:
              type: string
              description: Human-readable error message (English)
              example: "Organization unit not found"
            details:
              type: object
              nullable: true
              description: >
                Additional error context (varies by error type). For business validator violations,
                the object MUST include `ruleId` (from `ValidatorRuleId`), `severity`, and may contain
                `field`, `httpStatus`, and `metadata` to describe the failing payload scope.
        timestamp:
          type: string
          format: date-time
          description: Error timestamp (ISO 8601)
          example: "2025-08-23T10:30:00Z"
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: "req_error_12345678"

    ValidatorRuleId:
      type: string
      description: >
        Identifier for business validator rules (see `internal/organization/README.md#validators`).
        Prefix indicates domain (`ORG`, `POS`, `ASSIGN`, `CROSS` etc).
      enum:
        - ORG-DEPTH
        - ORG-CIRC
        - ORG-STATUS
        - ORG-TEMPORAL
        - POS-ORG
        - POS-HEADCOUNT
        - ASSIGN-STATE
        - ASSIGN-FTE
        - CROSS-ACTIVE

    ValidatorErrorCode:
      type: string
      description: >
        Machine-readable error codes returned when Business Validator rules fail. Codes align with
        the frozen matrix documented in `internal/organization/README.md#validators`.
      enum:
        - INVALID_PARENT
        - ORG_DEPTH_LIMIT
        - ORG_CYCLE_DETECTED
        - ORG_STATUS_GUARD
        - ORG_TEMPORAL_PARENT_INACTIVE
        - POS_ORG_INACTIVE
        - POS_HEADCOUNT_EXCEEDED
        - ASSIGN_INVALID_STATE
        - ASSIGN_FTE_LIMIT
        - CROSS_ACTIVATION_CONFLICT

    PositionStatus:
      type: string
      enum: [PLANNED, ACTIVE, FILLED, VACANT, INACTIVE, DELETED]
      description: Position lifecycle status.

    PositionType:
      type: string
      enum: [REGULAR, TEMPORARY, CONTRACTOR]
      description: Position classification based on employment contract.

    EmploymentType:
      type: string
      enum: [FULL_TIME, PART_TIME, INTERN]
      description: Employment type for the position contract.

    PositionEventType:
      type: string
      enum: [SUSPEND, REACTIVATE, DELETE]
      description: Position lifecycle events supported by the /events endpoint.

    JobCatalogStatus:
      type: string
      enum: [ACTIVE, INACTIVE]
      description: Active or inactive status for job catalog entries.

    PositionResource:
      type: object
      required:
        - code
        - title
        - organizationCode
        - positionType
        - employmentType
        - status
        - effectiveDate
        - headcountCapacity
        - headcountInUse
        - availableHeadcount
        - recordId
      properties:
        code:
          type: string
          pattern: ^P[0-9]{7}$
          description: Position code (P + 7 digits)
          example: "P1000001"
        title:
          type: string
          maxLength: 120
          description: Position title
          example: "高级后端工程师"
        organizationCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          description: Owning organization code
          example: "1000001"
        jobProfileCode:
          type: string
          maxLength: 64
          nullable: true
        jobProfileName:
          type: string
          maxLength: 120
          nullable: true
        jobFamilyGroupCode:
          type: string
          pattern: ^[A-Z]{4,6}$
          example: "PROF"
        jobFamilyCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
          example: "PROF-ITOPS"
        jobRoleCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
          example: "PROF-ITOPS-BKND"
        jobLevelCode:
          type: string
          pattern: ^[A-Z][0-9]{1,2}$
          example: "P5"
        positionType:
          $ref: '#/components/schemas/PositionType'
        employmentType:
          $ref: '#/components/schemas/EmploymentType'
        gradeLevel:
          type: string
          maxLength: 16
          nullable: true
        headcountCapacity:
          type: number
          format: float
          minimum: 0
          example: 3
        headcountInUse:
          type: number
          format: float
          minimum: 0
          example: 2
        availableHeadcount:
          type: number
          format: float
          minimum: 0
          example: 1
        currentAssignment:
          $ref: '#/components/schemas/PositionAssignmentResource'
          nullable: true
          description: Latest active assignment for the position, if any.
        assignmentHistory:
          type: array
          description: Full assignment history sorted by effectiveDate descending.
          items:
            $ref: '#/components/schemas/PositionAssignmentResource'
        status:
          $ref: '#/components/schemas/PositionStatus'
        effectiveDate:
          type: string
          format: date
          example: "2025-10-01"
        endDate:
          type: string
          format: date
          nullable: true
        isCurrent:
          type: boolean
        isFuture:
          type: boolean
        reportsToPositionCode:
          type: string
          pattern: ^P[0-9]{7}$
          nullable: true
        recordId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    PositionSuccessResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/PositionResource'

    CreatePositionRequest:
      type: object
      required:
        - title
        - jobFamilyGroupCode
        - jobFamilyCode
        - jobRoleCode
        - jobLevelCode
        - organizationCode
        - positionType
        - employmentType
        - headcountCapacity
        - effectiveDate
        - operationReason
      properties:
        title:
          type: string
          maxLength: 120
        jobProfileCode:
          type: string
          maxLength: 64
          nullable: true
        jobProfileName:
          type: string
          maxLength: 120
          nullable: true
        jobFamilyGroupCode:
          type: string
          pattern: ^[A-Z]{4,6}$
        jobFamilyGroupRecordId:
          type: string
          format: uuid
          nullable: true
        jobFamilyCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
        jobFamilyRecordId:
          type: string
          format: uuid
          nullable: true
        jobRoleCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
        jobRoleRecordId:
          type: string
          format: uuid
          nullable: true
        jobLevelCode:
          type: string
          pattern: ^[A-Z][0-9]{1,2}$
        jobLevelRecordId:
          type: string
          format: uuid
          nullable: true
        organizationCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
        positionType:
          $ref: '#/components/schemas/PositionType'
        employmentType:
          $ref: '#/components/schemas/EmploymentType'
        gradeLevel:
          type: string
          maxLength: 16
          nullable: true
        headcountCapacity:
          type: number
          format: float
          minimum: 0
        reportsToPositionCode:
          type: string
          pattern: ^P[0-9]{7}$
          nullable: true
        effectiveDate:
          type: string
          format: date
        operationReason:
          type: string
          maxLength: 500

    CreatePositionVersionRequest:
      allOf:
        - $ref: '#/components/schemas/CreatePositionRequest'
      description: Request to insert a new temporal version for an existing position.

    FillPositionRequest:
      type: object
      required:
        - employeeId
        - employeeName
        - assignmentType
        - effectiveDate
        - operationReason
      properties:
        employeeId:
          type: string
          format: uuid
          description: Unique identifier of the worker being assigned.
        employeeName:
          type: string
          maxLength: 120
          description: Display name of the worker being assigned.
        employeeNumber:
          type: string
          maxLength: 64
          nullable: true
          description: Optional worker number for HR reporting.
        assignmentType:
          $ref: '#/components/schemas/PositionAssignmentType'
        fte:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 1
          description: Full-time equivalent allocation for this assignment.
        effectiveDate:
          type: string
          format: date
          description: Date when the assignment becomes active.
        anticipatedEndDate:
          type: string
          format: date
          nullable: true
          description: Optional planned end date for fixed-term assignments.
        operationReason:
          type: string
          maxLength: 500
        notes:
          type: string
          maxLength: 500
          nullable: true

    VacatePositionRequest:
      type: object
      required:
        - assignmentId
        - effectiveDate
        - operationReason
      properties:
        assignmentId:
          type: string
          format: uuid
          description: Identifier of the active assignment to close.
        effectiveDate:
          type: string
          format: date
          description: Date when the assignment should end.
        operationReason:
          type: string
          maxLength: 500
        notes:
          type: string
          maxLength: 500
          nullable: true

    TransferPositionRequest:
      type: object
      required:
        - targetOrganizationCode
        - effectiveDate
        - operationReason
      properties:
        targetOrganizationCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
        effectiveDate:
          type: string
          format: date
        operationReason:
          type: string
          maxLength: 500
        reassignReports:
          type: boolean
          default: true
          description: Whether to automatically re-align subordinate reporting lines after transfer.

    PositionAssignmentType:
      type: string
      enum: [PRIMARY, SECONDARY, ACTING]

    PositionAssignmentStatus:
      type: string
      enum: [PENDING, ACTIVE, ENDED]

    PositionAssignmentResource:
      type: object
      required:
        - assignmentId
        - positionCode
        - positionRecordId
        - employeeId
        - employeeName
        - assignmentType
        - assignmentStatus
        - fte
        - effectiveDate
        - isCurrent
        - autoRevert
        - createdAt
        - updatedAt
      properties:
        assignmentId:
          type: string
          format: uuid
        positionCode:
          type: string
          pattern: ^P[0-9]{7}$
        positionRecordId:
          type: string
          format: uuid
        employeeId:
          type: string
          format: uuid
        employeeName:
          type: string
          maxLength: 120
        employeeNumber:
          type: string
          maxLength: 64
          nullable: true
        assignmentType:
          $ref: '#/components/schemas/PositionAssignmentType'
        assignmentStatus:
          $ref: '#/components/schemas/PositionAssignmentStatus'
        fte:
          type: number
          format: float
          minimum: 0
          maximum: 1
        effectiveDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
          nullable: true
        actingUntil:
          type: string
          format: date
          nullable: true
        autoRevert:
          type: boolean
          description: Whether the assignment should automatically revert when actingUntil is reached
        reminderSentAt:
          type: string
          format: date-time
          nullable: true
        isCurrent:
          type: boolean
        notes:
          type: string
          maxLength: 500
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PositionEventRequest:
      type: object
      required:
        - eventType
        - effectiveDate
        - operationReason
      properties:
        eventType:
          $ref: '#/components/schemas/PositionEventType'
        recordId:
          type: string
          format: uuid

    CreatePositionAssignmentRequest:
      type: object
      required:
        - employeeId
        - employeeName
        - assignmentType
        - effectiveDate
        - operationReason
      properties:
        employeeId:
          type: string
          format: uuid
        employeeName:
          type: string
          maxLength: 120
        employeeNumber:
          type: string
          maxLength: 64
          nullable: true
        assignmentType:
          $ref: '#/components/schemas/PositionAssignmentType'
        fte:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 1
        effectiveDate:
          type: string
          format: date
        actingUntil:
          type: string
          format: date
          nullable: true
        autoRevert:
          type: boolean
          default: false
        notes:
          type: string
          maxLength: 500
          nullable: true
        operationReason:
          type: string
          maxLength: 500

    UpdatePositionAssignmentRequest:
      type: object
      required:
        - operationReason
      properties:
        fte:
          type: number
          format: float
          minimum: 0
          maximum: 1
        actingUntil:
          type: string
          format: date
          nullable: true
        autoRevert:
          type: boolean
          nullable: true
        notes:
          type: string
          maxLength: 500
          nullable: true
        operationReason:
          type: string
          maxLength: 500

    ClosePositionAssignmentRequest:
      type: object
      required:
        - endDate
        - operationReason
      properties:
        endDate:
          type: string
          format: date
        notes:
          type: string
          maxLength: 500
          nullable: true
        operationReason:
          type: string
          maxLength: 500

    PositionAssignmentListResponse:
      type: object
      required:
        - data
        - pagination
        - totalCount
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PositionAssignmentResource'
        pagination:
          type: object
          required:
            - total
            - page
            - pageSize
            - hasNext
            - hasPrevious
          properties:
            total:
              type: integer
              minimum: 0
            page:
              type: integer
              minimum: 1
            pageSize:
              type: integer
              minimum: 1
              maximum: 200
            hasNext:
              type: boolean
            hasPrevious:
              type: boolean
        totalCount:
          type: integer
          minimum: 0
          nullable: true
        effectiveDate:
          type: string
          format: date
        operationReason:
          type: string
          maxLength: 500

    CreateJobFamilyGroupRequest:
      type: object
      required:
        - code
        - name
        - status
        - effectiveDate
      properties:
        code:
          type: string
          pattern: ^[A-Z]{4,6}$
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true

    UpdateJobFamilyGroupRequest:
      type: object
      required:
        - name
        - status
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true

    CreateJobFamilyRequest:
      type: object
      required:
        - code
        - name
        - jobFamilyGroupCode
        - status
        - effectiveDate
      properties:
        code:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
        jobFamilyGroupCode:
          type: string
          pattern: ^[A-Z]{4,6}$
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true

    UpdateJobFamilyRequest:
      type: object
      required:
        - name
        - status
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true
        jobFamilyGroupCode:
          type: string
          pattern: ^[A-Z]{4,6}$

    CreateJobRoleRequest:
      type: object
      required:
        - code
        - name
        - jobFamilyCode
        - status
        - effectiveDate
      properties:
        code:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
        jobFamilyCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true

    UpdateJobRoleRequest:
      type: object
      required:
        - name
        - status
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true
        jobFamilyCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}$

    CreateJobLevelRequest:
      type: object
      required:
        - code
        - name
        - jobRoleCode
        - status
        - effectiveDate
        - levelRank
      properties:
        code:
          type: string
          pattern: ^[A-Z][0-9]{1,2}$
        jobRoleCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        levelRank:
          type: integer
          minimum: 1
        description:
          type: string
          maxLength: 500
          nullable: true

    UpdateJobLevelRequest:
      type: object
      required:
        - name
        - status
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true
        jobRoleCode:
          type: string
          pattern: ^[A-Z]{4,6}-[A-Z0-9]{3,6}-[A-Z0-9]{3,6}$
        levelRank:
          type: integer
          minimum: 1

    JobCatalogVersionRequest:
      type: object
      required:
        - name
        - status
        - effectiveDate
      properties:
        name:
          type: string
          maxLength: 120
        status:
          $ref: '#/components/schemas/JobCatalogStatus'
        effectiveDate:
          type: string
          format: date
        description:
          type: string
          maxLength: 500
          nullable: true
        parentRecordId:
          type: string
          format: uuid
          nullable: true

    JobCatalogSyncRequest:
      type: object
      required:
        - sourceSystem
        - batchId
        - changes
      properties:
        sourceSystem:
          type: string
          maxLength: 64
        batchId:
          type: string
          maxLength: 64
        changes:
          type: array
          items:
            type: object
            additionalProperties: true
        dryRun:
          type: boolean
          default: false

  responses:
    BadRequest:
      description: |
        Bad Request - Invalid input data, validation errors, or malformed requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validation_error:
              summary: Validation Error
              value:
                success: false
                error:
                  code: "ORG_DEPTH_LIMIT"
                  message: "Organization depth exceeds maximum of 17 levels"
                  details:
                    ruleId: "ORG-DEPTH"
                    severity: "HIGH"
                    field: "parentCode"
                    httpStatus: 400
                    metadata:
                      maxDepth: 17
                      attemptedDepth: 18
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_validation_error_001"
            incomplete_resource:
              summary: Incomplete Resource (PUT)
              value:
                success: false
                error:
                  code: "INCOMPLETE_RESOURCE"
                  message: "PUT request missing required fields"
                  details:
                    missingFields: ["name", "unitType", "status"]
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_incomplete_001"
            readonly_field:
              summary: Read-only Field Update (PATCH)
              value:
                success: false
                error:
                  code: "READONLY_FIELD"
                  message: "Cannot modify read-only field"
                  details:
                    field: "operationType"
                    reason: "operationType is automatically set by API endpoints"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_readonly_001"

    Unauthorized:
      description: |
        Unauthorized - Authentication required or invalid access token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalid_token:
              summary: Invalid Access Token
              value:
                success: false
                error:
                  code: "INVALID_TOKEN"
                  message: "Invalid or expired access token"
                  details:
                    errorDescription: "The access token provided is invalid, expired, or malformed"
                    errorUri: "https://docs.api.yourcompany.com/errors/invalid-token"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_001"
            token_expired:
              summary: Token Expired
              value:
                success: false
                error:
                  code: "TOKEN_EXPIRED"
                  message: "Access token has expired"
                  details:
                    expiredAt: "2025-08-23T09:30:00Z"
                    errorDescription: "Please obtain a new access token using your client credentials"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_002"

    Forbidden:
      description: |
        Forbidden - Insufficient permissions or access denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            insufficient_permissions:
              summary: Insufficient Permissions
              value:
                success: false
                error:
                  code: "INSUFFICIENT_PERMISSIONS"
                  message: "Insufficient permissions to access this resource"
                  details:
                    requiredPermissions: ["org:modify:history"]
                    currentPermissions: ["org:read", "org:update"]
                    resource: "/api/v1/organization-units/1000001"
                    action: "DEACTIVATE"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_003"
            tenant_access_denied:
              summary: Tenant Access Denied
              value:
                success: false
                error:
                  code: "TENANT_ACCESS_DENIED"
                  message: "Access denied to specified tenant resources"
                  details:
                    requestedTenant: "tenant-uuid-456"
                    authorizedTenants: ["tenant-uuid-123"]
                    errorDescription: "Your credentials do not have access to the requested tenant"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_004"

    NotFound:
      description: |
        Not Found - Organization unit or related resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            org_unit_not_found:
              summary: Organization Unit Not Found
              value:
                success: false
                error:
                  code: "ORG_UNIT_NOT_FOUND"
                  message: "Organization unit not found"
                  details:
                    code: "1000999"
                    searchContext: "current active units"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_not_found_001"

    Conflict:
      description: |
        Conflict - Business rule violation, constraint conflicts, or resource conflicts.
        Typical temporal conflicts include:
        - TEMPORAL_POINT_CONFLICT: unique (tenant_id, code, effective_date) violation
        - CURRENT_CONFLICT: partial unique (tenant_id, code) WHERE is_current=true violation
        - TEMPORAL_GAP_VIOLATION: Time gap detected in temporal sequence
        - TEMPORAL_OVERLAP_VIOLATION: Time overlap detected between versions
        - TEMPORAL_BOUNDARY_CONFLICT: Boundary calculation conflict during concurrent updates
        - TEMPORAL_TRANSACTION_FAILED: Temporal recomputation transaction failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            temporal_point_conflict:
              summary: Temporal Point Unique Conflict
              value:
                success: false
                error:
                  code: "TEMPORAL_POINT_CONFLICT"
                  message: "(tenant_id, code, effective_date) must be unique"
                  details:
                    code: "1000001"
                    effectiveDate: "2025-08-23"
                    tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_conflict_temporal_point_001"
            current_conflict:
              summary: Single Current Constraint Conflict
              value:
                success: false
                error:
                  code: "CURRENT_CONFLICT"
                  message: "Only one current record per (tenant_id, code) is allowed"
                  details:
                    code: "1000001"
                    tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_conflict_current_001"
            circular_reference:
              summary: Circular Reference Error
              value:
                success: false
                error:
                  code: "CIRCULAR_REFERENCE"
                  message: "Operation would create circular reference"
                  details:
                    conflictPath: ["1000001", "1000002", "1000001"]
                    resolution: "Verify parent-child relationships"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_circular_ref_001"
            has_child_units:
              summary: Cannot Delete - Has Children
              value:
                success: false
                error:
                  code: "HAS_CHILD_UNITS"
                  message: "Cannot delete organization unit with child units"
                  details:
                    childUnits: ["1000011", "1000012"]
                    affectedCount: 2
                    resolution: "Delete or reassign child units first"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_delete_conflict_001"
            temporal_gap_violation:
              summary: Temporal Gap Violation
              value:
                success: false
                error:
                  code: "TEMPORAL_GAP_VIOLATION"
                  message: "Time gap detected in temporal sequence"
                  details:
                    code: "1000001"
                    gapPeriod: "2024-01-01 to 2024-12-31"
                    previousEndDate: "2023-12-31"
                    nextEffectiveDate: "2025-01-01"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_gap_001"
            temporal_overlap_violation:
              summary: Temporal Overlap Violation
              value:
                success: false
                error:
                  code: "TEMPORAL_OVERLAP_VIOLATION"
                  message: "Time overlap detected between versions"
                  details:
                    code: "1000001"
                    conflictingVersions: [
                      { "recordId": "uuid1", "period": "2025-06-01 to 2025-08-31" },
                      { "recordId": "uuid2", "period": "2025-07-01 to 2025-09-30" }
                    ]
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_overlap_001"
            temporal_boundary_conflict:
              summary: Temporal Boundary Calculation Conflict
              value:
                success: false
                error:
                  code: "TEMPORAL_BOUNDARY_CONFLICT"
                  message: "Boundary calculation conflict during concurrent updates"
                  details:
                    code: "1000001"
                    conflictType: "CONCURRENT_MODIFICATION"
                    expectedVersion: 5
                    actualVersion: 7
                    resolution: "Retry with latest version"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_boundary_conflict_001"
            temporal_transaction_failed:
              summary: Temporal Transaction Rollback
              value:
                success: false
                error:
                  code: "TEMPORAL_TRANSACTION_FAILED"
                  message: "Temporal recomputation transaction failed and was rolled back"
                  details:
                    code: "1000001"
                    operationType: "DELETE_VERSION"
                    affectedRecords: 3
                    rollbackReason: "Constraint violation during boundary update"
                    retryable: true
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_tx_failed_001"

    PreconditionFailed:
      description: |
        Precondition Failed - The provided If-Match ETag does not match the latest
        resource version. Indicates the resource was modified after the client
        retrieved its representation.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            version_conflict:
              summary: ETag Mismatch Conflict
              value:
                success: false
                error:
                  code: "VERSION_CONFLICT"
                  message: "Resource was updated by another operation"
                  details:
                    providedEtag: 'W/"3b2a7d54"'
                    currentEtag: 'W/"4c1f9b87"'
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_precondition_failed_001"

    InternalError:
      description: |
        Internal Server Error - System errors, database issues, or unexpected failures
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            database_error:
              summary: Database Connection Error
              value:
                success: false
                error:
                  code: "DATABASE_ERROR"
                  message: "Database connection failed"
                  details:
                    errorType: "CONNECTION_TIMEOUT"
                    retryable: true
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_db_error_001"
            internal_error:
              summary: Generic Internal Error
              value:
                success: false
                error:
                  code: "INTERNAL_ERROR"
                  message: "An unexpected error occurred"
                  details:
                    errorId: "ERR_20250823_103000_001"
                    supportContact: "api-support@yourcompany.com"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_internal_error_001"
