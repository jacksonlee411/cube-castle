openapi: 3.0.3
info:
  title: Organization Units Management API
  description: |
    Enterprise-grade organization units management API with strict CQRS architecture.
    
    **Architecture Features:**
    - **Command Operations**: REST API (Port 9090) - All data modifications
    - **Query Operations**: GraphQL (Port 8090) - All data retrieval
    - **Single Data Source**: PostgreSQL with temporal data support
    - **Authentication**: OAuth 2.0 Client Credentials Flow
    - **Authorization**: Permission-Based Access Control (PBAC) with 19 fine-grained permissions
    - **Multi-Tenant Security**: Mandatory X-Tenant-ID header for data isolation
    
    **Key Capabilities:**
    - 17-level hierarchy depth support
    - Temporal data management with effective/end dates
    - Intelligent cascade updates for hierarchy changes
    - Comprehensive audit trail with operation history
    - Multi-tenant isolation and security
    
    **Multi-Tenant Usage Guide:**
    - **MANDATORY Header**: All API requests MUST include `X-Tenant-ID` header
    - **UUID Format**: Tenant ID must be a valid UUID v4 format
    - **Data Isolation**: Each tenant's data is completely isolated from others
    - **Security Risk**: Missing tenant header may result in default tenant access
    - **Example**: `X-Tenant-ID: 987fcdeb-51a2-43d7-8f9e-123456789012`
    
    **Business Operation Types:**
    - **SUSPEND**: 因业务调整而暂时停用部门，支持后续重新启用，用于组织架构临时调整
    - **REACTIVATE**: 重新启用已停用的组织（对应端点 POST /api/v1/organization-units/{code}/activate）
    - **DEACTIVATE**: 停用特定版本记录，用于时态数据纠错（通过 /events 端点）
    
    **Permission System:**
    - **Basic CRUD**: org:read, org:create, org:update
    - **State Management**: org:suspend, org:activate
    - **Hierarchy Operations**: org:read:hierarchy, org:move, org:create:child
    - **Temporal Data**: org:read:history, org:read:future, org:create:planned, org:modify:history, org:cancel:planned
    - **Audit & Analytics**: org:read:audit, org:read:stats, org:read:timeline
    - **System Management**: org:validate, org:maintenance, org:batch-operations
    
    **Response Format**: All endpoints use unified enterprise envelope structure
    with `success`, `data`, `message`, `timestamp`, and `requestId` fields.
  version: 4.6.0
  contact:
    name: System Architecture Team
    email: api-support@yourcompany.com
  license:
    name: Proprietary
    url: https://yourcompany.com/license

servers:
  - url: http://localhost:9090
    description: Development - Command Service (REST API)
  - url: https://api.yourcompany.com
    description: Production - Command Service (REST API)

security:
  - OAuth2ClientCredentials: []

tags:
  - name: organization-units
    description: Standard CRUD operations for organization units
  - name: business-operations
    description: Specialized business operations (suspend/activate)
  - name: data-validation
    description: Data validation and business rule checking
  - name: maintenance
    description: System maintenance and hierarchy management tools
  - name: corehr-compatibility
    description: CoreHR system compatibility endpoints

paths:
  /api/v1/organization-units:
    post:
      tags:
        - organization-units
      summary: Create new organization unit
      description: |
        Creates a new organization unit with automatic code generation and hierarchy setup.
        
        **Business Rules:**
        - Automatically generates 7-digit code (1000000-9999999)
        - Sets operationType=CREATE and status=ACTIVE by default
        - Triggers intelligent cascade update for hierarchy paths
        - Validates parent unit exists and is active
        
        **Temporal Note:**
        - This endpoint creates the initial record for a new organization code.
        - It does not perform temporal backfilling across versions.
        - For temporal version management (adjacent boundary updates, backfilling), use
          `POST /api/v1/organization-units/{code}/versions` or temporal event endpoints.
        
        **Required Permissions:** `org:create`
      security:
        - OAuth2ClientCredentials: ['org:create']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationUnitRequest'
            examples:
              basic_department:
                summary: Basic Department Creation
                value:
                  name: "技术部"
                  unitType: "DEPARTMENT"
                  parentCode: "1000000"
                  description: "负责产品研发和技术创新"
                  effectiveDate: "2025-08-23"
                  operationReason: "业务扩展需要"
              future_effective:
                summary: Future Effective Organization
                value:
                  name: "AI研发中心"
                  unitType: "DEPARTMENT"
                  parentCode: "1000001"
                  description: "人工智能技术研发中心"
                  effectiveDate: "2025-12-01"
                  profile:
                    budget: 10000000
                    headCountLimit: 50
                  operationReason: "战略业务扩展"
      responses:
        '201':
          description: Organization unit created successfully
          headers:
            Location:
              description: URL of the created organization unit
              schema:
                type: string
                example: "/api/v1/organization-units/1000008"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success_creation:
                  summary: Successful Creation
                  value:
                    success: true
                    message: "Organization unit created successfully"
                    data:
                      code: "1000008"
                      parentCode: "1000000"
                      tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                      name: "技术部"
                      unitType: "DEPARTMENT"
                      status: "ACTIVE"
                      isDeleted: false
                      level: 2
                      codePath: "/1000000/1000008"
                      namePath: "/高谷集团/技术部"
                      sortOrder: 0
                      description: "负责产品研发和技术创新"
                      profile: {}
                      createdAt: "2025-08-23T15:00:00Z"
                      updatedAt: "2025-08-23T15:00:00Z"
                      operationType: "CREATE"
                      operatedBy:
                        id: "789e0123-e89b-12d3-a456-426614174003"
                        name: "Zhang San"
                      operationReason: "业务扩展需要"
                      effectiveDate: "2025-08-23"
                      endDate: null
                      isCurrent: true
                      isFuture: false
                      recordId: "456e7890-e89b-12d3-a456-426614174008"
                    timestamp: "2025-08-23T15:00:00Z"
                    requestId: "req_create_1000008"
        '200':
          description: Idempotent replay - resource already created for the same Idempotency-Key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                idempotent_replay:
                  summary: Idempotent Replay
                  value:
                    success: true
                    message: "Idempotent replay"
                    data:
                      code: "1000008"
                      isCurrent: true
                    timestamp: "2025-08-23T15:00:10Z"
                    requestId: "req_replay_1000008"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}:
    put:
      tags:
        - organization-units
      summary: Complete replacement of organization unit
      description: |
        Completely replaces an organization unit with new data. Follows HTTP PUT semantics
        where all fields must be provided and missing fields are reset to defaults.
        
        **Important Notes:**
        - **Complete Resource Replacement**: Must provide all required and optional fields
        - **Missing Fields**: Will be reset to default values or null
        - **Idempotent**: Multiple calls with same data produce same result
        - **Use Cases**: Complete resource rebuild, bulk standardization
        
        **Temporal Behavior:**
        - **Field Restrictions**: Cannot modify temporal fields (effectiveDate, endDate, isCurrent)
        - **Version Immutability**: PUT updates the current version in-place, does not create new versions
        - **Temporal Integration**: For temporal modifications, use dedicated temporal endpoints
        - **Constraint Validation**: Validates that changes don't violate existing temporal sequences
        
        **Required Permissions:** `org:update`
      security:
        - OAuth2ClientCredentials: ['org:update']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceOrganizationUnitRequest'
            examples:
              complete_replacement:
                summary: Complete Resource Replacement
                value:
                  name: "技术研发部"
                  unitType: "DEPARTMENT"
                  parentCode: "1000000"
                  description: "负责产品研发、技术创新和系统架构设计"
                  status: "ACTIVE"
                  sortOrder: 0
                  profile:
                    budget: 6000000
                    managerPositionCode: "POS-789e0123"
                    costCenterCode: "CC001"
                    headCountLimit: 60
                    establishedDate: "2024-01-01"
                  effectiveDate: "2025-08-23"
                  endDate: null
                  operationReason: "组织架构全面重构"
      responses:
        '200':
          description: Organization unit replaced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

    # PATCH removed in v4.6.x contract alignment – use PUT and specialized endpoints instead.


  /api/v1/organization-units/{code}/versions:
    post:
      tags:
        - organization-units
      summary: Create new temporal version for existing organization
      description: |
        Creates a new temporal version for an existing organization unit.
        Extends standard CRUD operations with temporal data management.
        
        **Business Rules:**
        - Organization must exist with the specified code
        - New effectiveDate must not conflict with existing versions
        - Application transaction manages is_current and end_date transitions
        - Previous current version gets end_date = new effectiveDate - 1 day
        - Supports both historical and future-effective versions
        
        **End Date Automatic Update Rules (Temporal Versions):**
        - **INSERT (new version)**: Previous record end_date = new effective_date - 1; new record end_date = next effective_date - 1 (if any)
        - **UPDATE (change effectiveDate)**: Recalculate adjacent boundaries to maintain continuity
        - **DELETE (remove a version)**: Bridge adjacent records by setting previous end_date = next effective_date - 1
        - **TAIL BEHAVIOR**: Last record has open end (`end_date = null`) and current flag recomputed when applicable
        - **SCOPE**: Only non-deleted records (status ≠ 'DELETED') participate in sequencing
        - **ORDERING/CONSTRAINTS**: Chronological by `effective_date`; prevents overlaps and gaps
        
        **Required Permissions:** `org:create:planned`
      security:
        - OAuth2ClientCredentials: ['org:create:planned']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVersionRequest'
            examples:
              future_version:
                summary: Future Effective Version
                value:
                  name: "技术研发部"
                  unitType: "DEPARTMENT" 
                  description: "重组后的技术部门"
                  parentCode: "1000001"
                  effectiveDate: "2024-04-01"
                  operationReason: "组织架构调整"
              historical_correction:
                summary: Historical Version Correction
                value:
                  name: "原始技术部"
                  unitType: "DEPARTMENT"
                  description: "历史记录补正"
                  parentCode: "1000001"
                  effectiveDate: "2023-01-01"
                  endDate: "2023-12-31"
                  operationReason: "历史数据补正"
      responses:
        '201':
          description: Temporal version created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                data:
                  recordId: "550e8400-e29b-41d4-a716-446655440000"
                  code: "1000028"
                  name: "技术研发部"
                  effectiveDate: "2024-04-01"
                  isCurrent: false
                message: "Temporal version created successfully"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '200':
          description: Idempotent replay - version already exists for the same Idempotency-Key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ORGANIZATION_NOT_FOUND"
                  message: "Organization unit not found"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '409':
          description: Version conflict or date overlap
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "VERSION_CONFLICT"
                  message: "Effective date conflicts with existing version"
                  details:
                    conflictingVersion: "2024-03-01 to 2024-06-30"
                    requestedDate: "2024-04-01"
                timestamp: "2025-08-31T06:30:00Z"
                requestId: "req-123456"
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/events:
    post:
      tags:
        - temporal-operations
      summary: Process organization events
      description: |
        Processes events for organization units such as DEACTIVATE operations.
        This endpoint supports temporal version management operations.
        
        **Event Types:**
        - DEACTIVATE: Soft delete a specific version by setting status to DELETED (by `recordId`)
        
        **Temporal Behavior:**
        - Runs full timeline recomputation in a single transaction after event application
          (bridges adjacent records, opens tail end, recomputes `is_current`)
        - Deleted versions do not participate in temporal continuity checks
        - Returns the latest non-deleted timeline in response to avoid read-cache delays
        
        **Required Permissions:** `org:modify:history`
      security:
        - OAuth2ClientCredentials: ['org:modify:history']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - eventType
                - recordId
                - changeReason
              properties:
                eventType:
                  type: string
                  enum: [DEACTIVATE]
                  description: Type of event to process
                  example: "DEACTIVATE"
                recordId:
                  type: string
                  format: uuid
                  description: UUID of the specific record to deactivate
                  example: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                effectiveDate:
                  type: string
                  format: date
                  description: Effective date for logging purposes (optional)
                  example: "2026-01-01"
                changeReason:
                  type: string
                  maxLength: 500
                  description: Reason for the operation
                  example: "通过组织详情页面作废版本"
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                            example: "1000028"
                          record_id:
                            type: string
                            format: uuid
                            example: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                  description: ACTIVE/INACTIVE/PLANNED (non-DELETED)
                                level:
                                  type: integer
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
                                createdAt:
                                  type: string
                                  format: date-time
                                updatedAt:
                                  type: string
                                  format: date-time
                                parentCode:
                                  type: string
                                  nullable: true
                                description:
                                  type: string
                                  nullable: true
              example:
                success: true
                data:
                  code: "1000028"
                  record_id: "07f91c91-82ee-4bba-afde-9c3d7500f2cd"
                  timeline:
                    - recordId: "11111111-1111-1111-1111-111111111111"
                      code: "1000028"
                      name: "AI治理办公室"
                      unitType: "DEPARTMENT"
                      status: "ACTIVE"
                      level: 2
                      effectiveDate: "2024-11-01"
                      endDate: "2025-07-31"
                      isCurrent: false
                      createdAt: "2025-08-31T09:00:00Z"
                      updatedAt: "2025-09-06T06:00:00Z"
                    - recordId: "22222222-2222-2222-2222-222222222222"
                      code: "1000028"
                      name: "AI治理办公室"
                      unitType: "DEPARTMENT"
                      status: "ACTIVE"
                      level: 2
                      effectiveDate: "2025-08-01"
                      endDate: null
                      isCurrent: true
                      createdAt: "2025-09-01T09:00:00Z"
                      updatedAt: "2025-09-06T06:05:00Z"
                message: "版本作废成功"
                timestamp: "2025-08-31T09:17:43Z"
                requestId: "3f975f9b-6cf9-4e14-956b-2435d1a802bd"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Organization unit or record not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ORGANIZATION_NOT_FOUND"
                  message: "Organization unit not found"
                timestamp: "2025-08-31T09:17:43Z"
                requestId: "req-123456"
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/suspend:
    post:
      tags:
        - business-operations
      summary: Suspend organization unit
      description: |
        Suspends an organization unit by setting status=INACTIVE and operationType=SUSPEND.
        This is a specialized business operation with dedicated endpoint to ensure clear intent.
        
        **Business Use Case:** 用于因业务调整而暂时停用部门，支持后续重新启用。
        这是业务流程层面的操作，用于组织架构的临时调整，预期会在适当时机重新启用。
        
        **Business Logic:**
        - Forces status=INACTIVE regardless of request body
        - Sets operationType=SUSPEND automatically
        - Supports future-effective suspension planning
        - Records complete audit trail
        
        **Temporal Behavior:**
        - Inserts a temporal version with status=INACTIVE at the specified effectiveDate
        - Recomputes adjacent boundaries in a single transaction (prev.end_date = new.effective_date - 1; tail open)
        - Recomputes `is_current` according to the latest effectiveDate ≤ today
        - Returns latest non-deleted timeline in response to avoid read-cache delays
        
        **Required Permissions:** `org:suspend`
      security:
        - OAuth2ClientCredentials: ['org:suspend']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuspendOrganizationRequest'
            examples:
              immediate_suspension:
                summary: Immediate Suspension
                value:
                  operationReason: "业务调整需要"
                  effectiveDate: "2025-08-23"
              planned_suspension:
                summary: Future Planned Suspension
                value:
                  operationReason: "业务重组，部门合并"
                  effectiveDate: "2025-09-01"
      responses:
        '200':
          description: Organization unit suspended successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                          status:
                            type: string
                          operationType:
                            type: string
                          operationReason:
                            type: string
                          effectiveDate:
                            type: string
                            format: date
                          updatedAt:
                            type: string
                            format: date-time
                          isCurrent:
                            type: boolean
                          isFuture:
                            type: boolean
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
              examples:
                suspension_success:
                  summary: Successful Suspension (with timeline)
                  value:
                    success: true
                    message: "Organization unit suspended successfully"
                    data:
                      code: "1000001"
                      status: "INACTIVE"
                      operationType: "SUSPEND"
                      operationReason: "业务调整需要"
                      effectiveDate: "2025-08-23"
                      updatedAt: "2025-08-23T10:30:00Z"
                      isCurrent: true
                      isFuture: false
                      timeline:
                        - recordId: "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
                          code: "1000001"
                          name: "某组织"
                          unitType: "DEPARTMENT"
                          status: "INACTIVE"
                          effectiveDate: "2025-08-23"
                          endDate: null
                          isCurrent: true
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_suspend_1000001"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/activate:
    post:
      tags:
        - business-operations
      summary: Activate organization unit
      description: |
        Activates an organization unit by setting status=ACTIVE and operationType=REACTIVATE.
        This is the symmetric operation to suspend, ensuring clear business intent.
        
        **Business Use Case:** 用于重新启用已停用的组织，恢复业务运营。
        与停用操作形成完整的业务循环，是业务流程恢复操作，用于重新投入组织运营。
        
        **Business Logic:**
        - Forces status=ACTIVE regardless of request body
        - Sets operationType=REACTIVATE automatically
        - Supports future-effective activation planning
        - Can cancel planned suspension operations
        
        **Temporal Behavior:**
        - Inserts a temporal version with status=ACTIVE at the specified effectiveDate
        - Recomputes adjacent boundaries in a single transaction; tail remains open
        - Recomputes `is_current` and returns latest non-deleted timeline
        
        **Required Permissions:** `org:activate`
      security:
        - OAuth2ClientCredentials: ['org:activate']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivateOrganizationRequest'
            examples:
              immediate_activation:
                summary: Immediate Activation
                value:
                  operationReason: "恢复业务运营"
                  effectiveDate: "2025-08-23"
              cancel_planned_suspension:
                summary: Cancel Planned Suspension
                value:
                  operationReason: "计划变更，继续运营"
                  effectiveDate: "2025-09-01"
      responses:
        '200':
          description: Organization unit activated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          code:
                            type: string
                          status:
                            type: string
                          operationType:
                            type: string
                          operationReason:
                            type: string
                          effectiveDate:
                            type: string
                            format: date
                          updatedAt:
                            type: string
                            format: date-time
                          isCurrent:
                            type: boolean
                          isFuture:
                            type: boolean
                          timeline:
                            type: array
                            description: Latest non-deleted timeline after recomputation
                            items:
                              type: object
                              properties:
                                recordId:
                                  type: string
                                  format: uuid
                                code:
                                  type: string
                                name:
                                  type: string
                                unitType:
                                  type: string
                                status:
                                  type: string
                                effectiveDate:
                                  type: string
                                  format: date
                                endDate:
                                  type: string
                                  format: date
                                  nullable: true
                                isCurrent:
                                  type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/validate:
    post:
      tags:
        - data-validation
      summary: Validate organization unit data
      description: |
        Validates organization unit data without actually creating or modifying records.
        Uses the same validation logic as actual operations to ensure consistency.
        
        **Validation Layers:**
        1. **Database Constraints**: Time logic, immutable fields
        2. **Business Rules**: Parent-child relationships, operation sequences
        3. **Configurable Rules**: Temporal constraints, hierarchy limits
        
        **Required Permissions:** `org:validate`
      security:
        - OAuth2ClientCredentials: ['org:validate']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateOrganizationRequest'
            examples:
              create_validation:
                summary: Validate New Organization
                value:
                  operation: "create"
                  data:
                    name: "测试部门"
                    unitType: "DEPARTMENT"
                    parentCode: "1000000"
                    effectiveDate: "2025-08-23"
                  dryRun: true
              suspend_validation:
                summary: Validate Suspension Operation
                value:
                  operation: "suspend"
                  data:
                    code: "1000001"
                    status: "INACTIVE"
                    effectiveDate: "2025-09-01"
                  dryRun: true
      responses:
        '200':
          description: Validation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
              examples:
                validation_success:
                  summary: Validation Passed
                  value:
                    success: true
                    message: "Validation completed successfully"
                    data:
                      valid: true
                      warnings: ["父组织将在6个月后过期"]
                      errors: []
                      suggestions: ["建议设置结束日期以明确停用期限"]
                      validationDetails:
                        temporalCheck: "PASS"
                        parentChildCheck: "PASS"
                        operationSequenceCheck: "PASS"
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_validate_001"
                validation_failure:
                  summary: Validation Failed
                  value:
                    success: true
                    message: "Validation completed with errors"
                    data:
                      valid: false
                      warnings: []
                      errors: 
                        - "Parent organization unit does not exist"
                        - "Effective date cannot be more than 365 days in future"
                      suggestions: 
                        - "Verify parent code '1000999' exists"
                        - "Adjust effective date to within policy limits"
                      validationDetails:
                        temporalCheck: "FAIL"
                        parentChildCheck: "FAIL"
                        operationSequenceCheck: "PASS"
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_validate_002"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/{code}/refresh-hierarchy:
    post:
      tags:
        - maintenance
      summary: Manual hierarchy refresh for single organization
      description: |
        Manually refreshes hierarchy data (paths, levels, depths) for a specific organization
        and its subtree. This is a maintenance tool for data repair scenarios.
        
        **Use Cases:**
        - Data migration recovery
        - Database direct modification repair
        - System exception recovery
        - Performance optimization
        
        **⚠️ Important:** This is NOT for normal business operations. Use business
        endpoints (POST/PUT/PATCH) for regular operations which trigger automatic cascade updates.
        
        **Required Permissions:** `org:maintenance`
      security:
        - OAuth2ClientCredentials: ['org:maintenance']
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/CodePathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshHierarchyRequest'
            examples:
              single_refresh:
                summary: Single Organization Refresh
                value:
                  reason: "数据迁移后的路径修复"
                  force: false
                  dryRun: false
              dry_run_check:
                summary: Dry Run Preview
                value:
                  reason: "检查修复范围"
                  force: false
                  dryRun: true
      responses:
        '200':
          description: Hierarchy refresh completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                refresh_success:
                  summary: Successful Refresh
                  value:
                    success: true
                    message: "Hierarchy refresh completed successfully"
                    data:
                      processedUnits: 12
                      updatedPaths: 12
                      updatedLevels: 12
                      executionTimeMs: 245
                      affectedCodes: ["1000001", "1000011", "1000012"]
                    timestamp: "2025-08-23T10:30:00Z"
                    requestId: "req_refresh_1000001"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/organization-units/batch-refresh-hierarchy:
    post:
      tags:
        - maintenance
      summary: Batch hierarchy refresh for multiple organizations
      description: |
        Batch refreshes hierarchy data for multiple organizations or entire tenant.
        This is a powerful maintenance tool requiring special permissions and careful use.
        
        **⚠️ Critical Operation:** This operation can affect large amounts of data and impact
        system performance. Always test with dryRun=true first.
        
        **Required Permissions:** `org:batch-operations`
      security:
        - OAuth2ClientCredentials: ['org:batch-operations']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRefreshHierarchyRequest'
            examples:
              tenant_refresh:
                summary: Full Tenant Refresh
                value:
                  tenantFilter: "987fcdeb-51a2-43d7-8f9e-123456789012"
                  reason: "系统迁移后的全量路径重建"
                  dryRun: true
                  maxUnits: 1000
              selective_refresh:
                summary: Selective Units Refresh
                value:
                  targetCodes: ["1000000", "2000000"]
                  reason: "特定组织的层级修复"
                  dryRun: false
                  maxUnits: 100
      responses:
        '200':
          description: Batch hierarchy refresh completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/corehr/organizations:
    post:
      tags:
        - corehr-compatibility
      summary: Create organization (CoreHR compatible)
      description: |
        CoreHR-compatible organization creation endpoint that maps to OrganizationUnit entity.
        Provides compatibility layer for existing CoreHR frontend modules.
        
        **Note:** Query operations for CoreHR compatibility now use GraphQL endpoints
        as per strict CQRS compliance. Use GraphQL queries for data retrieval.
        
        **Required Permissions:** `org:create`
      security:
        - OAuth2ClientCredentials: ['org:create']
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationUnitRequest'
      responses:
        '201':
          description: Organization created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    OAuth2ClientCredentials:
      type: oauth2
      description: |
        OAuth 2.0 Client Credentials Flow for machine-to-machine authentication.
        
        **Token Endpoint:** `POST /oauth/token`
        **Grant Type:** `client_credentials`
        **Token Type:** Bearer JWT
        **Expiration:** 1-4 hours (configurable)
      flows:
        clientCredentials:
          tokenUrl: /oauth/token
          scopes:
            # 基础CRUD权限
            'org:read': Read organization unit information
            'org:create': Create organization units
            'org:update': Update organization unit basic information
            
            # 状态管理权限
            'org:suspend': Suspend organization units
            'org:activate': Activate organization units
            
            # 层级结构权限
            'org:read:hierarchy': Read organization hierarchy structure
            'org:move': Move organization units in hierarchy
            'org:create:child': Create child organization units
            
            # 时态数据权限 (Temporal Data Permissions)
            'org:read:history': Read organization historical data
            'org:read:future': Read organization future-effective data
            'org:create:planned': Create planned/future-effective changes
            'org:modify:history': Modify historical data (temporal correction)
            'org:cancel:planned': Cancel planned/future-effective changes
            
            # 审计和统计权限
            'org:read:audit': Read audit history records
            'org:read:stats': Get organization statistics
            'org:read:timeline': View organization operation timeline
            
            # 系统管理权限
            'org:validate': Data validity validation
            'org:maintenance': Hierarchy consistency check and repair
            'org:batch-operations': Batch operations permission

  parameters:
    CodePathParam:
      name: code
      in: path
      required: true
      schema:
        type: string
        pattern: '^[1-9][0-9]{6}$'
        example: "1000001"
      description: |
        7-digit organization unit code (1000000-9999999).
        This is the primary business identifier for organization units.
    TenantIdHeader:
      name: X-Tenant-ID
      in: header
      required: true
      schema:
        type: string
        format: uuid
        example: "987fcdeb-51a2-43d7-8f9e-123456789012"
      description: |
        **REQUIRED** Tenant isolation identifier for multi-tenant data security.
        
        **Security Warning**: This header is MANDATORY for all API operations. 
        Missing this header may result in data access issues or operations 
        being performed against the default tenant.
        
        **Format**: Must be a valid UUID v4 format.
        **Usage**: Include in all API requests to ensure proper data isolation.
    IdempotencyKeyHeader:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
        maxLength: 128
        pattern: '^[A-Za-z0-9._:-]{8,128}$'
        example: 'org-activate-1000001-20250823-abc123'
      description: |
        Optional idempotency key to make POST operations idempotent within a 24h window.
        When provided, repeated requests with the same key return 200 with the original result.

  schemas:
    OrganizationUnit:
      type: object
      description: Complete organization unit model with temporal and audit data
      required:
        - code
        - tenantId
        - name
        - unitType
        - status
        - isDeleted
        - level
        - hierarchyDepth
        - codePath
        - namePath
        - sortOrder
        - createdAt
        - updatedAt
        - operationType
        - operatedBy
        - effectiveDate
        - isCurrent
        - isFuture
        - recordId
      properties:
        code:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          description: 7-digit organization code (primary business identifier)
          example: "1000001"
        parentCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          description: Parent organization code (null for root units)
          example: "1000000"
        tenantId:
          type: string
          format: uuid
          description: Tenant isolation identifier
          example: "987fcdeb-51a2-43d7-8f9e-123456789012"
        name:
          type: string
          maxLength: 255
          description: Organization unit name
          example: "技术部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        status:
          $ref: '#/components/schemas/Status'
        isDeleted:
          type: boolean
          description: Soft deletion flag (independent from business status)
          example: false
        level:
          type: integer
          minimum: 1
          maximum: 17
          description: Hierarchy level (1-17)
          example: 2
        hierarchyDepth:
          type: integer
          minimum: 1
          maximum: 17
          description: Hierarchy depth cache (synchronized with level)
          example: 2
        codePath:
          type: string
          maxLength: 2000
          description: Hierarchy path using codes (/1000000/1000001)
          example: "/1000000/1000001"
        namePath:
          type: string
          maxLength: 4000
          description: Human-readable hierarchy path (/Company/Department)
          example: "/高谷集团/技术部"
        sortOrder:
          type: integer
          description: Sorting order within same level
          default: 0
          example: 0
        description:
          type: string
          nullable: true
          maxLength: 1000
          description: Organization unit description
          example: "技术研发部门"
        profile:
          type: object
          description: |
            Flexible JSON configuration for organization-specific data.
            Structure is defined by business requirements rather than predefined schemas.
            
            **Common usage:**
            - Custom business attributes
            - Integration identifiers  
            - Type-specific metadata
          default: {}
          example:
            budget: 5000000
            costCenter: "CC001"
            customField1: "value1"
        createdAt:
          type: string
          format: date-time
          description: Record creation timestamp
          example: "2025-08-05T11:23:01.426455Z"
        updatedAt:
          type: string
          format: date-time
          description: Last operation timestamp (meaning defined by operationType)
          example: "2025-08-23T06:13:47.072807Z"
        operationType:
          $ref: '#/components/schemas/OperationType'
        operatedBy:
          $ref: '#/components/schemas/OperatedBy'
        operationReason:
          type: string
          nullable: true
          maxLength: 500
          description: Reason for the operation
          example: "预算调整和人员编制优化"
        effectiveDate:
          type: string
          format: date
          description: Record effective date (supports future operations)
          example: "2025-08-05"
        isCurrent:
          type: boolean
          description: Dynamic field - whether record is effective on specified date
          example: true
        isFuture:
          type: boolean
          description: Dynamic field - whether record is future effective
          example: false
        recordId:
          type: string
          format: uuid
          description: Global unique record identifier for audit
          example: "123e4567-e89b-12d3-a456-426614174000"

    UnitType:
      type: string
      enum:
        - DEPARTMENT
        - ORGANIZATION_UNIT
        - COMPANY
        - PROJECT_TEAM
      description: |
        Organization unit types:
        - **DEPARTMENT**: Regular business department
        - **ORGANIZATION_UNIT**: Generic organizational unit
        - **COMPANY**: Legal entity company
        - **PROJECT_TEAM**: Temporary project team
      example: "DEPARTMENT"

    Status:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
      description: |
        Business status of organization unit:
        - **ACTIVE**: Actively operating unit
        - **INACTIVE**: Non-active but existing unit
      default: "ACTIVE"
      example: "ACTIVE"

    OperationType:
      type: string
      enum:
        - CREATE
        - UPDATE
        - SUSPEND
        - REACTIVATE
        - DEACTIVATE
      description: |
        Operation types (automatically set by API endpoints):
        - **CREATE**: New organization creation
        - **UPDATE**: Data modification (PUT/PATCH)
        - **SUSPEND**: Suspension operation (/suspend endpoint)
        - **REACTIVATE**: Reactivation operation (/activate endpoint)
        - **DEACTIVATE**: Version deactivation operation (/events endpoint)
      readOnly: true
      example: "UPDATE"

    OperatedBy:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
          description: Operator user ID
          example: "456e7890-e89b-12d3-a456-426614174002"
        name:
          type: string
          description: Operator display name (English)
          example: "Li Si"
      description: |
        Standard operator information structure used across all endpoints.
        Provides both machine-readable ID and human-readable name for audit trails.

    AnalysisType:
      type: string
      enum:
        - SUMMARY
        - DETAILED
      description: |
        Analysis depth for change analysis queries:
        - **SUMMARY**: High-level summary analysis
        - **DETAILED**: Detailed field-by-field analysis with impact assessment
      default: "SUMMARY"
      example: "DETAILED"

    ConsistencyCheckMode:
      type: string
      enum:
        - FAST
        - DEEP
        - TARGETED
      description: |
        Consistency check modes with different performance characteristics:
        - **FAST**: Cache field consistency only (< 5s)
        - **DEEP**: Full recursive validation (30s-5min data dependent)
        - **TARGETED**: Specific area focus validation (< 30s)
      default: "FAST"
      example: "DEEP"

    SearchField:
      type: string
      enum:
        - NAME
        - DESCRIPTION
        - CODE_PATH
        - NAME_PATH
      description: |
        Search fields for text-based filtering:
        - **NAME**: Search in organization name
        - **DESCRIPTION**: Search in description field
        - **CODE_PATH**: Search in hierarchy code path
        - **NAME_PATH**: Search in hierarchy name path
      example: "NAME"

    SortField:
      type: string
      enum:
        - CODE
        - NAME
        - CREATED_AT
        - UPDATED_AT
        - EFFECTIVE_DATE
        - LEVEL
        - SORT_ORDER
      description: |
        Sorting field options:
        - **CODE**: Sort by organization code
        - **NAME**: Sort by organization name
        - **CREATED_AT**: Sort by creation timestamp
        - **UPDATED_AT**: Sort by last update timestamp
        - **EFFECTIVE_DATE**: Sort by effective date
        - **LEVEL**: Sort by hierarchy level
        - **SORT_ORDER**: Sort by sort order value
      example: "NAME"

    SortOrder:
      type: string
      enum:
        - ASC
        - DESC
      description: |
        Sorting order options:
        - **ASC**: Ascending order (A-Z, 0-9, oldest first)
        - **DESC**: Descending order (Z-A, 9-0, newest first)
      default: "ASC"
      example: "DESC"

    CreateOrganizationUnitRequest:
      type: object
      required:
        - name
        - unitType
        - effectiveDate
        - operationReason
      properties:
        name:
          type: string
          maxLength: 255
          description: Organization unit name
          example: "新部门"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          description: Parent organization code (null for root level)
          example: "1000000"
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Organization description
          example: "新创建的部门"
        sortOrder:
          type: integer
          default: 0
          description: Sorting order within same level
        profile:
          type: object
          default: {}
          description: Type-specific configuration
          example:
            budget: 5000000
            costCenterCode: "CC001"
        effectiveDate:
          type: string
          format: date
          description: Record effective date
          example: "2025-08-23"
        operationReason:
          type: string
          maxLength: 500
          description: Reason for creation
          example: "业务扩展需要"

    CreateVersionRequest:
      type: object
      description: |
        Request to create a new temporal version for an existing organization unit.
        Supports both historical corrections and future-effective versions.
      required:
        - name
        - unitType
        - effectiveDate
        - operationReason
      properties:
        name:
          type: string
          maxLength: 255
          description: Organization unit name for this version
          example: "技术研发部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          description: Parent organization code (null for root level)
          example: "1000001"
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Version-specific description
          example: "重组后的技术部门，专注人工智能研发"
        sortOrder:
          type: integer
          default: 0
          description: Sorting order within same level
        profile:
          type: object
          default: {}
          description: Version-specific configuration
          example:
            budget: 8000000
            headCountLimit: 45
            costCenterCode: "CC-TECH-2024"
        effectiveDate:
          type: string
          format: date
          description: When this version becomes effective
          example: "2024-04-01"
        operationReason:
          type: string
          maxLength: 500
          description: Reason for creating this version
          example: "组织架构调整，加强技术研发能力"

    ReplaceOrganizationUnitRequest:
      type: object
      description: |
        Complete resource replacement request. All fields must be provided as
        missing fields will be reset to defaults (HTTP PUT semantics).
      required:
        - name
        - unitType
        - parentCode
        - status
        - sortOrder
        - profile
        - effectiveDate
        - operationReason
      properties:
        name:
          type: string
          maxLength: 255
          example: "技术研发部"
        unitType:
          $ref: '#/components/schemas/UnitType'
        parentCode:
          type: string
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          example: "1000000"
        description:
          type: string
          maxLength: 1000
          nullable: true
          example: "负责产品研发、技术创新和系统架构设计"
        status:
          $ref: '#/components/schemas/Status'
        sortOrder:
          type: integer
          example: 0
        profile:
          type: object
          description: Complete profile configuration
          example:
            budget: 6000000
            managerPositionCode: "POS-789e0123"
            costCenterCode: "CC001"
            headCountLimit: 60
            establishedDate: "2024-01-01"
        effectiveDate:
          type: string
          format: date
          example: "2025-08-23"
        endDate:
          type: string
          format: date
          nullable: true
        operationReason:
          type: string
          maxLength: 500
          example: "组织架构全面重构"

    UpdateOrganizationUnitRequest:
      type: object
      description: |
        Partial update request. Only provided fields are modified, others remain unchanged.
        **Cannot be used to change status** - use dedicated suspend/activate endpoints.
      required:
        - operationReason
      properties:
        name:
          type: string
          maxLength: 255
          example: "技术研发部"
        description:
          type: string
          maxLength: 1000
          nullable: true
          example: "负责产品研发、技术创新和系统架构设计"
        sortOrder:
          type: integer
          example: 0
        profile:
          type: object
          description: Partial profile updates (merged with existing)
          example:
            budget: 6000000
            headCountLimit: 60
        effectiveDate:
          type: string
          format: date
          description: Update effective date
          example: "2025-08-23"
        operationReason:
          type: string
          maxLength: 500
          description: Reason for update (required)
          example: "预算调整和人员编制优化"

    SuspendOrganizationRequest:
      type: object
      required:
        - operationReason
        - effectiveDate
      properties:
        operationReason:
          type: string
          maxLength: 500
          description: Reason for suspension
          example: "业务调整需要"
        effectiveDate:
          type: string
          format: date
          description: Suspension effective date (supports future dates)
          example: "2025-08-23"

    ActivateOrganizationRequest:
      type: object
      required:
        - operationReason
        - effectiveDate
      properties:
        operationReason:
          type: string
          maxLength: 500
          description: Reason for activation
          example: "恢复业务运营"
        effectiveDate:
          type: string
          format: date
          description: Activation effective date
          example: "2025-08-23"

    ValidateOrganizationRequest:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          description: Organization data to validate (basic format validation)
          example:
            name: "测试部门"
            unitType: "DEPARTMENT"
            parentCode: "1000000"
            effectiveDate: "2025-08-23"
        dryRun:
          type: boolean
          default: true
          description: Whether this is a dry run validation
          example: true

    RefreshHierarchyRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          maxLength: 500
          description: Reason for manual refresh
          example: "数据迁移后的路径修复"
        force:
          type: boolean
          default: false
          description: Force refresh even if operations are in progress
          example: false
        dryRun:
          type: boolean
          default: false
          description: Preview mode - don't actually execute changes
          example: false

    BatchRefreshHierarchyRequest:
      type: object
      required:
        - reason
      properties:
        tenantFilter:
          type: string
          format: uuid
          nullable: true
          description: Limit refresh to specific tenant
          example: "987fcdeb-51a2-43d7-8f9e-123456789012"
        targetCodes:
          type: array
          items:
            type: string
            pattern: '^[1-9][0-9]{6}$'
          nullable: true
          description: Specific organization codes to refresh
          example: ["1000000", "2000000"]
        reason:
          type: string
          maxLength: 500
          description: Reason for batch refresh
          example: "系统迁移后的全量路径重建"
        dryRun:
          type: boolean
          default: true
          description: Preview mode (always recommended first)
          example: true
        maxUnits:
          type: integer
          minimum: 1
          maximum: 10000
          default: 1000
          description: Maximum units to process (safety limit)
          example: 1000

    ValidationResult:
      type: object
      properties:
        valid:
          type: boolean
          description: Whether validation passed overall
        warnings:
          type: array
          items:
            type: string
          description: Non-blocking warnings
        errors:
          type: array
          items:
            type: string
          description: Validation errors that must be fixed
        suggestions:
          type: array
          items:
            type: string
          description: Recommended improvements
        validationDetails:
          type: object
          properties:
            temporalCheck:
              type: string
              enum: [PASS, FAIL]
            parentChildCheck:
              type: string
              enum: [PASS, FAIL]
            operationSequenceCheck:
              type: string
              enum: [PASS, FAIL]

    SuccessResponse:
      type: object
      description: |
        Unified enterprise envelope for successful responses.
        All successful API responses use this consistent structure.
      required:
        - success
        - data
        - message
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Always true for successful responses
          example: true
        data:
          type: object
          description: Actual business data (varies by endpoint)
        message:
          type: string
          description: Human-readable success message (English)
          example: "Organization unit created successfully"
        timestamp:
          type: string
          format: date-time
          description: Response timestamp (ISO 8601)
          example: "2025-08-23T15:00:00Z"
        requestId:
          type: string
          description: Unique request identifier for tracing
          example: "req_create_1000008"

    ErrorResponse:
      type: object
      description: |
        Unified enterprise envelope for error responses.
        All error responses use this consistent structure for easier client handling.
      required:
        - success
        - error
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "ORG_UNIT_NOT_FOUND"
            message:
              type: string
              description: Human-readable error message (English)
              example: "Organization unit not found"
            details:
              type: object
              nullable: true
              description: Additional error context (varies by error type)
        timestamp:
          type: string
          format: date-time
          description: Error timestamp (ISO 8601)
          example: "2025-08-23T10:30:00Z"
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: "req_error_12345678"

  responses:
    BadRequest:
      description: |
        Bad Request - Invalid input data, validation errors, or malformed requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validation_error:
              summary: Validation Error
              value:
                success: false
                error:
                  code: "VALIDATION_ERROR"
                  message: "Request validation failed"
                  details:
                    field: "effectiveDate"
                    reason: "Date cannot be more than 365 days in future"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_validation_error_001"
            incomplete_resource:
              summary: Incomplete Resource (PUT)
              value:
                success: false
                error:
                  code: "INCOMPLETE_RESOURCE"
                  message: "PUT request missing required fields"
                  details:
                    missingFields: ["name", "unitType", "status"]
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_incomplete_001"
            readonly_field:
              summary: Read-only Field Update (PATCH)
              value:
                success: false
                error:
                  code: "READONLY_FIELD"
                  message: "Cannot modify read-only field"
                  details:
                    field: "operationType"
                    reason: "operationType is automatically set by API endpoints"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_readonly_001"

    Unauthorized:
      description: |
        Unauthorized - Authentication required or invalid access token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalid_token:
              summary: Invalid Access Token
              value:
                success: false
                error:
                  code: "INVALID_TOKEN"
                  message: "Invalid or expired access token"
                  details:
                    errorDescription: "The access token provided is invalid, expired, or malformed"
                    errorUri: "https://docs.api.yourcompany.com/errors/invalid-token"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_001"
            token_expired:
              summary: Token Expired
              value:
                success: false
                error:
                  code: "TOKEN_EXPIRED"
                  message: "Access token has expired"
                  details:
                    expiredAt: "2025-08-23T09:30:00Z"
                    errorDescription: "Please obtain a new access token using your client credentials"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_002"

    Forbidden:
      description: |
        Forbidden - Insufficient permissions or access denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            insufficient_permissions:
              summary: Insufficient Permissions
              value:
                success: false
                error:
                  code: "INSUFFICIENT_PERMISSIONS"
                  message: "Insufficient permissions to access this resource"
                  details:
                    requiredPermissions: ["org:modify:history"]
                    currentPermissions: ["org:read", "org:update"]
                    resource: "/api/v1/organization-units/1000001"
                    action: "DEACTIVATE"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_003"
            tenant_access_denied:
              summary: Tenant Access Denied
              value:
                success: false
                error:
                  code: "TENANT_ACCESS_DENIED"
                  message: "Access denied to specified tenant resources"
                  details:
                    requestedTenant: "tenant-uuid-456"
                    authorizedTenants: ["tenant-uuid-123"]
                    errorDescription: "Your credentials do not have access to the requested tenant"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_auth_error_004"

    NotFound:
      description: |
        Not Found - Organization unit or related resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            org_unit_not_found:
              summary: Organization Unit Not Found
              value:
                success: false
                error:
                  code: "ORG_UNIT_NOT_FOUND"
                  message: "Organization unit not found"
                  details:
                    code: "1000999"
                    searchContext: "current active units"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_not_found_001"

    Conflict:
      description: |
        Conflict - Business rule violation, constraint conflicts, or resource conflicts.
        Typical temporal conflicts include:
        - TEMPORAL_POINT_CONFLICT: unique (tenant_id, code, effective_date) violation
        - CURRENT_CONFLICT: partial unique (tenant_id, code) WHERE is_current=true violation
        - TEMPORAL_GAP_VIOLATION: Time gap detected in temporal sequence
        - TEMPORAL_OVERLAP_VIOLATION: Time overlap detected between versions
        - TEMPORAL_BOUNDARY_CONFLICT: Boundary calculation conflict during concurrent updates
        - TEMPORAL_TRANSACTION_FAILED: Temporal recomputation transaction failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            temporal_point_conflict:
              summary: Temporal Point Unique Conflict
              value:
                success: false
                error:
                  code: "TEMPORAL_POINT_CONFLICT"
                  message: "(tenant_id, code, effective_date) must be unique"
                  details:
                    code: "1000001"
                    effectiveDate: "2025-08-23"
                    tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_conflict_temporal_point_001"
            current_conflict:
              summary: Single Current Constraint Conflict
              value:
                success: false
                error:
                  code: "CURRENT_CONFLICT"
                  message: "Only one current record per (tenant_id, code) is allowed"
                  details:
                    code: "1000001"
                    tenantId: "987fcdeb-51a2-43d7-8f9e-123456789012"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_conflict_current_001"
            circular_reference:
              summary: Circular Reference Error
              value:
                success: false
                error:
                  code: "CIRCULAR_REFERENCE"
                  message: "Operation would create circular reference"
                  details:
                    conflictPath: ["1000001", "1000002", "1000001"]
                    resolution: "Verify parent-child relationships"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_circular_ref_001"
            has_child_units:
              summary: Cannot Delete - Has Children
              value:
                success: false
                error:
                  code: "HAS_CHILD_UNITS"
                  message: "Cannot delete organization unit with child units"
                  details:
                    childUnits: ["1000011", "1000012"]
                    affectedCount: 2
                    resolution: "Delete or reassign child units first"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_delete_conflict_001"
            temporal_gap_violation:
              summary: Temporal Gap Violation
              value:
                success: false
                error:
                  code: "TEMPORAL_GAP_VIOLATION"
                  message: "Time gap detected in temporal sequence"
                  details:
                    code: "1000001"
                    gapPeriod: "2024-01-01 to 2024-12-31"
                    previousEndDate: "2023-12-31"
                    nextEffectiveDate: "2025-01-01"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_gap_001"
            temporal_overlap_violation:
              summary: Temporal Overlap Violation
              value:
                success: false
                error:
                  code: "TEMPORAL_OVERLAP_VIOLATION"
                  message: "Time overlap detected between versions"
                  details:
                    code: "1000001"
                    conflictingVersions: [
                      { "recordId": "uuid1", "period": "2025-06-01 to 2025-08-31" },
                      { "recordId": "uuid2", "period": "2025-07-01 to 2025-09-30" }
                    ]
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_overlap_001"
            temporal_boundary_conflict:
              summary: Temporal Boundary Calculation Conflict
              value:
                success: false
                error:
                  code: "TEMPORAL_BOUNDARY_CONFLICT"
                  message: "Boundary calculation conflict during concurrent updates"
                  details:
                    code: "1000001"
                    conflictType: "CONCURRENT_MODIFICATION"
                    expectedVersion: 5
                    actualVersion: 7
                    resolution: "Retry with latest version"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_boundary_conflict_001"
            temporal_transaction_failed:
              summary: Temporal Transaction Rollback
              value:
                success: false
                error:
                  code: "TEMPORAL_TRANSACTION_FAILED"
                  message: "Temporal recomputation transaction failed and was rolled back"
                  details:
                    code: "1000001"
                    operationType: "DELETE_VERSION"
                    affectedRecords: 3
                    rollbackReason: "Constraint violation during boundary update"
                    retryable: true
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_temporal_tx_failed_001"

    InternalError:
      description: |
        Internal Server Error - System errors, database issues, or unexpected failures
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            database_error:
              summary: Database Connection Error
              value:
                success: false
                error:
                  code: "DATABASE_ERROR"
                  message: "Database connection failed"
                  details:
                    errorType: "CONNECTION_TIMEOUT"
                    retryable: true
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_db_error_001"
            internal_error:
              summary: Generic Internal Error
              value:
                success: false
                error:
                  code: "INTERNAL_ERROR"
                  message: "An unexpected error occurred"
                  details:
                    errorId: "ERR_20250823_103000_001"
                    supportContact: "api-support@yourcompany.com"
                timestamp: "2025-08-23T10:30:00Z"
                requestId: "req_internal_error_001"
