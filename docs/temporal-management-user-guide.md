# 时态管理系统用户指南

## 🚀 系统概述

Cube Castle时态管理系统基于纯日期生效模型，为企业组织架构管理提供了完整的历史追踪、版本管理和时间线可视化功能。

### 核心特性
- ✅ **纯日期生效模型** - 符合SAP、Oracle HCM等企业级标准
- ✅ **强制时间连续性** - 自动填补时间空洞，保证数据完整性
- ✅ **事件驱动架构** - 支持CREATE、UPDATE、RESTRUCTURE、DISSOLVE等操作
- ✅ **实时数据同步** - CDC机制保证数据一致性(<300ms)
- ✅ **可视化时间线** - 直观展示组织变更历史
- ✅ **智能缓存系统** - Redis缓存+精确失效，查询性能提升120倍

## 📋 系统架构

### 服务端点
- **前端界面**: http://localhost:3000
- **查询服务** (GraphQL): http://localhost:8090 
- **命令服务** (REST): http://localhost:9090
- **时态管理服务**: http://localhost:9091 ⭐

### 核心概念
- **生效日期** (`effective_date`): 记录开始生效的日期
- **结束日期** (`end_date`): 记录失效的日期（可选）
- **当前有效** (`is_current`): 标识当前是否为有效记录
- **变更原因** (`change_reason`): 记录变更的业务原因

## 📱 功能使用指南

### 1. 时态查询功能

#### 1.1 时间点查询
查询特定时间点的组织架构状态，支持历史审计和合规检查。

**使用场景**:
- 季度末组织架构状态查询
- 历史时点的人员归属查询
- 合规性审计报告生成

**操作步骤**:
1. 进入组织管理页面
2. 点击"时态管理"按钮
3. 选择目标组织
4. 在查询面板中选择"时间点查询"
5. 设置查询日期（如：2025-06-30）
6. 查看该时点的组织状态

**API调用示例**:
```bash
curl "http://localhost:9091/api/v1/organization-units/1000056/temporal?as_of_date=2025-08-11"
```

#### 1.2 时间范围查询
查询指定时间范围内的所有组织变更记录。

**使用场景**:
- 月度/季度组织变更分析
- 变更频率统计
- 业务影响评估

**操作步骤**:
1. 选择"时间范围查询"模式
2. 设置开始日期和结束日期
3. 可选择包含历史记录、未来规划
4. 查看时间范围内的所有版本

### 2. 组织变更管理

#### 2.1 创建新版本
通过事件驱动机制创建组织的新时态版本。

**支持的事件类型**:
- **UPDATE**: 组织信息更新（名称、描述、状态等）
- **RESTRUCTURE**: 组织重构（层级调整、归属变更）
- **DISSOLVE**: 组织解散
- **ACTIVATE/DEACTIVATE**: 组织激活/停用

**操作步骤**:
1. 在时态管理界面中，点击"新增版本"按钮
2. 填写变更表单：
   - 选择事件类型
   - 设置生效日期
   - 修改组织信息
   - 填写变更原因
3. 提交后系统自动处理时间连续性
4. 查看新版本在时间轴中的位置

**表单字段说明**:
- **组织名称**: 新版本的组织名称
- **组织类型**: COMPANY, DEPARTMENT, TEAM等
- **状态**: ACTIVE, INACTIVE, PLANNED
- **生效日期**: 新版本开始生效的日期
- **变更原因**: 业务原因描述（必填）

#### 2.2 编辑现有版本
修改未来生效的计划版本，历史版本不可修改。

**编辑规则**:
- ✅ **未来版本**: 可自由编辑所有字段
- ⚠️ **当前版本**: 仅可修改部分字段，需谨慎操作
- ❌ **历史版本**: 不可编辑，保持数据完整性

**操作步骤**:
1. 在时间轴导航中选择目标版本
2. 点击"编辑"按钮（仅对可编辑版本可用）
3. 修改相关字段
4. 保存变更

#### 2.3 删除版本
删除不需要的时态版本，系统自动填补时间空洞。

**删除策略**:
- **智能时间填补**: 自动调整相邻版本的生效期间
- **强制连续性**: 确保时间线无空洞
- **数据完整性**: 删除操作原子性执行

**操作步骤**:
1. 选择要删除的版本
2. 点击"作废"按钮
3. 确认删除操作
4. 系统自动重新计算时间线连续性

### 3. 时间线可视化

#### 3.1 时间轴导航
左侧垂直时间轴提供直观的版本导航功能。

**界面元素**:
- **版本节点**: 圆点表示不同状态（生效中🟢、计划中🔵、已结束⚫）
- **版本卡片**: 显示生效日期、版本名称、变更摘要
- **连接线**: 表示版本间的时间连续性
- **操作按钮**: 新增、编辑、删除版本

**状态指示器**:
- 🟢 **生效中**: 当前有效的版本
- 🔵 **计划中**: 未来生效的版本  
- ⚫ **已结束**: 历史失效的版本
- 🔴 **已作废**: 被删除或作废的版本

#### 3.2 版本详情面板
右侧面板展示选中版本的详细信息。

**信息分类**:
- **📋 基本信息**: 名称、编码、类型、状态
- **🏗️ 层级结构**: 层级、上级组织、路径、排序
- **⏰ 生效期间**: 生效日期、失效日期、变更原因
- **🔧 系统信息**: 创建时间、更新时间、当前状态标志

#### 3.3 时间线数据可视化
独立的时间线可视化组件，展示组织的完整变更历史。

**功能特性**:
- **交互式事件节点**: 点击展开详细信息
- **事件类型图标**: 不同类型用不同图标标识（🏗️创建、✏️更新、🔄重构等）
- **时间戳显示**: 精确到分钟的事件时间
- **元数据展示**: 变更的具体内容和触发者信息

**操作说明**:
1. 在主从视图中选择"📊 时间线可视化"选项卡
2. 查看按时间排序的事件列表
3. 点击事件节点查看详细信息
4. 使用刷新按钮更新数据

## 🔧 高级功能

### 1. 批量操作
支持对多个组织或版本进行批量操作。

**支持的批量操作**:
- 批量状态更新（激活/停用）
- 批量生效日期调整
- 批量变更原因更新

### 2. 数据导入导出
支持组织架构数据的导入导出功能。

**支持格式**:
- CSV格式导出
- Excel模板导入
- JSON格式数据交换

### 3. 权限控制
基于角色的操作权限管理。

**权限级别**:
- **查看权限**: 可查看时态数据和历史记录
- **编辑权限**: 可创建和编辑未来版本
- **管理权限**: 可删除版本和执行高级操作
- **审计权限**: 可查看所有操作日志和系统指标

## 📊 监控和维护

### 1. 系统健康检查
定期检查各服务组件的运行状态。

**检查项目**:
- 数据库连接状态
- 缓存系统运行状况  
- CDC同步延迟监控
- API响应时间统计

**健康检查命令**:
```bash
# 时态管理服务
curl http://localhost:9091/health

# 查询服务
curl http://localhost:8090/health

# 命令服务  
curl http://localhost:9090/health
```

### 2. 性能监控
监控系统的性能指标和资源使用情况。

**关键指标**:
- **查询响应时间**: < 100ms（时间点查询）
- **缓存命中率**: > 90%
- **同步延迟**: < 300ms（CDC）
- **并发处理能力**: 1000+ QPS

### 3. 故障排除
常见问题的诊断和解决方法。

**常见问题**:

#### 问题1: 时态查询返回空结果
**可能原因**: 查询时间点没有有效数据
**解决方案**: 
1. 检查查询日期是否在组织存在期间内
2. 确认是否设置了正确的时态查询参数
3. 查看是否有网络连接问题

#### 问题2: 版本创建失败
**可能原因**: 生效日期冲突或数据验证失败
**解决方案**:
1. 检查生效日期是否与现有版本冲突
2. 验证必填字段是否完整
3. 确认变更原因字段已填写

#### 问题3: 时间线加载缓慢
**可能原因**: 事件数量过多或缓存失效
**解决方案**:
1. 使用日期范围过滤减少数据量
2. 检查Redis缓存服务状态
3. 重启相关服务刷新缓存

## 🎯 最佳实践

### 1. 变更管理最佳实践
- **提前规划**: 重要变更应提前规划，设置未来生效日期
- **清晰命名**: 版本名称应明确反映变更内容
- **详细原因**: 变更原因应详细描述业务背景
- **逐步执行**: 大规模重构应分阶段执行

### 2. 查询性能优化
- **合理使用缓存**: 频繁查询的数据会自动缓存
- **精确时间范围**: 避免过大的时间范围查询
- **分页处理**: 大量数据使用分页方式处理
- **异步加载**: 复杂查询使用异步方式加载

### 3. 数据完整性保证
- **测试环境验证**: 重要变更先在测试环境验证
- **备份机制**: 重要操作前做好数据备份
- **操作日志**: 关键操作应记录详细的审计日志
- **权限控制**: 严格控制删除和批量操作权限

## 📞 技术支持

### 系统信息
- **版本**: v1.2-Temporal (纯日期生效模型)
- **架构**: CQRS + 事件驱动 + CDC数据同步
- **数据库**: PostgreSQL + Neo4j + Redis
- **部署**: Docker Compose + Go微服务

### 联系方式
- **项目路径**: `/home/shangmeilin/cube-castle`
- **文档路径**: `/home/shangmeilin/cube-castle/docs/`
- **API文档**: `/home/shangmeilin/cube-castle/docs/api/temporal-management-api.md`

### 相关链接
- [API接口文档](./api/temporal-management-api.md)
- [系统架构文档](../CLAUDE.md)
- [数据库设计文档](./database-schema.md)
- [部署运维文档](./deployment-guide.md)

---

*最后更新: 2025-08-11*  
*文档版本: v1.2*  
*系统状态: 生产环境就绪 + E2E测试通过*