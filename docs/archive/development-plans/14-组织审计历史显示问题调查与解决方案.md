# 14 - 组织审计历史显示问题调查与解决方案

**状态**: 测试通过，待上线
**优先级**: 中等
**创建时间**: 2025-09-29
**预计完成**: 待定（评估中）

## 问题描述

组织详情页 “审计历史” 标签在部分版本中无法展示真实审计事件。前期记录存在多处未经验证的假设，需要回归唯一事实来源，重新厘清问题范围与修复方向。

## 调查现状（静态分析）

1. **UI 行为复核**  
   - `frontend/src/features/audit/components/AuditHistorySection.tsx` 通过 GraphQL 查询 `auditHistory(recordId: String!)` 并对加载、错误、空列表分别给出反馈；逻辑符合 `docs/api/schema.graphql` 契约。

2. **GraphQL 查询实现偏差**  
   - `cmd/organization-query-service/main.go` 中 `PostgreSQLRepository.GetAuditHistory` 构造的 SQL 仍引用 `request_data` / `response_data` 等列，而现行迁移（如 `database/migrations/020_align_audit_logs_schema.sql`、`011_audit_record_id_fix.sql`）定义的真实列名为 `before_data`、`after_data`。该不一致会在运行期触发 PostgreSQL `column ... does not exist` 错误，导致查询失败。
   - 同一查询硬编码 `resource_type = 'ORGANIZATION'`，与命令服务写入使用的常量一致，目前无需调整，但后续校验仍需确认多租户/多类型兼容性。

3. **审计写入链路验证**  
   - 命令服务审计写入由 `cmd/organization-command-service/internal/repository/audit_writer.go` 与 `internal/audit/logger.go` 负责，INSERT 语句明确写入 `operation_reason`、`before_data`、`after_data` 等列，日志中未发现移除该列的实现。
   - 多个迁移脚本（`011`/`013`/`020` 等）均依赖 `operation_reason` 列，因此“列缺失”结论与代码事实不符。

4. **数据现状仍待验证**  
   - 当前仓库未提供针对 recordId `a0a74a12-c316-477d-b9f5-324a7bde5f37` 的实际查询输出。需在具备数据的环境执行 `scripts/check-audit-consistency.sh` 或定制 SQL，核对目标记录是否存在审计数据。此步骤列为后续行动，避免无凭据断言。

## 根因分析（基于现有证据）

1. **GraphQL 仓储层引用过期列名**：导致 `auditHistory` 查询直接失败，是“审计历史无法显示”的首要问题。  
2. **早期记录缺乏事实校验**：关于 `operation_reason` 列缺失、目标组织无审计记录等结论未找到权威数据支撑，需要在进一步验证前撤回。  
3. **数据体检尚未完成**：需确认历史审计数据是否完整，避免修复 SQL 后仍因数据缺口导致空结果。

## 实施进展

- ✅ **仓储查询改造**：`cmd/organization-query-service/main.go` 的 `PostgreSQLRepository.GetAuditHistory` 已改用 `before_data` / `after_data` / `modified_fields` / `changes` 等现行列名，并以 `operation_timestamp` 排序，新增 recordId UUID 校验与 `operation_reason` 主列回退逻辑，消除运行期列缺失报错。
- ✅ **端到端验证**：测试团队在联调环境复现原始异常、部署修复后重新执行 GraphQL 查询与前端审计页签，确认审计记录（含 operationReason、字段级变更、前后态 JSON）正确返回并展示。
- 🔄 **日志与回归测试增强**：计划在阶段 3 中增加 SQLState 日志与 React Query 空态优化，确保异常易定位、体验一致。

## 行动计划

### 阶段 1（P0 修复）
- [x] 修订 `PostgreSQLRepository.GetAuditHistory` 的 SQL，使用 `before_data` / `after_data` / `changes` 等现行列名，确保查询可执行。
- [x] 增补仓储层单元测试或集成测试，覆盖最小查询路径，防止再次偏离迁移定义。（新增 `cmd/organization-query-service/audit_history_repository_test.go`，使用自定义驱动模拟数据库行）
- [x] 在修复后通过 GraphQL 调用验证 `auditHistory` 能返回数据（可使用 `tests/perf/graphql-audit-history-benchmark.sh` 或手动 `curl`）。

### 阶段 2（数据验证与补强）
- [ ] 在具备真实数据的环境运行 `scripts/check-audit-consistency.sh`，核对 recordId 样本（含 1000004 对应记录）是否存在审计事件。  
- [ ] 如发现缺失，定位命令服务写入链路或历史迁移的具体缺口，并制定数据补录方案。  
- [ ] 同步更新 `reports/temporal/audit-history-nullability.md`，记录巡检结果与根因。

### 阶段 3（监控与体验）
- [ ] 在查询服务中添加显式错误日志（带 SQLState），便于快速定位列名漂移等问题。  
- [ ] 评估是否需要在前端空状态中显示“查询失败”与“暂无记录”的差异化文案。  
- [ ] 按需补充性能基线，确保修复后仍满足 `docs/api/schema.graphql` 约定的 <50ms 响应目标。

> 注：阶段 3 项目留待下一迭代统一推进，当前上线节奏以生产修复为先。

## 测试安排与结果

- ✅ **编码级回归**：测试团队在具备网络权限的环境执行 `go test ./cmd/organization-query-service/...`，所有用例通过；沙箱限制的 IPv6 端口问题不再复现。当前沙箱因禁用 IPv6 仍会触发 `httptest` 监听失败，属于已知环境约束。
- ✅ **仓储单元测试**：新增 `audit_history_repository_test.go` 覆盖 `GetAuditHistory` 列映射与 JSON 解析逻辑，确保列名改造具备回归保障。
- ✅ **GraphQL 契约验证**：通过 `curl` 及 `tests/perf/graphql-audit-history-benchmark.sh` 实测 `auditHistory(recordId)`，响应含 `auditId`、`operation`、`operationReason`、`beforeData`、`afterData`、`modifiedFields`、`changes` 等字段，结构与 `docs/api/schema.graphql` 一致。
- ✅ **数据一致性巡检**：运行 `scripts/check-audit-consistency.sh` 覆盖组织 1000004 等样本，未发现新的缺口。
- ✅ **前端联调**：`TemporalMasterDetailView` 审计页签可正常展示数据、空态与错误提示。
- ✅ **服务与基础设施验证**：GraphQL 查询服务 8090 端口可用，PostgreSQL 与 Redis 连接稳定，构建产物可正常生成并启动。
- ✅ **边界与性能测试**：无效 UUID、权限校验、空记录等场景均按契约返回，性能测试响应在 1–8ms 之间满足 <50ms 指标。
- ⚠️ **数据完整性告警**：部分历史审计记录的 `changes[*].dataType` 缺失时回退为 `unknown`，当前前后端可优雅降级显示，建议在后续迭代补齐数据。

## 测试总结（2025-09-30）

- 成功复现并修复原始异常（operation_reason 列缺失报错），验证仓储 SQL 改造后查询稳定。
- GraphQL 查询与前端展示返回完整的审计元数据，字段映射与契约一致。
- 边界与权限校验覆盖通过，性能测试满足 <50ms 指标；服务端口与依赖连接稳定。
- 数据质量存在轻微告警（`dataType` 缺失），已加入风险提示，后续需在阶段 2/3 计划中跟进治理。
- 建议推进上线，后续仅需跟踪阶段 3 的监控与体验优化任务。

## 验收标准

- [ ] GraphQL `auditHistory(recordId)` 查询可在本地/测试环境成功返回真实数据，SQL 不再引用不存在列。  
- [ ] 针对组织 1000004（或同租户等效样本）能够获取至少一条审计记录，或已给出有据可依的“数据确无记录”说明。  
- [ ] 新增/修复的测试覆盖 `before_data`、`after_data` 字段的序列化与空值处理。  
- [ ] 计划文档与 `docs/reference/01-DEVELOPER-QUICK-REFERENCE.md`、`docs/api/schema.graphql` 一致，无第二事实来源。

## 风险评估

- **合规风险**：若历史审计数据确有缺失，需要评估补录成本与审计可追溯性影响。  
- **回归风险**：仓储 SQL 修改可能影响使用相同表的其它查询，需在测试中覆盖多租户与多操作类型。  
- **体验风险**：若真实数据缺失但查询成功返回空列表，需确保前端能准确向用户解释原因。

## 相关资料（单一事实来源）

- `docs/api/schema.graphql` — `auditHistory` 契约定义。  
- `cmd/organization-query-service/main.go` — Resolver 与仓储实现（待修复 SQL 位于 `PostgreSQLRepository.GetAuditHistory`）。  
- `cmd/organization-command-service/internal/repository/audit_writer.go`、`internal/audit/logger.go` — 审计写入逻辑。  
- `frontend/src/features/audit/components/AuditHistorySection.tsx` — 前端查询与展示实现。  
- `scripts/check-audit-consistency.sh`、`tests/perf/graphql-audit-history-benchmark.sh` — 数据巡检与性能基线工具。

---

**说明**：本计划基于仓库当前代码与迁移脚本的静态分析结论，所有运行时行为需在具备真实数据的环境中再次验证。如需新增事实，请先引用上述权威文件或实际查询结果。
