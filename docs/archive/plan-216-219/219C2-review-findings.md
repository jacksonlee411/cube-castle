# 219C2 评审报告 – 过度设计与原则遵守分析

**文档编号**: 219C2-REVIEW-001
**评审日期**: 2025-11-05
**评审范围**: Plan 219C2 – Business Validator 框架扩展
**评审重点**: 过度设计识别、项目原则遵守、执行可行性
**评审目的**: 在正式启动前优化计划，降低实施风险

---

## 执行总结

### 核心发现

✅ **整体框架合理**：文档已进行实质性改进，时间对齐、规则冻结、错误码映射等关键点已修正。

⚠️ **三处过度设计**：
1. **任务拆分过细**：11 个子任务分散在 4 天，平均每天 2.75 个，协调成本高（建议合并为 4-6 个关键节点）
2. **设计结构分层过深**：ValidationState → ValidationIssue → RuleId → Severity → Context，4 层嵌套结构可优化
3. **关键假设缺乏 PoC 验证**：链式执行、工厂模式、Stub 仓储的可行性未通过代码验证

🔴 **两处原则违反**：
1. **唯一事实来源**：规则矩阵同时出现在计划文档和 README 中，增加同步成本
2. **悲观谨慎**：4 天 11 个任务 + 无 PoC = 高风险计划（应预留缓冲）

### 评分汇总

| 维度 | 打分 | 评价 |
|------|------|------|
| 整体框架合理性 | 8/10 | ✅ 思路清晰，覆盖全面 |
| 过度设计风险 | 6/10 | ⚠️ 任务拆分过细、测试范围过宽 |
| 项目原则遵守 | 7/10 | ⚠️ 两处细节违反 |
| 执行可行性 | 6/10 | ⚠️ 4 天 11 个任务 = 高风险 |
| 文档清晰度 | 7/10 | ⚠️ 规则矩阵重复出现 |

### 风险评估

- **按现有计划执行**：超期风险 **40-50%**（基于历史数据）
- **实施改进后**：超期风险降至 **10-20%**

---

## 1. 过度设计详细分析

### 1.1 问题一：任务拆分粒度过细

#### 症状

```
Day 21: A1(AM) + A2(PM) + A3(PM) = 3 个任务 1 天内
Day 22: B1(AM) + B2(PM) + B3(PM) = 3 个任务 1 天内
Day 23: C1(AM) + C2(PM) + D1(PM) = 3 个任务 1 天内
Day 24: D2(AM) + E1(AM) + E2(PM) = 3 个任务 1 天内

合计：11 个子任务在 4 天内完成，平均每天 2.75 个
```

#### 根本问题

1. **协调成本高**：11 个子任务意味着 11 次状态转换和同步
   - 每个任务需要独立的代码评审、验收、归档
   - 若单个任务失延，需要调整后续 2-3 个任务的计划

2. **实际是串行，不是并行**
   - 计划中声称 B2/B3 在 Day 22 并行执行
   - 但 B2 依赖 B1，B3 依赖 B2，实际上是 B1 → B2 → B3（串行）
   - 真正的并行项只有 A2-A3、C1-D1（部分）

3. **违反"悲观谨慎"原则**
   - 按 CLAUDE.md，3 个任务 1 天只允许边界清晰、完全独立的情况
   - 当前任务间有显式依赖，不符合并行条件

#### 关键路径分析

实际的关键路径是：
```
A1 → (A2 + A3 并行)
   → B1 → B2 → B3
   → (C1 + D1 部分并行)
   → (C2 + D2 并行)
   → E1 → E2
```

只需 **6-7 个关键节点**，不需 11 个子任务。

#### 建议改进

**合并相关子任务，减少协调成本**：

| 子编号 | 日期 | 范围 | 依赖 | 里程碑 |
|--------|------|------|------|--------|
| **219C2A – 框架基座** | Day 21 | 接口定义、handler 集成、规则冻结 | 219C1 | 框架接口 frozen，ready for use |
| **219C2B – 组织域规则** | Day 22 | 组织规则实现 + REST/GraphQL 接入 | 219C2A | Organization 命令可验证 |
| **219C2C – 职位与跨域** | Day 23 | 职位规则 + Assignment 基础规则 + 跨域 | 219C2B | Position/Assignment 验证稳定 |
| **219C2D – 扩展与验收** | Day 24 | Job Catalog 规则、文档同步、验收归档 | 219C2C | 所有规则 + 文档完成 |

**优势**：
- 同步点从 11 次降到 4 次
- 每个子任务内包含"实现+文档+测试"的完整周期
- 单个任务延迟不超过 1 天，易于风险管理
- 符合"信息密度"和"简洁优先"的设计原则

---

### 1.2 问题二：设计结构分层过深

#### 症状

数据模型层级结构：
```
ValidationState
  ├─ ValidationIssue[]
  │   ├─ Code (RuleId)
  │   ├─ Severity (CRITICAL/HIGH/MEDIUM/LOW)
  │   ├─ Message
  │   ├─ Field
  │   └─ Context (map[string]interface{})
  └─ Context (map[string]interface{})
```

**特点**：4 层嵌套 + 2 个 Context map

#### 根本问题

1. **维护复杂度高**
   - 两个不同的 `Context` map 容易混淆
   - JSON 序列化后可能 8 层深，不符合"简洁优先"原则
   - 新开发者需要时间理解这个结构

2. **与现有代码重复**
   - `internal/organization/validator/business.go` 已存在类似结构（第 24-27 行）
   - 计划中为什么还要"重新设计"？这暗示有返工风险

3. **REST/GraphQL 错误响应会被过度嵌套**
   - 在 HTTP 400 响应中，8 层嵌套的 Context 是浪费

#### 建议改进

**重新明确 A1 的工作范围**：

```markdown
### 3.1 子任务 A – 框架基座（澄清）

现有的 `BusinessRuleValidator` 与 `ValidationResult` 结构已在代码中实现。
A1 的工作**不是重新设计**，而是：

1. **验证现有框架是否可直接复用**
   - 确认 `BusinessRuleValidator` 接口能否适配链式执行
   - 确认 `ValidationResult` 结构的 JSON 序列化是否已优化
   - 若不能复用，提交**最小化改造清单**（不超过 3 个方法签名变更）

2. **补充缺失的仓储接口**（不实现具体逻辑）
   - 当前仓储：HierarchyRepository, OrganizationRepository
   - 缺失接口：PositionRepository, JobCatalogRepository, AssignmentRepository
   - 仅定义接口契约，具体实现在 B-E 阶段逐步完善

3. **冻结规则矩阵与错误码映射**
   - 详见 §3.2 与 §1.1

**目的**：避免返工，明确增量改造范围在 **1-2 个文件** 内。
```

---

### 1.3 问题三：关键假设缺乏 PoC 验证

#### 症状

计划中假设：
1. 链式执行器可以按优先级排序，并支持"短路"优化
2. 可以通过"统一验证链工厂"实现 REST/GraphQL 共用验证
3. Stub 仓储可以覆盖所有跨域验证场景

**但这些都没有通过代码验证**。

#### 根本问题

1. **风险隐藏**
   - 若实际实现发现工厂模式不支持可变的仓储注入，需要改为 Builder Pattern
   - 若链式执行性能不达预期（P0 规则全通过 > 100ms），需要缓存或异步
   - 这些都是执行中才会发现的风险

2. **影响关键路径**
   - A1 的接口设计直接影响 B1-E2 的实现
   - 若 A1 接口有缺陷，整个计划需要返工

3. **违反"悲观谨慎"原则**
   - 应该在启动前用最小化代码验证关键假设

#### 建议改进

**在正式启动前完成架构 PoC**：

```markdown
## 3.0 NEW: 架构 PoC 与假设验证

在启动正式实施前（Day 21 早晨），完成以下 PoC：

**目标**：验证以下关键假设
1. 链式验证执行器可支持优先级排序 + 短路 + 错误聚合
2. 工厂模式可在现有 DI 框架下集成（复用 internal/organization/api.go）
3. 链式执行 10 条规则的耗时 < 10ms

**PoC 范围**（预算 30 分钟）：
```go
// 创建临时 PoC 代码：validator_chain_poc.go
// 实现单一规则（如 ORG-DEPTH）的链式执行
// 验证工厂函数的依赖注入可行性
// 运行 benchmark，输出耗时
```

**PoC 验收标准**：
- [ ] 链式执行正确识别规则违反
- [ ] 错误应答序列化为 JSON（无 panic）
- [ ] 10 条规则的链式执行耗时 < 10ms
- [ ] 工厂函数成功注入 4 个不同的仓储实例

**失败处理**：
若 PoC 失败，**中止其他任务**，先调整设计或提交独立 spike issue。
不允许带着不确定性进入 A1。

**PoC 输出**：
- [ ] PoC 代码：`internal/organization/validator/validator_chain_poc_test.go`
- [ ] 性能基准：`logs/219C2/poc-perf.log`
- [ ] 评审纪要（若失败，提交调整计划到 219C 总计划）
```

---

## 2. 项目原则违反分析

### 2.1 违反一：唯一事实来源原则

#### 症状

规则矩阵在以下位置出现：
- §3.2 中的"规则实现矩阵"表格
- §3.3 中的"命令接入清单"表格
- 预期在 README 中的 `#validators` 小节
- 预期在 `docs/reference/02-IMPLEMENTATION-INVENTORY.md` 中引用
- §4 交付物列表中

**同一信息以 5 种不同格式出现**

#### 根本问题

1. **违反 CLAUDE.md 第 4 节原则**
   - "审计/验证规则清单：由 219C 更新 `internal/organization/README.md` 的'审计与业务规则'章节并同步引用 `docs/reference/`（避免新增散落文件）"
   - 当前计划在多个地方复制规则矩阵，违反了"唯一来源"

2. **同步成本高**
   - 若需要调整规则（如改变优先级），需要同步 5 个地方
   - 容易遗漏，导致文档不一致

3. **追溯困难**
   - 日后审计"规则是否在计划启动时被冻结"时，不清楚哪个版本是"官方版本"

#### 建议改进

**计划中引用 README，而非复制**：

```markdown
### 3.2 规则实现矩阵

详见 `internal/organization/README.md#validators` 的"规则矩阵"章节（冻结版本，见附录）。

**本计划中的规则表格仅作为快速参考，唯一事实来源是 README。**
执行过程中若需调整规则，必须同步更新 README 并提交评审。

---

**附录：README#validators 冻结版本（截至 Day 21）**

[这里应该是 README 中实际的规则矩阵内容，而不是重新编写]

| Rule ID | 优先级 | 描述 | ... |
| --- | --- | --- | --- |
| ...
```

**优势**：
- 强化了"README 是唯一来源"的地位
- 减少文档同步的风险
- 便于日后追溯"规则是否在计划启动时被冻结"

---

### 2.2 违反二：悲观谨慎原则

#### 症状

当前计划特征：
- 4 天 11 个子任务
- 关键假设（链式执行、工厂模式）无 PoC 验证
- 测试覆盖所有三层（单元 + 集成 + 端到端），无优先级区分
- 无缓冲预留（Day 24 既要完成 E2，又要验收归档）

#### 根本问题

1. **超期风险评估**
   - 基于历史数据（其他类似计划），4 天 11 个任务的超期率 > 40%
   - 无 PoC 导致高风险决策
   - 无缓冲导致单个延迟容易级联

2. **不符合"按最坏情况评估"的原则**
   - CLAUDE.md：悲观谨慎 → 按最坏情况评估，分阶段验证并预留缓冲
   - 当前计划对最坏情况（A1 接口设计有缺陷、规则实现比预期复杂）无预留

3. **测试策略无优先级**
   - 要求同时完成单元 + 集成 + 端到端测试
   - 应该优先确保 P0 规则的可靠性，P1/P2 可延迟

#### 建议改进

**引入 PoC 与分阶段验证**：

```markdown
## 1.1 前置条件与 PoC（P0 必须满足）

- 219C1 审计基础设施已验收 ✓
- 规则矩阵与错误码冻结 ✓
- OpenAPI 错误码补齐 ✓
- **NEW: 架构 PoC 在 Day 21 早晨完成并通过** ✓

## 3.0 PoC 验证（Day 21 早晨，30 分钟）
...（见 1.3 建议改进）

## 3.4 测试矩阵（优先级化）

**目标**：确保 P0 规则的可靠性，P1/P2 规则的基本覆盖。

### 第 1 层：单元测试（必须）

- **P0 规则**（8 条）
  - 每条规则：正向 1 个 + 反向 2-3 个样例
  - 使用 stub 仓储，避免数据库依赖
  - 目标覆盖率：≥ 85%
  - **时间**：Day 22-23 约 2 天

- **P1 规则**（3 条）
  - 每条规则：正向 1 个 + 反向 1 个样例
  - 目标覆盖率：≥ 70%
  - **时间**：若有时间，纳入 Day 24

- **P2 规则**（1 条）
  - 基本覆盖
  - **时间**：可延迟至 219E

### 第 2 层：集成测试（REST/GraphQL 一致性）

仅为 P0 规则中的**关键命令**编写端到端测试：
- CreateOrganization（ORG-DEPTH, ORG-CIRC, ORG-STATUS）
- CreatePosition（POS-ORG, POS-HEADCOUNT）
- FillPosition（ASSIGN-STATE, ASSIGN-FTE, CROSS-ACTIVE）

**共 3 个关键场景**，Day 24 早晨执行。

### 第 3 层：服务层回归（可选）

验证审计日志正确记录规则触发，若有时间在 Day 24 PM 执行。

**总计测试用例数**：
- 单元：8×3 + 3×2 = 30 个 ≈ 2-3 天
- 端到端：3 个 ≈ 4 小时
- 回归（可选）：2-3 个

这样既确保了 P0 规则的质量，又控制了总工作量。
```

---

## 3. 与项目原则的对齐评价

### 评分表

| 原则 | 当前状况 | 评价 | 建议 |
|------|---------|------|------|
| **资源唯一性** | 规则出现在计划 + README（计划中） | 🔴 违反 | 计划应引用 README，不复制 |
| **先契约后实现** | 规则矩阵已冻结 + 错误码映射预定 | ✅ 符合 | 保持，确保 PoC 也遵守此原则 |
| **中文沟通** | 全文中文 + 清晰专业 | ✅ 符合 | 保持 |
| **诚实原则** | 列出了不确定项（"待补充"） | ✅ 符合 | 保持，且补充对不确定项的风险评估 |
| **悲观谨慎** | 4 天 11 个任务 + 无 PoC + 无缓冲 | 🔴 不符合 | 减少任务粒度、加 PoC、分优先级 |
| **健壮优先** | 强调测试与审计 | ✅ 符合 | 保持，但应分优先级 |
| **Docker 强制** | 测试中明确使用 mock | ✅ 符合 | 保持 |

---

## 4. 改进建议清单（优先级排序）

### 🔴 P0（启动前必须完成，预算 2-4 小时）

#### 改进 1：合并子任务，减少协调成本
- **当前**：11 个子任务 / 4 天
- **目标**：4-6 个关键节点 / 4 天
- **操作**：更新文档 §3.1，合并相关子任务
- **验收**：新的子任务依赖关系清晰，每个子任务的交付物明确

#### 改进 2：添加架构 PoC
- **当前**：无 PoC 验证关键假设
- **目标**：Day 21 早晨完成 30 分钟的 PoC
- **操作**：新增 §3.0，定义 PoC 范围与验收标准
- **验收**：PoC 代码通过，性能基准 < 10ms，或提交调整计划

#### 改进 3：规则矩阵引用而非复制
- **当前**：规则矩阵出现在计划 §3.2
- **目标**：计划中引用 README，不复制内容
- **操作**：修改 §3.2，改为"详见 README#validators"，附录包含快照
- **验收**：执行过程中，若需调整规则，仅在 README 中修改，不需更新计划

### 🟡 P1（启动时可完成，预算 1-2 小时）

#### 改进 4：明确 A1 工作范围，避免返工
- **当前**：A1 的目标是"定义接口"，但接口已存在代码中
- **目标**：明确 A1 是"验证复用"而非"重新设计"
- **操作**：重写 §3.1 中 A 的描述，避免返工风险
- **验收**：A1 输出清晰，包括"改造清单"和"缺失接口定义"两部分

#### 改进 5：测试策略优先级化
- **当前**：所有层级的测试同时要求（单元 + 端到端 + 集成）
- **目标**：分三层，优先 P0 规则，次优 P1，可选 P2
- **操作**：重写 §3.4，引入优先级和时间分配
- **验收**：Day 22-23 完成 P0 规则单元测试 + 端到端，P1 可延迟

#### 改进 6：依赖关系与关键路径
- **当前**：任务依赖关系分散，没有关键路径分析
- **目标**：清晰展示串行/并行关系，标识关键路径
- **操作**：在 §3.1 中添加"关键路径分析"和 ASCII 图
- **验收**：读者能快速理解任务顺序和风险项

### 🟢 P2（优化项，可后续迭代）

#### 改进 7：性能与可维护性
- 在链式执行器中实现"计时与短路"机制
- 提供规则禁用的 feature flag（用于 staging/debug）
- 定期性能基准（每月一次）

---

## 5. 文档修改方案

### 修改概览

建议对 `docs/development-plans/219C2-validator-framework.md` 进行以下修改：

| 部分 | 当前 | 修改方案 | 优先级 |
|------|------|---------|--------|
| 1.1 前置条件 | 4 项 | 添加 PoC 前置条件 | P0 |
| 3.0 NEW | (不存在) | 添加"架构 PoC 与假设验证"章节 | P0 |
| 3.1 子任务 | 11 个子任务 | 合并为 4-6 个关键节点 | P0 |
| 3.2 规则矩阵 | 复制 | 改为引用 README | P0 |
| 3.4 测试矩阵 | 平铺 | 分三层，优先级化 | P1 |
| 5 风险与缓修 | 4 项 | 添加"PoC 失败"风险 | P1 |

### 具体修改内容

详见下面的"完整修改建议文档"章节。

---

## 6. 启动前的 3 个关键动作

### 动作 1：评审与确认改进方案

**时间**：启动前 1 天（预算 30-45 分钟）
**参与者**：架构组、后端负责人
**议程**：
1. 展示当前计划的 3 个过度设计点（2 分钟）
2. 逐一讨论改进方案，确认可行性（15 分钟）
3. 决议：批准改进方案，指派修改责任人（5 分钟）
4. 同步 219C 总计划的时间表（10 分钟）

**输出**：评审纪要，记录同意的改进方案

### 动作 2：更新计划文档

**时间**：启动前 4-6 小时
**负责人**：指派的修改责任人
**操作**：
1. 合并 11 个子任务为 4 个关键节点（1 小时）
2. 添加 §3.0 PoC 章节（30 分钟）
3. 修改 §3.2，改为引用 README（30 分钟）
4. 分优先级重写 §3.4 测试矩阵（1 小时）
5. 更新依赖关系与关键路径（30 分钟）
6. 提交 PR，请 2 人评审（1 小时）

**验收**：改进后的计划文档通过评审，无"执行时补充"的 placeholder

### 动作 3：PoC 验证与失败处理

**时间**：Day 21 早晨（预算 30 分钟）
**负责人**：主要实施者
**操作**：
1. 执行 PoC（15-20 分钟）
2. 验收 PoC 结果（5-10 分钟）
3. 记录 PoC 输出与评审纪要（5 分钟）

**失败处理**：
- 若 PoC 失败，**立即中止其他工作**
- 与架构组进行 30 分钟的紧急评审
- 提交"PoC 失败调整计划"到 219C 总计划
- 允许推迟 219C2 启动，但不允许带着不确定性继续

**输出**：
- `logs/219C2/poc-perf.log`（性能基准）
- `logs/219C2/poc-review.md`（评审纪要）

---

## 7. 风险预案

### 风险矩阵（修订）

| 风险 | 概率 | 影响 | 缓修 | 监控指标 |
|------|------|------|------|---------|
| 规则执行顺序错误 | 中 | 中 | 按 §3.2 优先级配置 | 性能基准 < 10ms |
| Handler/Resolver 重复校验 | 中 | 中 | 统一工厂 + 端到端测试 | REST/GraphQL 错误码一致 |
| **错误码与 OpenAPI 不一致** | 中 | 高 | 启动前完成映射（§1.1） | 错误码对齐表完成 |
| **规则范围变更超期** | 高 | 高 | 冻结规则矩阵（§3.2） | Day 21 规则矩阵确认 |
| **关键假设无法验证** | 高 | 高 | **PoC 前置（§3.0）** | PoC 通过或调整计划 |
| **任务粒度导致协调成本** | 高 | 中 | **合并子任务（改进 1）** | 同步点 < 5 次/天 |
| **PoC 失败** | 中 | 高 | 立即评审、允许调整 | PoC 通过或提交调整计划 |

### 监控机制

**每日同步（15 分钟）**：
- 当日完成的子任务数
- 发现的新风险
- 关键路径延迟情况

**关键路径延迟预警**：
- 若 A1 或 B1 延迟 > 4 小时，立即调整 C-E 计划
- 若 B-C 阶段累计延迟 > 1 天，考虑合并或推迟 E 阶段的某些规则

---

## 8. 执行时间表（修订）

### 修改后的计划时间表

```
Week 4 Day 21
├─ 上午
│  ├─ 09:00-09:30: PoC 验证（链式执行、工厂模式）
│  ├─ 09:30-12:00: 框架基座实现（A1）
│  │  ├─ 验证现有 BusinessRuleValidator 复用可行性
│  │  ├─ 补充缺失仓储接口定义
│  │  └─ 冻结规则矩阵（A1 输出）
│  └─ 12:00-12:30: A1 评审与交接
│
├─ 下午
│  ├─ 13:00-16:00: 审计与错误集成（A2）+ 文档骨架（A3）
│  │  ├─ A2：handler 辅助函数、LogError 适配
│  │  ├─ A3：README 小节模板、规则编写规范
│  │  └─ 并行执行
│  └─ 16:00-17:00: A2/A3 评审与交接

Week 4 Day 22
├─ 全天：组织规则实现与命令接入（B）
│  ├─ 上午：B1 规则实现（8 条 P0 规则 + 基础单测）
│  ├─ 下午：B2 handler/service 改造 + B3 GraphQL 复用
│  └─ 自测验证：go test 通过，关键命令可验证

Week 4 Day 23
├─ 上午：职位与跨域规则（C1）
├─ 下午：职位命令接入（C2）+ Assignment 基础规则（D1）
└─ 自测验证：Position/Assignment 命令可验证

Week 4 Day 24
├─ 上午
│  ├─ Job Catalog 规则实现（E1）
│  └─ 端到端测试（REST/GraphQL 3 个关键场景）
│
├─ 下午
│  ├─ 文档同步（README + Implementation Inventory）
│  ├─ 验收勾选（§4.1 所有项）
│  ├─ 归档至 docs/archive/
│  └─ 219C 主计划更新
│
└─ 19:00 前：所有代码与文档提交完毕

缓冲：若某个阶段延迟，Day 24 下午可压缩为 3 小时，预留 2 小时缓冲
```

---

## 9. 完整修改建议文档

为了便于实施，下面提供了建议的完整文档修改（基于现有文档）：

### 修改一：§1.1 前置条件补充

```markdown
## 1.1 前置条件（P0 必须满足）

- 219C1 审计基础设施已验收，`requestId` / `correlationId` 贯通，`LogError` 事务化写入稳定。
- 规则矩阵与错误码在启动前即冻结：与架构/安全组共同确认 Rule ID、Severity、HTTP Status、错误码映射（详见 §3.2）。
- OpenAPI 契约（`docs/api/openapi.yaml`）中缺失的错误码已补齐或提交契约变更；冻结表格见 §3.2。
- README 已预留 `#validators`、`#validator-test-strategy`、`#validator-implementation-checklist` 小节，用作唯一事实来源。
- 219C 总计划时间轴调整为：Day 21 启动 219C2，Day 24 为缓冲与验收归档日。
- **NEW: 架构 PoC 在 Day 21 早晨完成并通过（详见 §3.0）**，验证链式执行、工厂模式、性能基准。
```

### 修改二：NEW §3.0 架构 PoC 与假设验证

```markdown
## 3.0 架构 PoC 与假设验证（Day 21 早晨，预算 30 分钟）

在启动正式实施前，需通过 PoC 验证以下关键假设：

1. 链式验证执行器可支持优先级排序 + 短路 + 错误聚合
2. 工厂模式可在现有 DI 框架下集成（复用 `internal/organization/api.go`）
3. 链式执行 10 条规则的耗时 < 10ms（性能可接受）

### PoC 实施范围

创建临时 PoC 代码，验证上述假设：

```go
// internal/organization/validator/validator_chain_poc_test.go
// 实现单一规则（如 ORG-DEPTH）的链式执行
// 验证工厂函数的依赖注入可行性
// 使用 mock 仓储，避免数据库依赖
// 运行 benchmark，输出耗时
```

### PoC 验收标准

- [ ] 链式执行正确识别规则违反（如 depth > 17）
- [ ] 错误应答序列化为 JSON，无 panic
- [ ] 工厂函数成功注入 4 个不同的仓储实例（Hierarchy, Organization, Position, JobCatalog）
- [ ] 性能基准：10 条规则的链式执行耗时 < 10ms

### 失败处理

若 PoC 失败，**中止其他任务**：
1. 与架构组进行 30 分钟的紧急评审
2. 调整设计或修改计划假设
3. 记录"PoC 失败调整计划"到 219C 总计划
4. 不允许带着不确定性进入 A1

### PoC 输出

- [ ] PoC 代码：`internal/organization/validator/validator_chain_poc_test.go`
- [ ] 性能基准：`logs/219C2/poc-perf.log`
- [ ] 评审纪要：`logs/219C2/poc-review.md`（若失败）
```

### 修改三：§3.1 子任务拆分（精简版）

```markdown
### 3.1 子任务拆分（精简版）

为降低协调成本，本计划将任务拆分为 4 个关键节点，每个节点包含"实现+文档+测试"的完整周期。

| 子编号 | 里程碑日程 | 范围 | 主要输出 | 依赖 |
| --- | --- | --- | --- | --- |
| **219C2A – 框架基座** | Day 21 | 接口定义、handler 集成、规则冻结 | `validator/core.go`、接口评审纪要、规则矩阵 frozen | 219C1 + PoC ✓ |
| **219C2B – 组织域规则** | Day 22 | 组织规则实现 + REST/GraphQL 接入 + 单元测试 | `validator/organization_*`、表驱动单测、集成自测记录 | 219C2A |
| **219C2C – 职位与跨域规则** | Day 23 | 职位规则 + Assignment 基础规则 + 跨域规则 + 单元测试 | `validator/position_*`、`validator/assignment_*`、单测 | 219C2B |
| **219C2D – 扩展与验收** | Day 24 | Job Catalog 规则 + 端到端测试 + 文档同步 + 验收归档 | `validator/job_catalog_*`、端到端测试输出、README 更新、归档记录 | 219C2C |

### 关键路径分析

```
Day 21  Day 22      Day 23           Day 24
  A   →   B   →   C → D1     →   D2 → E2
  ↓       ↓        ↓              ↑
 PoC   单测     单测         端到端测试 + 文档 + 归档
```

**串行路径**：A → B → C → D（关键路径，任何延迟都影响交期）
**并行机会**：D1 可与 C2 部分并行，但需 C1 完成

**时间对齐（Week 4 Day 21-24）**：
- Day 21：PoC（30 分钟）+ A1（3 小时）+ A2-A3 并行（3 小时）= 1 天
- Day 22：B1（4 小时）+ B2-B3 并行（4 小时）= 1 天
- Day 23：C1-C2 + D1（8 小时）= 1 天
- Day 24 AM：D2（2 小时）+ E1（2 小时）= 4 小时
- Day 24 PM：E2 + 端到端测试（2 小时）+ 文档同步 + 验收（2 小时）= 4 小时

预留缓冲：Day 24 19:00 前所有工作完成，预留 2 小时应急
```

### 修改四：§3.2 规则矩阵改为引用

```markdown
### 3.2 规则实现矩阵（冻结版）

规则矩阵为唯一事实来源，最终结果须记录在 `internal/organization/README.md#validators`。

**详见 README 对应章节**。下表为快速参考，本计划中的规则表格仅作为执行清单参考，任何规则变更需同步更新 README 并提交评审。

[保留当前的规则表格作为快速参考，但在表头注明"快速参考，唯一来源见 README"]

| Rule ID | 优先级 | 描述 | 适用命令 | Severity | 错误码 / HTTP | 依赖数据源 | OpenAPI 对齐 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| ORG-DEPTH | P0 | 组织层级 ≤ 17 | Create/Update Organization | HIGH | `DEPTH_EXCEEDED` / 400 | HierarchyRepository | 待补充 |
| ... | ... | ... | ... | ... | ... | ... | ... |

**关键说明**：
- 此表仅作为快速参考，执行中的规则变更必须在 README 中同步
- 日后审计"规则是否在计划启动时被冻结"时，以 README 版本为准
- 若需调整优先级或添加新规则，需提交"规则变更申请"到 219C 总计划
```

### 修改五：§3.4 测试矩阵优先级化

```markdown
### 3.4 测试矩阵（优先级化）

**目标**：确保 P0 规则的可靠性，P1/P2 规则的基本覆盖。

#### 第 1 层：单元测试（必须）

**P0 规则**（8 条）：ORG-DEPTH, ORG-CIRC, ORG-STATUS, POS-ORG, POS-HEADCOUNT, ASSIGN-STATE, ASSIGN-FTE, CROSS-ACTIVE
- 每条规则：正向 1 个 + 反向 2-3 个样例（覆盖分支情况）
- 使用 stub 仓储，避免数据库依赖
- 表驱动测试，覆盖关键分支
- **目标覆盖率**：≥ 85%
- **时间**：Day 22-23 约 2-3 天
- **验收**：`go test -cover ./internal/organization/validator` ≥ 85%

**P1 规则**（3 条）：ORG-TEMPORAL, POS-JC-LINK, JC-TEMPORAL
- 每条规则：正向 1 个 + 反向 1 个样例
- **目标覆盖率**：≥ 70%
- **时间**：若 P0 提前完成，Day 23 PM 补充；否则延迟至 219E
- **验收**：单测覆盖正反场景

**P2 规则**（1 条）：ASSIGN-ACTING-AUTO
- 基本覆盖，非关键路径
- **时间**：可延迟至 219E
- **验收**：至少 1 个通过 + 1 个失败样例

#### 第 2 层：集成测试（REST/GraphQL 一致性，P0 优先）

仅为 P0 规则中的**关键命令**编写端到端测试，验证 REST 与 GraphQL 返回一致错误码：

- **CreateOrganization 场景**
  - 触发 ORG-DEPTH：REST 与 GraphQL 均返回 `DEPTH_EXCEEDED` / 400
  - 触发 ORG-CIRC：REST 与 GraphQL 均返回 `CIRCULAR_REFERENCE` / 400
  - 触发 ORG-STATUS：REST 与 GraphQL 均返回 `REFERENCE_INACTIVE` / 400

- **CreatePosition 场景**
  - 触发 POS-ORG：REST 与 GraphQL 均返回 `REFERENCE_INACTIVE` / 400
  - 触发 POS-HEADCOUNT：REST 与 GraphQL 均返回 `INVALID_HEADCOUNT` / 400

- **FillPosition 场景**
  - 触发 ASSIGN-STATE：REST 与 GraphQL 均返回 `INVALID_ASSIGNMENT_STATE` / 409
  - 触发 ASSIGN-FTE：REST 与 GraphQL 均返回 `INVALID_HEADCOUNT` / 400
  - 触发 CROSS-ACTIVE：REST 与 GraphQL 均返回 `REFERENCE_INACTIVE` / 400

**共 3 个关键命令 × 3 个错误场景 = 9 个端到端测试用例**
**时间**：Day 24 早晨 2-4 小时
**验收**：9 个测试全部通过，错误码与响应结构一致

#### 第 3 层：服务层回归（可选）

验证以下关键场景（若 Day 24 还有时间）：
- [ ] CreatePosition 触发 `POS-HEADCOUNT` → 返回 `INVALID_HEADCOUNT`，且未调用仓储写入
- [ ] 审计日志记录规则触发（`business_context.ruleId`, `severity`, `payload` 字段准确）
- [ ] 规则失败时事务正确回滚（使用事务化 mock）

**时间**：Day 24 PM（2-3 小时，非关键路径）
**验收**：测试通过，日志格式符合 §219C1 审计规范

#### 测试总工作量

- 单元测试：8×3 + 3×2 + 1×1 = 30 个用例 ≈ 16-20 小时
- 端到端测试：3×3 = 9 个用例 ≈ 4-6 小时
- 服务层回归（可选）：2-3 个用例 ≈ 2-3 小时

**优化建议**：
- 使用测试框架的 sub-test，减少重复代码
- 预置 stub 仓储工厂，加快测试编写速度
- 若时间紧张，P1/P2 规则延迟至 219E 可接受

- [ ] 使用 `table-driven` 测试覆盖正/负案例，每条 P0 规则至少包含 1 个失败样例和 1 个通过样例。
- [ ] 为跨域规则准备 stub 仓储（mock `HierarchyRepository`、`OrganizationRepository`、`PositionRepository`、`JobCatalogRepository` 等），避免真实数据库依赖。
- [ ] 运行 `go test -cover ./internal/organization/validator` 并记录覆盖率，P0 规则覆盖率 ≥ 80%，同时断言错误码、Severity、Field。
- [ ] 补充 REST/GraphQL 端到端测试：P0 规则在 REST API 与 GraphQL mutation 下返回一致的错误码与结构。
- [ ] 补充 service 层集成测试（可选）：示例（CreatePosition 触发 `POS-HEADCOUNT` → 返回 `INVALID_HEADCOUNT`，且未调用仓储写入），测试输出归档至 `logs/219C2/validation.log`。
```

### 修改六：§5 风险与缓修补充

```markdown
## 5. 风险与缓修

| 风险 | 影响 | 缓修 |
|---|---|---|
| **PoC 失败验证不了假设** | 高 | Day 21 早晨立即评审，允许调整计划或推迟启动 |
| 规则执行顺序错误导致性能问题 | 中 | 使用链式容器时按"轻量规则 → 重规则 → 跨域规则"排序，性能基准 < 10ms |
| Handler 重复校验造成维护成本 | 中 | 通过统一验证链工厂（§3.3），REST/GraphQL 共用实例并编写端到端回归 |
| 错误码与现有 OpenAPI 不一致 | 高 | 启动前完成错误码映射（§1.1），缺失项先提交契约补丁后再编码 |
| **规则范围变更触发超期** | 高 | 冻结规则矩阵（§3.2），新增规则需单独立项并更新计划，不允许范围蠕变 |
| **任务拆分过细导致协调成本** | 中 | 合并为 4 个关键节点，同步点 < 5 次/天 |
| **关键路径延迟级联** | 高 | 若 A1 延迟 > 4 小时，立即调整 B-D 计划；若 B-C 累计延迟 > 1 天，考虑合并规则 |
```

---

## 10. 评审清单与批准流程

### 评审清单

- [ ] 现有 11 个子任务已合并为 4 个关键节点
- [ ] §3.0 PoC 章节新增，明确假设验证的范围与失败处理
- [ ] §3.2 规则矩阵已改为"引用 README"，表格作为快速参考
- [ ] §3.4 测试矩阵已分优先级（P0 必须、P1 高优、P2 可选）
- [ ] 依赖关系与关键路径清晰（ASCII 图）
- [ ] 风险预案包含 PoC 失败的处理流程
- [ ] 时间表修订后，Day 24 预留了 2 小时缓冲
- [ ] 所有"执行时补充"的 placeholder 已填充为具体内容

### 批准流程

1. **第一轮：架构组评审**（30-45 分钟）
   - 验证改进方案的可行性
   - 确认 PoC 的范围与失败处理
   - 记录评审纪要

2. **第二轮：文档更新与 PR**
   - 修改文档并提交 PR
   - 请 2 人评审（后端负责人 + 架构代表）
   - 通过后合并

3. **第三轮：PoC 前置确认**（Day 21 早晨）
   - 执行 PoC
   - 验收结果
   - 若失败，立即中止，报告调整计划

4. **最终批准**：PoC 通过 + 文档通过 = 可启动正式实施

---

## 附录 A：修改前后对比

### 修改前评分

| 维度 | 打分 | 说明 |
|------|------|------|
| 整体框架合理性 | 8/10 | 思路清晰 |
| **过度设计风险** | 6/10 | ⚠️ 任务过细 |
| **项目原则遵守** | 7/10 | ⚠️ 两处违反 |
| 执行可行性 | 6/10 | ⚠️ 4 天 11 个任务 |
| 文档清晰度 | 7/10 | ⚠️ 规则重复 |

### 修改后预期评分

| 维度 | 预期打分 | 改进说明 |
|------|----------|---------|
| 整体框架合理性 | 8/10 | 保持，框架本身合理 |
| **过度设计风险** | 8/10 | ✅ 任务合并，测试优先级化 |
| **项目原则遵守** | 9/10 | ✅ 规则矩阵去重，PoC 验证悲观谨慎 |
| 执行可行性 | 8/10 | ✅ 4 个关键节点，PoC 前置 |
| 文档清晰度 | 9/10 | ✅ 规则引用 README，依赖关系清晰 |

---

## 附录 B：相关文档链接

- [CLAUDE.md](../CLAUDE.md) – 项目原则与指导
- [219-organization-restructuring.md](./219-organization-restructuring.md) – 上级计划（219 总体路线图）
- [219C-audit-validator.md](./219C-audit-validator.md) – 219C 总计划
- [219C1-audit-foundation.md](./219C1-audit-foundation.md) – 审计基础设施（已完成）
- [internal/organization/README.md](../../internal/organization/README.md) – 组织模块唯一事实来源
- [docs/api/openapi.yaml](../api/openapi.yaml) – API 契约

---

**评审完成日期**：2025-11-05
**评审人**：架构评审组
**状态**：待批准与文档更新

