{
  "info": {
    "name": "Cube Castle API Collection",
    "description": "完整的API测试工具集，包含JWT认证和所有端点测试",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{jwt_token}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 自动刷新过期JWT令牌",
          "const token = pm.environment.get('jwt_token');",
          "const expiry = pm.environment.get('jwt_expiry');",
          "",
          "if (!token || !expiry || new Date() >= new Date(expiry)) {",
          "  console.log('JWT令牌已过期或不存在，正在获取新令牌...');",
          "  ",
          "  const devTokenRequest = {",
          "    url: pm.environment.get('command_service_url') + '/auth/dev-token',",
          "    method: 'POST',",
          "    header: {",
          "      'Content-Type': 'application/json'",
          "    },",
          "    body: {",
          "      mode: 'raw',",
          "      raw: JSON.stringify({",
          "        userId: 'dev-user',",
          "        tenantId: 'dev-tenant',",
          "        roles: ['ADMIN', 'USER'],",
          "        duration: '8h'",
          "      })",
          "    }",
          "  };",
          "  ",
          "  pm.sendRequest(devTokenRequest, function (err, response) {",
          "    if (err) {",
          "      console.error('获取JWT令牌失败:', err);",
          "    } else if (response.code === 200) {",
          "      const responseJson = response.json();",
          "      const token = responseJson.data.token;",
          "      const expiresAt = responseJson.data.expiresAt;",
          "      ",
          "      pm.environment.set('jwt_token', token);",
          "      pm.environment.set('jwt_expiry', expiresAt);",
          "      console.log('JWT令牌获取成功，有效期至:', expiresAt);",
          "    } else {",
          "      console.error('JWT令牌获取失败:', response.text());",
          "    }",
          "  });",
          "}"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "command_service_url",
      "value": "http://localhost:9090",
      "type": "string"
    },
    {
      "key": "query_service_url", 
      "value": "http://localhost:8090",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "开发工具",
      "description": "JWT令牌管理和开发状态查询",
      "item": [
        {
          "name": "生成开发JWT令牌",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userId\": \"dev-user\",\n  \"tenantId\": \"dev-tenant\",\n  \"roles\": [\"ADMIN\", \"USER\"],\n  \"duration\": \"8h\"\n}"
            },
            "url": {
              "raw": "{{command_service_url}}/auth/dev-token",
              "host": ["{{command_service_url}}"],
              "path": ["auth", "dev-token"]
            },
            "description": "生成用于开发和测试的JWT令牌"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('状态码为200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('响应包含JWT令牌', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson.success).to.be.true;",
                  "    pm.expect(responseJson.data.token).to.be.a('string');",
                  "    pm.expect(responseJson.data.expiresAt).to.be.a('string');",
                  "    ",
                  "    // 自动设置环境变量",
                  "    pm.environment.set('jwt_token', responseJson.data.token);",
                  "    pm.environment.set('jwt_expiry', responseJson.data.expiresAt);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取令牌信息",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{command_service_url}}/auth/dev-token/info",
              "host": ["{{command_service_url}}"],
              "path": ["auth", "dev-token", "info"]
            },
            "description": "获取当前JWT令牌的详细信息"
          },
          "response": []
        },
        {
          "name": "开发状态检查",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{command_service_url}}/dev/status",
              "host": ["{{command_service_url}}"],
              "path": ["dev", "status"]
            },
            "description": "检查开发环境状态和配置"
          },
          "response": []
        },
        {
          "name": "测试端点列表",
          "request": {
            "method": "GET", 
            "header": [],
            "url": {
              "raw": "{{command_service_url}}/dev/test-endpoints",
              "host": ["{{command_service_url}}"],
              "path": ["dev", "test-endpoints"]
            },
            "description": "获取所有可用的测试端点列表"
          },
          "response": []
        }
      ]
    },
    {
      "name": "组织单元管理 (REST API)",
      "description": "组织单元的CRUD操作",
      "item": [
        {
          "name": "创建组织单元",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"测试部门\",\n  \"unitType\": \"DEPARTMENT\",\n  \"parentCode\": null,\n  \"description\": \"这是一个测试部门\",\n  \"sortOrder\": 1,\n  \"effectiveDate\": \"2025-08-25\",\n  \"isTemporal\": false\n}"
            },
            "url": {
              "raw": "{{command_service_url}}/api/v1/organization-units",
              "host": ["{{command_service_url}}"],
              "path": ["api", "v1", "organization-units"]
            },
            "description": "创建新的组织单元"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('状态码为201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('响应包含组织代码', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson.success).to.be.true;",
                  "    pm.expect(responseJson.data.code).to.be.a('string');",
                  "    ",
                  "    // 保存组织代码用于后续测试",
                  "    pm.environment.set('test_org_code', responseJson.data.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "更新组织单元",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"更新后的测试部门\",\n  \"description\": \"这是更新后的描述\",\n  \"sortOrder\": 2\n}"
            },
            "url": {
              "raw": "{{command_service_url}}/api/v1/organization-units/{{test_org_code}}",
              "host": ["{{command_service_url}}"],
              "path": ["api", "v1", "organization-units", "{{test_org_code}}"]
            },
            "description": "更新指定组织单元信息"
          },
          "response": []
        },
        {
          "name": "停用组织单元",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"部门重组\"\n}"
            },
            "url": {
              "raw": "{{command_service_url}}/api/v1/organization-units/{{test_org_code}}/suspend",
              "host": ["{{command_service_url}}"],
              "path": ["api", "v1", "organization-units", "{{test_org_code}}", "suspend"]
            },
            "description": "停用指定组织单元"
          },
          "response": []
        },
        {
          "name": "激活组织单元",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"恢复业务运营\"\n}"
            },
            "url": {
              "raw": "{{command_service_url}}/api/v1/organization-units/{{test_org_code}}/activate",
              "host": ["{{command_service_url}}"],
              "path": ["api", "v1", "organization-units", "{{test_org_code}}", "activate"]
            },
            "description": "重新激活组织单元"
          },
          "response": []
        },
        {
          "name": "删除组织单元",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "url": {
              "raw": "{{command_service_url}}/api/v1/organization-units/{{test_org_code}}",
              "host": ["{{command_service_url}}"],
              "path": ["api", "v1", "organization-units", "{{test_org_code}}"]
            },
            "description": "删除指定组织单元"
          },
          "response": []
        }
      ]
    },
    {
      "name": "组织查询 (GraphQL)",
      "description": "组织数据查询操作",
      "item": [
        {
          "name": "查询组织统计",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"query OrganizationStats { organizationStats { totalCount temporalStats { totalVersions averageVersionsPerOrg oldestEffectiveDate newestEffectiveDate } byType { unitType count percentage } } }\"\n}"
            },
            "url": {
              "raw": "{{query_service_url}}/graphql",
              "host": ["{{query_service_url}}"],
              "path": ["graphql"]
            },
            "description": "获取组织单元统计信息"
          },
          "response": []
        },
        {
          "name": "查询组织列表",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"query Organizations($filter: OrganizationFilter, $pagination: PaginationInput) { organizations(filter: $filter, pagination: $pagination) { nodes { code name unitType status level effectiveDate isCurrent } pagination { total hasNext hasPrevious } } }\",\n  \"variables\": {\n    \"filter\": {\n      \"status\": \"ACTIVE\"\n    },\n    \"pagination\": {\n      \"limit\": 10,\n      \"offset\": 0\n    }\n  }\n}"
            },
            "url": {
              "raw": "{{query_service_url}}/graphql",
              "host": ["{{query_service_url}}"],
              "path": ["graphql"]
            },
            "description": "分页查询组织单元列表"
          },
          "response": []
        },
        {
          "name": "查询单个组织",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Tenant-ID",
                "value": "dev-tenant"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"query Organization($code: String!) { organization(code: $code) { code name unitType status level path parentCode effectiveDate endDate isCurrent description createdAt updatedAt } }\",\n  \"variables\": {\n    \"code\": \"{{test_org_code}}\"\n  }\n}"
            },
            "url": {
              "raw": "{{query_service_url}}/graphql",
              "host": ["{{query_service_url}}"],
              "path": ["graphql"]
            },
            "description": "查询单个组织单元详细信息"
          },
          "response": []
        }
      ]
    },
    {
      "name": "健康检查",
      "description": "服务状态检查",
      "item": [
        {
          "name": "命令服务健康检查",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{command_service_url}}/health",
              "host": ["{{command_service_url}}"],
              "path": ["health"]
            },
            "description": "检查REST命令服务状态"
          },
          "response": []
        },
        {
          "name": "查询服务健康检查",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{query_service_url}}/health",
              "host": ["{{query_service_url}}"],
              "path": ["health"]
            },
            "description": "检查GraphQL查询服务状态"
          },
          "response": []
        }
      ]
    }
  ]
}