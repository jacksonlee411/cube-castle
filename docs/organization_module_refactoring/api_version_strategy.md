# API版本策略 - V1到V2迁移路径

**文档编号**: API-VERSION-2025-08-04  
**创建日期**: 2025年8月4日  
**适用范围**: CoreHR API模块  
**状态**: 设计阶段  

## 版本策略概述

### 版本控制原则

#### 1. 语义化版本控制
- **V1 (1.x.x)**: 当前生产版本，仅UUID支持
- **V2 (2.x.x)**: 增强版本，双ID系统支持
- **向后兼容**: V1 API将持续维护至少12个月

#### 2. 并行版本支持
- **同时支持**: V1和V2 API同时提供服务
- **渐进迁移**: 客户端可按自己的节奏迁移
- **数据统一**: 两个版本共享同一数据存储

## API路径设计

### V1 API (Legacy)
```
/api/v1/corehr/employees
/api/v1/corehr/organizations
/api/v1/corehr/organizations/tree
```

### V2 API (Enhanced)
```
/api/v2/corehr/employees
/api/v2/corehr/organizations
/api/v2/corehr/organizations/tree
/api/v2/corehr/business-ids/generate
```

## 字段映射策略

### V1到V2字段映射

#### 员工实体映射
| V1字段 | V2字段 | 变更类型 | 说明 |
|--------|--------|----------|------|
| `id` | `uuid` | 重命名 | UUID移至uuid字段 |
| - | `id` | 新增 | 业务ID作为主要标识 |
| `employee_number` | `employee_number` | 保留(废弃) | 标记为将来废弃 |
| `position_id` | `position_id` | 增强 | 支持UUID或业务ID |
| `organization_id` | `organization_id` | 增强 | 支持UUID或业务ID |

#### 组织实体映射
| V1字段 | V2字段 | 变更类型 | 说明 |
|--------|--------|----------|------|
| `id` | `uuid` | 重命名 | UUID移至uuid字段 |
| - | `id` | 新增 | 业务ID作为主要标识 |
| `code` | `code` | 保留(废弃) | 标记为将来废弃 |
| `parent_id` | `parent_id` | 增强 | 支持UUID或业务ID |
| - | `unit_type` | 新增 | 组织类型明确化 |
| - | `manager_id` | 新增 | 管理者关联 |

## 迁移时间表

### Phase 1: 双版本部署 (第1-2周)
- ✅ V2 API开发完成
- ✅ V1 API保持完全兼容
- ✅ 数据库支持双字段存储
- ✅ API文档更新发布

### Phase 2: 软迁移期 (第3-8周)
- 🔄 V2 API对外发布
- 🔄 V1 API正常维护
- 🔄 新功能优先在V2实现
- 🔄 客户端开始测试V2

### Phase 3: 迁移推进期 (第9-20周)
- 📈 V2使用率目标: >50%
- 📢 V1废弃警告通知
- 🚀 V2性能优化
- 📊 迁移进度监控

### Phase 4: V1废弃准备 (第21-36周)
- ⚠️ V1 API标记为废弃
- 📧 客户端迁移提醒
- 🔒 V1仅安全补丁
- 📝 迁移指南完善

### Phase 5: V1下线 (第37+周)
- ❌ V1 API正式下线
- 🧹 清理V1相关代码
- 📈 V2成为标准版本

## 兼容性保证

### V1 API兼容性承诺

#### 保持不变的内容
- **URL路径**: 完全保持现有路径
- **请求格式**: HTTP方法、参数名称、数据类型
- **响应格式**: JSON结构、字段名称、数据类型
- **错误码**: HTTP状态码和错误消息格式
- **认证方式**: 现有认证机制继续支持

#### 增强但兼容的内容
- **性能优化**: 后端查询优化不影响API契约
- **安全加固**: 不破坏现有功能的安全改进
- **监控增强**: 增加监控指标但不影响响应

### V2 API增强功能

#### 核心增强
1. **双ID系统**: UUID + 业务ID并存
2. **灵活查询**: 支持两种ID类型的查询
3. **业务友好**: 人类可读的业务ID
4. **增强错误**: 更详细的错误信息
5. **性能优化**: 基于业务ID的高效查询

#### 新增端点
- `POST /api/v2/corehr/business-ids/generate`: 业务ID生成
- 所有V2端点支持`include_uuid`参数
- 所有V2端点支持`id_type`查询优化参数

## 客户端迁移指南

### 迁移检查清单

#### 准备阶段
- [ ] 了解V2 API文档和变更内容
- [ ] 评估现有代码中的API调用
- [ ] 制定迁移计划和时间表
- [ ] 准备测试环境和测试用例

#### 实施阶段
- [ ] 更新API URL从v1到v2
- [ ] 适配新的响应字段结构
- [ ] 更新ID字段处理逻辑
- [ ] 添加错误处理增强
- [ ] 进行集成测试

#### 验证阶段
- [ ] 功能完整性测试
- [ ] 性能基准对比
- [ ] 错误场景测试
- [ ] 用户验收测试
- [ ] 生产环境灰度发布

### 常见迁移场景

#### 场景1: 员工信息查询
```javascript
// V1 方式
const response = await fetch('/api/v1/corehr/employees/e60891dc-7d20-444b-9002-22419238d499');
const employee = response.json();
console.log(employee.id); // UUID

// V2 方式 (使用业务ID)
const response = await fetch('/api/v2/corehr/employees/1');
const employee = response.json();
console.log(employee.id); // "1" (业务ID)
console.log(employee.uuid); // UUID (如果请求了)
```

#### 场景2: 员工列表检索
```javascript
// V1 方式
const response = await fetch('/api/v1/corehr/employees?page=1&page_size=20');

// V2 方式 (增强搜索)
const response = await fetch('/api/v2/corehr/employees?page=1&page_size=20&search_by=id&search=1');
```

#### 场景3: 组织树查询
```javascript
// V1 方式
const response = await fetch('/api/v1/corehr/organizations/tree');

// V2 方式 (可选UUID)
const response = await fetch('/api/v2/corehr/organizations/tree?include_uuid=true');
```

## 监控和度量

### 关键指标

#### 版本使用情况
- **V1请求量**: 每日/每周/每月统计
- **V2请求量**: 增长趋势监控
- **版本分布**: V1 vs V2使用比例
- **客户端分布**: 不同客户端的版本使用情况

#### 性能指标
- **响应时间**: V1 vs V2平均响应时间
- **错误率**: 各版本的错误率对比
- **吞吐量**: QPS对比分析
- **资源消耗**: CPU、内存使用情况

#### 迁移进度
- **客户端迁移率**: 已迁移客户端百分比
- **功能使用率**: V2新功能使用情况
- **支持工单**: 迁移相关问题统计

### 告警设置

#### 版本健康告警
- V1 API错误率 > 1%
- V2 API错误率 > 0.5%
- 响应时间 > 2秒
- V1使用量异常增长 (可能的回退)

#### 迁移进度告警
- 迁移进度低于预期
- V1使用量在废弃期仍然很高
- 客户端迁移问题集中出现

## 风险控制

### 技术风险

#### 数据一致性风险
- **风险**: 双版本API数据不一致
- **缓解**: 共享数据层，统一事务管理
- **监控**: 数据一致性检查工具

#### 性能风险
- **风险**: V2 API性能不如V1
- **缓解**: 专项性能测试和优化
- **回退**: 性能问题时的快速回退机制

#### 兼容性风险
- **风险**: V1 API意外破坏兼容性
- **缓解**: 自动化兼容性测试
- **验证**: 集成测试覆盖所有V1场景

### 业务风险

#### 迁移延迟风险
- **风险**: 客户端迁移进度缓慢
- **缓解**: 充分的迁移指导和技术支持
- **预案**: 延长V1支持期

#### 用户体验风险
- **风险**: 迁移过程中用户体验下降
- **缓解**: 灰度发布和快速回退机制
- **监控**: 用户反馈和支持工单跟踪

## 废弃策略

### V1 API废弃流程

#### 废弃通知 (提前6个月)
- **通知渠道**: API响应头、邮件、文档公告
- **通知内容**: 废弃时间、迁移指南、技术支持
- **通知频率**: 月度提醒，最后3个月周度提醒

#### 废弃标记 (提前3个月)
- **HTTP头**: `Deprecation: true`，`Sunset: 2025-12-31`
- **响应提醒**: 在响应中添加废弃警告
- **日志记录**: 记录仍在使用V1的客户端

#### 正式下线
- **流量切断**: 404响应或重定向到V2
- **代码清理**: 删除V1相关代码
- **文档更新**: 移除V1文档，保留迁移指南

---

**版本策略状态**: 设计完成，等待技术评审  
**下一步行动**: 开发团队技术评审会议  
**负责人**: API架构组  
**预计完成**: 2025年8月第2周  