# Cube Castle 技术栈信息

**文档版本**: v2.0.0-alpha.1  
**更新时间**: 2025-07-31 19:45  
**维护状态**: ✅ 活跃维护

## 📚 技术栈概览

### 后端技术栈 (Go生态系统)

#### 🏗️ 核心框架
```yaml
语言版本: Go 1.23+
Web框架: Chi Router v5.1.0
ORM框架: Ent v0.14+ (Facebook/Meta)
数据库: PostgreSQL 16+ 
缓存: Redis 7+
消息队列: RabbitMQ 3.13+
```

#### 🔒 安全与中间件
- **认证授权**: JWT + OAuth2.0 + RBAC
- **多租户**: PostgreSQL行级安全(RLS)
- **策略引擎**: Open Policy Agent (OPA)
- **数据分类**: 自动PII检测与分类
- **API安全**: 请求验证 + 速率限制

#### 🛠️ 开发工具
- **元合约编译器**: 自定义CLI (YAML→Go代码生成)
- **构建工具**: Makefile + Go modules
- **代码生成**: Ent Schema + API生成器
- **容器化**: Docker + Docker Compose

### 前端技术栈 (现代化React生态系统)

#### ⚡ 核心框架 (v2.0 现代化技术栈)
```yaml
框架版本: Next.js 14.1.4 (稳定版本)
UI架构: shadcn/ui + Radix UI + Tailwind CSS
组件库: 完全基于Radix UI primitives
图标库: Lucide React (统一现代图标系统)
语言: TypeScript 5.5+
样式系统: Tailwind CSS 3.4+
```

> 🎯 **v2.0 架构升级**: 完全移除Ant Design，建立现代化原子设计系统

#### 🎨 UI组件架构 (全新设计)
**现代化组件分层**:
```
├── Radix UI Primitives (无头组件基础)
├── shadcn/ui Components (设计系统实现)  
├── Custom Business Components (业务组件)
└── Page-level Compositions (页面组合)
```

**组件库对比**:
| 特性 | v1.x (Ant Design) | v2.0 (现代化架构) |
|------|------------------|------------------|
| 样式系统 | Less + CSS-in-JS | Tailwind CSS 原子化 |
| 主题定制 | 受限的主题变量 | 完全可定制 CSS Variables |
| 包体积 | ~2.3MB (完整导入) | ~400KB (按需加载) |
| 可访问性 | 部分支持 | WAI-ARIA 完全支持 |
| 设计自由度 | 受限于Ant设计语言 | 完全自定义 |
| TypeScript | 基础支持 | 原生TypeScript优先 |
- **动画库**: Framer Motion 11.3+ (高性能动画)
- **拖拽交互**: @dnd-kit + React DnD (现代拖拽体验)

#### 🔧 状态管理与数据
- **状态管理**: Zustand 4.5+ (轻量级)
- **数据获取**: SWR 2.2+ (缓存优化)
- **表单处理**: React Hook Form + Zod验证
- **HTTP客户端**: Axios 1.7+

#### 🧪 测试与质量
- **单元测试**: Jest 29+ + Testing Library
- **E2E测试**: Playwright 1.45+
- **类型检查**: TypeScript strict模式
- **代码规范**: ESLint + Prettier

### 数据库与存储

#### 🗄️ 主数据库
- **类型**: PostgreSQL 16+
- **特性**: JSON支持, 全文搜索, 时态表
- **安全**: 行级安全(RLS) + 列级加密
- **备份**: 自动备份 + 点时间恢复

#### 📊 缓存与会话
- **Redis**: 会话存储 + 查询缓存
- **内存缓存**: 应用级缓存策略
- **CDN**: 静态资源分发

### DevOps与部署

#### 🚀 容器化部署
```yaml
容器运行时: Docker 24+
编排平台: Docker Compose (开发) / Kubernetes (生产)
镜像仓库: 私有Docker Registry
配置管理: 环境变量 + Secret管理
```

#### 📈 监控与可观测性
- **日志**: 结构化JSON日志
- **指标**: 自定义业务指标
- **追踪**: 分布式请求追踪
- **健康检查**: 自动健康监控

#### 🔄 CI/CD流程
- **版本控制**: Git + GitFlow工作流
- **构建**: 自动化构建管道
- **测试**: 自动化测试执行
- **部署**: 滚动更新 + 零停机部署

## 🔄 版本兼容性矩阵

### 当前稳定版本组合 (2025-07-30)

#### 前端依赖 (v2.0 现代化技术栈)
| 包名 | 当前版本 | 变更状态 | 备注 |
|------|----------|----------|------|
| next | 14.1.4 | ✅ 保持 | 稳定版本，支持现代React特性 |
| ~~antd~~ | ~~5.20.6~~ | ❌ 已移除 | 完全移除，迁移至现代化架构 |
| ~~@ant-design/icons~~ | ~~5.3.7~~ | ❌ 已移除 | 替换为lucide-react |
| @radix-ui/react-* | ^1.1.14 | ✅ 新增 | 无头组件基础设施 |
| shadcn/ui | latest | ✅ 新增 | 现代设计系统实现 |
| lucide-react | ^0.400.0 | ✅ 升级 | 统一现代图标系统 |
| tailwindcss | 3.4.0 | ✅ 保持 | 原子化CSS框架 |
| typescript | 5.5.0 | ✅ 保持 | 类型系统 |

#### 后端依赖
| 包名 | 版本要求 | 状态 | 说明 |
|------|----------|------|------|
| Go | 1.23+ | ✅ | 语言运行时 |
| Chi | v5.1.0 | ✅ | Web路由框架 |
| Ent | v0.14+ | ✅ | ORM框架 |
| GORM | - | ❌ | 已迁移到Ent |
| PostgreSQL | 16+ | ✅ | 主数据库 |

### 升级路线图

#### 短期计划 (1个月内)
- **前端**: 监控当前版本稳定性
- **后端**: Go 1.24 迁移准备
- **数据库**: PostgreSQL 17 评估

#### 中期计划 (3个月内)
- **前端**: Next.js 15.x 兼容性研究
- **前端**: Ant Design 6.x 迁移评估
- **后端**: Ent v0.15 升级

#### 长期计划 (6个月内)
- **架构**: 微服务拆分评估
- **前端**: React 19 支持
- **数据库**: 分布式数据库方案

## 🚨 已知限制与约束

### 前端限制
1. **版本锁定**: 当前版本组合不可随意升级
2. **ES模块**: 需要特殊Webpack配置处理
3. **构建时间**: 大型项目构建可能较长

### 后端限制
1. **单体架构**: 当前为单体应用，大规模时需要拆分
2. **内存使用**: Go应用内存占用相对较高
3. **并发限制**: 数据库连接池需要合理配置

### 基础设施限制
1. **单机部署**: 当前配置适用于中小规模
2. **存储容量**: 文件存储需要扩展方案
3. **网络带宽**: 大文件处理需要CDN支持

## 📋 技术决策记录

### ADR-001: ~~前端UI库选择~~ (已废弃)
- **决策**: ~~选择Ant Design作为主要UI库~~
- **原因**: ~~企业级特性丰富，中文支持好~~
- **影响**: ~~需要处理ES模块兼容性问题~~
- **状态**: ❌ 已废弃，迁移至现代化架构

### ADR-002: ORM框架选择  
- **决策**: 从GORM迁移到Ent
- **原因**: 类型安全，代码生成，Facebook维护
- **影响**: 需要重写数据访问层
- **状态**: ✅ 已完成迁移

### ~~ADR-003: 前端版本策略~~ (已废弃)
- **决策**: ~~采用稳定版本组合而非最新版本~~
- **原因**: ~~确保生产环境稳定性~~
- **影响**: ~~部分最新特性不可用~~
- **状态**: ❌ 已废弃，v2.0采用现代化架构

### ADR-004: UI组件库标准化重构 (v2.0)
- **决策**: 完全移除Ant Design，迁移至shadcn/ui + Radix UI架构
- **原因**: 
  - 消除ES模块兼容性问题
  - 获得完全的设计自主权和定制能力
  - 大幅减少包体积 (2.3MB → 400KB)
  - 提升可访问性和TypeScript支持
  - 建立现代化原子设计系统
- **影响**: 
  - 需要重构所有UI组件和页面
  - 短期内部分页面功能不可用
  - 长期获得更好的开发体验和性能
- **实施阶段**:
  - ✅ Phase 1: 基础清理和依赖移除 (2025-07-31)
  - 🔄 Phase 2: 核心组件体系重建 (计划中)
  - 📋 Phase 3: 页面重构和功能恢复 (计划中)
- **状态**: 🚧 进行中，Phase 1已完成

---

## 📈 迁移记录

### v2.0.0-alpha.1 UI架构现代化 (2025-07-31)

#### 重大架构变更
- **完全移除**: Ant Design 5.20.6 + @ant-design/icons
- **新增基础**: @radix-ui/react-popover + shadcn/ui组件
- **图标系统**: 统一使用Lucide React
- **构建优化**: 修复ESLint配置，支持现代TypeScript工作流

#### 技术债务清理
- 移除17个文件中的antd引用
- 清理ES模块兼容性问题
- 简化构建配置和依赖关系

#### 当前限制
⚠️ **临时不可用页面** (等待重构):
- 工作流管理 (`/workflows/*`)
- 职位管理 (`/positions/*`) 
- 员工职位历史 (`/employees/positions/*`)
- 组织架构图 (`/organization/chart`)
- 管理员功能 (`/admin/*`)

#### 下一步计划
- 完善Radix UI依赖安装
- 重建核心业务组件
- 恢复页面功能 (优先级: 员工管理 → 职位管理 → 工作流管理)

## 🔗 相关文档

- **架构文档**: `/docs/architecture/`
- **开发指南**: `/docs/development/`
- **API文档**: `/docs/api/`
- **部署指南**: `/docs/deployment/`
- **故障排除**: `/docs/troubleshooting/`

---

**维护负责人**: 技术架构团队  
**文档状态**: ✅ 当前有效  
**下次更新**: 2025-08-30 (月度更新)