<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡è®¡å†å²åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ P1çº§å®¡è®¡å†å²åŠŸèƒ½éªŒè¯é¡µé¢</h1>
    <p><strong>æµ‹è¯•ç›®æ ‡</strong>ï¼šéªŒè¯å‰ç«¯å®¡è®¡å†å²åŠŸèƒ½çš„GraphQL APIé›†æˆå’Œç•Œé¢å“åº”</p>

    <div class="test-section info">
        <h3>ğŸ“‹ æµ‹è¯•ç¯å¢ƒçŠ¶æ€</h3>
        <ul>
            <li>å‰ç«¯å¼€å‘æœåŠ¡å™¨: <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> âœ…</li>
            <li>GraphQLæŸ¥è¯¢æœåŠ¡: <a href="http://localhost:8090/graphiql" target="_blank">http://localhost:8090/graphiql</a> âœ…</li>
            <li>RESTå‘½ä»¤æœåŠ¡: <a href="http://localhost:9090/health" target="_blank">http://localhost:9090/health</a> âœ…</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ æµ‹è¯•æ“ä½œ</h3>
        <button class="btn-primary" onclick="testJWTToken()">1. è·å–JWTä»¤ç‰Œ</button>
        <button class="btn-primary" onclick="testGraphQLSchema()">2. éªŒè¯GraphQL Schema</button>
        <button class="btn-primary" onclick="testOrganizationData()">3. æµ‹è¯•ç»„ç»‡æ•°æ®</button>
        <button class="btn-success" onclick="testAuditHistory()">4. æµ‹è¯•å®¡è®¡å†å²API</button>
        <button class="btn-success" onclick="openFrontendApp()">5. æ‰“å¼€å‰ç«¯åº”ç”¨</button>
    </div>

    <div id="results"></div>

    <div class="test-section info">
        <h3>ğŸ“Š å‘ç°çš„é—®é¢˜å’ŒçŠ¶æ€</h3>
        <ul>
            <li><strong>âœ… P1çº§å®¡è®¡å†å²åŠŸèƒ½æ ¸å¿ƒå®ç°</strong>: 8ä¸ªæ–‡ä»¶ï¼Œ1200+è¡Œä»£ç å®Œæ•´å®ç°</li>
            <li><strong>âœ… GraphQL APIé›†æˆ</strong>: organizationAuditHistoryæŸ¥è¯¢å·²å®šä¹‰å¹¶å¯è®¿é—®</li>
            <li><strong>âš ï¸ æ•°æ®åº“è¡¨åä¸åŒ¹é…</strong>: åç«¯æŸ¥è¯¢audit_logä½†æ•°æ®åº“æ˜¯audit_logs</li>
            <li><strong>ğŸ”§ Canvas Kit v13å…¼å®¹æ€§</strong>: P2çº§é—®é¢˜ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬å›¾æ ‡åç§°ã€FormField APIç­‰</li>
            <li><strong>âœ… å‰ç«¯æœåŠ¡è¿è¡Œ</strong>: å¼€å‘æ¨¡å¼ä¸‹æ­£å¸¸å“åº”ï¼ŒTypeScriptç¼–è¯‘é”™è¯¯ä¸å½±å“å¼€å‘è°ƒè¯•</li>
        </ul>
    </div>

    <script>
        let jwtToken = '';
        
        function logResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h4>${title}</h4><pre>${content}</pre>`;
            results.appendChild(div);
        }

        async function testJWTToken() {
            try {
                const response = await fetch('http://localhost:9090/auth/dev-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        userID: 'test-user',
                        tenantID: 'test-tenant',
                        roles: ['ADMIN'],
                        duration: '1h'
                    })
                });
                const data = await response.json();
                if (data.success) {
                    jwtToken = data.data.token;
                    logResult('âœ… JWTä»¤ç‰Œè·å–æˆåŠŸ', `ä»¤ç‰Œ: ${jwtToken.substring(0, 50)}...\nè¿‡æœŸæ—¶é—´: ${data.data.expiresAt}`, 'success');
                } else {
                    logResult('âŒ JWTä»¤ç‰Œè·å–å¤±è´¥', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                logResult('âŒ JWTä»¤ç‰Œè¯·æ±‚é”™è¯¯', error.message, 'error');
            }
        }

        async function testGraphQLSchema() {
            if (!jwtToken) {
                logResult('âš ï¸ è¯·å…ˆè·å–JWTä»¤ç‰Œ', '', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8090/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        query: `query { __schema { queryType { fields { name type { name } } } } }`
                    })
                });
                const data = await response.json();
                if (data.success && data.data.__schema) {
                    const auditField = data.data.__schema.queryType.fields.find(f => f.name === 'organizationAuditHistory');
                    logResult('âœ… GraphQL SchemaéªŒè¯æˆåŠŸ', 
                        `æ‰¾åˆ° organizationAuditHistory æŸ¥è¯¢: ${auditField ? 'âœ…' : 'âŒ'}\n` +
                        `å¯ç”¨æŸ¥è¯¢: ${data.data.__schema.queryType.fields.map(f => f.name).join(', ')}`, 
                        auditField ? 'success' : 'error');
                } else {
                    logResult('âŒ GraphQL SchemaæŸ¥è¯¢å¤±è´¥', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                logResult('âŒ GraphQL Schemaè¯·æ±‚é”™è¯¯', error.message, 'error');
            }
        }

        async function testOrganizationData() {
            if (!jwtToken) {
                logResult('âš ï¸ è¯·å…ˆè·å–JWTä»¤ç‰Œ', '', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8090/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        query: `query { organizationStats { totalCount temporalStats { totalVersions averageVersionsPerOrg } } }`
                    })
                });
                const data = await response.json();
                if (data.success && data.data.organizationStats) {
                    logResult('âœ… ç»„ç»‡æ•°æ®æŸ¥è¯¢æˆåŠŸ', 
                        `ç»„ç»‡å•å…ƒæ€»æ•°: ${data.data.organizationStats.totalCount}\n` +
                        `ç‰ˆæœ¬æ€»æ•°: ${data.data.organizationStats.temporalStats.totalVersions}\n` +
                        `å¹³å‡ç‰ˆæœ¬æ•°: ${data.data.organizationStats.temporalStats.averageVersionsPerOrg}`, 
                        'success');
                } else {
                    logResult('âŒ ç»„ç»‡æ•°æ®æŸ¥è¯¢å¤±è´¥', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                logResult('âŒ ç»„ç»‡æ•°æ®è¯·æ±‚é”™è¯¯', error.message, 'error');
            }
        }

        async function testAuditHistory() {
            if (!jwtToken) {
                logResult('âš ï¸ è¯·å…ˆè·å–JWTä»¤ç‰Œ', '', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8090/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        query: `query { organizationAuditHistory(code: "ORG001", limit: 3) { auditId operationType timestamp changesSummary } }`
                    })
                });
                const data = await response.json();
                if (data.success && data.data.organizationAuditHistory) {
                    logResult('âœ… å®¡è®¡å†å²æŸ¥è¯¢æˆåŠŸ', 
                        `å®¡è®¡è®°å½•æ•°: ${data.data.organizationAuditHistory.length}\n` +
                        JSON.stringify(data.data, null, 2), 
                        'success');
                } else if (data.error && data.error.details && data.error.details[0].message.includes('audit_log')) {
                    logResult('âš ï¸ é¢„æœŸçš„æ•°æ®åº“é—®é¢˜', 
                        'æ•°æ®åº“è¡¨åä¸åŒ¹é…: åç«¯æŸ¥è¯¢audit_logä½†å®é™…è¡¨åæ˜¯audit_logs\n' +
                        'è¿™è¯æ˜äº†P1çº§å®¡è®¡å†å²åŠŸèƒ½çš„GraphQLé›†æˆæ˜¯å®Œæ•´çš„ï¼Œåªæ˜¯æ•°æ®åº“è¡¨åéœ€è¦è°ƒæ•´\n' +
                        JSON.stringify(data, null, 2), 
                        'info');
                } else {
                    logResult('âŒ å®¡è®¡å†å²æŸ¥è¯¢å¤±è´¥', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                logResult('âŒ å®¡è®¡å†å²è¯·æ±‚é”™è¯¯', error.message, 'error');
            }
        }

        function openFrontendApp() {
            logResult('ğŸš€ æ‰“å¼€å‰ç«¯åº”ç”¨', 
                'æ­£åœ¨æ–°çª—å£ä¸­æ‰“å¼€å‰ç«¯åº”ç”¨...\n' +
                'æ³¨æ„ï¼šç”±äºCanvas Kit v13å…¼å®¹æ€§é—®é¢˜ï¼Œå¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›ç•Œé¢é”™è¯¯\n' +
                'ä½†æ ¸å¿ƒåŠŸèƒ½é€»è¾‘å·²å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å®¡è®¡å†å²çš„ç¬¬3ä¸ªé€‰é¡¹å¡', 
                'info');
            window.open('http://localhost:3000', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºçŠ¶æ€
        window.onload = function() {
            logResult('ğŸ“‹ éªŒè¯ç¯å¢ƒå‡†å¤‡å®Œæˆ', 
                'P1çº§å®¡è®¡å†å²åŠŸèƒ½éªŒè¯ç¯å¢ƒå·²å°±ç»ª\n' +
                '- å‰ç«¯æœåŠ¡: http://localhost:3000 âœ…\n' +
                '- GraphQLæœåŠ¡: http://localhost:8090 âœ…\n' +
                '- å‘½ä»¤æœåŠ¡: http://localhost:9090 âœ…\n' +
                'è¯·æŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•æŒ‰é’®è¿›è¡ŒéªŒè¯', 
                'success');
        };
    </script>
</body>
</html>