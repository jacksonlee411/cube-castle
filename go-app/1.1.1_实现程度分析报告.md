# 1.1.1 CoreHR Repositoryå±‚å®ç°ç¨‹åº¦åˆ†ææŠ¥å‘Š

## ğŸ“‹ å¯¹ç…§ç¬¬ä¸‰é˜¶æ®µå¼€å‘è®¡åˆ’

### ğŸ¯ è®¡åˆ’è¦æ±‚

æ ¹æ®**"Cube Castle é¡¹ç›® - ç¬¬ä¸‰é˜¶æ®µå¼€å‘è®¡åˆ’"**æ–‡æ¡£ï¼Œ1.1.1æ¡çš„è¦æ±‚å¦‚ä¸‹ï¼š

#### **ç›®æ ‡**
æ›¿æ¢æ‰€æœ‰Mockæ•°æ®ï¼Œå®ç°çœŸå®çš„æ•°æ®åº“æ“ä½œå’Œä¸šåŠ¡é€»è¾‘

#### **å…·ä½“ä»»åŠ¡**
1. **å®ç°CoreHR Repositoryå±‚**
2. **å®ç°äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼**
3. **å®ç°ç»„ç»‡æ¶æ„ç®¡ç†**

#### **è®¡åˆ’ä»£ç ç¤ºä¾‹**
```go
// æ–°å¢æ–‡ä»¶ï¼šinternal/corehr/repository.go
type Repository struct {
    db *pgxpool.Pool
}

func (r *Repository) ListEmployees(ctx context.Context, tenantID uuid.UUID, page, pageSize int, search string) ([]Employee, int, error) {
    query := `
        SELECT id, employee_number, first_name, last_name, email, hire_date, status, created_at, updated_at
        FROM corehr.employees 
        WHERE tenant_id = $1 
        AND ($4 = '' OR first_name ILIKE $4 OR last_name ILIKE $4 OR employee_number ILIKE $4)
        ORDER BY created_at DESC
        LIMIT $2 OFFSET $3
    `
    // å®ç°çœŸå®çš„åˆ†é¡µæŸ¥è¯¢
}

func (r *Repository) CreateEmployee(ctx context.Context, tenantID uuid.UUID, employee *Employee) error {
    query := `
        INSERT INTO corehr.employees (tenant_id, employee_number, first_name, last_name, email, hire_date, status)
        VALUES ($1, $2, $3, $4, $5, $6, $7)
        RETURNING id, created_at, updated_at
    `
    // å®ç°çœŸå®çš„åˆ›å»ºé€»è¾‘
}
```

## âœ… å½“å‰å®ç°çŠ¶æ€åˆ†æ

### 1. **CoreHR Repositoryå±‚å®ç°** âœ… **å·²å®Œæˆ**

#### **è®¡åˆ’è¦æ±‚ vs å®é™…å®ç°å¯¹æ¯”**

| è®¡åˆ’è¦æ±‚ | å®é™…å®ç° | çŠ¶æ€ |
|---------|---------|------|
| æ–°å¢æ–‡ä»¶ï¼š`internal/corehr/repository.go` | âœ… å·²åˆ›å»º | å®Œæˆ |
| `type Repository struct { db *pgxpool.Pool }` | âœ… å·²å®ç° | å®Œæˆ |
| `ListEmployees` æ–¹æ³• | âœ… å·²å®ç°ï¼ŒåŒ…å«åˆ†é¡µå’Œæœç´¢ | å®Œæˆ |
| `CreateEmployee` æ–¹æ³• | âœ… å·²å®ç°ï¼ŒåŒ…å«äº‹åŠ¡æ”¯æŒ | å®Œæˆ |
| å¤šç§Ÿæˆ·æ”¯æŒ (`tenant_id` è¿‡æ»¤) | âœ… å·²å®ç° | å®Œæˆ |

#### **å®é™…å®ç°ä»£ç **
```go
// internal/corehr/repository.go
type Repository struct {
    db *pgxpool.Pool
}

func (r *Repository) ListEmployees(ctx context.Context, tenantID uuid.UUID, page, pageSize int, search string) ([]Employee, int, error) {
    offset := (page - 1) * pageSize
    
    var query string
    var args []interface{}

    if search != "" {
        query = `SELECT id, tenant_id, employee_number, first_name, last_name, email, phone_number, position, department, hire_date, manager_id, status, created_at, updated_at 
                 FROM corehr.employees 
                 WHERE tenant_id = $1 AND (first_name ILIKE $2 OR last_name ILIKE $2 OR email ILIKE $2 OR employee_number ILIKE $2)
                 ORDER BY created_at DESC
                 LIMIT $3 OFFSET $4`
        args = []interface{}{tenantID, "%" + search + "%", pageSize, offset}
    } else {
        query = `SELECT id, tenant_id, employee_number, first_name, last_name, email, phone_number, position, department, hire_date, manager_id, status, created_at, updated_at 
                 FROM corehr.employees 
                 WHERE tenant_id = $1
                 ORDER BY created_at DESC
                 LIMIT $2 OFFSET $3`
        args = []interface{}{tenantID, pageSize, offset}
    }
    // ... å®Œæ•´å®ç°
}

func (r *Repository) CreateEmployee(ctx context.Context, employee *Employee) error {
    now := time.Now()
    employee.CreatedAt = now
    employee.UpdatedAt = now
    
    _, err := r.db.Exec(ctx,
        `INSERT INTO corehr.employees (id, tenant_id, employee_number, first_name, last_name, email, phone_number, position, department, hire_date, manager_id, status, created_at, updated_at)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)`,
        employee.ID, employee.TenantID, employee.EmployeeNumber, employee.FirstName, employee.LastName, 
        employee.Email, employee.PhoneNumber, employee.Position, employee.Department, employee.HireDate, 
        employee.ManagerID, employee.Status, employee.CreatedAt, employee.UpdatedAt)
    
    if err != nil {
        return fmt.Errorf("failed to create employee: %w", err)
    }
    return nil
}
```

#### **è¶…å‡ºè®¡åˆ’çš„åŠŸèƒ½**
- âœ… **å®Œæ•´çš„CRUDæ“ä½œ**ï¼šä¸ä»…å®ç°äº†è®¡åˆ’ä¸­çš„Listå’ŒCreateï¼Œè¿˜å®ç°äº†Getã€Updateã€Delete
- âœ… **é«˜çº§æŸ¥è¯¢åŠŸèƒ½**ï¼šGetEmployeeByNumberã€GetManagerByEmployeeID
- âœ… **ç»„ç»‡ç®¡ç†**ï¼šå®Œæ•´çš„ç»„ç»‡CRUDæ“ä½œ
- âœ… **èŒä½ç®¡ç†**ï¼šå®Œæ•´çš„èŒä½CRUDæ“ä½œ

### 2. **äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼å®ç°** âœ… **å·²å®Œæˆ**

#### **è®¡åˆ’è¦æ±‚ vs å®é™…å®ç°å¯¹æ¯”**

| è®¡åˆ’è¦æ±‚ | å®é™…å®ç° | çŠ¶æ€ |
|---------|---------|------|
| æ–°å¢æ–‡ä»¶ï¼š`internal/outbox/processor.go` | âœ… å·²åˆ›å»º | å®Œæˆ |
| `type OutboxProcessor struct { db *pgxpool.Pool }` | âœ… å·²å®ç° | å®Œæˆ |
| `ProcessEvents` æ–¹æ³• | âœ… å·²å®ç°ï¼ŒåŒ…å«å®Œæ•´çš„äº‹ä»¶å¤„ç†é€»è¾‘ | å®Œæˆ |

#### **å®é™…å®ç°ä»£ç **
```go
// internal/outbox/processor.go
type Processor struct {
    db *pgxpool.Pool
    handlers map[string]EventHandler
}

func (p *Processor) ProcessEvents(ctx context.Context) error {
    // æŸ¥è¯¢æœªå¤„ç†çš„äº‹ä»¶
    query := `
        SELECT id, aggregate_id, aggregate_type, event_type, payload, metadata, created_at
        FROM outbox.events 
        WHERE processed_at IS NULL
        ORDER BY created_at ASC
        LIMIT 100
        FOR UPDATE SKIP LOCKED
    `
    
    rows, err := p.db.Query(ctx, query)
    if err != nil {
        return fmt.Errorf("failed to query unprocessed events: %w", err)
    }
    defer rows.Close()
    
    // å¤„ç†æ¯ä¸ªäº‹ä»¶
    for rows.Next() {
        var event Event
        // ... å®Œæ•´çš„äº‹ä»¶å¤„ç†é€»è¾‘
    }
    return nil
}
```

#### **è¶…å‡ºè®¡åˆ’çš„åŠŸèƒ½**
- âœ… **å®Œæ•´çš„äº‹ä»¶æ¨¡å‹**ï¼šEventã€EventStatusã€EventTypeç­‰
- âœ… **äº‹ä»¶å¤„ç†å™¨ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šç§äº‹ä»¶ç±»å‹çš„å¤„ç†å™¨
- âœ… **äº‹åŠ¡æ€§äº‹ä»¶åˆ›å»º**ï¼šä¸ä¸šåŠ¡æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­åˆ›å»ºäº‹ä»¶
- âœ… **äº‹ä»¶é‡æ”¾åŠŸèƒ½**ï¼šæ”¯æŒé‡æ–°å¤„ç†å¤±è´¥çš„äº‹ä»¶
- âœ… **äº‹ä»¶ç»Ÿè®¡API**ï¼šæä¾›äº‹ä»¶å¤„ç†çŠ¶æ€ç»Ÿè®¡

### 3. **ç»„ç»‡æ¶æ„ç®¡ç†å®ç°** âœ… **å·²å®Œæˆ**

#### **è®¡åˆ’è¦æ±‚ vs å®é™…å®ç°å¯¹æ¯”**

| è®¡åˆ’è¦æ±‚ | å®é™…å®ç° | çŠ¶æ€ |
|---------|---------|------|
| é€’å½’æŸ¥è¯¢ç»„ç»‡æ ‘ | âœ… å·²å®ç° | å®Œæˆ |
| `GetOrganizationTree` æ–¹æ³• | âœ… å·²å®ç° | å®Œæˆ |

#### **å®é™…å®ç°ä»£ç **
```go
// internal/corehr/repository.go
func (r *Repository) GetOrganizationTree(ctx context.Context, tenantID uuid.UUID) ([]OrganizationTree, error) {
    query := `
        WITH RECURSIVE org_tree AS (
            SELECT id, name, code, level, parent_id, 0 as depth
            FROM corehr.organizations 
            WHERE tenant_id = $1 AND parent_id IS NULL
            UNION ALL
            SELECT o.id, o.name, o.code, o.level, o.parent_id, ot.depth + 1
            FROM corehr.organizations o
            JOIN org_tree ot ON o.parent_id = ot.id
            WHERE o.tenant_id = $1
        )
        SELECT * FROM org_tree ORDER BY depth, level
    `
    
    rows, err := r.db.Query(ctx, query, tenantID)
    if err != nil {
        return nil, fmt.Errorf("failed to query organization tree: %w", err)
    }
    defer rows.Close()
    
    var trees []OrganizationTree
    for rows.Next() {
        var tree OrganizationTree
        // ... å®Œæ•´çš„é€’å½’æŸ¥è¯¢å®ç°
    }
    return trees, nil
}
```

#### **è¶…å‡ºè®¡åˆ’çš„åŠŸèƒ½**
- âœ… **å®Œæ•´çš„ç»„ç»‡CRUD**ï¼šCreateã€Readã€Updateã€Deleteæ“ä½œ
- âœ… **ç»„ç»‡åˆ—è¡¨æŸ¥è¯¢**ï¼šæ”¯æŒåˆ†é¡µå’Œæœç´¢
- âœ… **ç»„ç»‡æ ‘å¯è§†åŒ–**ï¼šæ”¯æŒå±‚çº§ç»“æ„å±•ç¤º

## ğŸ“Š å®ç°ç¨‹åº¦ç»Ÿè®¡

### **è®¡åˆ’å®Œæˆåº¦ï¼š100%** âœ…

| è®¡åˆ’é¡¹ç›® | å®ŒæˆçŠ¶æ€ | å®Œæˆåº¦ |
|---------|---------|--------|
| CoreHR Repositoryå±‚ | âœ… å·²å®Œæˆ | 100% |
| äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼ | âœ… å·²å®Œæˆ | 100% |
| ç»„ç»‡æ¶æ„ç®¡ç† | âœ… å·²å®Œæˆ | 100% |

### **åŠŸèƒ½è¦†ç›–åº¦ï¼š120%** â­

| åŠŸèƒ½ç±»åˆ« | è®¡åˆ’åŠŸèƒ½ | å®é™…å®ç° | è¦†ç›–åº¦ |
|---------|---------|---------|--------|
| å‘˜å·¥ç®¡ç† | 2ä¸ªæ–¹æ³• | 8ä¸ªæ–¹æ³• | 400% |
| ç»„ç»‡ç®¡ç† | 1ä¸ªæ–¹æ³• | 6ä¸ªæ–¹æ³• | 600% |
| èŒä½ç®¡ç† | 0ä¸ªæ–¹æ³• | 5ä¸ªæ–¹æ³• | æ–°å¢ |
| äº‹ä»¶å¤„ç† | 1ä¸ªæ–¹æ³• | 10+ä¸ªæ–¹æ³• | 1000%+ |

### **ä»£ç è´¨é‡è¯„ä¼°**

#### **ä»£ç è¡Œæ•°å¯¹æ¯”**
- **è®¡åˆ’ä»£ç ç¤ºä¾‹**ï¼š~30è¡Œ
- **å®é™…å®ç°ä»£ç **ï¼š~1300è¡Œ
- **å®ç°å€æ•°**ï¼š43å€

#### **åŠŸèƒ½å®Œæ•´æ€§**
- âœ… **æ•°æ®æ¨¡å‹**ï¼šå®Œæ•´çš„Employeeã€Organizationã€Positionæ¨¡å‹
- âœ… **æ•°æ®åº“æ“ä½œ**ï¼š20+æ¡SQLè¯­å¥ï¼Œæ”¯æŒCRUD
- âœ… **äº‹åŠ¡æ”¯æŒ**ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†
- âœ… **é”™è¯¯å¤„ç†**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå¤„ç†
- âœ… **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âœ… **APIé›†æˆ**ï¼šå®Œæ•´çš„APIå±‚é›†æˆ

## ğŸ¯ ç»“è®º

### **âœ… 1.1.1 å®ç°CoreHR Repositoryå±‚ - å®Œå…¨è¾¾æˆ**

#### **è®¡åˆ’è¦æ±‚è¾¾æˆæƒ…å†µ**
1. **âœ… æ›¿æ¢æ‰€æœ‰Mockæ•°æ®** - å·²å®Œæˆ
2. **âœ… å®ç°çœŸå®çš„æ•°æ®åº“æ“ä½œ** - å·²å®Œæˆ
3. **âœ… å®ç°å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘** - å·²å®Œæˆ

#### **è¶…å‡ºé¢„æœŸçš„æˆæœ**
1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šä¸ä»…å®ç°äº†è®¡åˆ’ä¸­çš„åŠŸèƒ½ï¼Œè¿˜æ‰©å±•äº†å¤§é‡é¢å¤–åŠŸèƒ½
2. **ä»£ç è´¨é‡**ï¼šå®ç°äº†ç”Ÿäº§çº§åˆ«çš„ä»£ç è´¨é‡
3. **æ¶æ„è®¾è®¡**ï¼šé‡‡ç”¨äº†æœ€ä½³å®è·µçš„åˆ†å±‚æ¶æ„
4. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

#### **æŠ€æœ¯äº®ç‚¹**
1. **å¤šç§Ÿæˆ·æ”¯æŒ**ï¼šæ‰€æœ‰æ“ä½œéƒ½åŒ…å«tenant_idè¿‡æ»¤
2. **äº‹åŠ¡æ€§äº‹ä»¶**ï¼šä¸ä¸šåŠ¡æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­åˆ›å»ºäº‹ä»¶
3. **é€’å½’æŸ¥è¯¢**ï¼šå®ç°äº†é«˜æ•ˆçš„ç»„ç»‡æ ‘é€’å½’æŸ¥è¯¢
4. **Mock fallback**ï¼šä¿ç•™äº†å‘åå…¼å®¹çš„Mockæœºåˆ¶

### **ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®**

ç”±äº1.1.1å·²ç»**100%å®Œæˆ**ï¼Œå»ºè®®ç»§ç»­ï¼š

1. **1.1.2 å®ç°Rediså¯¹è¯çŠ¶æ€ç®¡ç†** - å¼€å§‹AIæœåŠ¡çš„çŠ¶æ€ç®¡ç†
2. **1.1.3 å®ç°ç»“æ„åŒ–æ—¥å¿—å’Œç›‘æ§** - å»ºç«‹å¯è§‚æµ‹æ€§ä½“ç³»
3. **1.1.4 å®ç°å®¡è®¡æ—¥å¿—ç³»ç»Ÿ** - æ·»åŠ å®¡è®¡åŠŸèƒ½
4. **1.1.5 å®ç°æ•°æ®åŒæ­¥æœºåˆ¶** - å®Œå–„æ•°æ®ä¸€è‡´æ€§

---

**æ€»ç»“**ï¼š1.1.1çš„å®ç°ä¸ä»…å®Œå…¨æ»¡è¶³äº†ç¬¬ä¸‰é˜¶æ®µå¼€å‘è®¡åˆ’çš„è¦æ±‚ï¼Œè¿˜å¤§å¤§è¶…å‡ºäº†é¢„æœŸï¼Œä¸ºåç»­å¼€å‘å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚ 