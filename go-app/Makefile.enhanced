# Enhanced Makefile for Cube Castle Employee Management System
# Includes comprehensive testing framework and automation

# Go parameters
GOCMD=go
GOBUILD=$(GOCMD) build
GOCLEAN=$(GOCMD) clean
GOTEST=$(GOCMD) test
GOGET=$(GOCMD) get
GOMOD=$(GOCMD) mod

# Binary names
SERVER_BINARY=cube-castle-server
COMPILER_BINARY=metacontract-compiler

# Test parameters
TEST_TIMEOUT=10m
TEST_FLAGS=-v -race -timeout=$(TEST_TIMEOUT)
COVERAGE_OUT=coverage.out
COVERAGE_HTML=coverage.html

# Colors for output
GREEN=\033[0;32m
RED=\033[0;31m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

.PHONY: help build test clean dev-setup server compiler test-all test-handlers test-coverage lint fmt mod-tidy docker-build docker-run

# Default target
help: ## Display this help message
	@echo "Cube Castle Employee Management System - Enhanced Makefile"
	@echo ""
	@echo "Available targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

## Build Targets

build: server compiler ## Build all binaries
	@echo -e "$(GREEN)‚úÖ Build completed successfully$(NC)"

server: ## Build the main server binary
	@echo -e "$(BLUE)üîß Building server...$(NC)"
	$(GOBUILD) -o $(SERVER_BINARY) ./cmd/server
	@echo -e "$(GREEN)‚úÖ Server binary built: $(SERVER_BINARY)$(NC)"

compiler: ## Build the meta-contract compiler
	@echo -e "$(BLUE)üîß Building meta-contract compiler...$(NC)"
	$(GOBUILD) -o $(COMPILER_BINARY) ./cmd/metacontract-compiler
	@echo -e "$(GREEN)‚úÖ Compiler binary built: $(COMPILER_BINARY)$(NC)"

## Testing Targets

test: ## Run comprehensive automated test suite
	@echo -e "$(BLUE)üöÄ Running comprehensive test suite...$(NC)"
	@./test_automation_framework.sh

test-quick: ## Run quick unit tests only
	@echo -e "$(BLUE)‚ö° Running quick unit tests...$(NC)"
	$(GOTEST) $(TEST_FLAGS) ./internal/handler/... ./internal/service/... ./internal/common/...

test-handlers: ## Run API handler tests specifically
	@echo -e "$(BLUE)üß™ Running API handler tests...$(NC)"
	$(GOTEST) $(TEST_FLAGS) ./internal/handler/...

test-coverage: ## Run tests with coverage report
	@echo -e "$(BLUE)üìä Running tests with coverage...$(NC)"
	$(GOTEST) $(TEST_FLAGS) -coverprofile=$(COVERAGE_OUT) ./internal/...
	$(GOCMD) tool cover -html=$(COVERAGE_OUT) -o $(COVERAGE_HTML)
	@echo -e "$(GREEN)‚úÖ Coverage report generated: $(COVERAGE_HTML)$(NC)"

test-integration: ## Run integration tests
	@echo -e "$(BLUE)üîó Running integration tests...$(NC)"
	$(GOTEST) $(TEST_FLAGS) ./internal/workflow/... ./internal/corehr/...

test-benchmarks: ## Run performance benchmarks
	@echo -e "$(BLUE)‚ö° Running benchmarks...$(NC)"
	$(GOTEST) -bench=. -benchmem ./internal/...

## Code Quality Targets

lint: ## Run linter (if available)
	@echo -e "$(BLUE)üîç Running linter...$(NC)"
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo -e "$(YELLOW)‚ö†Ô∏è golangci-lint not found, skipping...$(NC)"; \
	fi

fmt: ## Format Go code
	@echo -e "$(BLUE)üìù Formatting code...$(NC)"
	$(GOCMD) fmt ./...
	@echo -e "$(GREEN)‚úÖ Code formatted$(NC)"

vet: ## Run go vet
	@echo -e "$(BLUE)üîç Running go vet...$(NC)"
	$(GOCMD) vet ./...
	@echo -e "$(GREEN)‚úÖ Vet completed$(NC)"

mod-tidy: ## Tidy and vendor Go modules
	@echo -e "$(BLUE)üì¶ Tidying modules...$(NC)"
	$(GOMOD) tidy
	@echo -e "$(GREEN)‚úÖ Modules tidied$(NC)"

## Development Targets

dev-setup: build ## Set up development environment
	@echo -e "$(BLUE)üöÄ Setting up development environment...$(NC)"
	@make test-quick
	@echo -e "$(GREEN)‚úÖ Development environment ready!$(NC)"
	@echo ""
	@echo -e "$(BLUE)üìã Generated Files:$(NC)"
	@ls -la build/ 2>/dev/null || echo "No build directory yet"
	@echo ""
	@echo -e "$(BLUE)üîß Next Steps:$(NC)"
	@echo "  1. Run 'make server' to start the API server"
	@echo "  2. Run 'make test' to execute full test suite"
	@echo "  3. Run 'make test-coverage' for coverage analysis"

run-server: server ## Build and run the server
	@echo -e "$(BLUE)üöÄ Starting Cube Castle API server...$(NC)"
	./$(SERVER_BINARY)

## Database Targets

db-migrate: ## Run database migrations
	@echo -e "$(BLUE)üóÑÔ∏è Running database migrations...$(NC)"
	$(GOCMD) run ./cmd/migrate/main.go

db-schema: ## Generate database schema
	@echo -e "$(BLUE)üìä Generating database schema...$(NC)"
	$(GOCMD) run ./cmd/schema/main.go

## Docker Targets

docker-build: ## Build Docker image
	@echo -e "$(BLUE)üê≥ Building Docker image...$(NC)"
	docker build -t cube-castle-api .
	@echo -e "$(GREEN)‚úÖ Docker image built$(NC)"

docker-run: docker-build ## Build and run Docker container
	@echo -e "$(BLUE)üê≥ Running Docker container...$(NC)"
	docker run -p 8080:8080 cube-castle-api

## Cleanup Targets

clean: ## Clean build artifacts and test cache
	@echo -e "$(BLUE)üßπ Cleaning build artifacts...$(NC)"
	$(GOCLEAN)
	rm -f $(SERVER_BINARY) $(COMPILER_BINARY)
	rm -f $(COVERAGE_OUT) $(COVERAGE_HTML)
	rm -rf build/ generated/
	$(GOCMD) clean -testcache
	@echo -e "$(GREEN)‚úÖ Cleanup completed$(NC)"

clean-all: clean ## Clean everything including modules cache
	@echo -e "$(BLUE)üßπ Deep cleaning...$(NC)"
	$(GOCMD) clean -modcache
	@echo -e "$(GREEN)‚úÖ Deep cleanup completed$(NC)"

## Validation Targets

validate: lint vet test-quick ## Run all validation steps
	@echo -e "$(GREEN)‚úÖ All validation steps completed$(NC)"

validate-full: lint vet test ## Run comprehensive validation
	@echo -e "$(GREEN)‚úÖ Full validation completed$(NC)"

## CI/CD Targets

ci-test: ## Run tests in CI environment
	@echo -e "$(BLUE)ü§ñ Running CI tests...$(NC)"
	$(GOTEST) -v -race -coverprofile=$(COVERAGE_OUT) -covermode=atomic ./internal/...

ci-build: ## Build in CI environment
	@echo -e "$(BLUE)ü§ñ Building in CI environment...$(NC)"
	CGO_ENABLED=0 GOOS=linux $(GOBUILD) -a -installsuffix cgo -o $(SERVER_BINARY) ./cmd/server

## Meta Targets

all: clean mod-tidy validate-full build ## Complete build pipeline
	@echo -e "$(GREEN)üéâ Complete build pipeline finished!$(NC)"

status: ## Show project status
	@echo -e "$(BLUE)üìä Project Status$(NC)"
	@echo "Git branch: $$(git branch --show-current 2>/dev/null || echo 'unknown')"
	@echo "Go version: $$(go version)"
	@echo "Modules status:"
	@$(GOMOD) list -m all | head -5
	@echo ""
	@echo "Test files count: $$(find . -name '*_test.go' | wc -l)"
	@echo "Source files count: $$(find . -name '*.go' -not -name '*_test.go' | wc -l)"

info: ## Show detailed project information
	@echo -e "$(BLUE)üìã Cube Castle Employee Management System$(NC)"
	@echo "Version: Development"
	@echo "Language: Go"
	@echo "Framework: Chi Router + Ent ORM"
	@echo "Database: PostgreSQL (Production) / SQLite (Testing)"
	@echo "Testing: Go native + testify"
	@echo ""
	@echo -e "$(BLUE)üèóÔ∏è Architecture Components:$(NC)"
	@echo "‚Ä¢ API Handlers: Organization Units, Positions"
	@echo "‚Ä¢ Business Logic: Employee Lifecycle Workflows"
	@echo "‚Ä¢ Meta-Contract System: Dynamic schema compilation"
	@echo "‚Ä¢ Temporal Integration: Workflow orchestration"
	@echo "‚Ä¢ Multi-tenant Architecture: Tenant isolation"
	@echo ""
	@echo -e "$(BLUE)üß™ Testing Framework:$(NC)"
	@echo "‚Ä¢ Unit Tests: API handlers, business services"
	@echo "‚Ä¢ Integration Tests: Database operations, workflows"
	@echo "‚Ä¢ Automated Test Suite: Comprehensive coverage"
	@echo "‚Ä¢ Performance Tests: Benchmarks and profiling"