# Makefile for Go Meta-Contract Editor Backend Testing
# Provides convenient targets for running tests, coverage, and benchmarks

.PHONY: test test-coverage test-benchmark test-all test-race test-memory test-integration clean help

# Configuration
COVERAGE_DIR := coverage
COVERAGE_FILE := $(COVERAGE_DIR)/coverage.out
MIN_COVERAGE := 85
TEST_TIMEOUT := 10m
PACKAGE_LIST := ./internal/...

# Default target
.DEFAULT_GOAL := help

## Test Targets

test: ## Run unit tests
	@echo "Running unit tests..."
	@go test -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

test-verbose: ## Run unit tests with verbose output
	@echo "Running unit tests with verbose output..."
	@go test -v -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

test-coverage: ## Run tests with coverage analysis
	@echo "Running tests with coverage analysis..."
	@mkdir -p $(COVERAGE_DIR)
	@go test -timeout=$(TEST_TIMEOUT) -coverprofile=$(COVERAGE_FILE) -covermode=atomic $(PACKAGE_LIST)
	@go tool cover -func=$(COVERAGE_FILE)
	@echo "Coverage report saved to $(COVERAGE_FILE)"

test-coverage-html: test-coverage ## Generate HTML coverage report
	@echo "Generating HTML coverage report..."
	@go tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_DIR)/coverage.html
	@echo "HTML coverage report generated: $(COVERAGE_DIR)/coverage.html"

test-benchmark: ## Run benchmark tests
	@echo "Running benchmark tests..."
	@mkdir -p $(COVERAGE_DIR)
	@go test -bench=. -benchmem -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST) | tee $(COVERAGE_DIR)/benchmarks.txt

test-race: ## Run tests with race detection
	@echo "Running tests with race detection..."
	@go test -race -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

test-memory: ## Run memory-specific tests
	@echo "Running memory tests..."
	@GOMAXPROCS=1 go test -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

test-integration: ## Run integration tests
	@echo "Running integration tests..."
	@go test -tags=integration -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

test-all: ## Run all tests (unit, coverage, benchmark, race)
	@echo "Running comprehensive test suite..."
	@$(MAKE) test-coverage
	@$(MAKE) test-race
	@$(MAKE) test-benchmark
	@$(MAKE) test-memory
	@echo "All tests completed successfully!"

## Coverage Analysis Targets

coverage-check: test-coverage ## Check if coverage meets minimum threshold
	@echo "Checking coverage threshold..."
	@COVERAGE=$$(go tool cover -func=$(COVERAGE_FILE) | grep total | awk '{print $$3}' | sed 's/%//'); \
	if [ "$$(echo "$$COVERAGE >= $(MIN_COVERAGE)" | bc -l)" -eq 1 ]; then \
		echo "✅ Coverage: $$COVERAGE% (meets $(MIN_COVERAGE)% threshold)"; \
	else \
		echo "❌ Coverage: $$COVERAGE% (below $(MIN_COVERAGE)% threshold)"; \
		exit 1; \
	fi

coverage-report: test-coverage ## Generate detailed coverage report
	@echo "Generating detailed coverage report..."
	@mkdir -p $(COVERAGE_DIR)
	@go tool cover -func=$(COVERAGE_FILE) > $(COVERAGE_DIR)/coverage_detailed.txt
	@echo "Detailed coverage report saved to $(COVERAGE_DIR)/coverage_detailed.txt"

## Specific Module Tests

test-metacontract: ## Test meta-contract compiler module
	@echo "Testing meta-contract compiler module..."
	@go test -v -timeout=$(TEST_TIMEOUT) ./internal/metacontract/...

test-localai: ## Test LocalAI service module
	@echo "Testing LocalAI service module..."
	@go test -v -timeout=$(TEST_TIMEOUT) ./internal/localai/...

test-websocket: ## Test WebSocket communication module
	@echo "Testing WebSocket communication module..."
	@go test -v -timeout=$(TEST_TIMEOUT) ./internal/metacontracteditor/...

## Benchmark Targets

benchmark-metacontract: ## Benchmark meta-contract compiler
	@echo "Benchmarking meta-contract compiler..."
	@go test -bench=. -benchmem ./internal/metacontract/...

benchmark-localai: ## Benchmark LocalAI service
	@echo "Benchmarking LocalAI service..."
	@go test -bench=. -benchmem ./internal/localai/...

benchmark-websocket: ## Benchmark WebSocket communication
	@echo "Benchmarking WebSocket communication..."
	@go test -bench=. -benchmem ./internal/metacontracteditor/...

## CI/CD Targets

ci-test: ## Run tests suitable for CI environment
	@echo "Running tests for CI..."
	@go test -timeout=$(TEST_TIMEOUT) -coverprofile=$(COVERAGE_FILE) -covermode=atomic $(PACKAGE_LIST)
	@go test -race -timeout=$(TEST_TIMEOUT) $(PACKAGE_LIST)

ci-coverage: ci-test ## Generate coverage for CI with threshold check
	@echo "Checking coverage for CI..."
	@COVERAGE=$$(go tool cover -func=$(COVERAGE_FILE) | grep total | awk '{print $$3}' | sed 's/%//'); \
	echo "Coverage: $$COVERAGE%"; \
	if [ "$$(echo "$$COVERAGE >= $(MIN_COVERAGE)" | bc -l)" -ne 1 ]; then \
		echo "❌ Coverage below $(MIN_COVERAGE)% threshold"; \
		exit 1; \
	fi

## Development Targets

test-watch: ## Watch for file changes and run tests (requires entr)
	@echo "Watching for file changes..."
	@find . -name "*.go" | entr -c make test

dev-test: ## Quick development test (without race detection)
	@echo "Running quick development tests..."
	@go test -short $(PACKAGE_LIST)

## Quality Targets

lint: ## Run linter (requires golangci-lint)
	@echo "Running linter..."
	@golangci-lint run $(PACKAGE_LIST)

vet: ## Run go vet
	@echo "Running go vet..."
	@go vet $(PACKAGE_LIST)

fmt: ## Format code
	@echo "Formatting code..."
	@go fmt $(PACKAGE_LIST)

tidy: ## Tidy dependencies
	@echo "Tidying dependencies..."
	@go mod tidy

quality: fmt vet lint ## Run all quality checks

## Utility Targets

clean: ## Clean test artifacts and coverage files
	@echo "Cleaning test artifacts..."
	@rm -rf $(COVERAGE_DIR)
	@go clean -testcache
	@go clean -cache

deps: ## Download dependencies
	@echo "Downloading dependencies..."
	@go mod download

tools: ## Install development tools
	@echo "Installing development tools..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/stretchr/testify@latest

## Docker Targets

docker-test: ## Run tests in Docker container
	@echo "Running tests in Docker..."
	@docker build -t go-metacontract-test -f Dockerfile.test .
	@docker run --rm go-metacontract-test

## Reporting Targets

test-report: test-all ## Generate comprehensive test report
	@echo "Generating test report..."
	@./test_coverage.sh --report

## Help

help: ## Show this help message
	@echo "Go Meta-Contract Editor Backend Test Makefile"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Configuration:"
	@echo "  COVERAGE_DIR   = $(COVERAGE_DIR)"
	@echo "  MIN_COVERAGE   = $(MIN_COVERAGE)%"
	@echo "  TEST_TIMEOUT   = $(TEST_TIMEOUT)"
	@echo "  PACKAGE_LIST   = $(PACKAGE_LIST)"
	@echo ""
	@echo "Examples:"
	@echo "  make test                    # Run unit tests"
	@echo "  make test-coverage-html      # Run tests and generate HTML coverage"
	@echo "  make test-all                # Run comprehensive test suite"
	@echo "  make ci-coverage             # Run tests with coverage check for CI"
	@echo "  make clean                   # Clean artifacts"

# Ensure make doesn't try to build files that match target names
.PHONY: $(shell grep -E '^[a-zA-Z_-]+:' $(MAKEFILE_LIST) | awk -F':' '{print $$1}')