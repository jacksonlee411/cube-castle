# 预防机制：重复造轮子检测与防控体系

**建立时间**: 2025-08-03  
**建立目的**: 防止未来重复开发已有功能，确保架构一致性

## 1. 强制性开发前检查流程

### 1.1 代码审查检查点 (CodeReview Checklist)

**开发前必须检查** (`PRE_DEVELOPMENT_CHECKLIST.md`):
```markdown
## 开发前强制检查清单

### [ ] 1. 现有功能调研 (30分钟)
- [ ] 搜索相关关键词: `sync`, `cdc`, `monitor`, `recovery`
- [ ] 检查现有服务: `internal/service/`, `internal/neo4j/`
- [ ] 检查现有处理器: `internal/handler/`, `internal/cqrs/`
- [ ] 查看架构文档: `docs/architecture/`

### [ ] 2. 数据库架构检查 (15分钟)  
- [ ] 检查数据库触发器: `SHOW TRIGGERS;`
- [ ] 检查现有表结构: `\d+ table_name`
- [ ] 验证CDC配置: `SELECT * FROM pg_replication_slots;`

### [ ] 3. 企业级服务检查 (15分钟)
- [ ] 检查监控系统: `internal/monitoring/`
- [ ] 检查事件总线: `internal/events/`
- [ ] 检查同步服务: `internal/service/organization_sync_service.go`

### [ ] 4. 架构一致性验证 (15分钟)
- [ ] 确认符合CQRS模式
- [ ] 确认符合事件驱动架构
- [ ] 确认符合微服务设计原则
```

### 1.2 自动化重复检测脚本

**脚本位置**: `scripts/check-duplicates.sh`
```bash
#!/bin/bash
# 自动检测重复功能脚本

echo "🔍 检测潜在重复功能..."

KEYWORDS=("sync" "cdc" "monitor" "recovery" "organization" "employee")
DUPLICATES_FOUND=false

for keyword in "${KEYWORDS[@]}"; do
    echo "检查关键词: $keyword"
    
    # 检查Go文件
    go_files=$(find . -name "*.go" -type f | grep -i "$keyword" | wc -l)
    if [ "$go_files" -gt 1 ]; then
        echo "⚠️ 发现多个包含'$keyword'的Go文件:"
        find . -name "*.go" -type f | grep -i "$keyword"
        DUPLICATES_FOUND=true
    fi
    
    # 检查功能相似度
    similar_funcs=$(grep -r "func.*$keyword" --include="*.go" . | wc -l)
    if [ "$similar_funcs" -gt 2 ]; then
        echo "⚠️ 发现多个相似的'$keyword'功能"
        DUPLICATES_FOUND=true
    fi
done

if [ "$DUPLICATES_FOUND" = true ]; then
    echo "❌ 检测到潜在重复功能，请先调研现有实现"
    exit 1
else
    echo "✅ 未检测到明显重复功能"
    exit 0
fi
```

## 2. Git Hook预防机制

### 2.1 Pre-commit Hook
**文件**: `.git/hooks/pre-commit`
```bash
#!/bin/bash
# Pre-commit检查，防止提交重复功能

echo "🔍 Pre-commit检查: 重复功能检测..."

# 检查新增的文件是否包含重复功能标识
for file in $(git diff --cached --name-only | grep '\.go$'); do
    if [ -f "$file" ]; then
        # 检查是否包含敏感关键词
        if grep -q "// TODO: Check if this duplicates existing functionality" "$file"; then
            echo "⚠️ 发现需要重复检查的代码: $file"
            echo "请确认已完成重复功能检查"
            exit 1
        fi
        
        # 检查是否直接实现CDC或同步功能
        if grep -q "CREATE TRIGGER\|pg_notify\|LISTEN\|neo4j sync" "$file"; then
            echo "❌ 检测到直接实现CDC/同步功能: $file"
            echo "请先检查是否已有现成实现: internal/neo4j/cdc_sync_service.go"
            exit 1
        fi
    fi
done

echo "✅ Pre-commit检查通过"
```

### 2.2 Pre-push Hook
**文件**: `.git/hooks/pre-push`  
```bash
#!/bin/bash
# Pre-push检查，运行完整的重复功能检测

echo "🔍 Pre-push检查: 运行重复功能检测..."

if ! ./scripts/check-duplicates.sh; then
    echo "❌ 重复功能检测失败，推送被阻止"
    echo "请运行: ./scripts/check-duplicates.sh 查看详情"
    exit 1
fi

echo "✅ Pre-push检查通过"
```

## 3. 开发规范与文档

### 3.1 架构决策记录 (ADR)
**目录**: `docs/adr/`

**ADR-001**: 使用现有企业级CDC服务
**ADR-002**: 禁止重复实现监控功能  
**ADR-003**: 统一使用事件驱动架构

### 3.2 代码注释规范
```go
// ARCHITECTURE_NOTE: 此功能使用现有的OrganizationSyncService
// 位置: internal/service/organization_sync_service.go
// 避免重复实现同步逻辑

// ENTERPRISE_SERVICE: 使用企业级CDC服务
// 服务: internal/neo4j/cdc_sync_service.go
// 监控: internal/monitoring/monitor.go
```

## 4. 自动化检测工具

### 4.1 CI/CD集成
**文件**: `.github/workflows/duplicate-check.yml`
```yaml
name: 重复功能检测
on: [push, pull_request]
jobs:
  duplicate-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 运行重复检测
        run: ./scripts/check-duplicates.sh
      - name: 检查架构一致性
        run: ./scripts/verify-architecture.sh
```

### 4.2 代码分析工具配置
**工具**: `golangci-lint` 配置
```yaml
# .golangci.yml
linters-settings:
  dupl:
    threshold: 100  # 降低阈值，更严格检测重复
  gocyclo:
    min-complexity: 10
  
custom-rules:
  - name: "no-duplicate-sync"
    pattern: "func.*Sync.*Organization"
    message: "请使用现有的OrganizationSyncService"
```

## 5. 培训与意识提升

### 5.1 开发者培训清单
1. **架构意识训练**: 了解现有企业级服务
2. **代码审查培训**: 识别重复功能的方法
3. **工具使用培训**: 熟练使用检测脚本

### 5.2 定期架构评审
- **频率**: 每月一次
- **内容**: 检查新增功能是否符合架构原则
- **参与者**: 架构师、开发负责人、质量保证

## 6. 监控与度量

### 6.1 关键指标
- **重复代码率**: 每月统计相似代码百分比
- **架构违规次数**: 统计绕过现有服务的情况
- **修复成本**: 统计重复功能修复的时间成本

### 6.2 预警机制
```bash
# 监控脚本: scripts/monitor-duplicates.sh
# 每日运行，检测新增的潜在重复功能

THRESHOLD=5  # 相似函数阈值
SIMILAR_COUNT=$(find . -name "*.go" -exec grep -l "Sync.*Organization" {} \; | wc -l)

if [ "$SIMILAR_COUNT" -gt "$THRESHOLD" ]; then
    echo "⚠️ 检测到过多相似同步功能，请审查"
    # 发送告警邮件或Slack通知
fi
```

---

## 实施计划

### Phase 1: 立即实施 (本周)
- [x] 创建预防机制文档
- [ ] 部署Git hooks
- [ ] 创建检测脚本

### Phase 2: 工具集成 (下周)  
- [ ] 集成CI/CD检查
- [ ] 配置代码分析工具
- [ ] 建立监控dashboard

### Phase 3: 流程优化 (两周内)
- [ ] 开发者培训
- [ ] 架构评审流程
- [ ] 度量指标建立

**负责人**: 开发团队负责人  
**审核**: 架构师  
**时间**: 2025-08-03 至 2025-08-17