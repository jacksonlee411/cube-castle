name: ğŸ“ æ–‡æ¡£è‡ªåŠ¨åŒæ­¥éªŒè¯

on:
  push:
    branches: [ main, master, develop, "feature/*" ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CLAUDE.md'
      - 'frontend/package.json'
      - 'frontend/src/shared/config/**'
      - 'frontend/vite.config.ts'
      - 'frontend/playwright.config.ts'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CLAUDE.md'
      - 'frontend/package.json'
      - 'frontend/src/shared/config/**'
  schedule:
    # æ¯å¤©æ—©ä¸Š9ç‚¹æ£€æŸ¥æ–‡æ¡£ä¸€è‡´æ€§
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      auto_sync:
        description: 'å¯ç”¨è‡ªåŠ¨åŒæ­¥'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      dry_run:
        description: 'Dry Runæ¨¡å¼'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  AUTO_SYNC: ${{ github.event.inputs.auto_sync || 'false' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
  VERBOSE: 'true'

jobs:
  document-sync-validation:
    name: ğŸ“„ æ–‡æ¡£åŒæ­¥ä¸€è‡´æ€§éªŒè¯
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ¯”è¾ƒåˆ†æ
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ğŸ” æ£€æµ‹æ–‡æ¡£å˜æ›´
      id: detect_changes
      run: |
        # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD)
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..HEAD)
        else
          # å®šæ—¶ä»»åŠ¡æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œæ£€æŸ¥æ‰€æœ‰æ–‡æ¡£
          CHANGED_FILES="docs/ README.md CLAUDE.md frontend/package.json frontend/src/shared/config/"
        fi
        
        echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "ğŸ” æ£€æµ‹åˆ°å˜æ›´æ–‡ä»¶:"
        echo "$CHANGED_FILES" | tr ' ' '\n'

    - name: ğŸ“Š æ–‡æ¡£åŒæ­¥ä¸€è‡´æ€§æ£€æŸ¥
      id: sync_check
      run: |
        echo "ğŸ”„ æ‰§è¡Œæ–‡æ¡£åŒæ­¥æ£€æŸ¥..."
        echo "è‡ªåŠ¨åŒæ­¥: $AUTO_SYNC"
        echo "Dry Run: $DRY_RUN"
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p reports/document-sync
        
        # æ‰§è¡Œæ–‡æ¡£åŒæ­¥æ£€æŸ¥
        node scripts/quality/document-sync.js || exit_code=$?
        
        echo "ğŸ“Š åŒæ­¥æ£€æŸ¥å®Œæˆï¼Œé€€å‡ºç : ${exit_code:-0}"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        if [ -f "reports/document-sync/document-sync-report.json" ]; then
          SYNC_SUCCESS=$(node -e "
            const report = JSON.parse(require('fs').readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            console.log(report.summary.conflicts === 0 && report.summary.errors === 0 ? 'true' : 'false');
          ")
          echo "sync_success=$SYNC_SUCCESS" >> $GITHUB_OUTPUT
          
          # æå–ç»Ÿè®¡ä¿¡æ¯
          TOTAL_PAIRS=$(node -e "
            const report = JSON.parse(require('fs').readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            console.log(report.summary.totalPairs);
          ")
          
          SYNCED_PAIRS=$(node -e "
            const report = JSON.parse(require('fs').readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            console.log(report.summary.syncedPairs);
          ")
          
          CONFLICTS=$(node -e "
            const report = JSON.parse(require('fs').readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            console.log(report.summary.conflicts);
          ")
          
          echo "total_pairs=$TOTAL_PAIRS" >> $GITHUB_OUTPUT
          echo "synced_pairs=$SYNCED_PAIRS" >> $GITHUB_OUTPUT
          echo "conflicts=$CONFLICTS" >> $GITHUB_OUTPUT
        else
          echo "sync_success=false" >> $GITHUB_OUTPUT
          echo "total_pairs=0" >> $GITHUB_OUTPUT
          echo "synced_pairs=0" >> $GITHUB_OUTPUT
          echo "conflicts=1" >> $GITHUB_OUTPUT
        fi
        
        # å¦‚æœæœ‰å†²çªä¸”ä¸æ˜¯è‡ªåŠ¨åŒæ­¥æ¨¡å¼ï¼Œåˆ™å¤±è´¥
        if [[ "${exit_code:-0}" -ne 0 && "$AUTO_SYNC" != "true" ]]; then
          echo "ğŸ’¥ æ–‡æ¡£åŒæ­¥æ£€æŸ¥å¤±è´¥ï¼Œå‘ç°ä¸ä¸€è‡´æ€§é—®é¢˜"
          exit 1
        else
          echo "âœ… æ–‡æ¡£åŒæ­¥æ£€æŸ¥å®Œæˆ"
        fi

    - name: ğŸ“¤ ä¸Šä¼ åŒæ­¥æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: document-sync-report-${{ github.run_number }}
        path: |
          reports/document-sync/
          !reports/document-sync/**/*.tmp
        retention-days: 30

    - name: ğŸ“Š ç”ŸæˆåŒæ­¥æ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ“ æ–‡æ¡£åŒæ­¥æ£€æŸ¥æ‘˜è¦" > sync_summary.md
        echo "" >> sync_summary.md
        
        if [ -f "reports/document-sync/document-sync-report.json" ]; then
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            
            console.log('| æŒ‡æ ‡ | æ•°å€¼ |');
            console.log('|------|------|');
            console.log(\`| ğŸ“ åŒæ­¥å¯¹æ€»æ•° | \${report.summary.totalPairs} |\`);
            console.log(\`| âœ… åŒæ­¥æˆåŠŸ | \${report.summary.syncedPairs} |\`);
            console.log(\`| âš ï¸ å‘ç°å†²çª | \${report.summary.conflicts} |\`);
            console.log(\`| ğŸ”§ è‡ªåŠ¨ä¿®å¤ | \${report.summary.autoFixed} |\`);
            console.log(\`| âŒ å¤„ç†é”™è¯¯ | \${report.summary.errors} |\`);
            console.log(\`| ğŸ“Š æˆåŠŸç‡ | \${report.summary.successRate}% |\`);
            console.log('');
            
            if (report.summary.conflicts > 0) {
              console.log('### âš ï¸ å‘ç°çš„åŒæ­¥é—®é¢˜');
              console.log('');
              console.log('ä»¥ä¸‹æ–‡æ¡£é—´å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ï¼š');
              console.log('');
              
              report.syncPairs.forEach(pair => {
                if (pair.conflicts && pair.conflicts > 0) {
                  console.log(\`- **\${pair.name}**: \${pair.description}\`);
                  console.log(\`  - æºæ–‡ä»¶: \${pair.source}\`);
                  console.log(\`  - ç›®æ ‡æ–‡ä»¶: \${pair.targets.join(', ')}\`);
                  console.log('');
                }
              });
              
              console.log('### ğŸ”§ ä¿®å¤å»ºè®®');
              console.log('');
              console.log('1. æ‰‹åŠ¨æ£€æŸ¥ä¸Šè¿°æ–‡ä»¶çš„å·®å¼‚');
              console.log('2. è¿è¡Œ \`node scripts/quality/document-sync.js --auto-sync --dry-run\` é¢„è§ˆè‡ªåŠ¨ä¿®å¤');
              console.log('3. è¿è¡Œ \`node scripts/quality/document-sync.js --auto-sync\` æ‰§è¡Œè‡ªåŠ¨åŒæ­¥');
            } else {
              console.log('ğŸ‰ **æ‰€æœ‰æ–‡æ¡£ä¿æŒåŒæ­¥ä¸€è‡´æ€§ï¼**');
            }
          " >> sync_summary.md
        else
          echo "âŒ æ— æ³•ç”ŸæˆåŒæ­¥æŠ¥å‘Š" >> sync_summary.md
        fi
        
        cat sync_summary.md

    - name: ğŸ’¬ PRè¯„è®ºåŒæ­¥ç»“æœ
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let commentBody = '## ğŸ“ æ–‡æ¡£åŒæ­¥éªŒè¯ç»“æœ\n\n';
          
          if (fs.existsSync('reports/document-sync/document-sync-report.json')) {
            const report = JSON.parse(fs.readFileSync('reports/document-sync/document-sync-report.json', 'utf8'));
            
            commentBody += '| æŒ‡æ ‡ | æ•°å€¼ |\n';
            commentBody += '|------|------|\n';
            commentBody += `| ğŸ“ åŒæ­¥å¯¹æ•°é‡ | ${report.summary.totalPairs} |\n`;
            commentBody += `| âœ… åŒæ­¥æˆåŠŸ | ${report.summary.syncedPairs} |\n`;
            commentBody += `| âš ï¸ å‘ç°å†²çª | ${report.summary.conflicts} |\n`;
            commentBody += `| ğŸ“Š æˆåŠŸç‡ | ${report.summary.successRate}% |\n`;
            
            if (report.summary.conflicts === 0) {
              commentBody += '\nğŸ‰ **æ–‡æ¡£åŒæ­¥éªŒè¯é€šè¿‡ï¼** æ‰€æœ‰å…³é”®æ–‡æ¡£ä¿æŒä¸€è‡´æ€§ã€‚\n';
            } else {
              commentBody += '\nâš ï¸ **å‘ç°æ–‡æ¡£ä¸ä¸€è‡´æ€§** - è¯·æ£€æŸ¥ä»¥ä¸‹åŒæ­¥å¯¹ï¼š\n\n';
              
              report.syncPairs.forEach(pair => {
                commentBody += `- **${pair.name}**: ${pair.description}\n`;
              });
              
              commentBody += '\nğŸ’¡ **ä¿®å¤å»ºè®®**ï¼š\n';
              commentBody += '- æœ¬åœ°è¿è¡Œ `node scripts/quality/document-sync.js --auto-sync` è‡ªåŠ¨ä¿®å¤\n';
              commentBody += '- æ‰‹åŠ¨æ£€æŸ¥å¹¶æ›´æ–°ä¸ä¸€è‡´çš„æ–‡æ¡£å†…å®¹\n';
            }
            
            commentBody += `\nğŸ“Š [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](../actions/runs/${{ github.run_id }})`;
            
          } else {
            commentBody += 'âŒ æ–‡æ¡£åŒæ­¥æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Šã€‚\n';
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    - name: ğŸ”„ è‡ªåŠ¨åŒæ­¥æäº¤ (å¦‚æœå¯ç”¨)
      if: env.AUTO_SYNC == 'true' && env.DRY_RUN == 'false' && steps.sync_check.outputs.conflicts > 0
      run: |
        # é…ç½®Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ“ å‘ç°è‡ªåŠ¨åŒæ­¥çš„æ–‡ä»¶å˜æ›´"
          git status --short
          
          # æ·»åŠ å¹¶æäº¤å˜æ›´
          git add -A
          git commit -m "ğŸ“ è‡ªåŠ¨åŒæ­¥æ–‡æ¡£ä¸€è‡´æ€§

ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œçš„æ–‡æ¡£åŒæ­¥ï¼Œç¡®ä¿å…³é”®æ–‡æ¡£é—´çš„ä¸€è‡´æ€§ã€‚

- åŒæ­¥å¯¹è±¡: ${{ steps.sync_check.outputs.total_pairs }} ä¸ª
- ä¿®å¤å†²çª: ${{ steps.sync_check.outputs.conflicts }} ä¸ª
- è‡ªåŠ¨åŒ–ç³»ç»Ÿ: P3.3æ–‡æ¡£åŒæ­¥ç³»ç»Ÿ

ğŸ¤– Generated by GitHub Actions Document Sync"
          
          # æ¨é€å˜æ›´
          git push
          
          echo "âœ… è‡ªåŠ¨åŒæ­¥æäº¤å®Œæˆ"
        else
          echo "ğŸ“ æ— éœ€æäº¤ï¼Œæ–‡æ¡£å·²åŒæ­¥"
        fi

    - name: âš ï¸ è´¨é‡é—¨ç¦æ£€æŸ¥
      if: always()
      run: |
        SYNC_SUCCESS="${{ steps.sync_check.outputs.sync_success }}"
        CONFLICTS="${{ steps.sync_check.outputs.conflicts }}"
        
        echo "åŒæ­¥çŠ¶æ€: $SYNC_SUCCESS"
        echo "å†²çªæ•°é‡: $CONFLICTS"
        
        if [[ "$SYNC_SUCCESS" != "true" ]]; then
          if [[ "$AUTO_SYNC" == "true" ]]; then
            echo "âš ï¸ è‡ªåŠ¨åŒæ­¥æ¨¡å¼ï¼šå­˜åœ¨æ–‡æ¡£ä¸ä¸€è‡´æ€§ï¼Œä½†å·²å°è¯•è‡ªåŠ¨ä¿®å¤"
            exit 0
          else
            echo "ğŸ’¥ è´¨é‡é—¨ç¦å¤±è´¥ï¼šæ–‡æ¡£åŒæ­¥æ£€æŸ¥æœªé€šè¿‡"
            echo "ğŸ”§ è¯·è¿è¡Œæœ¬åœ°åŒæ­¥å‘½ä»¤æˆ–å¯ç”¨è‡ªåŠ¨åŒæ­¥æ¨¡å¼"
            exit 1
          fi
        else
          echo "âœ… è´¨é‡é—¨ç¦é€šè¿‡ï¼šæ–‡æ¡£åŒæ­¥ä¸€è‡´æ€§éªŒè¯æˆåŠŸ"
        fi