name: pr-body-policy

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to evaluate'
        required: true

jobs:
  policy:
    name: PR Body Policy – required
    runs-on: ubuntu-latest
    steps:
      - name: Resolve PR metadata
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_HTML_URL: ${{ github.event.pull_request.html_url }}
          INPUT_PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            if [ -z "$INPUT_PR_NUMBER" ]; then
              echo "::error::workflow_dispatch 触发必须提供 pr_number"
              exit 1
            fi
            export GH_TOKEN
            repo="${GITHUB_REPOSITORY}"
            pr_json=$(gh api "repos/${repo}/pulls/${INPUT_PR_NUMBER}")
            pr_number="$INPUT_PR_NUMBER"
            pr_title=$(echo "$pr_json" | jq -r '.title')
            pr_body=$(echo "$pr_json" | jq -r '.body')
            pr_url=$(echo "$pr_json" | jq -r '.html_url')
          else
            pr_number="$PR_NUMBER"
            pr_title="$PR_TITLE"
            pr_body="$PR_BODY"
            pr_url="$PR_HTML_URL"
          fi
          {
            echo "RESOLVED_PR_NUMBER=$pr_number"
            echo "RESOLVED_PR_HTML_URL=$pr_url"
            echo "RESOLVED_PR_TITLE<<'EOF'"
            echo "$pr_title"
            echo "EOF"
            echo "RESOLVED_PR_BODY<<'EOF'"
            echo "$pr_body"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Evaluate PR body
        env:
          PR_TITLE: ${{ env.RESOLVED_PR_TITLE }}
          PR_BODY: ${{ env.RESOLVED_PR_BODY }}
          PR_NUMBER: ${{ env.RESOLVED_PR_NUMBER }}
          PR_HTML_URL: ${{ env.RESOLVED_PR_HTML_URL }}
        run: |
          echo "PR #$PR_NUMBER $PR_HTML_URL"
          echo "Title: $PR_TITLE"
          echo "Body length: ${#PR_BODY}"
          missing=0
          require_issue='Closes #[0-9]+'
          require_evidence='Evidence:|证据'
          require_rollback='Rollback:|回滚方案'
          if ! printf '%s' "$PR_BODY" | grep -Eq "$require_issue"; then
            echo "::error::PR body missing 'Closes #<id>'（必填：关联 Issue）"
            missing=$((missing+1))
          fi
          if ! printf '%s' "$PR_BODY" | grep -Eq "$require_evidence"; then
            echo "::error::PR body missing 'Evidence:'（必填：Actions 运行/工件链接）"
            missing=$((missing+1))
          fi
          if ! printf '%s' "$PR_BODY" | grep -Eq "$require_rollback"; then
            echo "::error::PR body missing 'Rollback:'（必填：回滚方案）"
            missing=$((missing+1))
          fi
          echo "Missing sections: $missing"
          if [ "$missing" -gt 0 ]; then
            echo "❌ PR body policy failed: $missing required sections missing."
            exit 1
          fi
          echo "✅ PR body policy passed."
