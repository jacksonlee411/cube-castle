name: Go Meta-Contract Editor Backend Tests

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'go-app/**'
      - '.github/workflows/go-backend-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'go-app/**'

env:
  GO_VERSION: '1.21'
  MIN_COVERAGE: 85

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('go-app/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ env.GO_VERSION }}-

    - name: Install dependencies
      working-directory: ./go-app
      run: |
        go mod download
        go mod verify

    - name: Run go vet
      working-directory: ./go-app
      run: go vet ./internal/...

    - name: Run tests with race detection
      working-directory: ./go-app
      run: go test -race -timeout=10m ./internal/...

    - name: Run tests with coverage
      working-directory: ./go-app
      run: |
        mkdir -p coverage
        go test -timeout=10m -coverprofile=coverage/coverage.out -covermode=atomic ./internal/...

    - name: Check coverage threshold
      working-directory: ./go-app
      run: |
        COVERAGE=$(go tool cover -func=coverage/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE >= $MIN_COVERAGE" | bc -l) )); then
          echo "✅ Coverage: ${COVERAGE}% (meets ${MIN_COVERAGE}% threshold)"
        else
          echo "❌ Coverage: ${COVERAGE}% (below ${MIN_COVERAGE}% threshold)"
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./go-app/coverage/coverage.out
        directory: ./go-app
        flags: backend
        name: go-backend-coverage
        fail_ci_if_error: true

    - name: Generate coverage report
      working-directory: ./go-app
      run: |
        go tool cover -func=coverage/coverage.out > coverage/coverage_summary.txt
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat coverage/coverage_summary.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: go-app/coverage/

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('go-app/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ env.GO_VERSION }}-

    - name: Install dependencies
      working-directory: ./go-app
      run: go mod download

    - name: Run benchmarks
      working-directory: ./go-app
      run: |
        mkdir -p coverage
        go test -bench=. -benchmem -timeout=10m ./internal/... | tee coverage/benchmarks.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: go-app/coverage/benchmarks.txt

    - name: Generate benchmark summary
      working-directory: ./go-app
      run: |
        echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        grep "Benchmark" coverage/benchmarks.txt | head -10 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        working-directory: go-app
        args: --timeout=5m ./internal/...

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run Gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: '-fmt sarif -out gosec-report.sarif ./go-app/...'

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gosec-report.sarif

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies
      working-directory: ./go-app
      run: go mod download

    - name: Wait for services
      run: |
        timeout 60 bash -c 'until nc -z localhost 5432; do sleep 1; done'
        timeout 60 bash -c 'until nc -z localhost 6379; do sleep 1; done'

    - name: Run integration tests
      working-directory: ./go-app
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: testuser
        DB_PASSWORD: testpass
        DB_NAME: testdb
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: go test -tags=integration -timeout=10m ./internal/...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build binaries
      working-directory: ./go-app
      run: |
        go build -o bin/server ./cmd/server/
        go build -o bin/metacontract-compiler ./cmd/metacontract-compiler/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: go-app/bin/

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test, benchmark, lint, security, integration, build]
    if: always()
    
    steps:
    - name: Check job statuses
      run: |
        echo "Test: ${{ needs.test.result }}"
        echo "Benchmark: ${{ needs.benchmark.result }}"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Integration: ${{ needs.integration.result }}"
        echo "Build: ${{ needs.build.result }}"
        
        if [[ "${{ needs.test.result }}" != "success" || 
              "${{ needs.lint.result }}" != "success" || 
              "${{ needs.build.result }}" != "success" ]]; then
          echo "❌ Quality gate failed"
          exit 1
        fi
        
        echo "✅ Quality gate passed"

    - name: Generate quality report
      run: |
        echo "## Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result == 'success' && '✅' || '❌' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Benchmark | ${{ needs.benchmark.result == 'success' && '✅' || '❌' }} ${{ needs.benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result == 'success' && '✅' || '❌' }} ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result == 'success' && '✅' || '❌' }} ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration | ${{ needs.integration.result == 'success' && '✅' || '❌' }} ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY