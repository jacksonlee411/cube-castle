name: CI (Self-Hosted Runner Diagnose)

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: [self-hosted, cubecastle, docker]
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Docker 版本
        run: |
          docker version
          docker compose version

      - name: 确认 Docker Compose 可用
        run: |
          set -euo pipefail
          if docker compose version >/dev/null 2>&1; then
            docker compose version
            exit 0
          fi
          echo "Docker Compose plugin missing, installing from Docker APT repo..."
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl gnupg
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y docker-ce-cli docker-compose-plugin
          docker compose version

      - name: 验证 Compose 配置
        run: |
          set -xe
          docker compose -f docker-compose.dev.yml config -q
          docker compose -f docker-compose.runner.yml config -q
          docker compose -f docker-compose.runner.persist.yml config -q

      - name: 校验基础网络与卷能力
        run: |
          set -xe
          cat >/tmp/diagnose-compose.yml <<'EOF'
          services:
            hello:
              image: busybox:1.36
              command: sh -c "echo hello-from-runner && sleep 2"
          EOF
          docker compose -f /tmp/diagnose-compose.yml up --abort-on-container-exit
          docker compose -f /tmp/diagnose-compose.yml down -v
