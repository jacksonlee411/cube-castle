name: CI (Self-Hosted Runner Diagnose)

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: [self-hosted, cubecastle, docker]
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Docker 版本
        run: |
          docker version
          docker compose version

      - name: 安装 Docker Compose 插件
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin

      - name: 验证 Compose 配置
        run: |
          set -xe
          docker compose -f docker-compose.dev.yml config -q
          docker compose -f docker-compose.runner.yml config -q
          docker compose -f docker-compose.runner.persist.yml config -q

      - name: 校验基础网络与卷能力
        run: |
          set -xe
          cat >/tmp/diagnose-compose.yml <<'EOF'
          services:
            hello:
              image: busybox:1.36
              command: sh -c "echo hello-from-runner && sleep 2"
          EOF
          docker compose -f /tmp/diagnose-compose.yml up --abort-on-container-exit
          docker compose -f /tmp/diagnose-compose.yml down -v
