name: Guardian: IIGæŠ¤å«ç³»ç»Ÿ (Implementation Inventory Guardian)

on:
  push:
    branches: [ main, master, develop, "feature/*" ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      feature_description:
        description: 'æ–°åŠŸèƒ½æè¿° (ç”¨äºé‡å¤æ£€æµ‹)'
        required: false
        default: 'new-feature-development'
        type: string
      guardian_mode:
        description: 'IIGæŠ¤å«æ¨¡å¼'
        required: false
        default: 'guard'
        type: choice
        options:
        - guard    # å®Œæ•´æŠ¤å«æ£€æŸ¥
        - check    # ä»…æ¸…å•æ£€æŸ¥
        - analysis # æ·±åº¦åˆ†ææ¨¡å¼
      risk_tolerance:
        description: 'é£é™©å®¹å¿åº¦'
        required: false
        default: 'medium'
        type: choice
        options:
        - low      # ä½å®¹å¿åº¦ (ä¸¥æ ¼)
        - medium   # ä¸­ç­‰å®¹å¿åº¦ (å¹³è¡¡)
        - high     # é«˜å®¹å¿åº¦ (å®½æ¾)

env:
  FEATURE_DESCRIPTION: ${{ github.event.inputs.feature_description || 'auto-detected-changes' }}
  GUARDIAN_MODE: ${{ github.event.inputs.guardian_mode || 'guard' }}
  RISK_TOLERANCE: ${{ github.event.inputs.risk_tolerance || 'medium' }}
  NODE_VERSION: '18'
  TYPE_SAFETY_THRESHOLD: '30'

jobs:
  iig-guardian-check:
    name: Guardian: IIGæŠ¤å«æ£€æŸ¥
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      actions: read

    steps:
      - name: Detect docs-only changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            docs_only:
              - 'AGENTS.md'
              - '**/*.md'
              - 'docs/**'
              - 'reports/**'
              - 'scripts/plan222/**'
              - 'docs/development-plans/**'
              - '!frontend/**'
              - '!cmd/**'
              - '!internal/**'
              - '!pkg/**'
              - '!database/**'
              - '!tests/**'
              - '!go.*'
              - '!package*.json'
              - '!.github/workflows/**'
      - name: Docs-only fast pass
        if: steps.changes.outputs.docs_only == 'true'
        run: |
          echo "Docs-only changes detected. Skipping IIG guardian heavy checks."
          echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
          exit 0
      - name: ğŸ“¥ æ£€å‡ºä»£ç åº“
        if: steps.changes.outputs.docs_only != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºå˜æ›´åˆ†æ

      - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
        if: steps.changes.outputs.docs_only != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        # å®‰è£…jscpdç”¨äºP3.1é‡å¤ä»£ç æ£€æµ‹é›†æˆ
        npm install -g jscpd@latest
        echo "ğŸ“¦ jscpdç‰ˆæœ¬: $(jscpd --version)"
        
        # ç¡®ä¿æ‰€æœ‰è„šæœ¬å¯æ‰§è¡Œ
        chmod +x scripts/quality/*.sh
        chmod +x scripts/quality/*.js

    - name: ğŸ“ åˆ›å»ºæŠ¥å‘Šç›®å½•
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        mkdir -p reports/iig-guardian
        mkdir -p reports/duplicate-code
        mkdir -p reports/architecture
        mkdir -p reports/document-sync

    - name: ğŸ“ ä»£ç è§„æ¨¡ä¸å¼±ç±»å‹å·¡æ£€
      run: |
        chmod +x scripts/code-smell-check-quick.sh
        scripts/code-smell-check-quick.sh \
          --with-types \
          --type-threshold "${{ env.TYPE_SAFETY_THRESHOLD }}" \
          --ci-output "reports/iig-guardian/code-smell-ci-${{ github.run_id }}.md"

    - name: ğŸ” è‡ªåŠ¨æ£€æµ‹å˜æ›´å†…å®¹ (ç”¨äºåŠŸèƒ½æè¿°)
      if: env.FEATURE_DESCRIPTION == 'auto-detected-changes'
      run: |
        # åˆ†æå½“å‰å˜æ›´ï¼Œç”ŸæˆåŠŸèƒ½æè¿°
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
        fi
        
        echo "ğŸ” å˜æ›´æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # åˆ†æå˜æ›´ç±»å‹
        FEATURE_TYPE="unknown"
        if echo "$CHANGED_FILES" | grep -q "api/"; then
          FEATURE_TYPE="api-endpoint"
        elif echo "$CHANGED_FILES" | grep -q "components/"; then
          FEATURE_TYPE="frontend-component"
        elif echo "$CHANGED_FILES" | grep -q "hooks/"; then
          FEATURE_TYPE="react-hook"
        elif echo "$CHANGED_FILES" | grep -q "handlers/"; then
          FEATURE_TYPE="backend-handler"
        elif echo "$CHANGED_FILES" | grep -q "services/"; then
          FEATURE_TYPE="backend-service"
        fi
        
        echo "DETECTED_FEATURE_TYPE=$FEATURE_TYPE" >> $GITHUB_ENV
        echo "ğŸ¤– æ£€æµ‹åˆ°åŠŸèƒ½ç±»å‹: $FEATURE_TYPE"

    - name: Guardian: æ‰§è¡ŒIIGæŠ¤å«å®Œæ•´æ£€æŸ¥
      if: env.GUARDIAN_MODE == 'guard'
      run: |
        echo "Guardian: å¯åŠ¨IIGæŠ¤å«ç³»ç»Ÿ - å®Œæ•´æŠ¤å«æ¨¡å¼"
        echo "ğŸ¯ åŠŸèƒ½æè¿°: $FEATURE_DESCRIPTION"
        echo "ğŸ”§ é£é™©å®¹å¿åº¦: $RISK_TOLERANCE"
        
        # æ‰§è¡ŒIIGæŠ¤å«æ£€æŸ¥
        node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --guard || exit_code=$?
        
        echo "IIG_GUARDIAN_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV
        
        # æ ¹æ®é£é™©å®¹å¿åº¦è°ƒæ•´é€€å‡ºç­–ç•¥
        if [ "${exit_code:-0}" -ne 0 ]; then
          if [ "$RISK_TOLERANCE" = "low" ]; then
            echo "âŒ ä½é£é™©å®¹å¿åº¦: IIGæŠ¤å«æ£€æŸ¥å¤±è´¥ï¼Œé˜»å¡æµæ°´çº¿"
            exit 1
          elif [ "$RISK_TOLERANCE" = "medium" ]; then
            echo "âš ï¸ ä¸­ç­‰é£é™©å®¹å¿åº¦: IIGæŠ¤å«å‘ç°é—®é¢˜ï¼Œè®°å½•ä½†ç»§ç»­"
            echo "IIG_GUARDIAN_WARNING=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ é«˜é£é™©å®¹å¿åº¦: IIGæŠ¤å«å‘ç°é—®é¢˜ï¼Œä»…è®°å½•"
            echo "IIG_GUARDIAN_INFO=true" >> $GITHUB_ENV
          fi
        else
          echo "âœ… IIGæŠ¤å«æ£€æŸ¥é€šè¿‡"
        fi

    - name: ğŸ“Š æ‰§è¡ŒIIGæ¸…å•æ£€æŸ¥æ¨¡å¼
      if: env.GUARDIAN_MODE == 'check'
      run: |
        echo "ğŸ“Š å¯åŠ¨IIGæŠ¤å«ç³»ç»Ÿ - æ¸…å•æ£€æŸ¥æ¨¡å¼"
        node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --check

    - name: ğŸ” æ‰§è¡ŒIIGæ·±åº¦åˆ†ææ¨¡å¼
      if: env.GUARDIAN_MODE == 'analysis'
      run: |
        echo "ğŸ” å¯åŠ¨IIGæŠ¤å«ç³»ç»Ÿ - æ·±åº¦åˆ†ææ¨¡å¼"
        
        # è¿è¡Œæ‰€æœ‰P3ç³»ç»Ÿè¿›è¡Œç»¼åˆåˆ†æ
        echo "ğŸ”„ è¿è¡ŒP3.1é‡å¤ä»£ç æ£€æµ‹..."
        bash scripts/quality/duplicate-detection.sh --verbose || true
        
        echo "ğŸ”„ è¿è¡ŒP3.2æ¶æ„éªŒè¯..."
        node scripts/quality/architecture-validator.js --verbose || true
        
        echo "ğŸ”„ è¿è¡ŒP3.3æ–‡æ¡£åŒæ­¥..."
        node scripts/quality/document-sync.js --verbose || true
        
        echo "ğŸ”„ è¿è¡ŒIIGæŠ¤å«åˆ†æ..."
        node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --guard

    - name: ğŸ“Š ç”Ÿæˆç»¼åˆè´¨é‡æŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ç”ŸæˆIIGæŠ¤å«ç»¼åˆæŠ¥å‘Š..."
        
        # æ”¶é›†å„ç³»ç»ŸæŠ¥å‘Š
        REPORTS_SUMMARY="reports/iig-guardian/ç»¼åˆè´¨é‡æŠ¥å‘Š.md"
        
        cat > "$REPORTS_SUMMARY" << 'EOF'
        # Guardian: IIGæŠ¤å«ç³»ç»Ÿç»¼åˆè´¨é‡æŠ¥å‘Š
        
        ## ğŸ“‹ æ£€æŸ¥æ¦‚è¦
        - **åŠŸèƒ½æè¿°**: ${{ env.FEATURE_DESCRIPTION }}
        - **æŠ¤å«æ¨¡å¼**: ${{ env.GUARDIAN_MODE }}  
        - **é£é™©å®¹å¿åº¦**: ${{ env.RISK_TOLERANCE }}
        - **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
        
        ## ğŸ¯ IIGæŠ¤å«ç»“æœ
        EOF
        
        if [ -f "reports/iig-guardian/iig-guardian-report.json" ]; then
          echo "âœ… IIGæŠ¤å«æŠ¥å‘Šå·²ç”Ÿæˆ" >> "$REPORTS_SUMMARY"
          
          # æå–å…³é”®æŒ‡æ ‡
          if command -v jq >/dev/null 2>&1; then
            TOTAL_IMPLEMENTATIONS=$(jq -r '.statistics.analysedImplementations // 0' reports/iig-guardian/iig-guardian-report.json)
            DETECTED_DUPLICATES=$(jq -r '.statistics.detectedDuplicates // 0' reports/iig-guardian/iig-guardian-report.json)
            RISK_LEVEL=$(jq -r '.checkResults.assessment.overallRisk // "UNKNOWN"' reports/iig-guardian/iig-guardian-report.json)
            
            cat >> "$REPORTS_SUMMARY" << EOF
        - **åˆ†æå®ç°æ•°**: $TOTAL_IMPLEMENTATIONS ä¸ª
        - **æ£€æµ‹é‡å¤æ•°**: $DETECTED_DUPLICATES ä¸ª  
        - **é£é™©ç­‰çº§**: $RISK_LEVEL
        EOF
          fi
        else
          echo "âš ï¸ IIGæŠ¤å«æŠ¥å‘Šæœªç”Ÿæˆ" >> "$REPORTS_SUMMARY"
        fi
        
        echo "ğŸ“Š ç»¼åˆæŠ¥å‘Šå·²ç”Ÿæˆ: $REPORTS_SUMMARY"

    - name: ğŸ“¤ ä¸Šä¼ IIGæŠ¤å«æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iig-guardian-reports-${{ github.run_number }}
        path: |
          reports/iig-guardian/
          reports/duplicate-code/
          reports/architecture/
          reports/document-sync/
          !reports/**/*.tmp
        retention-days: 30

    - name: ğŸ’¬ PRè¯„è®º - IIGæŠ¤å«æŠ¥å‘Š
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './reports/iig-guardian/iig-guardian-report.json';
          
          let comment = `## Guardian: IIGæŠ¤å«ç³»ç»Ÿæ£€æŸ¥æŠ¥å‘Š\n\n`;
          comment += `**åŠŸèƒ½æè¿°**: ${process.env.FEATURE_DESCRIPTION}\n`;
          comment += `**æŠ¤å«æ¨¡å¼**: ${process.env.GUARDIAN_MODE}\n`;
          comment += `**é£é™©å®¹å¿åº¦**: ${process.env.RISK_TOLERANCE}\n\n`;
          
          if (fs.existsSync(path)) {
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const stats = report.statistics || {};
            const assessment = report.checkResults?.assessment || {};
            
            comment += `### ğŸ“Š æ£€æŸ¥ç»Ÿè®¡\n\n`;
            comment += `| æŒ‡æ ‡ | æ•°å€¼ |\n`;
            comment += `|------|------|\n`;
            comment += `| ğŸ” åˆ†æå®ç° | ${stats.analysedImplementations || 0} ä¸ª |\n`;
            comment += `| âš ï¸ æ£€æµ‹é‡å¤ | ${stats.detectedDuplicates || 0} ä¸ª |\n`;
            comment += `| ğŸ¯ é£é™©ç­‰çº§ | **${assessment.overallRisk || 'UNKNOWN'}** |\n`;
            comment += `| ğŸ“Š ä»£ç é‡å¤ç‡ | ${stats.p3Integration?.duplicateCodeRate || 0}% |\n`;
            comment += `| ğŸ—ï¸ æ¶æ„è¿è§„ | ${stats.p3Integration?.architectureViolations || 0} ä¸ª |\n`;
            comment += `| ğŸ“š æ–‡æ¡£åŒæ­¥ç‡ | ${stats.p3Integration?.documentSyncRate || 0}% |\n\n`;
            
            // é£é™©è¯„ä¼°
            const riskEmoji = {
              'HIGH': 'ğŸ”´',
              'MEDIUM': 'ğŸŸ¡', 
              'LOW': 'ğŸŸ¢'
            }[assessment.overallRisk] || 'âš«';
            
            comment += `### ${riskEmoji} é£é™©è¯„ä¼°: ${assessment.overallRisk || 'UNKNOWN'}\n\n`;
            
            if (stats.detectedDuplicates > 0) {
              comment += `âš ï¸ **å‘ç°æ½œåœ¨é‡å¤å®ç°**: å»ºè®®ä¼˜å…ˆå¤ç”¨ç°æœ‰ç»„ä»¶\n\n`;
            }
            
            // å»ºè®®
            const recommendations = report.checkResults?.recommendations || [];
            if (recommendations.length > 0) {
              comment += `### ğŸ’¡ IIGæŠ¤å«å»ºè®®\n\n`;
              recommendations.forEach((rec, index) => {
                const priorityEmoji = {
                  'HIGH': 'ğŸ”´',
                  'MEDIUM': 'ğŸŸ¡',
                  'LOW': 'ğŸŸ¢'
                }[rec.priority] || 'âš«';
                comment += `${index + 1}. ${priorityEmoji} **[${rec.priority}]** ${rec.message}\n`;
              });
              comment += `\n`;
            }
            
          } else {
            comment += `âš ï¸ IIGæŠ¤å«æŠ¥å‘Šæœªæ‰¾åˆ°ï¼Œå¯èƒ½æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ã€‚\n\n`;
          }
          
          // æœ€ç»ˆå†³ç­–
          const exitCode = process.env.IIG_GUARDIAN_EXIT_CODE || '0';
          if (exitCode !== '0') {
            if (process.env.RISK_TOLERANCE === 'low') {
              comment += `ğŸ›‘ **IIGæŠ¤å«å†³ç­–**: æ£€æŸ¥å¤±è´¥ï¼Œå»ºè®®ä¿®å¤é—®é¢˜åé‡æ–°æäº¤\n`;
            } else {
              comment += `âš ï¸ **IIGæŠ¤å«å†³ç­–**: å‘ç°é—®é¢˜ä½†å·²æ”¾è¡Œï¼Œå»ºè®®å…³æ³¨ç›¸å…³å»ºè®®\n`;
            }
          } else {
            comment += `âœ… **IIGæŠ¤å«å†³ç­–**: æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨åˆå¹¶\n`;
          }
          
          comment += `\nğŸ“Š [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](../actions/runs/${{ github.run_id }})`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: ğŸš¨ è´¨é‡é—¨ç¦åˆ¤å®š
      if: always()
      run: |
        echo "ğŸš¨ æ‰§è¡ŒIIGæŠ¤å«è´¨é‡é—¨ç¦åˆ¤å®š..."
        
        EXIT_CODE="${IIG_GUARDIAN_EXIT_CODE:-0}"
        RISK_TOLERANCE="${RISK_TOLERANCE:-medium}"
        
        echo "ğŸ“Š IIGæŠ¤å«é€€å‡ºç : $EXIT_CODE"
        echo "ğŸ¯ é£é™©å®¹å¿åº¦: $RISK_TOLERANCE"
        
        if [ "$EXIT_CODE" != "0" ]; then
          case "$RISK_TOLERANCE" in
            "low")
              echo "ğŸ”´ ä½é£é™©å®¹å¿åº¦: è´¨é‡é—¨ç¦å¤±è´¥"
              echo "ğŸ›‘ IIGæŠ¤å«å‘ç°é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½ç»§ç»­"
              exit 1
              ;;
            "medium")
              echo "ğŸŸ¡ ä¸­ç­‰é£é™©å®¹å¿åº¦: è´¨é‡é—¨ç¦è­¦å‘Š"
              echo "âš ï¸ IIGæŠ¤å«å‘ç°é—®é¢˜ï¼Œå»ºè®®ä¼˜å…ˆä¿®å¤ä½†å…è®¸ç»§ç»­"
              ;;
            "high")
              echo "ğŸŸ¢ é«˜é£é™©å®¹å¿åº¦: è´¨é‡é—¨ç¦é€šè¿‡"
              echo "â„¹ï¸ IIGæŠ¤å«å‘ç°é—®é¢˜ï¼Œä»…è®°å½•ä¸é˜»å¡"
              ;;
          esac
        else
          echo "âœ… IIGæŠ¤å«è´¨é‡é—¨ç¦é€šè¿‡"
        fi
        
        echo "Guardian: IIGæŠ¤å«ç³»ç»Ÿæ£€æŸ¥å®Œæˆ"

  post-guardian-analysis:
    name: ğŸ“Š IIGæŠ¤å«åç»­åˆ†æ
    runs-on: ubuntu-latest
    needs: iig-guardian-check
    if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4

    - name: ğŸ“Š ä¸»åˆ†æ”¯è´¨é‡è¶‹åŠ¿åˆ†æ
      run: |
        echo "ğŸ“Š æ‰§è¡Œä¸»åˆ†æ”¯IIGæŠ¤å«è´¨é‡è¶‹åŠ¿åˆ†æ..."
        
        # ä¸‹è½½ä¹‹å‰çš„æŠ¥å‘Šè¿›è¡Œè¶‹åŠ¿åˆ†æ
        # è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤æ‚çš„è¶‹åŠ¿åˆ†æé€»è¾‘
        
        echo "ğŸ” åˆ†æå®ç°æ¸…å•å˜åŒ–è¶‹åŠ¿..."
        echo "ğŸ“ˆ åˆ†æé‡å¤ç‡å˜åŒ–è¶‹åŠ¿..."
        echo "ğŸ—ï¸ åˆ†ææ¶æ„è´¨é‡å˜åŒ–è¶‹åŠ¿..."
        
        echo "âœ… ä¸»åˆ†æ”¯è´¨é‡è¶‹åŠ¿åˆ†æå®Œæˆ"
