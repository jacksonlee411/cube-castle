name: guardian-iig     (Implementation Inventory Guardian)

on:
  push:
    branches: [ main, master, develop, "feature/*", feat/shared-dev ]
  pull_request:
    branches: [ main, master, develop, feat/shared-dev ]
  workflow_dispatch:
    inputs:
      feature_description:
        description: '      (      )'
        required: false
        default: 'new-feature-development'
        type: string
      guardian_mode:
        description: 'IIG    '
        required: false
        default: 'guard'
        type: choice
        options:
        - guard    #       
        - check    #      
        - analysis #       
      risk_tolerance:
        description: '     '
        required: false
        default: 'medium'
        type: choice
        options:
        - low      #      (  )
        - medium   #       (  )
        - high     #      (  )

env:
  FEATURE_DESCRIPTION: ${{ github.event.inputs.feature_description || 'auto-detected-changes' }}
  GUARDIAN_MODE: ${{ github.event.inputs.guardian_mode || 'guard' }}
  RISK_TOLERANCE: ${{ github.event.inputs.risk_tolerance || 'medium' }}
  NODE_VERSION: '18'
  TYPE_SAFETY_THRESHOLD: '30'

jobs:
  iig-guardian-check:
    name: guardian-iig    
    strategy:
      matrix:
        runner: [ubuntu, selfhosted-wsl]
        include:
          - runner: ubuntu
            labels: ubuntu-latest
            prepare: false
          - runner: selfhosted-wsl
            labels:
              - self-hosted
              - cubecastle
              - wsl
            prepare: true
            wsl_only: true
    runs-on: ${{ matrix.labels }}
    permissions:
      contents: read
      pull-requests: write
      checks: write
      actions: read

    steps:
      - name: 运行器触发守卫（Plan 270）
        id: runner-gate
        shell: bash
        env:
          MATRIX_WSL_ONLY: ${{ matrix.wsl_only == true }}
        run: |
          set -euo pipefail
          skip=false
          reason=""
          if [ "$MATRIX_WSL_ONLY" = "true" ] && [ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]; then
            skip=true
            reason="Self-hosted WSL 仅允许 workflow_dispatch 触发，当前事件=${GITHUB_EVENT_NAME}"
          fi
          echo "skip=$skip" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"
          if [ "$skip" = "true" ]; then
            echo "ℹ️ $reason"
          else
            echo "✅ Runner gate passed（event=${GITHUB_EVENT_NAME}, matrix.wsl_only=$MATRIX_WSL_ONLY）"
          fi

      - name: 跳过当前矩阵变体
        if: steps.runner-gate.outputs.skip == 'true'
        shell: bash
        env:
          RUNNER_SKIP_REASON: ${{ steps.runner-gate.outputs.reason }}
        run: |
          set -euo pipefail
          msg="${RUNNER_SKIP_REASON:-Self-hosted 变体在该触发场景下禁用}"
          echo "⏭️ $msg"
          echo "剩余步骤已跳过。"
      - name: Checkout repository
        if: steps.runner-gate.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect docs-only changes
        if: steps.runner-gate.outputs.skip != 'true'
        id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            docs_only:
              - 'AGENTS.md'
              - '**/*.md'
              - 'docs/**'
              - 'reports/**'
              - 'scripts/plan222/**'
              - 'docs/development-plans/**'
              - '!frontend/**'
              - '!cmd/**'
              - '!internal/**'
              - '!pkg/**'
              - '!database/**'
              - '!tests/**'
              - '!go.*'
              - '!package*.json'
              - '!.github/workflows/**'
      - name: Docs-only fast pass
        if: steps.runner-gate.outputs.skip != 'true' && steps.changes.outputs.docs_only == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          echo "Docs-only changes detected. Skipping IIG guardian heavy checks."
          echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
          exit 0
      - name: 自托管环境准备
        if: steps.runner-gate.outputs.skip != 'true' && matrix.prepare == true && steps.changes.outputs.docs_only != 'true'
        shell: bash
        run: bash scripts/ci/workflows/prepare-selfhosted.sh iig-guardian
      - name: Setup Node.js runtime
        if: steps.runner-gate.outputs.skip != 'true' && steps.changes.outputs.docs_only != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install guardian toolchain
        if: steps.runner-gate.outputs.skip != 'true' && steps.changes.outputs.docs_only != 'true'
        run: |
          npm install -g jscpd@latest
          echo "jscpd version: $(jscpd --version)"
          chmod +x scripts/quality/*.sh
          chmod +x scripts/quality/*.js

      - name: Prepare report directories
        if: steps.runner-gate.outputs.skip != 'true' && steps.changes.outputs.docs_only != 'true'
        run: |
          mkdir -p reports/iig-guardian
          mkdir -p reports/duplicate-code
          mkdir -p reports/architecture
          mkdir -p reports/document-sync

      - name: Run code smell quick check
        if: steps.runner-gate.outputs.skip != 'true' && steps.changes.outputs.docs_only != 'true'
        run: |
          chmod +x scripts/code-smell-check-quick.sh
          scripts/code-smell-check-quick.sh \
            --with-types \
            --type-threshold "${{ env.TYPE_SAFETY_THRESHOLD }}" \
            --ci-output "reports/iig-guardian/code-smell-ci-${{ github.run_id }}.md"

      - name: "          (      )"
        if: steps.runner-gate.outputs.skip != 'true' && env.FEATURE_DESCRIPTION == 'auto-detected-changes'
        run: |
          #              
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi
          
          echo "      :"
          echo "$CHANGED_FILES"
          
          #       
          FEATURE_TYPE="unknown"
          if echo "$CHANGED_FILES" | grep -q "api/"; then
            FEATURE_TYPE="api-endpoint"
          elif echo "$CHANGED_FILES" | grep -q "components/"; then
            FEATURE_TYPE="frontend-component"
          elif echo "$CHANGED_FILES" | grep -q "hooks/"; then
            FEATURE_TYPE="react-hook"
          elif echo "$CHANGED_FILES" | grep -q "handlers/"; then
            FEATURE_TYPE="backend-handler"
          elif echo "$CHANGED_FILES" | grep -q "services/"; then
            FEATURE_TYPE="backend-service"
          fi
          
          echo "DETECTED_FEATURE_TYPE=$FEATURE_TYPE" >> $GITHUB_ENV
          echo "         : $FEATURE_TYPE"

      - name: "Guardian:   IIG      "
        if: steps.runner-gate.outputs.skip != 'true' && env.GUARDIAN_MODE == 'guard'
        run: |
          echo "Guardian:   IIG     -       "
          echo "      : $FEATURE_DESCRIPTION"
          echo "       : $RISK_TOLERANCE"
          
          #   IIG    
          node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --guard || exit_code=$?
          
          echo "IIG_GUARDIAN_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV
          
          #              
          if [ "${exit_code:-0}" -ne 0 ]; then
            if [ "$RISK_TOLERANCE" = "low" ]; then
              echo "        : IIG            "
              exit 1
            elif [ "$RISK_TOLERANCE" = "medium" ]; then
              echo "          : IIG            "
              echo "IIG_GUARDIAN_WARNING=true" >> $GITHUB_ENV
            else
              echo "         : IIG          "
              echo "IIG_GUARDIAN_INFO=true" >> $GITHUB_ENV
            fi
          else
            echo "  IIG      "
          fi

      - name: "    IIG      "
        if: steps.runner-gate.outputs.skip != 'true' && env.GUARDIAN_MODE == 'check'
        run: |
          echo "    IIG     -       "
          node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --check

      - name: "    IIG      "
        if: steps.runner-gate.outputs.skip != 'true' && env.GUARDIAN_MODE == 'analysis'
        run: |
          echo "    IIG     -       "
          
          #     P3        
          echo "    P3.1      ..."
          bash scripts/quality/duplicate-detection.sh --verbose || true
          
          echo "    P3.2    ..."
          node scripts/quality/architecture-validator.js --verbose || true
          
          echo "    P3.3    ..."
          node scripts/quality/document-sync.js --verbose || true
          
          echo "    IIG    ..."
          node scripts/quality/iig-guardian.js "$FEATURE_DESCRIPTION" --guard

      - name: 自托管环境清理
        if: matrix.prepare == true && steps.runner-gate.outputs.skip != 'true' && always()
        shell: bash
        run: bash scripts/ci/workflows/prepare-selfhosted.sh iig-guardian --teardown

      - name: "          "
        if: steps.runner-gate.outputs.skip != 'true' && always()
        run: |
          echo "    IIG      ..."
          
          #        
          REPORTS_SUMMARY="reports/iig-guardian/      .md"
          
          {
            echo "# Guardian: IIG"
            echo
            echo "##       "
            echo "- **    **: ${{ env.FEATURE_DESCRIPTION }}"
            echo "- **    **: ${{ env.GUARDIAN_MODE }}  "
            echo "- **     **: ${{ env.RISK_TOLERANCE }}"
            echo "- **    **: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")"
            echo "- **    **: ${{ github.event_name }}"
            echo
            echo "##   IIG    "
          } > "$REPORTS_SUMMARY"
          
          if [ -f "reports/iig-guardian/iig-guardian-report.json" ]; then
            echo "  IIG       " >> "$REPORTS_SUMMARY"
            
            #       
            if command -v jq >/dev/null 2>&1; then
              TOTAL_IMPLEMENTATIONS=$(jq -r '.statistics.analysedImplementations // 0' reports/iig-guardian/iig-guardian-report.json)
              DETECTED_DUPLICATES=$(jq -r '.statistics.detectedDuplicates // 0' reports/iig-guardian/iig-guardian-report.json)
              RISK_LEVEL=$(jq -r '.checkResults.assessment.overallRisk // "UNKNOWN"' reports/iig-guardian/iig-guardian-report.json)
              {
                echo "- **     **: $TOTAL_IMPLEMENTATIONS  "
                echo "- **     **: $DETECTED_DUPLICATES    "
                echo "- **    **: $RISK_LEVEL"
              } >> "$REPORTS_SUMMARY"
            fi
          else
            echo "   IIG       " >> "$REPORTS_SUMMARY"
          fi
          
          echo "         : $REPORTS_SUMMARY"

      - name:     IIG    
        if: steps.runner-gate.outputs.skip != 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: iig-guardian-reports-${{ github.run_number }}
          path: |
            reports/iig-guardian/
            reports/duplicate-code/
            reports/architecture/
            reports/document-sync/
            !reports/**/*.tmp
          retention-days: 30

      - name:   PR   - IIG    
        if: steps.runner-gate.outputs.skip != 'true' && github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './reports/iig-guardian/iig-guardian-report.json';
            
            let comment = `## Guardian: IIG        \n\n`;
            comment += `**    **: ${process.env.FEATURE_DESCRIPTION}\n`;
            comment += `**    **: ${process.env.GUARDIAN_MODE}\n`;
            comment += `**     **: ${process.env.RISK_TOLERANCE}\n\n`;
            
            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const stats = report.statistics || {};
              const assessment = report.checkResults?.assessment || {};
              
              comment += `###       \n\n`;
              comment += `|    |    |\n`;
              comment += `|------|------|\n`;
              comment += `|        | ${stats.analysedImplementations || 0}   |\n`;
              comment += `|         | ${stats.detectedDuplicates || 0}   |\n`;
              comment += `|        | **${assessment.overallRisk || 'UNKNOWN'}** |\n`;
              comment += `|         | ${stats.p3Integration?.duplicateCodeRate || 0}% |\n`;
            comment += `|         | ${stats.p3Integration?.architectureViolations || 0}   |\n`;
            comment += `|         | ${stats.p3Integration?.documentSyncRate || 0}% |\n\n`;
            
            //     
            const riskEmoji = {
              'HIGH': ' ',
              'MEDIUM': ' ', 
              'LOW': ' '
            }[assessment.overallRisk] || ' ';
            
            comment += `### ${riskEmoji}     : ${assessment.overallRisk || 'UNKNOWN'}\n\n`;
            
            if (stats.detectedDuplicates > 0) {
              comment += `   **        **:           \n\n`;
            }
            
            //   
            const recommendations = report.checkResults?.recommendations || [];
            if (recommendations.length > 0) {
              comment += `###   IIG    \n\n`;
              recommendations.forEach((rec, index) => {
                const priorityEmoji = {
                  'HIGH': ' ',
                  'MEDIUM': ' ',
                  'LOW': ' '
                }[rec.priority] || ' ';
                comment += `${index + 1}. ${priorityEmoji} **[${rec.priority}]** ${rec.message}\n`;
              });
              comment += `\n`;
            }
            
            } else {
              comment += `   IIG                    \n\n`;
            }
            
            //     
            const exitCode = process.env.IIG_GUARDIAN_EXIT_CODE || '0';
            if (exitCode !== '0') {
              if (process.env.RISK_TOLERANCE === 'low') {
                comment += `  **IIG    **:                 \n`;
              } else {
                comment += `   **IIG    **:                  \n`;
              }
            } else {
              comment += `  **IIG    **:            \n`;
            }
            
            comment += `\n  [      ](../actions/runs/${{ github.run_id }})`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name:         
        if: steps.runner-gate.outputs.skip != 'true' && always()
        run: |
          echo "    IIG        ..."
          
          EXIT_CODE="${IIG_GUARDIAN_EXIT_CODE:-0}"
          RISK_TOLERANCE="${RISK_TOLERANCE:-medium}"
          
          echo "  IIG     : $EXIT_CODE"
          echo "       : $RISK_TOLERANCE"
          
          if [ "$EXIT_CODE" != "0" ]; then
            case "$RISK_TOLERANCE" in
              "low")
                echo "        :       "
                echo "  IIG                "
                exit 1
                ;;
              "medium")
                echo "         :       "
                echo "   IIG                  "
                ;;
              "high")
                echo "        :       "
                echo "   IIG             "
                ;;
            esac
          else
            echo "  IIG        "
          fi
          
          echo "Guardian: IIG        "

  post-guardian-analysis:
    name:   IIG      
    runs-on: ubuntu-latest
    needs: iig-guardian-check
    if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name:        
      uses: actions/checkout@v4

    - name:            
      run: |
        echo "       IIG        ..."
        
        #              
        #                 
        
        echo "            ..."
        echo "           ..."
        echo "             ..."
        
        echo "             "
