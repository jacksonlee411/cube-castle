name: plan-255-gates

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ master, main ]

jobs:
  gates-255:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        env:
          # PR å›ºå®š 255ï¼›push ä½¿ç”¨ run_numberï¼Œä¾¿äºŽè¯æ®åˆ†æ¡¶
          E2E_PLAN_ID: ${{ (github.event_name == 'pull_request') && '255' || github.run_number }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Prepare logs directory
        id: prep
        shell: bash
        run: |
          ts="$(date +%Y%m%d_%H%M%S)"
          echo "TS=$ts" >> $GITHUB_OUTPUT
          mkdir -p logs/plan255
          echo "Plan 255 TS=${ts}"

      - name: Install Node deps (for ESLint architecture guard)
        shell: bash
        run: |
          set -e
          npm ci
          node -v
          npx eslint -v

      - name: Frontend ESLint Architecture gate (CQRS/Ports/Contracts)
        shell: bash
        run: |
          set -e
          # Use flat-config dedicated to architecture guard (AST-accurate; complements static scanner)
          npx eslint -c eslint.config.architecture.mjs "frontend/src/**/*.{ts,tsx}" \
            2>&1 | tee "logs/plan255/eslint-architecture-${{ steps.prep.outputs.TS }}.log"

      - name: Frontend CQRS/Ports/Forbidden gate (architecture-validator)
        shell: bash
        run: |
          set -e
          node scripts/quality/architecture-validator.js --scope frontend --rule cqrs,ports,forbidden \
            2>&1 | tee "logs/plan255/architecture-validator-${{ steps.prep.outputs.TS }}.log"

      - name: Audit root for ports/forbidden endpoints (non-blocking)
        shell: bash
        run: |
          # Non-gating auditing step to discover hardcoded ports/forbidden endpoints outside frontend/src
          node scripts/quality/architecture-validator.js --scope root --rule ports,forbidden \
            2>&1 | tee "logs/plan255/audit-root-${{ steps.prep.outputs.TS }}.log" || true

      - name: Install golangci-lint
        shell: bash
        run: |
          # Pin version to ensure reproducible CI results (align with AGENTS reproducibility guideline)
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.59.1
          golangci-lint version

      - name: Backend boundary and JSON naming gate (golangci-lint)
        shell: bash
        run: |
          set -e
          # Focus on depguard/tagliatelle; ignore unrelated typecheck noise by filtering diagnostics
          RAW_OUT="$(golangci-lint run --disable-all -E depguard -E tagliatelle 2>&1 || true)"
          echo "${RAW_OUT}" | tee "logs/plan255/golangci-lint-${{ steps.prep.outputs.TS }}.log"
          if echo "${RAW_OUT}" | rg -q '(depguard|tagliatelle)'; then
            echo "ðŸ’¥ golangci-lint reported depguard/tagliatelle violations"
            exit 1
          fi
          echo "âœ… golangci-lint depguard/tagliatelle clean"

      - name: Print E2E SUMMARY (if any)
        if: always()
        shell: bash
        env:
          E2E_PLAN_ID: ${{ (github.event_name == 'pull_request') && '255' || github.run_number }}
        run: |
          if [ -f "scripts/ci/print-e2e-summary.js" ]; then
            node scripts/ci/print-e2e-summary.js "${E2E_PLAN_ID}" || true
          else
            echo "SUMMARY: no printer script found"
          fi

      - name: Upload plan-255 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan255-logs
          path: |
            logs/plan255/**
            reports/architecture/architecture-validation.json
          if-no-files-found: warn
          retention-days: 7
