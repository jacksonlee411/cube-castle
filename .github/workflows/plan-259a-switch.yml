name: plan-259A-switch-to-hard-gate

on:
  push:
    branches: [ master, main ]

permissions:
  contents: read
  actions: write

jobs:
  switch-to-hard-gate:
    name: Switch PLAN259 threshold to 0 when business GET cleared
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install root deps
        run: npm ci
      - name: Generate protocol duplication matrix
        run: |
          node scripts/quality/protocol-duplication-matrix.js \
            --openapi docs/api/openapi.yaml \
            --graphql docs/api/schema.graphql \
            --out reports/plan259/protocol-duplication-matrix.json
      - name: Read matrix and switch variable if cleared
        id: read-matrix
        run: |
          COUNT="$(jq -r '.restBusinessGetCount' reports/plan259/protocol-duplication-matrix.json)"
          printf 'count=%s\n' "$COUNT" >>"$GITHUB_OUTPUT"
      - name: Switch repository variable to 0
        if: steps.read-matrix.outputs.count == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          NAME="PLAN259_BUSINESS_GET_THRESHOLD"
          echo "Switching $NAME to 0 (hard gate)..."
          curl -sS -X PATCH \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO}/actions/variables/${NAME}" \
            -d "{\"name\":\"${NAME}\",\"value\":\"0\"}" >/dev/null
          echo "Done."
