name: å¥‘çº¦æµ‹è¯•è‡ªåŠ¨åŒ–éªŒè¯

'on':
  push:
    branches: [ main, master, develop, feat/shared-dev ]
  pull_request:
    branches: [ main, master, develop, feat/shared-dev ]
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

jobs:
  contract-snapshot:
    name: å¥‘çº¦å¿«ç…§æ ¡éªŒ
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ä»“åº“ï¼ˆdiff åŸºçº¿ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect docs-only/ci-only changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        filters: |
          docs_only:
            - 'AGENTS.md'
            - '**/*.md'
            - 'docs/**'
            - '!docs/api/**'
            - 'reports/**'
            - 'scripts/plan222/**'
            - 'docs/development-plans/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
            - '!cmd/**'
            - '!frontend/**'
            - '!go.*'
            - '!package*.json'
            - '!.github/workflows/**'
          ci_only:
            - '.github/workflows/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
    - name: Docs/CI-only fast pass
      if: (steps.changes.outputs.docs_only == 'true' || steps.changes.outputs.ci_only == 'true') && github.event_name != 'workflow_dispatch'
      run: |
        echo "Docs/CI-only changes detected. Skipping contract snapshot heavy steps."
        echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
        exit 0
    - name: è®¾ç½® Go ç¯å¢ƒ
      if: steps.changes.outputs.docs_only != 'true'
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.9'

    - name: è®¾ç½® Node.js ç¯å¢ƒ
      if: steps.changes.outputs.docs_only != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: å®‰è£…æ ¹ç›®å½•ä¾èµ–
      if: steps.changes.outputs.docs_only != 'true'
      run: npm ci

    - name: è¿è¡Œå¥‘çº¦åŒæ­¥è„šæœ¬
      if: steps.changes.outputs.docs_only != 'true'
      run: bash scripts/contract/sync.sh

    - name: ç¡®è®¤ç”Ÿæˆåå·¥ä½œæ ‘ cleanï¼ˆPlan 256ï¼‰
      if: steps.changes.outputs.docs_only != 'true'
      shell: bash
      run: |
        echo "ğŸ” æ£€æŸ¥ç”Ÿæˆåå·¥ä½œæ ‘æ˜¯å¦ clean..."
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ ç”Ÿæˆåå­˜åœ¨æœªæäº¤å˜æ›´ï¼š"
          git status --porcelain
          echo "â€”â€” å˜æ›´æ–‡ä»¶ â€”â€”"
          git --no-pager diff --name-only
          exit 1
        fi
        echo "âœ… å·¥ä½œæ ‘ clean"

    - name: éªŒè¯å¥‘çº¦å¿«ç…§
      if: steps.changes.outputs.docs_only != 'true'
      run: python3 tests/contract/verify_inventory.py

    - name: æ ¡éªŒæ ¡éªŒè§„åˆ™å¼•ç”¨ä¸€è‡´æ€§
      if: steps.changes.outputs.docs_only != 'true'
      run: npm run lint:validation

    - name: å¥‘çº¦æ¼‚ç§»å¯¹æ¯”ï¼ˆOpenAPI â†” GraphQLï¼ŒæŠ¥å‘Šæ¨¡å¼ï¼Œå«å­—æ®µçŸ©é˜µï¼‰
      if: steps.changes.outputs.docs_only != 'true'
      run: node scripts/contract/drift-check.js --include-fields

    - name: ä¸Šä¼ æ¼‚ç§»å¯¹æ¯”æŠ¥å‘Šï¼ˆPlan 256ï¼‰
      if: ${{ steps.changes.outputs.docs_only != 'true' && always() }}
      uses: actions/upload-artifact@v4
      with:
        name: plan256-drift-report
        path: reports/contracts/drift-report.json
        retention-days: 30

  contract-testing:
    name: å¥‘çº¦æµ‹è¯•éªŒè¯
    runs-on: ubuntu-latest
    needs: contract-snapshot
    
    steps:
    - name: Checkout ä»“åº“ï¼ˆdiff åŸºçº¿ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect docs-only/ci-only changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        filters: |
          docs_only:
            - 'AGENTS.md'
            - '**/*.md'
            - 'docs/**'
            - '!docs/api/**'
            - 'reports/**'
            - 'scripts/plan222/**'
            - 'docs/development-plans/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
            - '!cmd/**'
            - '!frontend/**'
            - '!go.*'
            - '!package*.json'
            - '!.github/workflows/**'
          ci_only:
            - '.github/workflows/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
    - name: Docs/CI-only fast pass
      if: (steps.changes.outputs.docs_only == 'true' || steps.changes.outputs.ci_only == 'true') && github.event_name != 'workflow_dispatch'
      run: |
        echo "Docs/CI-only changes detected. Skipping contract testing heavy steps."
        echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
        exit 0
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      if: steps.changes.outputs.docs_only != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: å®‰è£…ä¾èµ–åŒ…
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        cd frontend
        npm ci
        
    - name: GraphQL Schemaè¯­æ³•éªŒè¯
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        cd frontend
        npm run validate:schema
        
    - name: å­—æ®µå‘½åè§„èŒƒéªŒè¯  
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        cd frontend
        npm run validate:field-naming
        
    - name: è¿è¡Œå¥‘çº¦æµ‹è¯•å¥—ä»¶
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        cd frontend
        npm run test:contract
        
    - name: éªŒè¯æ„å»ºåˆè§„æ€§
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        cd frontend
        npm run build:verify
        
    - name: ç”Ÿæˆå¥‘çº¦æµ‹è¯•æŠ¥å‘Š
      if: ${{ steps.changes.outputs.docs_only != 'true' && always() }}
      run: |
        cd frontend
        npm run test:contract -- --reporter=json --outputFile=contract-test-results.json
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: ${{ steps.changes.outputs.docs_only != 'true' && always() }}
      uses: actions/upload-artifact@v4
      with:
        name: contract-test-results
        path: frontend/contract-test-results.json
        retention-days: 30

  contract-compliance-gate:
    name: å¥‘çº¦åˆè§„æ€§é—¨ç¦
    needs:
      - contract-snapshot
      - contract-testing
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ£€æŸ¥å¥‘çº¦æµ‹è¯•ç»“æœ
      run: |
        if [[ "${{ needs.contract-testing.result }}" != "success" ]]; then
          echo "âŒ å¥‘çº¦æµ‹è¯•å¤±è´¥ - é˜»æ­¢åˆå¹¶"
          echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜ï¼š"
          echo "1. GraphQL Schemaè¯­æ³•é”™è¯¯"
          echo "2. å­—æ®µå‘½åä¸ç¬¦åˆcamelCaseè§„èŒƒ"
          echo "3. å“åº”ç»“æ„ä¸ç¬¦åˆä¼ä¸šçº§ä¿¡å°æ ‡å‡†"
          echo "4. æ„å»ºéªŒè¯å¤±è´¥"
          exit 1
        else
          echo "âœ… å¥‘çº¦æµ‹è¯•é€šè¿‡ - å…è®¸åˆå¹¶"
        fi

  schema-change-detection:
    name: Schemaå˜æ›´æ£€æµ‹
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ£€æµ‹Schemaå˜æ›´
      id: schema-changes
      run: |
        if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -q "docs/api/schema.graphql"; then
          echo "schema-changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ£€æµ‹åˆ°GraphQL Schemaå˜æ›´"
        else
          echo "schema-changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Schemaå‘åå…¼å®¹æ€§æ£€æŸ¥
      if: steps.schema-changes.outputs.schema-changed == 'true'
      run: |
        echo "ğŸ” æ‰§è¡ŒSchemaå‘åå…¼å®¹æ€§æ£€æŸ¥"
        echo "æ£€æŸ¥é¡¹ç›®ï¼š"
        echo "- å­—æ®µåˆ é™¤æ£€æµ‹"
        echo "- ç±»å‹å˜æ›´æ£€æµ‹" 
        echo "- æšä¸¾å€¼åˆ é™¤æ£€æµ‹"
        echo "- å¿…å¡«å­—æ®µæ–°å¢æ£€æµ‹"
        # è¿™é‡Œå¯ä»¥é›†æˆschema-diffå·¥å…·
        
    - name: é€šçŸ¥Schemaå˜æ›´
      if: steps.schema-changes.outputs.schema-changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ”„ GraphQL Schemaå˜æ›´æ£€æµ‹
            
            æ£€æµ‹åˆ°APIå¥‘çº¦å˜æ›´ï¼Œè¯·ç¡®è®¤ï¼š
            
            ### ğŸ“‹ å˜æ›´æ£€æŸ¥æ¸…å•
            - [ ] Schemaè¯­æ³•éªŒè¯é€šè¿‡
            - [ ] å‘åå…¼å®¹æ€§ç¡®è®¤
            - [ ] å®¢æˆ·ç«¯å½±å“è¯„ä¼°
            - [ ] APIç‰ˆæœ¬æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰
            - [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ
            
            ### ğŸ§ª å¥‘çº¦æµ‹è¯•çŠ¶æ€
            å¥‘çº¦æµ‹è¯•å°†è‡ªåŠ¨éªŒè¯Schemaä¸€è‡´æ€§å’Œå­—æ®µå‘½åè§„èŒƒã€‚
            
            è¯·åœ¨åˆå¹¶å‰ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡ã€‚`
          })

performance-impact-analysis:
  name: æ€§èƒ½å½±å“åˆ†æ
  if: github.event_name == 'pull_request'
  strategy:
    matrix:
      runner: [ubuntu, selfhosted]
      include:
        - runner: ubuntu
          labels: ubuntu-latest
          prepare: false
        - runner: selfhosted
          labels:
            - self-hosted
            - cubecastle
            - docker
          prepare: true
  runs-on: ${{ matrix.labels }}
  
  steps:
  - name: Checkoutä»£ç 
    uses: actions/checkout@v4
    
  - name: è‡ªæ‰˜ç®¡ç¯å¢ƒå‡†å¤‡
    if: matrix.prepare == true
    shell: bash
    run: bash scripts/ci/workflows/prepare-selfhosted.sh performance-impact-analysis

  - name: è®¾ç½®Node.jsç¯å¢ƒ
    uses: actions/setup-node@v4
    with:
      node-version: '20'
      cache: 'npm'
      cache-dependency-path: frontend/package-lock.json
      
  - name: å®‰è£…ä¾èµ–åŒ…
    run: |
      cd frontend
      npm ci
      
  - name: æ„å»ºæ€§èƒ½åˆ†æ
    run: |
      cd frontend
      npm run build
      
  - name: Bundleå¤§å°åˆ†æ
    run: |
      cd frontend
      echo "ğŸ“Š Bundleå¤§å°åˆ†æï¼š" 
      du -sh dist/ || echo "æ„å»ºè¾“å‡ºä¸å­˜åœ¨"
      
  - name: å¥‘çº¦æµ‹è¯•æ€§èƒ½åŸºå‡†
    run: |
      cd frontend
      time npm run test:contract
      echo "å¥‘çº¦æµ‹è¯•æ‰§è¡Œæ—¶é—´å·²è®°å½•"

  - name: è‡ªæ‰˜ç®¡ç¯å¢ƒæ¸…ç†
    if: matrix.prepare == true
    shell: bash
    run: bash scripts/ci/workflows/prepare-selfhosted.sh performance-impact-analysis --teardown
