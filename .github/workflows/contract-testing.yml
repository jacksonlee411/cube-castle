name: å¥‘çº¦æµ‹è¯•è‡ªåŠ¨åŒ–éªŒè¯

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]

jobs:
  contract-testing:
    name: å¥‘çº¦æµ‹è¯•éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        cd frontend
        npm ci
        
    - name: GraphQL Schemaè¯­æ³•éªŒè¯
      run: |
        cd frontend
        npm run validate:schema
        
    - name: å­—æ®µå‘½åè§„èŒƒéªŒè¯  
      run: |
        cd frontend
        npm run validate:field-naming
        
    - name: è¿è¡Œå¥‘çº¦æµ‹è¯•å¥—ä»¶
      run: |
        cd frontend
        npm run test:contract
        
    - name: éªŒè¯æ„å»ºåˆè§„æ€§
      run: |
        cd frontend
        npm run build:verify
        
    - name: ç”Ÿæˆå¥‘çº¦æµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        cd frontend
        npm run test:contract -- --reporter=json --outputFile=contract-test-results.json
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: contract-test-results
        path: frontend/contract-test-results.json
        retention-days: 30

  contract-compliance-gate:
    name: å¥‘çº¦åˆè§„æ€§é—¨ç¦
    needs: contract-testing
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ£€æŸ¥å¥‘çº¦æµ‹è¯•ç»“æœ
      run: |
        if [[ "${{ needs.contract-testing.result }}" != "success" ]]; then
          echo "âŒ å¥‘çº¦æµ‹è¯•å¤±è´¥ - é˜»æ­¢åˆå¹¶"
          echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜ï¼š"
          echo "1. GraphQL Schemaè¯­æ³•é”™è¯¯"
          echo "2. å­—æ®µå‘½åä¸ç¬¦åˆcamelCaseè§„èŒƒ"
          echo "3. å“åº”ç»“æ„ä¸ç¬¦åˆä¼ä¸šçº§ä¿¡å°æ ‡å‡†"
          echo "4. æ„å»ºéªŒè¯å¤±è´¥"
          exit 1
        else
          echo "âœ… å¥‘çº¦æµ‹è¯•é€šè¿‡ - å…è®¸åˆå¹¶"
        fi

  schema-change-detection:
    name: Schemaå˜æ›´æ£€æµ‹
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ£€æµ‹Schemaå˜æ›´
      id: schema-changes
      run: |
        if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -q "docs/api/schema.graphql"; then
          echo "schema-changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ£€æµ‹åˆ°GraphQL Schemaå˜æ›´"
        else
          echo "schema-changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Schemaå‘åå…¼å®¹æ€§æ£€æŸ¥
      if: steps.schema-changes.outputs.schema-changed == 'true'
      run: |
        echo "ğŸ” æ‰§è¡ŒSchemaå‘åå…¼å®¹æ€§æ£€æŸ¥"
        echo "æ£€æŸ¥é¡¹ç›®ï¼š"
        echo "- å­—æ®µåˆ é™¤æ£€æµ‹"
        echo "- ç±»å‹å˜æ›´æ£€æµ‹" 
        echo "- æšä¸¾å€¼åˆ é™¤æ£€æµ‹"
        echo "- å¿…å¡«å­—æ®µæ–°å¢æ£€æµ‹"
        # è¿™é‡Œå¯ä»¥é›†æˆschema-diffå·¥å…·
        
    - name: é€šçŸ¥Schemaå˜æ›´
      if: steps.schema-changes.outputs.schema-changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ”„ GraphQL Schemaå˜æ›´æ£€æµ‹
            
            æ£€æµ‹åˆ°APIå¥‘çº¦å˜æ›´ï¼Œè¯·ç¡®è®¤ï¼š
            
            ### ğŸ“‹ å˜æ›´æ£€æŸ¥æ¸…å•
            - [ ] Schemaè¯­æ³•éªŒè¯é€šè¿‡
            - [ ] å‘åå…¼å®¹æ€§ç¡®è®¤
            - [ ] å®¢æˆ·ç«¯å½±å“è¯„ä¼°
            - [ ] APIç‰ˆæœ¬æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰
            - [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ
            
            ### ğŸ§ª å¥‘çº¦æµ‹è¯•çŠ¶æ€
            å¥‘çº¦æµ‹è¯•å°†è‡ªåŠ¨éªŒè¯Schemaä¸€è‡´æ€§å’Œå­—æ®µå‘½åè§„èŒƒã€‚
            
            è¯·åœ¨åˆå¹¶å‰ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡ã€‚`
          })

  performance-impact-analysis:
    name: æ€§èƒ½å½±å“åˆ†æ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        cd frontend
        npm ci
        
    - name: æ„å»ºæ€§èƒ½åˆ†æ
      run: |
        cd frontend
        npm run build
        
    - name: Bundleå¤§å°åˆ†æ
      run: |
        cd frontend
        echo "ğŸ“Š Bundleå¤§å°åˆ†æï¼š" 
        du -sh dist/ || echo "æ„å»ºè¾“å‡ºä¸å­˜åœ¨"
        
    - name: å¥‘çº¦æµ‹è¯•æ€§èƒ½åŸºå‡†
      run: |
        cd frontend
        time npm run test:contract
        echo "å¥‘çº¦æµ‹è¯•æ‰§è¡Œæ—¶é—´å·²è®°å½•"