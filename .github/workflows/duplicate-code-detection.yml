name: ğŸ” è‡ªåŠ¨åŒ–é‡å¤ä»£ç æ£€æµ‹

on:
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œå®Œæ•´æ‰«æ
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      threshold:
        description: 'é‡å¤ä»£ç é˜ˆå€¼ (%)'
        required: false
        default: '5'
        type: string
      scope:
        description: 'æ‰«æèŒƒå›´'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - frontend-only
        - backend-only
        - changed-files

env:
  # Plan 261: å°†é»˜è®¤é˜ˆå€¼ä¸´æ—¶æ”¾å®½è‡³ 10%ï¼Œåç»­æŒ‰å‘¨æ”¶ç´§ï¼ˆPR ä»å¯è¦†ç›–æ›´ä¸¥é˜ˆå€¼ï¼‰
  DUPLICATE_THRESHOLD: ${{ github.event.inputs.threshold || '10' }}
  SCAN_SCOPE: ${{ github.event.inputs.scope || 'full' }}

jobs:
  duplicate-detection:
    name: ğŸ“Š é‡å¤ä»£ç æ‰«æ (${{ matrix.label }})
    strategy:
      fail-fast: false
      matrix:
        label: [ubuntu, selfhosted]
        include:
          - label: ubuntu
            runs_on: '["ubuntu-latest"]'
          - label: selfhosted
            runs_on: '["self-hosted","cubecastle","docker"]'
    runs-on: ${{ fromJson(matrix.runs_on) }}
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
    - name: Detect docs-only changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        filters:
          docs_only:
            - 'AGENTS.md'
            - '**/*.md'
            - 'docs/**'
            - 'reports/**'
            - 'scripts/plan222/**'
            - 'docs/development-plans/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
            - '!go.*'
            - '!package*.json'
            - '!.github/workflows/**'
          ci_only:
            - '.github/workflows/**'
            - '!frontend/**'
            - '!cmd/**'
            - '!internal/**'
            - '!pkg/**'
            - '!database/**'
            - '!tests/**'
    - name: Docs/CI-only fast pass
      if: steps.changes.outputs.docs_only == 'true' || steps.changes.outputs.ci_only == 'true'
      run: |
        echo "Docs/CI-only changes detected. Skipping duplicate code detection."
        echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
        exit 0
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      if: steps.changes.outputs.docs_only != 'true'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºblameåˆ†æ

    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      if: steps.changes.outputs.docs_only != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ğŸ› ï¸ å®‰è£…jscpdå·¥å…·
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        npm install -g jscpd@latest
        echo "ğŸ“¦ jscpdç‰ˆæœ¬: $(jscpd --version)"

    - name: ğŸ“ åˆ›å»ºæŠ¥å‘Šç›®å½•
      if: steps.changes.outputs.docs_only != 'true'
      run: mkdir -p reports/duplicate-code

    - name: ğŸ” æ‰§è¡Œé‡å¤ä»£ç æ£€æµ‹ (å®Œæ•´æ‰«æ)
      if: steps.changes.outputs.docs_only != 'true' && env.SCAN_SCOPE == 'full'
      run: |
        echo "ğŸ” æ‰§è¡Œå®Œæ•´é¡¹ç›®æ‰«æï¼Œé˜ˆå€¼: ${DUPLICATE_THRESHOLD}%"
        # Plan 261: å¿½ç•¥ç¬¬ä¸‰æ–¹ä¸äº§ç‰©ï¼Œé™ä½è¯¯æŠ¥ï¼›ä¸´æ—¶ç¨³æ€ï¼Œ11-22 å‰å›æ”¶ç­–ç•¥
        jscpd --threshold=$DUPLICATE_THRESHOLD \
          --ignore \"**/node_modules/**\" \
          --ignore \"**/dist/**\" \
          --ignore \"**/build/**\" \
          --ignore \"**/.cache/**\" \
          --ignore \"**/coverage/**\" \
          --ignore \"**/reports/**\" \
          --ignore \"**/logs/**\" \
          --ignore \"**/*.min.js\" \
          . || exit_code=$?
        
        echo "ğŸ“Š æ‰«æå®Œæˆï¼Œé€€å‡ºç : ${exit_code:-0}"
        
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        if [ "${exit_code:-0}" -ne 0 ]; then
          echo "âŒ é‡å¤ä»£ç æ£€æµ‹å¤±è´¥ï¼é‡å¤ç‡è¶…è¿‡ ${DUPLICATE_THRESHOLD}% é˜ˆå€¼"
          exit 1
        else
          echo "âœ… é‡å¤ä»£ç æ£€æµ‹é€šè¿‡ï¼é‡å¤ç‡åœ¨ ${DUPLICATE_THRESHOLD}% é˜ˆå€¼ä»¥å†…"
        fi

    - name: ğŸ” æ‰§è¡Œé‡å¤ä»£ç æ£€æµ‹ (å‰ç«¯)
      if: steps.changes.outputs.docs_only != 'true' && env.SCAN_SCOPE == 'frontend-only'
      run: |
        echo "ğŸ” æ‰§è¡Œå‰ç«¯ä»£ç æ‰«æ"
        jscpd --threshold=$DUPLICATE_THRESHOLD \
          --ignore \"**/node_modules/**\" \
          --ignore \"**/dist/**\" \
          --ignore \"**/build/**\" \
          --ignore \"**/.cache/**\" \
          --ignore \"**/coverage/**\" \
          --ignore \"**/reports/**\" \
          --ignore \"**/logs/**\" \
          --ignore \"**/*.min.js\" \
          frontend/ || exit_code=$?
        [ "${exit_code:-0}" -eq 0 ] || (echo "âŒ å‰ç«¯é‡å¤ä»£ç è¶…è¿‡é˜ˆå€¼" && exit 1)

    - name: ğŸ” æ‰§è¡Œé‡å¤ä»£ç æ£€æµ‹ (åç«¯)
      if: steps.changes.outputs.docs_only != 'true' && env.SCAN_SCOPE == 'backend-only'
      run: |
        echo "ğŸ” æ‰§è¡Œåç«¯ä»£ç æ‰«æ"
        jscpd --threshold=$DUPLICATE_THRESHOLD \
          --ignore \"**/node_modules/**\" \
          --ignore \"**/dist/**\" \
          --ignore \"**/build/**\" \
          --ignore \"**/.cache/**\" \
          --ignore \"**/coverage/**\" \
          --ignore \"**/reports/**\" \
          --ignore \"**/logs/**\" \
          --ignore \"**/*.min.js\" \
          --format=go \
          cmd/ internal/ pkg/ || exit_code=$?
        [ "${exit_code:-0}" -eq 0 ] || (echo "âŒ åç«¯é‡å¤ä»£ç è¶…è¿‡é˜ˆå€¼" && exit 1)

    - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        # ç”ŸæˆJSONæŠ¥å‘Šç”¨äºåç»­å¤„ç†
        jscpd --threshold=100 --reporters=json --output=./reports/duplicate-code \
          --ignore \"**/node_modules/**\" \
          --ignore \"**/dist/**\" \
          --ignore \"**/build/**\" \
          --ignore \"**/.cache/**\" \
          --ignore \"**/coverage/**\" \
          --ignore \"**/reports/**\" \
          --ignore \"**/logs/**\" \
          --ignore \"**/*.min.js\" \
          . || true
        
        # è¾“å‡ºç»Ÿè®¡æ‘˜è¦
        if [ -f "./reports/duplicate-code/jscpd-report.json" ]; then
          echo "ğŸ“ˆ é‡å¤ä»£ç æ£€æµ‹ç»Ÿè®¡:"
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./reports/duplicate-code/jscpd-report.json', 'utf8'));
            console.log(\`ğŸ“ æ€»æ–‡ä»¶æ•°: \${report.statistics.total.sources}\`);
            console.log(\`ğŸ“‹ æ€»è¡Œæ•°: \${report.statistics.total.lines}\`);
            console.log(\`ğŸ” é‡å¤è¡Œæ•°: \${report.statistics.total.duplicatedLines}\`);
            console.log(\`ğŸ“Š é‡å¤ç‡: \${report.statistics.total.percentage.toFixed(2)}%\`);
            console.log(\`âš ï¸ é‡å¤ç‰‡æ®µ: \${report.statistics.total.clones}\`);
          " 2>/dev/null || echo "ğŸ“Š æŠ¥å‘Šç”Ÿæˆä¸­..."
        fi

    - name: ğŸ“¤ ä¸Šä¼ æ£€æµ‹æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: duplicate-code-report-${{ github.run_number }}
        path: |
          reports/duplicate-code/
          !reports/duplicate-code/**/*.tmp
        retention-days: 30

    - name: ğŸ’¬ PRè¯„è®ºæŠ¥å‘Š
      if: github.event_name == 'pull_request' && steps.changes.outputs.docs_only != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './reports/duplicate-code/jscpd-report.json';
          
          if (fs.existsSync(path)) {
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const stats = report.statistics.total;
            
            const comment = `## ğŸ” é‡å¤ä»£ç æ£€æµ‹æŠ¥å‘Š
            
            | æŒ‡æ ‡ | æ•°å€¼ |
            |------|------|
            | ğŸ“ æ‰«ææ–‡ä»¶ | ${stats.sources} |
            | ğŸ“‹ ä»£ç è¡Œæ•° | ${stats.lines.toLocaleString()} |
            | ğŸ” é‡å¤è¡Œæ•° | ${stats.duplicatedLines.toLocaleString()} |
            | ğŸ“Š é‡å¤ç‡ | **${stats.percentage.toFixed(2)}%** |
            | âš ï¸ é‡å¤ç‰‡æ®µ | ${stats.clones} |
            | ğŸ¯ æ£€æµ‹é˜ˆå€¼ | ${process.env.DUPLICATE_THRESHOLD}% |
            | âœ… æ£€æµ‹çŠ¶æ€ | ${stats.percentage <= parseFloat(process.env.DUPLICATE_THRESHOLD) ? 'é€šè¿‡ âœ…' : 'å¤±è´¥ âŒ'} |
            
            ${stats.percentage > parseFloat(process.env.DUPLICATE_THRESHOLD) ? 
              'âš ï¸ **è­¦å‘Š**: é‡å¤ç‡è¶…è¿‡é˜ˆå€¼ï¼Œè¯·å®¡æŸ¥é‡å¤ä»£ç ç‰‡æ®µ' : 
              'ğŸ‰ **ä¼˜ç§€**: é‡å¤ç‡æ§åˆ¶è‰¯å¥½ï¼Œç¬¦åˆè´¨é‡æ ‡å‡†'}
            
            ğŸ“Š [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](../actions/runs/${{ github.run_id }})`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: âš ï¸ è´¨é‡é—¨ç¦æ£€æŸ¥
      if: steps.changes.outputs.docs_only != 'true'
      run: |
        if [ -f "./reports/duplicate-code/jscpd-report.json" ]; then
          CURRENT_PERCENTAGE=$(node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./reports/duplicate-code/jscpd-report.json', 'utf8'));
            console.log(report.statistics.total.percentage);
          " 2>/dev/null || echo "0")
          
          echo "å½“å‰é‡å¤ç‡: ${CURRENT_PERCENTAGE}%"
          echo "è´¨é‡é˜ˆå€¼: ${DUPLICATE_THRESHOLD}%"
          
          # ä½¿ç”¨bcè¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒ
          if command -v bc >/dev/null 2>&1; then
            EXCEEDS_THRESHOLD=$(echo "${CURRENT_PERCENTAGE} > ${DUPLICATE_THRESHOLD}" | bc -l)
            if [ "$EXCEEDS_THRESHOLD" -eq 1 ]; then
              echo "ğŸ’¥ è´¨é‡é—¨ç¦å¤±è´¥ï¼šé‡å¤ç‡ ${CURRENT_PERCENTAGE}% è¶…è¿‡é˜ˆå€¼ ${DUPLICATE_THRESHOLD}%"
              echo "ğŸ”§ è¯·é‡æ„é‡å¤ä»£ç åå†æ¬¡æäº¤"
              exit 1
            else
              echo "âœ… è´¨é‡é—¨ç¦é€šè¿‡ï¼šé‡å¤ç‡ ${CURRENT_PERCENTAGE}% åœ¨é˜ˆå€¼ ${DUPLICATE_THRESHOLD}% ä»¥å†…"
            fi
          else
            echo "âš ï¸ æ— æ³•è¿›è¡Œç²¾ç¡®æ¯”è¾ƒï¼Œè·³è¿‡è´¨é‡é—¨ç¦æ£€æŸ¥"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ£€æµ‹æŠ¥å‘Šï¼Œè·³è¿‡è´¨é‡é—¨ç¦æ£€æŸ¥"
        fi
