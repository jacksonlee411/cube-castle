name: APIåˆè§„æ€§æ£€æŸ¥
on: 
  pull_request:
    branches: [master, main, develop]

jobs:
  api-compliance-check:
    name: APIä¸€è‡´æ€§ä¸Žè§„èŒƒåˆè§„ (${{ matrix.label }})
    strategy:
      fail-fast: false
      matrix:
        label: [ubuntu, selfhosted]
        include:
          - label: ubuntu
            runs_on: '["ubuntu-latest"]'
          - label: selfhosted
            runs_on: '["self-hosted","cubecastle","docker"]'
    runs-on: ${{ fromJson(matrix.runs_on) }}
    
    steps:
      - name: Detect docs-only/ci-only changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters:
            docs_only:
              - 'AGENTS.md'
              - '**/*.md'
              - 'docs/**'
              - 'reports/**'
              - 'scripts/plan222/**'
              - 'docs/development-plans/**'
              - '!frontend/**'
              - '!cmd/**'
              - '!internal/**'
              - '!pkg/**'
              - '!database/**'
              - '!tests/**'
              - '!go.*'
              - '!package*.json'
              - '!.github/workflows/**'
            ci_only:
              - '.github/workflows/**'
              - '!frontend/**'
              - '!cmd/**'
              - '!internal/**'
              - '!pkg/**'
              - '!database/**'
              - '!tests/**'
      - name: Docs/CI-only fast pass
        if: steps.changes.outputs.docs_only == 'true' || steps.changes.outputs.ci_only == 'true'
        run: |
          echo "Docs/CI-only changes detected. Skipping api-compliance heavy steps."
          echo "TODO-TEMPORARY(2025-11-22): Remove docs-only short-circuit once base CI is green."
          exit 0
      - name: Checkoutä»£ç 
        if: steps.changes.outputs.docs_only != 'true'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽdiffæ£€æŸ¥

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        if: steps.changes.outputs.docs_only != 'true'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…APIåˆè§„æ€§ä¾èµ–
        if: steps.changes.outputs.docs_only != 'true'
        run: npm ci
      
      - name: å®‰è£…ä¾èµ–å·¥å…·
        if: steps.changes.outputs.docs_only != 'true'
        run: |
          # å®‰è£…ripgrepç”¨äºŽé«˜æ€§èƒ½å­—ç¬¦ä¸²æœç´¢
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep_13.0.0_amd64.deb
          sudo dpkg -i ripgrep_13.0.0_amd64.deb
          
          # éªŒè¯å®‰è£…
          rg --version

      - name: ç¦ç”¨ç«¯ç‚¹æ¨¡å¼æ‰«æ
        if: steps.changes.outputs.docs_only != 'true'
        run: |
          echo "ðŸ” æ‰«æç¦ç”¨çš„APIæ¨¡å¼..."
          
          FORBIDDEN_PATTERNS=(
            '\b/reactivate\b'
            '\borg:reactivate\b'
            'reactivate\s*:'
            'PATCH.*status.*(ACTIVE|INACTIVE)'
            '\.reactivate\s*\('
          )
          
          VIOLATIONS_FOUND=0
          
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            echo "æ£€æŸ¥æ¨¡å¼: $pattern"
            
            if rg -nE "$pattern" \
              --type typescript --type yaml --type json --type markdown \
              frontend/src/ docs/ \
              --ignore-case || [ $? -eq 1 ]; then
              
              if rg -qE "$pattern" \
                --type typescript --type yaml --type json --type markdown \
                frontend/src/ docs/ \
                --ignore-case; then
                echo "âŒ å‘çŽ°è¿è§„æ¨¡å¼: $pattern"
                VIOLATIONS_FOUND=1
              fi
            fi
          done
          
          if [ $VIOLATIONS_FOUND -eq 1 ]; then
            echo ""
            echo "ðŸ’¥ APIåˆè§„æ£€æŸ¥å¤±è´¥!"
            echo "ADR-008è¦æ±‚ï¼š"
            echo "1. ä½¿ç”¨ /activate æ›¿ä»£ /reactivate"
            echo "2. ä½¿ç”¨ org:activate æ›¿ä»£ org:reactivate"
            echo "3. ä½¿ç”¨ .activate() æ›¿ä»£ .reactivate()"
            echo "4. ä½¿ç”¨ POST /activate æ›¿ä»£ PATCH status=ACTIVE"
            echo ""
            echo "è¯·ä¿®å¤åŽé‡æ–°æäº¤ã€‚"
            exit 1
          else
            echo "âœ… æœªå‘çŽ°ç¦ç”¨APIæ¨¡å¼"
          fi

      - name: éªŒè¯æƒé™-ç«¯ç‚¹å¯¹é½
        if: steps.changes.outputs.docs_only != 'true'
        run: |
          echo "ðŸ” éªŒè¯æƒé™-ç«¯ç‚¹ä¸€è‡´æ€§..."
          
          # æ£€æŸ¥activateç«¯ç‚¹æƒé™é…ç½®
          if grep -r "activate" docs/api/openapi.yaml | grep -v "org:activate"; then
            echo "âŒ activateç«¯ç‚¹å¿…é¡»ä½¿ç”¨org:activateæƒé™"
            exit 1
          fi
          
          # æ£€æŸ¥suspendç«¯ç‚¹æƒé™é…ç½®  
          if grep -r "suspend" docs/api/openapi.yaml | grep -v "org:suspend"; then
            echo "âŒ suspendç«¯ç‚¹å¿…é¡»ä½¿ç”¨org:suspendæƒé™"
            exit 1
          fi
          
          echo "âœ… æƒé™-ç«¯ç‚¹å¯¹é½éªŒè¯é€šè¿‡"

      - name: Spectral OpenAPI å¥‘çº¦æ ¡éªŒ
        if: steps.changes.outputs.docs_only != 'true'
        run: npm run lint:api

      - name: æ£€æŸ¥å“åº”ç»“æž„ä¸€è‡´æ€§
        if: steps.changes.outputs.docs_only != 'true'
        run: |
          echo "ðŸ” æ£€æŸ¥APIå“åº”ç»“æž„ä¸€è‡´æ€§..."
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ ‡å‡†å“åº”ä¿¡å°æ ¼å¼
          RESPONSE_STRUCTURE_FILES=(
            "frontend/src/shared/api/organizations.ts"
            "tests/e2e/activate-suspend-workflow.test.ts"
          )
          
          for file in "${RESPONSE_STRUCTURE_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              
              # éªŒè¯åŒ…å«æ ‡å‡†å“åº”å­—æ®µ
              if ! grep -q "success.*boolean" "$file" || \
                 ! grep -q "timestamp.*string" "$file" || \
                 ! grep -q "requestId.*string" "$file"; then
                echo "âŒ $file æœªä½¿ç”¨æ ‡å‡†å“åº”ä¿¡å°æ ¼å¼"
                echo "   è¦æ±‚: success, timestamp, requestIdå­—æ®µ"
                exit 1
              fi
            fi
          done
          
          echo "âœ… å“åº”ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

      - name: ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š
        if: steps.changes.outputs.docs_only != 'true'
        run: |
          echo "ðŸ“Š ç”ŸæˆAPIåˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š..."
          
          REPORT_FILE="api-compliance-report.md"
          
          cat > $REPORT_FILE << EOF
          # APIåˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š
          
          **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **æäº¤å“ˆå¸Œ**: $GITHUB_SHA
          **åˆ†æ”¯**: $GITHUB_REF_NAME
          
          ## æ£€æŸ¥ç»“æžœ

          âœ… **Spectral å¥‘çº¦æ ¡éªŒ**: docs/api/openapi.yaml è§„åˆ™æ‰«æå®Œæˆï¼ˆè¯¦è§å·¥ä½œæµæ—¥å¿—ï¼‰
          âœ… **ç¦ç”¨ç«¯ç‚¹æ‰«æ**: æœªå‘çŽ° /reactivate æˆ– org:reactivate æ®‹ç•™
          âœ… **æƒé™å¯¹é½éªŒè¯**: activate/suspend ç«¯ç‚¹æƒé™é…ç½®æ­£ç¡®
          âœ… **å“åº”ç»“æž„æ£€æŸ¥**: APIå“åº”ä½¿ç”¨æ ‡å‡†ä¿¡å°æ ¼å¼
          
          ## ADR-008åˆè§„çŠ¶æ€
          
          - [x] ç«¯ç‚¹ç»Ÿä¸€: ä»…ä½¿ç”¨ /activate å’Œ /suspend
          - [x] æƒé™å¯¹é½: org:activate å’Œ org:suspend
          - [x] å‰ç«¯æ¸…ç†: ç§»é™¤ .reactivate() åˆ«åæ–¹æ³•
          - [x] CIé˜»æ–­: è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢è¿è§„æ¨¡å¼
          
          ## å»ºè®®
          
          ç»§ç»­ç›‘æŽ§ç”Ÿäº§çŽ¯å¢ƒ410å“åº”ï¼Œç¡®ä¿å®¢æˆ·ç«¯å®Œå…¨è¿ç§»åˆ°æ–°ç«¯ç‚¹ã€‚
          EOF
          
          echo "âœ… åˆè§„æ€§æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
          cat $REPORT_FILE

      - name: ä¸Šä¼ åˆè§„æ€§æŠ¥å‘Š
        if: steps.changes.outputs.docs_only != 'true'
        uses: actions/upload-artifact@v3
        with:
          name: api-compliance-report
          path: api-compliance-report.md
          retention-days: 30
