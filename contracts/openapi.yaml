openapi: 3.0.3
info:
  title: Cube Castle Internal API
  version: 1.2.0
  description: "元合约：定义城堡内部模块间的通信规约 - 业务ID系统"
paths:
  # 面向用户的外部API保持不变
  /api/v1/interpret:
    post:
      summary: Interpret Natural Language Query
      operationId: interpretQuery
      tags:
        - IntelligenceGateway
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InterpretRequest'
      responses:
        '200':
          description: Successful interpretation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneralResponse'
        '400':
          description: Bad request
        '500':
          description: Internal server error

  # CoreHR 员工管理 API - 使用业务ID系统
  /api/v1/corehr/employees:
    get:
      summary: List employees with pagination
      operationId: listEmployees
      tags:
        - CoreHR
      parameters:
        - name: page
          in: query
          description: Page number (1-based)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: search
          in: query
          description: Search term for employee name, email, or business ID
          required: false
          schema:
            type: string
        - name: include_uuid
          in: query
          description: Include UUID in response for system integration
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of employees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeListResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
    
    post:
      summary: Create a new employee (auto-generates business ID)
      operationId: createEmployee
      tags:
        - CoreHR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEmployeeRequest'
      responses:
        '201':
          description: Employee created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '400':
          description: Bad request - validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Employee already exists
        '500':
          description: Internal server error

  /api/v1/corehr/employees/{employee_id}:
    get:
      summary: Get employee by business ID
      operationId: getEmployee
      tags:
        - CoreHR
      parameters:
        - name: employee_id
          in: path
          required: true
          description: Employee business ID (1-99999999)
          schema:
            type: string
            pattern: '^[1-9][0-9]{0,7}$'
        - name: include_uuid
          in: query
          description: Include UUID in response for system integration
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Employee details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '400':
          description: Invalid business ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Employee not found
        '500':
          description: Internal server error
    
    put:
      summary: Update employee
      operationId: updateEmployee
      tags:
        - CoreHR
      parameters:
        - name: employee_id
          in: path
          required: true
          description: Employee business ID (1-99999999)
          schema:
            type: string
            pattern: '^[1-9][0-9]{0,7}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEmployeeRequest'
      responses:
        '200':
          description: Employee updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Employee not found
        '500':
          description: Internal server error
    
    delete:
      summary: Delete employee
      operationId: deleteEmployee
      tags:
        - CoreHR
      parameters:
        - name: employee_id
          in: path
          required: true
          description: Employee business ID (1-99999999)
          schema:
            type: string
            pattern: '^[1-9][0-9]{0,7}$'
      responses:
        '204':
          description: Employee deleted successfully
        '400':
          description: Invalid business ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Employee not found
        '500':
          description: Internal server error

  # 组织架构 API - 使用业务ID系统
  /api/v1/corehr/organizations:
    get:
      summary: List organizations
      operationId: listOrganizations
      tags:
        - CoreHR
      parameters:
        - name: include_uuid
          in: query
          description: Include UUID in response for system integration
          required: false
          schema:
            type: boolean
            default: false
        - name: search
          in: query
          description: Search by name or business ID
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of organizations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationListResponse'
        '500':
          description: Internal server error

    post:
      summary: Create organization (auto-generates business ID)
      operationId: createOrganization
      tags:
        - CoreHR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error

  /api/v1/corehr/organizations/tree:
    get:
      summary: Get organization tree
      operationId: getOrganizationTree
      tags:
        - CoreHR
      parameters:
        - name: include_uuid
          in: query
          description: Include UUIDs in response for system integration
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Organization tree structure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationTreeResponse'
        '500':
          description: Internal server error

  /api/v1/corehr/organizations/{organization_id}:
    get:
      summary: Get organization by business ID
      operationId: getOrganization
      tags:
        - CoreHR
      parameters:
        - name: organization_id
          in: path
          required: true
          description: Organization business ID (100000-999999)
          schema:
            type: string
            pattern: '^[1-9][0-9]{5}$'
        - name: include_uuid
          in: query
          description: Include UUID in response for system integration
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Invalid business ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Organization not found
        '500':
          description: Internal server error

  # 业务ID管理 API
  /api/v1/corehr/business-ids/generate:
    post:
      summary: Generate business ID for entity (internal use)
      operationId: generateBusinessId
      tags:
        - CoreHR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateBusinessIdRequest'
      responses:
        '200':
          description: Business ID generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateBusinessIdResponse'
        '400':
          description: Invalid entity type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
  # 内部事件 API
  /api/v1/internal/corehr/employee-events/phone-number-update:
    post:
      summary: Create a phone number update event
      operationId: postPhoneNumberUpdateEvent
      tags:
        - CoreHR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhoneNumberUpdateEventRequest'
      responses:
        '202':
          description: Event accepted for processing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneralResponse'

components:
  schemas:
    InterpretRequest:
      type: object
      properties:
        query:
          type: string
          example: "update my phone number to 13800138000"
        user_id:
          type: string
          format: uuid
          example: "a4c2f6d8-2b1a-4c8d-9b7e-0e1f7a2d8c3b"

    # 员工相关模型 - 业务ID系统
    Employee:
      type: object
      properties:
        # 业务ID (主要标识)
        id:
          type: string
          description: "Business ID - string format number (1-99999999)"
          pattern: '^[1-9][0-9]{0,7}$'
          example: "1"
        # 系统UUID (仅当请求时包含)
        uuid:
          type: string
          format: uuid
          description: "System UUID - for internal integration"
          example: "e60891dc-7d20-444b-9002-22419238d499"
        # 业务字段
        person_name:
          type: string
          description: "员工姓名"
          example: "张三"
        email:
          type: string
          format: email
          example: "zhangsan@company.com"
        phone_number:
          type: string
          nullable: true
          example: "13800138000"
        hire_date:
          type: string
          format: date
          example: "2020-01-15"
        # 关联字段 (业务ID)
        position_id:
          type: string
          description: "Position business ID"
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          example: "1000000"
        organization_id:
          type: string
          description: "Organization business ID"
          pattern: '^[1-9][0-9]{5}$'
          nullable: true
          example: "100000"
        manager_id:
          type: string
          description: "Manager business ID"
          pattern: '^[1-9][0-9]{0,7}$'
          nullable: true
          example: "2"
        # 状态字段
        status:
          type: string
          enum: [active, inactive, terminated]
          default: active
        # 系统字段
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - person_name
        - email
        - hire_date

    CreateEmployeeRequest:
      type: object
      properties:
        person_name:
          type: string
          description: "员工姓名"
          example: "张三"
        email:
          type: string
          format: email
          example: "zhangsan@company.com"
        phone_number:
          type: string
          nullable: true
          example: "13800138000"
        hire_date:
          type: string
          format: date
          example: "2020-01-15"
        # 关联字段 (使用业务ID)
        position_id:
          type: string
          description: "Position business ID"
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
          example: "1000000"
        organization_id:
          type: string
          description: "Organization business ID"
          pattern: '^[1-9][0-9]{5}$'
          nullable: true
          example: "100000"
        manager_id:
          type: string
          description: "Manager business ID"
          pattern: '^[1-9][0-9]{0,7}$'
          nullable: true
          example: "2"
      required:
        - person_name
        - email
        - hire_date

    UpdateEmployeeRequest:
      type: object
      properties:
        person_name:
          type: string
          description: "员工姓名"
        email:
          type: string
          format: email
        phone_number:
          type: string
          nullable: true
        position_id:
          type: string
          description: "Position business ID"
          pattern: '^[1-9][0-9]{6}$'
          nullable: true
        organization_id:
          type: string
          description: "Organization business ID"
          pattern: '^[1-9][0-9]{5}$'
          nullable: true
        manager_id:
          type: string
          description: "Manager business ID"
          pattern: '^[1-9][0-9]{0,7}$'
          nullable: true
        status:
          type: string
          enum: [active, inactive, terminated]

    EmployeeListResponse:
      type: object
      properties:
        employees:
          type: array
          items:
            $ref: '#/components/schemas/Employee'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'
        total_count:
          type: integer

    # 组织相关模型 - 业务ID系统
    Organization:
      type: object
      properties:
        # 业务ID (主要标识)
        id:
          type: string
          description: "Business ID - string format number (100000-999999)"
          pattern: '^[1-9][0-9]{5}$'
          example: "100000"
        # 系统UUID (仅当请求时包含)
        uuid:
          type: string
          format: uuid
          description: "System UUID - for internal integration"
          example: "550e8400-e29b-41d4-a716-446655440000"
        # 业务字段
        name:
          type: string
          example: "技术部"
        unit_type:
          type: string
          enum: [COMPANY, DEPARTMENT, TEAM]
          example: "DEPARTMENT"
        description:
          type: string
          nullable: true
          example: "负责技术开发和维护"
        level:
          type: integer
          description: "Organization hierarchy level"
          example: 1
        # 关联字段 (业务ID)
        parent_id:
          type: string
          description: "Parent organization business ID"
          pattern: '^[1-9][0-9]{5}$'
          nullable: true
          example: "100001"
        manager_id:
          type: string
          description: "Manager business ID"
          pattern: '^[1-9][0-9]{0,7}$'
          nullable: true
          example: "1"
        # 计算字段
        employee_count:
          type: integer
          description: "Number of employees in this organization"
          example: 15
        # 状态字段
        status:
          type: string
          enum: [ACTIVE, INACTIVE, PLANNED]
          default: ACTIVE
        # 系统字段
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - unit_type
        - level

    CreateOrganizationRequest:
      type: object
      properties:
        name:
          type: string
          example: "技术部"
        unit_type:
          type: string
          enum: [COMPANY, DEPARTMENT, TEAM]
          example: "DEPARTMENT"
        description:
          type: string
          nullable: true
          example: "负责技术开发和维护"
        parent_id:
          type: string
          description: "Parent organization business ID"
          pattern: '^[1-9][0-9]{5}$'
          nullable: true
          example: "100001"
        manager_id:
          type: string
          description: "Manager business ID"
          pattern: '^[1-9][0-9]{0,7}$'
          nullable: true
          example: "1"
      required:
        - name
        - unit_type

    OrganizationTreeNode:
      type: object
      properties:
        id:
          type: string
          description: "Business ID"
          example: "100000"
        uuid:
          type: string
          format: uuid
          description: "System UUID (if requested)"
        name:
          type: string
          example: "技术部"
        unit_type:
          type: string
          enum: [COMPANY, DEPARTMENT, TEAM]
        level:
          type: integer
        employee_count:
          type: integer
        children:
          type: array
          items:
            $ref: '#/components/schemas/OrganizationTreeNode'

    OrganizationListResponse:
      type: object
      properties:
        organizations:
          type: array
          items:
            $ref: '#/components/schemas/Organization'
        total_count:
          type: integer

    OrganizationTreeResponse:
      type: object
      properties:
        tree:
          type: array
          items:
            $ref: '#/components/schemas/OrganizationTreeNode'

    # 通用模型
    PaginationInfo:
      type: object
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total_pages:
          type: integer
        has_next:
          type: boolean
        has_prev:
          type: boolean

    # 事件相关模型
    PhoneNumberUpdateEventRequest:
      type: object
      properties:
        employee_id:
          type: string
          format: uuid
        new_phone_number:
          type: string
      required:
        - employee_id
        - new_phone_number

    GeneralResponse:
      type: object
      properties:
        message:
          type: string
        event_id:
          type: string
          format: uuid
        data:
          type: object

    # 错误响应模型 - 增强版
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: "Error type"
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: "Human-readable error message"
          example: "Invalid business ID format"
        details:
          type: object
          properties:
            field:
              type: string
              example: "employee_id"
            expected_format:
              type: string
              example: "1-99999999 (string format)"
            provided_value:
              type: string
              example: "invalid_id"
        validation_errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
              code:
                type: string
        timestamp:
          type: string
          format: date-time
        request_id:
          type: string

    # 业务ID管理模型
    GenerateBusinessIdRequest:
      type: object
      properties:
        entity_type:
          type: string
          enum: [employee, organization, position]
          description: "Type of entity to generate ID for"
          example: "employee"
        tenant_id:
          type: string
          format: uuid
          description: "Tenant ID for scoping"
          example: "00000000-0000-0000-0000-000000000000"
      required:
        - entity_type
        - tenant_id

    GenerateBusinessIdResponse:
      type: object
      properties:
        business_id:
          type: string
          description: "Generated business ID"
          example: "1"
        entity_type:
          type: string
          example: "employee"
        generated_at:
          type: string
          format: date-time
        id_ranges:
          type: object
          properties:
            employee:
              type: string
              example: "1-99999999"
            organization:
              type: string
              example: "100000-999999"
            position:
              type: string
              example: "1000000-9999999"
          description: "Available ID ranges for each entity type"