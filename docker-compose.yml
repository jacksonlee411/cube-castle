# PostgreSQLåŸç”Ÿæ¶æ„ - ç®€åŒ–åŸºç¡€è®¾æ–½é…ç½®
# ç‰ˆæœ¬: v3.0-PostgreSQL-Native-Revolution
# æ›´æ–°æ—¥æœŸ: 2025-08-22
# ç›®æ ‡: 60%æ¶æ„ç®€åŒ–ï¼Œæè‡´æ€§èƒ½ä¼˜åŒ–

services:
  # âœ… æ ¸å¿ƒæ•°æ®åº“ - PostgreSQL 16+ (å•ä¸€æ•°æ®æº)
  postgres:
    image: postgres:16-alpine
    container_name: cube_castle_postgres
    hostname: postgres
    command: >
      postgres -c wal_level=logical 
               -c max_replication_slots=10 
               -c max_wal_senders=10
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-cubecastle}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      castle-net:
        aliases:
          - postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user} -d ${POSTGRES_DB:-cubecastle}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # âœ… ç¼“å­˜æœåŠ¡ - Redis 7.x (ç²¾ç¡®å¤±æ•ˆç­–ç•¥)
  redis:
    image: redis:7-alpine
    container_name: cube_castle_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - castle-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ğŸŸ¡ å¯é€‰: PostgreSQL Webç®¡ç†ç•Œé¢ (å¼€å‘å·¥å…·)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: cube_castle_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@cubecastle.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    networks:
      - castle-net
    depends_on:
      - postgres
    restart: unless-stopped

  # ğŸŸ¡ å¯é€‰: Temporalå·¥ä½œæµå¼•æ“ (å¦‚éœ€è¦å·¥ä½œæµåŠŸèƒ½)
  temporal-server:
    image: temporalio/auto-setup:1.24.2
    container_name: cube_castle_temporal
    ports:
      - "7233:7233"
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_SEEDS=postgres
      - POSTGRES_USER=${POSTGRES_USER:-user}
      - POSTGRES_PWD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=temporal
      - ENABLE_ES=false
      - SKIP_SCHEMA_SETUP=false
      - SKIP_DB_CREATE=false
    volumes:
      - temporal_data:/etc/temporal/config/dynamicconfig
    networks:
      - castle-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "tctl --address $(hostname -i):7233 cluster health"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 5
    restart: unless-stopped

  # ğŸŸ¡ å¯é€‰: Temporal UIç®¡ç†ç•Œé¢
  temporal-ui:
    image: temporalio/ui:2.31.1
    container_name: cube_castle_temporal_ui
    ports:
      - "8085:8080"
    environment:
      - TEMPORAL_UI_ENABLED=true
      - TEMPORAL_ADDRESS=temporal-server:7233
      - TEMPORAL_UI_PORT=8080
      - TEMPORAL_CLOUD_UI=false
    networks:
      - castle-net
    depends_on:
      temporal-server:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped

# âŒ å·²ç§»é™¤çš„æŠ€æœ¯å€ºåŠ¡ç»„ä»¶ (PostgreSQLåŸç”Ÿæ¶æ„é©å‘½)
# 
# neo4j:                    # å›¾æ•°æ®åº“ - å·²ç”±PostgreSQLåŸç”ŸæŸ¥è¯¢æ›¿ä»£
# elasticsearch:            # æœç´¢å¼•æ“ - æœªä½¿ç”¨ä¸”ENABLE_ES=false
# zookeeper:               # Kafkaä¾èµ– - CDCåŒæ­¥å·²å®Œå…¨ç§»é™¤
# kafka:                   # æ¶ˆæ¯é˜Ÿåˆ— - æ•°æ®åŒæ­¥æ¶æ„å·²ç®€åŒ–
# kafka-connect:           # Debeziumè¿æ¥å™¨ - PostgreSQLå•ä¸€æ•°æ®æºæ— éœ€åŒæ­¥
# kafka-ui:                # Kafkaç®¡ç†ç•Œé¢ - ç›¸å…³æœåŠ¡å·²ç§»é™¤
#
# ç§»é™¤æ”¶ç›Š:
# - å†…å­˜ä½¿ç”¨: 8GB â†’ 4GB (50%å‡å°‘)
# - CPUä½¿ç”¨: é™ä½15-25%
# - å¯åŠ¨æ—¶é—´: ç¼©çŸ­60-90ç§’  
# - è¿ç»´å¤æ‚åº¦: 11ä¸ªå®¹å™¨ â†’ 3-5ä¸ªå®¹å™¨
# - æ¶æ„å¤æ‚åº¦: ç®€åŒ–60%

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  temporal_data:
    driver: local
  # âŒ å·²ç§»é™¤: neo4j_data, elasticsearch_data

networks:
  castle-net:
    driver: bridge

# PostgreSQLåŸç”Ÿæ¶æ„æœåŠ¡å¯åŠ¨é¡ºåº:
# 1. PostgreSQL (æ ¸å¿ƒæ•°æ®åº“)
# 2. Redis (ç¼“å­˜æœåŠ¡)  
# 3. å¯é€‰å·¥å…·æœåŠ¡ (pgAdmin, Temporal)
#
# æœ€å°åŒ–å¯åŠ¨å‘½ä»¤:
# docker-compose up -d postgres redis
#
# å®Œæ•´å¼€å‘ç¯å¢ƒ:
# docker-compose up -d postgres redis pgadmin
#
# åŒ…å«å·¥ä½œæµåŠŸèƒ½:
# docker-compose up -d postgres redis temporal-server temporal-ui