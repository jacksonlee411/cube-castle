# API设计原则与标准

**版本**: v1.0  
**创建日期**: 2025-08-04  
**适用范围**: Cube Castle项目所有API  
**状态**: 标准实施中

## 🎯 总体原则

### 1. 一致性原则
- 所有API遵循相同的设计模式
- 统一的命名约定和数据格式
- 标准化的错误处理和响应结构

### 2. 简洁性原则
- API设计简单直观，易于理解和使用
- 避免不必要的复杂性和冗余
- 优先选择简单有效的解决方案

### 3. 可扩展性原则
- 设计支持未来功能扩展
- 向后兼容性保证
- 模块化和松耦合架构

### 4. 性能优先原则
- 响应时间和吞吐量优化
- 合理的缓存策略
- 资源使用效率最大化

## 🏗️ RESTful设计标准

### HTTP方法使用规范
```yaml
GET:    查询资源，无副作用，幂等
POST:   创建资源，有副作用，非幂等
PUT:    完整更新资源，有副作用，幂等
PATCH:  部分更新资源，有副作用，幂等
DELETE: 删除资源，有副作用，幂等
```

### 资源路径设计
```yaml
正确设计:
  - /api/v1/positions           # 职位集合
  - /api/v1/positions/{id}      # 特定职位
  - /api/v1/positions/{id}/applications  # 职位的应聘记录

错误设计:
  - /api/v1/getPositions        # 动词不应出现在路径中
  - /api/v1/position            # 应使用复数形式
  - /api/v1/positions-list      # 避免冗余描述
```

### HTTP状态码标准
```yaml
成功响应:
  200: OK - 成功获取资源
  201: Created - 成功创建资源
  204: No Content - 成功执行但无返回内容

客户端错误:
  400: Bad Request - 请求参数错误
  401: Unauthorized - 未认证
  403: Forbidden - 权限不足
  404: Not Found - 资源不存在
  409: Conflict - 资源冲突
  422: Unprocessable Entity - 数据验证失败

服务器错误:
  500: Internal Server Error - 服务器内部错误
  502: Bad Gateway - 网关错误
  503: Service Unavailable - 服务不可用
```

## 📊 数据格式标准

### 请求格式
```json
// POST /api/v1/positions
{
  "position_type": "REGULAR",
  "job_profile_id": "uuid",
  "department_id": "uuid",
  "manager_position_id": "uuid",
  "status": "OPEN",
  "budgeted_fte": 1.0,
  "details": {
    "title": "高级软件工程师",
    "description": "负责核心业务系统开发"
  }
}
```

### 响应格式
```json
// 单个资源响应
{
  "id": "uuid",
  "tenant_id": "uuid",
  "position_type": "REGULAR",
  "job_profile_id": "uuid",
  "department_id": "uuid",
  "manager_position_id": "uuid",
  "status": "OPEN",
  "budgeted_fte": 1.0,
  "details": {},
  "created_at": "2025-08-04T00:00:00Z",
  "updated_at": "2025-08-04T00:00:00Z"
}

// 集合资源响应
{
  "data": [
    // 资源数组
  ],
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 150,
    "total_pages": 3
  }
}

// 错误响应
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": {
      "field": "position_type",
      "value": null,
      "constraint": "required"
    }
  }
}
```

### 字段命名约定
```yaml
风格: snake_case (后端) / camelCase (前端)
时间: ISO 8601格式 (2025-08-04T00:00:00Z)
布尔值: true/false
枚举: 大写字母 (ACTIVE, INACTIVE)
标识符字段: 见标识符命名标准
```

### 标识符命名标准 ⭐
```yaml
实体编码位数分配:
  组织单元: 7位数字 (1000000-9999999)
  员工: 8位数字 (10000000-99999999)  
  职位: 7位数字 (1000000-9999999)
  作业档案: 5位数字 (10000-99999)

主要标识符:
  - 使用 "code" 作为对外标识符字段名
  - 示例: "code": "1000001" (组织单元)

关系引用:
  - 使用 "{entity}_code" 格式
  - 示例: "parent_code": "1000000" (组织关系)
  - 示例: "manager_code": "10000001" (员工关系)

内部标识符:
  - UUID仅作系统内部使用，不对外暴露
  - 数据库主键继续使用UUID
  - API层面完全隐藏UUID

设计原则:
  - 业务语义清晰: "编码"比"ID"更直观
  - 用户认知简单: 只需理解一种标识符
  - 独立扩展: 各实体编码位数独立设计
  - 行业标准兼容: 符合企业级HR系统惯例
```

## 🔒 安全设计标准

### 认证和授权
```yaml
认证方式:
  - JWT Bearer Token
  - Header: "Authorization: Bearer <token>"

授权控制:
  - 基于角色的访问控制 (RBAC)
  - 资源级权限检查
  - 租户隔离

安全头部:
  - X-Tenant-ID: 租户标识
  - X-Request-ID: 请求追踪ID
  - X-API-Version: API版本
```

### 数据验证
```yaml
输入验证:
  - 所有输入参数必须验证
  - 使用白名单验证方法
  - 防范SQL注入和XSS攻击

输出过滤:
  - 敏感信息过滤
  - 数据脱敏处理
  - 最小权限原则
```

## ⚡ 性能设计标准

### 响应时间目标
```yaml
API类型: 目标响应时间
简单查询: < 100ms
复杂查询: < 500ms
数据创建: < 200ms
数据更新: < 200ms
数据删除: < 100ms
```

### 缓存策略
```yaml
缓存层级:
  - 应用层缓存: 5-30分钟
  - 数据库查询缓存: 1-5分钟
  - CDN缓存: 24小时

缓存策略:
  - 读多写少: 长期缓存
  - 实时性要求高: 短期缓存
  - 静态数据: 永久缓存
```

### 分页设计
```yaml
默认参数:
  - page_size: 50 (默认)
  - max_page_size: 100 (最大)
  - page: 1 (起始页)

响应格式:
  data: [] # 数据数组
  pagination:
    page: 当前页码
    page_size: 每页大小
    total: 总记录数
    total_pages: 总页数
```

## 🔄 版本管理策略

### 版本化方案
```yaml
URL版本化: /api/v1/positions (推荐)
Header版本化: X-API-Version: v1 (备选)
参数版本化: ?version=v1 (不推荐)
```

### 版本兼容性
```yaml
向后兼容原则:
  - 新增字段: 兼容
  - 删除字段: 需要版本升级
  - 修改字段类型: 需要版本升级
  - 修改字段含义: 需要版本升级

弃用策略:
  - 提前3个月通知
  - 提供迁移指南
  - 支持并行版本
```

## 🧪 测试标准

### API测试覆盖率
```yaml
单元测试: ≥90%
集成测试: ≥80%
端到端测试: 核心场景100%
性能测试: 所有API端点
安全测试: 所有API端点
```

### 测试用例设计
```yaml
正常场景:
  - 有效数据测试
  - 边界值测试
  - 典型用例测试

异常场景:
  - 无效参数测试
  - 权限验证测试
  - 资源不存在测试
  - 并发访问测试

性能场景:
  - 负载测试
  - 压力测试
  - 并发测试
```

## 📚 文档标准

### API文档要求
```yaml
必须包含:
  - 完整的端点描述
  - 请求/响应示例
  - 参数说明和验证规则
  - 错误码和处理说明
  - 认证和权限要求

可选包含:
  - SDK和代码示例
  - 集成指南
  - 最佳实践
  - 常见问题解答
```

### OpenAPI规范
```yaml
格式: OpenAPI 3.0+
工具: Swagger UI
生成: 自动从代码注解生成
维护: 与代码同步更新
```

## 🔍 监控和日志

### API监控指标
```yaml
业务指标:
  - 请求量 (QPS)
  - 响应时间 (P50, P95, P99)
  - 错误率
  - 可用性 (SLA)

技术指标:
  - CPU使用率
  - 内存使用率
  - 数据库连接数
  - 缓存命中率
```

### 日志规范
```yaml
日志级别:
  ERROR: 系统错误，需要立即处理
  WARN: 警告信息，需要关注
  INFO: 一般信息，正常业务流程
  DEBUG: 调试信息，开发环境使用

日志格式:
  timestamp: ISO 8601格式
  level: 日志级别
  message: 日志消息
  context: 上下文信息 (request_id, user_id, tenant_id)
```

## 🚨 错误处理标准

### 错误分类
```yaml
客户端错误 (4xx):
  - 请求格式错误
  - 参数验证失败
  - 权限不足
  - 资源不存在

服务端错误 (5xx):
  - 系统内部错误
  - 数据库连接失败
  - 第三方服务不可用
  - 超时错误
```

### 错误响应格式
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "用户友好的错误描述",
    "details": {
      "field": "出错的字段",
      "value": "错误的值",
      "constraint": "约束类型"
    },
    "trace_id": "请求追踪ID"
  }
}
```

## 📋 API设计检查清单

### 设计阶段
- [ ] 遵循RESTful设计原则
- [ ] 使用标准HTTP方法和状态码
- [ ] 设计合理的资源路径
- [ ] 定义清晰的数据模型
- [ ] 考虑向后兼容性

### 实现阶段
- [ ] 实现完整的输入验证
- [ ] 添加适当的错误处理
- [ ] 实施安全认证和授权
- [ ] 优化性能和响应时间
- [ ] 添加缓存策略

### 测试阶段
- [ ] 编写全面的单元测试
- [ ] 执行集成测试
- [ ] 进行性能测试
- [ ] 实施安全测试
- [ ] 验证文档准确性

### 发布阶段
- [ ] 更新API文档
- [ ] 配置监控和告警
- [ ] 准备回滚计划
- [ ] 通知相关团队
- [ ] 收集使用反馈

## 🔄 持续改进

### 定期评估
```yaml
评估频率: 每季度
评估内容:
  - API使用情况分析
  - 性能指标评估
  - 用户反馈收集
  - 安全性审查

改进措施:
  - 性能优化
  - 功能增强
  - 文档完善
  - 工具升级
```

### 团队培训
```yaml
新员工培训:
  - API设计原则
  - 开发最佳实践
  - 工具使用指南
  - 代码审查标准

持续学习:
  - 技术分享会
  - 外部培训
  - 行业最佳实践
  - 工具和技术更新
```

---

**制定者**: 系统架构师  
**审核者**: 技术委员会  
**生效日期**: 2025-08-04  
**下次审查**: 2025-11-04