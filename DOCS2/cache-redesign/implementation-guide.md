# æ–°ä¸€ä»£ç¼“å­˜æ¶æ„å®æ–½æŒ‡å—

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–°ä¸€ä»£ç¼“å­˜ç®¡ç†æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   å‰ç«¯åº”ç”¨   â”‚â”€â”€â”€â–¶â”‚   ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨   â”‚â”€â”€â”€â–¶â”‚   Neo4jæ•°æ®åº“   â”‚ â”‚
â”‚  â”‚  (Client)   â”‚    â”‚  (Cache Manager)  â”‚    â”‚   (L3 Query)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  L1æœ¬åœ°ç¼“å­˜  â”‚â—€â”€â”€â”€â”¤    ç¼“å­˜åˆ†å±‚æ¶æ„    â”œâ”€â”€â”€â–¶â”‚   L2åˆ†å¸ƒå¼ç¼“å­˜   â”‚ â”‚
â”‚  â”‚ (In-Memory) â”‚    â”‚   (Multi-Layer)   â”‚    â”‚    (Redis)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â–²                                    â”‚
â”‚                            â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CDCäº‹ä»¶    â”‚â”€â”€â”€â–¶â”‚   å†™æ—¶æ›´æ–°æœåŠ¡    â”‚â”€â”€â”€â–¶â”‚   æ™ºèƒ½ç¼“å­˜æ›´æ–°   â”‚ â”‚
â”‚  â”‚  (Debezium) â”‚    â”‚ (Write-Through)   â”‚    â”‚ (Smart Update) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒä¼˜åŠ¿

### 1. **æ€§èƒ½æå‡**
- **L1ç¼“å­˜å‘½ä¸­**: å“åº”æ—¶é—´ < 1ms
- **L2ç¼“å­˜å‘½ä¸­**: å“åº”æ—¶é—´ < 10ms  
- **L3æ•°æ®æºæŸ¥è¯¢**: å“åº”æ—¶é—´ < 100ms
- **æ™ºèƒ½é¢„çƒ­**: ç¼“å­˜é¢„å…ˆå¡«å……çƒ­ç‚¹æ•°æ®

### 2. **ä¸€è‡´æ€§ä¿éšœ**
- **å†™æ—¶æ›´æ–°**: CDCäº‹ä»¶è§¦å‘ç¼“å­˜åŒæ­¥æ›´æ–°ï¼Œè€Œéç®€å•å¤±æ•ˆ
- **æ™ºèƒ½åˆ—è¡¨æ›´æ–°**: é«˜æ•ˆæ›´æ–°åˆ—è¡¨ç¼“å­˜ï¼Œé¿å…å…¨é‡é‡æŸ¥
- **ç‰ˆæœ¬æ§åˆ¶**: ç¼“å­˜æ¡ç›®åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼Œé˜²æ­¢æ•°æ®å›æ»š
- **ä¸€è‡´æ€§æ£€æŸ¥**: å®šæœŸéªŒè¯å¤šå±‚ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§

### 3. **å¯è§‚æµ‹æ€§**
- **å®æ—¶ç›‘æ§**: L1/L2ç¼“å­˜å‘½ä¸­ç‡ã€å“åº”æ—¶é—´ç»Ÿè®¡
- **å¥åº·æ£€æŸ¥**: ç¼“å­˜æœåŠ¡çŠ¶æ€ã€è¿æ¥æ€§æ£€æŸ¥
- **ä¸šåŠ¡æŒ‡æ ‡**: ç¼“å­˜æ›´æ–°é¢‘ç‡ã€æ•°æ®æ–°é²œåº¦æŒ‡æ ‡

## å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„éƒ¨ç½²

#### 1. åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
```bash
mkdir -p /home/shangmeilin/cube-castle/internal/cache
mkdir -p /home/shangmeilin/cube-castle/cmd/nextgen-cache-service
```

#### 2. éƒ¨ç½²æ–°ç¼“å­˜æœåŠ¡
```bash
cd /home/shangmeilin/cube-castle

# æ„å»ºæ–°ä¸€ä»£ç¼“å­˜æœåŠ¡
go build -o bin/nextgen-cache-service ./cmd/nextgen-cache-service/

# å¯åŠ¨æœåŠ¡ (ç«¯å£8088)
./bin/nextgen-cache-service
```

#### 3. éªŒè¯æœåŠ¡å¯åŠ¨
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8088/health

# ç¼“å­˜ç»Ÿè®¡
curl http://localhost:8088/api/v2/cache/stats

# æµ‹è¯•æŸ¥è¯¢
curl "http://localhost:8088/api/v2/organizations?first=10"
```

### ç¬¬äºŒé˜¶æ®µï¼šæ¸è¿›å¼è¿ç§»

#### 1. å¹¶è¡Œè¿è¡Œé˜¶æ®µ
```bash
# åŸç¼“å­˜æœåŠ¡ç»§ç»­è¿è¡Œ (ç«¯å£8090)
cd cmd/organization-query-service-unified && go run main.go &

# æ–°ç¼“å­˜æœåŠ¡åŒæ—¶è¿è¡Œ (ç«¯å£8088)  
cd cmd/nextgen-cache-service && go run main.go &

# A/Bæµ‹è¯•å¯¹æ¯”
curl http://localhost:8090/graphql  # åŸæœåŠ¡
curl http://localhost:8088/api/v2/organizations  # æ–°æœåŠ¡
```

#### 2. å‰ç«¯é€‚é…
```typescript
// å‰ç«¯é€æ­¥åˆ‡æ¢åˆ°æ–°API
const USE_NEXTGEN_CACHE = process.env.REACT_APP_USE_NEXTGEN_CACHE === 'true'

const apiEndpoint = USE_NEXTGEN_CACHE 
  ? 'http://localhost:8088/api/v2'
  : 'http://localhost:8090'

// å¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶åˆ‡æ¢
```

#### 3. æ€§èƒ½å¯¹æ¯”éªŒè¯
```bash
# å¯¹æ¯”æµ‹è¯•è„šæœ¬
#!/bin/bash
echo "=== åŸç¼“å­˜æœåŠ¡æ€§èƒ½æµ‹è¯• ==="
for i in {1..100}; do
  curl -w "%{time_total}\n" -s -o /dev/null "http://localhost:8090/graphql" \
    -H "Content-Type: application/json" \
    -d '{"query":"query { organizations { code name } }"}'
done | awk '{sum+=$1; n++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/n*1000, "ms"}'

echo "=== æ–°ä¸€ä»£ç¼“å­˜æœåŠ¡æ€§èƒ½æµ‹è¯• ==="
for i in {1..100}; do
  curl -w "%{time_total}\n" -s -o /dev/null "http://localhost:8088/api/v2/organizations"
done | awk '{sum+=$1; n++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/n*1000, "ms"}'
```

### ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå…¨åˆ‡æ¢

#### 1. æ›´æ–°CLAUDE.mdé…ç½®
```markdown
# ç¼“å­˜æœåŠ¡ç«¯å£æ›´æ–°
- **æ–°ä¸€ä»£ç¼“å­˜æœåŠ¡**: http://localhost:8088 - ä¸‰å±‚ç¼“å­˜æ¶æ„ï¼Œå†™æ—¶æ›´æ–°
- **åŸæŸ¥è¯¢æœåŠ¡**: http://localhost:8090 - å·²è¿ç§»è‡³æ–°æ¶æ„ (å¯é€‰ä¿ç•™)
```

#### 2. æ›´æ–°å¯åŠ¨è„šæœ¬
```bash
# scripts/start-nextgen-cqrs.sh
#!/bin/bash
echo "ğŸš€ å¯åŠ¨æ–°ä¸€ä»£CQRSæ¶æ„..."

# å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose up -d

# å¯åŠ¨æ ¸å¿ƒæœåŠ¡
cd cmd/organization-command-service && go run main.go &
cd cmd/nextgen-cache-service && go run main.go &          # æ–°ç¼“å­˜æœåŠ¡
cd cmd/organization-sync-service && go run main.go &

# å¯åŠ¨å‰ç«¯
cd frontend && npm run dev &

echo "âœ… æ–°ä¸€ä»£CQRSæ¶æ„å¯åŠ¨å®Œæˆ"
```

## é…ç½®å‚æ•°

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env.nextgen
REDIS_ADDR=localhost:6379
REDIS_PASSWORD=
KAFKA_BROKERS=localhost:9092
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=password
PORT=8088
WRITE_THROUGH=true
CONSISTENCY_MODE=STRONG
```

### ç¼“å­˜ç­–ç•¥é…ç½®
```go
// internal/cache/config.go
type CacheConfig struct {
    // L1è¿›ç¨‹å†…ç¼“å­˜
    L1TTL:           5 * time.Minute,    // L1ç¼“å­˜å­˜æ´»æ—¶é—´
    L1MaxSize:       2000,               // L1æœ€å¤§æ¡ç›®æ•°
    
    // L2åˆ†å¸ƒå¼ç¼“å­˜  
    L2TTL:           30 * time.Minute,   // L2ç¼“å­˜å­˜æ´»æ—¶é—´
    
    // å†™æ—¶æ›´æ–°ç­–ç•¥
    WriteThrough:    true,               // å¯ç”¨å†™æ—¶æ›´æ–°
    ConsistencyMode: "STRONG",           // å¼ºä¸€è‡´æ€§æ¨¡å¼
    
    // ç¼“å­˜å‘½åç©ºé—´
    Namespace:       "org_v2",           // ç¼“å­˜é”®å‰ç¼€
}
```

## ç›‘æ§ä¸è¿ç»´

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§
```bash
# ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
curl http://localhost:8088/metrics | grep cache_l1_hit_rate

# å“åº”æ—¶é—´ç›‘æ§
curl -w "@curl-format.txt" http://localhost:8088/api/v2/organizations

# ç¼“å­˜å¤§å°ç›‘æ§
curl http://localhost:8088/api/v2/cache/stats | jq '.l1_stats.size'
```

### 2. æ•…éšœæ¢å¤æœºåˆ¶
```bash
# ç¼“å­˜æ•°æ®æŸåæ¢å¤
curl -X DELETE "http://localhost:8088/api/v2/cache/refresh?type=organizations"

# ä¸€è‡´æ€§é—®é¢˜ä¿®å¤
curl http://localhost:8088/api/v2/cache/consistency

# æœåŠ¡é‡å¯æ¢å¤
systemctl restart nextgen-cache-service
```

### 3. æ€§èƒ½è°ƒä¼˜å‚æ•°
```go
// æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
type PerformanceTuning struct {
    L1Size:         2000,     // æ ¹æ®å†…å­˜å®¹é‡è°ƒæ•´
    L2TTL:          "30m",    // æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è°ƒæ•´
    WriteThrough:   true,     // é«˜ä¸€è‡´æ€§è¦æ±‚æ—¶å¯ç”¨
    BatchSize:      100,      // CDCæ‰¹é‡å¤„ç†å¤§å°
    ConsumerThreads: 3,       // CDCæ¶ˆè´¹è€…çº¿ç¨‹æ•°
}
```

## å›æ»šæ–¹æ¡ˆ

### å¿«é€Ÿå›æ»šæ­¥éª¤
```bash
# 1. åœæ­¢æ–°ç¼“å­˜æœåŠ¡
pkill nextgen-cache-service

# 2. æ¢å¤åŸæœåŠ¡ (å¦‚æœå·²åœæ­¢)
cd cmd/organization-query-service-unified && go run main.go &

# 3. å‰ç«¯åˆ‡æ¢å›åŸAPI
export REACT_APP_USE_NEXTGEN_CACHE=false
cd frontend && npm run dev

# 4. éªŒè¯å›æ»šæˆåŠŸ
curl http://localhost:8090/health
```

### æ•°æ®ä¸€è‡´æ€§ä¿è¯
```bash
# å›æ»šå‰æ•°æ®åŒæ­¥æ£€æŸ¥
curl http://localhost:8088/api/v2/cache/consistency

# å¦‚æœ‰ä¸ä¸€è‡´ï¼Œå…ˆåˆ·æ–°ç¼“å­˜å†å›æ»š
curl -X DELETE http://localhost:8088/api/v2/cache/refresh
```

## é¢„æœŸæ”¶ç›Š

### æ€§èƒ½æå‡æŒ‡æ ‡
- **æŸ¥è¯¢å“åº”æ—¶é—´**: ä»100msé™è‡³<10ms (ç¼“å­˜å‘½ä¸­)
- **ç¼“å­˜å‘½ä¸­ç‡**: é¢„æœŸè¾¾åˆ°85%+ (æ™ºèƒ½é¢„çƒ­)
- **ç³»ç»Ÿååé‡**: æå‡5-10å€ (å¤šå±‚ç¼“å­˜)
- **å¼€å‘ä½“éªŒ**: ç¼“å­˜æ›´æ–°å»¶è¿Ÿä»300msé™è‡³å®æ—¶

### è¿ç»´æ”¹å–„
- **æ•…éšœæ’æŸ¥**: ç»Ÿä¸€ç›‘æ§ç•Œé¢ï¼Œå®æ—¶ç¼“å­˜çŠ¶æ€
- **æ‰©å±•æ€§**: ç¼“å­˜å±‚ç‹¬ç«‹æ‰©å±•ï¼Œä¸å½±å“ä¸šåŠ¡é€»è¾‘
- **ä¸€è‡´æ€§**: å¼ºä¸€è‡´æ€§ä¿éšœï¼Œæ¶ˆé™¤æ•°æ®ä¸åŒæ­¥é—®é¢˜
- **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æŒ‡æ ‡ä½“ç³»ï¼Œä¾¿äºæ€§èƒ½è°ƒä¼˜

## é£é™©è¯„ä¼°

### ä¸­ç­‰é£é™©
- **å†…å­˜æ¶ˆè€—å¢åŠ **: L1ç¼“å­˜å ç”¨é¢å¤–å†…å­˜ (~100MB)
- **ä»£ç å¤æ‚åº¦**: ä¸‰å±‚ç¼“å­˜é€»è¾‘æ¯”ç®€å•å¤±æ•ˆå¤æ‚
- **æ•…éšœç‚¹å¢åŠ **: æ–°å¢ç¼“å­˜æœåŠ¡å¯èƒ½æˆä¸ºæ–°çš„æ•…éšœç‚¹

### ä½é£é™©
- **æ•°æ®ä¸€è‡´æ€§**: å†™æ—¶æ›´æ–°æœºåˆ¶é™ä½äº†ä¸ä¸€è‡´é£é™©
- **æ€§èƒ½å›é€€**: ç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®æºæŸ¥è¯¢
- **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰APIæ¥å£ï¼Œæ¸è¿›å¼è¿ç§»

### é£é™©ç¼“è§£æªæ–½
1. **å†…å­˜ç›‘æ§**: è®¾ç½®L1ç¼“å­˜å¤§å°ä¸Šé™ï¼Œè‡ªåŠ¨é©±é€ç­–ç•¥
2. **é™çº§æœºåˆ¶**: ç¼“å­˜æœåŠ¡æ•…éšœæ—¶è‡ªåŠ¨åˆ‡å›åŸæœåŠ¡
3. **ABæµ‹è¯•**: å¹¶è¡Œè¿è¡Œé˜¶æ®µå……åˆ†éªŒè¯ç¨³å®šæ€§
4. **å¿«é€Ÿå›æ»š**: ä¿æŒåŸæœåŠ¡å¯ç”¨ï¼Œç¡®ä¿å¿«é€Ÿæ¢å¤èƒ½åŠ›

## æ€»ç»“

æ–°ä¸€ä»£ç¼“å­˜æ¶æ„é€šè¿‡**ä¸‰å±‚ç¼“å­˜ + å†™æ—¶æ›´æ–°**ç­–ç•¥ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†ç¼“å­˜ä¸åŠæ—¶æ›´æ–°é—®é¢˜ï¼ŒåŒæ—¶å¤§å¹…æå‡äº†ç³»ç»Ÿæ€§èƒ½ã€‚æ•´ä¸ªæ¶æ„è®¾è®¡ç¬¦åˆé¡¹ç›®çš„CQRSåŸåˆ™å’Œ"åŠ¡å®æ€§"ç†å¿µï¼Œæ˜¯ä¸€ä¸ªé•¿æœŸç¨³å¥çš„è§£å†³æ–¹æ¡ˆã€‚

**å»ºè®®ä¼˜å…ˆçº§**ï¼š
1. ğŸ”¥ **ç«‹å³å®æ–½** - åŸºç¡€æ¶æ„æ­å»ºå’Œå¹¶è¡Œæµ‹è¯•
2. ğŸš€ **2å‘¨å†…å®Œæˆ** - æ¸è¿›å¼è¿ç§»å’Œæ€§èƒ½éªŒè¯  
3. ğŸ† **1ä¸ªæœˆç›®æ ‡** - å®Œå…¨åˆ‡æ¢å¹¶ç¨³å®šè¿è¡Œ

è¿™å¥—æ–¹æ¡ˆæ—¢è§£å†³äº†å½“å‰ç¼“å­˜é—®é¢˜ï¼Œåˆä¸ºæœªæ¥çš„æ€§èƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚