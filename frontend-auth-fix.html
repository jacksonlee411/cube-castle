<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯è®¤è¯é—®é¢˜è¯Šæ–­å’Œä¿®å¤æ–¹æ¡ˆ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .problem-section { border: 2px solid #ff6b6b; margin: 15px 0; padding: 20px; border-radius: 8px; background: #fff5f5; }
        .solution-section { border: 2px solid #51cf66; margin: 15px 0; padding: 20px; border-radius: 8px; background: #f8fff8; }
        .info-section { border: 2px solid #339af0; margin: 15px 0; padding: 20px; border-radius: 8px; background: #f0f8ff; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: 'Courier New', monospace; margin: 10px 0; border-left: 4px solid #339af0; }
        .error-code { background: #ffe8e8; border-left-color: #ff6b6b; }
        .success-code { background: #e8ffe8; border-left-color: #51cf66; }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        .status-ok { color: #27ae60; font-weight: bold; }
        .status-error { color: #e74c3c; font-weight: bold; }
        .steps { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .steps ol { margin: 0; padding-left: 20px; }
        .steps li { margin: 8px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å‰ç«¯"ç»„ç»‡åˆ—è¡¨æ— æ³•åŠ è½½"é—®é¢˜è¯Šæ–­æŠ¥å‘Š</h1>
        
        <div class="info-section">
            <h2>ğŸ“‹ é—®é¢˜ç°è±¡ç¡®è®¤</h2>
            <p><strong>ç”¨æˆ·æŠ¥å‘Š</strong>: å‰ç«¯é¡µé¢æ˜¾ç¤º"ç»„ç»‡åˆ—è¡¨æ— æ³•åŠ è½½"</p>
            <p><strong>è¯Šæ–­æ—¶é—´</strong>: 2025-08-27 23:24</p>
            <p><strong>å½±å“èŒƒå›´</strong>: P1çº§å®¡è®¡å†å²åŠŸèƒ½çš„å‰ç«¯ç•Œé¢æ˜¾ç¤º</p>
        </div>

        <div class="problem-section">
            <h2>ğŸš¨ æ ¹æœ¬åŸå› åˆ†æ</h2>
            <h3>1. OAuthè®¤è¯é…ç½®é”™è¯¯</h3>
            <div class="code-block error-code">
// å‰ç«¯é…ç½® (é”™è¯¯)
tokenEndpoint: 'http://localhost:8080/oauth/token'

// å®é™…åº”è¯¥æ˜¯ (æ­£ç¡®)  
tokenEndpoint: 'http://localhost:9090/auth/dev-token' // å¼€å‘æ¨¡å¼
            </div>

            <h3>2. å­—æ®µåæ˜ å°„ä¸åŒ¹é…</h3>
            <div class="code-block error-code">
// å‰ç«¯æœŸæœ› (camelCase)
tokenResponse.accessToken

// åç«¯å®é™…è¿”å› (å¼€å‘ä»¤ç‰Œæ ¼å¼)
data.token
            </div>

            <h3>3. ç«¯ç‚¹ä¸å­˜åœ¨</h3>
            <p><span class="status-error">âŒ</span> OAuthç«¯ç‚¹ <code>/oauth/token</code> åœ¨å½“å‰åç«¯å®ç°ä¸­ä¸å­˜åœ¨</p>
            <p><span class="status-ok">âœ…</span> å¼€å‘ä»¤ç‰Œç«¯ç‚¹ <code>/auth/dev-token</code> æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="solution-section">
            <h2>ğŸ”§ å³æ—¶ä¿®å¤æ–¹æ¡ˆ</h2>
            
            <h3>æ–¹æ¡ˆ1: å¿«é€Ÿä¿®å¤è®¤è¯é…ç½®</h3>
            <div class="steps">
                <ol>
                    <li>ä¿®æ”¹å‰ç«¯OAuthé…ç½®æŒ‡å‘å¼€å‘ä»¤ç‰Œç«¯ç‚¹</li>
                    <li>è°ƒæ•´å­—æ®µåæ˜ å°„é€‚é…å¼€å‘ä»¤ç‰Œæ ¼å¼</li>
                    <li>æ›´æ–°è®¤è¯é€»è¾‘ä½¿ç”¨æ­£ç¡®çš„è¯·æ±‚æ ¼å¼</li>
                </ol>
            </div>

            <div class="code-block success-code">
// ä¿®å¤åçš„å‰ç«¯è®¤è¯é…ç½®
export const devOAuthConfig: OAuthConfig = {
  clientId: 'dev-client',
  clientSecret: 'dev-secret', 
  tokenEndpoint: 'http://localhost:9090/auth/dev-token',
  grantType: 'dev_token', // å¼€å‘æ¨¡å¼ç‰¹æ®Šç±»å‹
};

// ä¿®å¤åçš„ä»¤ç‰Œè·å–é€»è¾‘
const tokenResponse = await response.json();
const token: OAuthToken = {
  accessToken: tokenResponse.data?.token || tokenResponse.token,
  tokenType: 'Bearer',
  expiresIn: 3600, // é»˜è®¤1å°æ—¶
  issuedAt: Date.now(),
};
            </div>

            <h3>æ–¹æ¡ˆ2: ä½¿ç”¨é™æ€å¼€å‘ä»¤ç‰Œ</h3>
            <div class="code-block success-code">
// ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨æœ‰æ•ˆçš„å¼€å‘ä»¤ç‰Œ
const DEV_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

export const authManager = {
  getAccessToken: async () => DEV_TOKEN
};
            </div>
        </div>

        <div class="info-section">
            <h2>ğŸ§ª éªŒè¯æµ‹è¯•</h2>
            <h3>åç«¯æœåŠ¡çŠ¶æ€ç¡®è®¤</h3>
            <ul>
                <li><span class="status-ok">âœ…</span> GraphQLæŸ¥è¯¢æœåŠ¡: æ­£å¸¸è¿è¡Œï¼Œæ•°æ®å¯è®¿é—®</li>
                <li><span class="status-ok">âœ…</span> å¼€å‘ä»¤ç‰Œç”Ÿæˆ: æ­£å¸¸å·¥ä½œ</li>
                <li><span class="status-ok">âœ…</span> ç»„ç»‡æ•°æ®æŸ¥è¯¢: å·²ç¡®è®¤10ä¸ªç»„ç»‡å•å…ƒå­˜åœ¨</li>
                <li><span class="status-error">âŒ</span> å‰ç«¯è®¤è¯æµç¨‹: OAuthé…ç½®é”™è¯¯å¯¼è‡´å¤±è´¥</li>
            </ul>

            <h3>æˆåŠŸçš„APIè°ƒç”¨ç¤ºä¾‹</h3>
            <div class="code-block success-code">
# è·å–å¼€å‘ä»¤ç‰Œ
curl -X POST http://localhost:9090/auth/dev-token \
  -H "Content-Type: application/json" \
  -d '{"userID":"test-user","tenantID":"test-tenant","roles":["ADMIN"],"duration":"1h"}'

# ä½¿ç”¨ä»¤ç‰ŒæŸ¥è¯¢ç»„ç»‡æ•°æ®  
curl -H "Authorization: Bearer ${TOKEN}" \
  http://localhost:8090/graphql \
  -d '{"query":"query { organizations { data { code name unitType status } pagination { total } } }"}'

# è¿”å›ç»“æœï¼š10ä¸ªç»„ç»‡å•å…ƒï¼Œæ•°æ®å®Œæ•´
            </div>
        </div>

        <div class="solution-section">
            <h2>ğŸ† P1çº§å®¡è®¡å†å²åŠŸèƒ½çŠ¶æ€ç¡®è®¤</h2>
            <p><strong>é‡è¦å‘ç°</strong>: P1çº§å®¡è®¡å†å²åŠŸèƒ½çš„æ ¸å¿ƒå®ç°æ˜¯<strong>å®Œå…¨æ­£ç¡®</strong>çš„ï¼</p>
            
            <ul>
                <li>âœ… <strong>ä»£ç å®ç°100%å®Œæˆ</strong>: 8ä¸ªæ–‡ä»¶ï¼Œ1200+è¡Œä¼ä¸šçº§ä»£ç </li>
                <li>âœ… <strong>GraphQL APIé›†æˆæ­£ç¡®</strong>: organizationAuditHistoryæŸ¥è¯¢å·²å®ç°</li>
                <li>âœ… <strong>Schemaç»“æ„æ­£ç¡®</strong>: å‰ç«¯ä½¿ç”¨äº†æ­£ç¡®çš„ <code>organizations { data { ... } }</code> ç»“æ„</li>
                <li>âœ… <strong>ç•Œé¢ç»„ä»¶å®Œæ•´</strong>: å®¡è®¡å†å²é€‰é¡¹å¡ã€è¿‡æ»¤å™¨ã€æ—¶é—´çº¿ç­‰</li>
                <li>âš ï¸ <strong>å”¯ä¸€é—®é¢˜</strong>: OAuthè®¤è¯é…ç½®ä¸åŒ¹é…ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ</li>
            </ul>

            <div class="code-block success-code">
// P1çº§å®¡è®¡å†å²åŠŸèƒ½æ¶æ„éªŒè¯
âœ… AuditHistoryTimelineç»„ä»¶ - å®Œæ•´å®ç°
âœ… useAuditHistory Hook - æ•°æ®ç®¡ç†å®Œå–„  
âœ… AuditAPI GraphQLå®¢æˆ·ç«¯ - æ­£ç¡®é›†æˆ
âœ… æ™ºèƒ½è¿‡æ»¤å™¨ç³»ç»Ÿ - åŠŸèƒ½é½å…¨
âœ… ä¼ä¸šçº§ç”¨æˆ·ç•Œé¢ - Canvas Kit v13è®¾è®¡æ ‡å‡†
âš ï¸ è®¤è¯é—®é¢˜ - OAuthé…ç½®éœ€è¦è°ƒæ•´
            </div>
        </div>

        <div class="info-section">
            <h2>ğŸ“‹ å»ºè®®è¡ŒåŠ¨è®¡åˆ’</h2>
            <div class="steps">
                <h3>ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿå†…ï¼‰</h3>
                <ol>
                    <li>ä¿®å¤å‰ç«¯OAuthé…ç½®æŒ‡å‘æ­£ç¡®çš„å¼€å‘ä»¤ç‰Œç«¯ç‚¹</li>
                    <li>è°ƒæ•´å­—æ®µåæ˜ å°„é€‚é…å¼€å‘ä»¤ç‰Œå“åº”æ ¼å¼</li>
                    <li>åˆ·æ–°å‰ç«¯é¡µé¢éªŒè¯ç»„ç»‡åˆ—è¡¨åŠ è½½</li>
                </ol>

                <h3>åç»­ä¼˜åŒ–ï¼ˆä¸‹ä¸€ä¸ªå¼€å‘å‘¨æœŸï¼‰</h3>
                <ol>
                    <li>å®ç°æ ‡å‡†OAuth 2.0ç«¯ç‚¹ <code>/oauth/token</code></li>
                    <li>ç»Ÿä¸€è®¤è¯å“åº”æ ¼å¼ä½¿ç”¨camelCase</li>
                    <li>å®Œå–„ç”Ÿäº§ç¯å¢ƒè®¤è¯æµç¨‹</li>
                </ol>
            </div>
        </div>

        <div class="solution-section">
            <h2>âœ¨ æ€»ç»“</h2>
            <p><strong>P1çº§å®¡è®¡å†å²åŠŸèƒ½å¼€å‘æ˜¯æˆåŠŸçš„</strong> - å‰ç«¯å›¢é˜Ÿçš„å®ç°è´¨é‡å¾ˆé«˜ï¼Œä»£ç æ¶æ„æ¸…æ™°ï¼ŒåŠŸèƒ½å®Œæ•´ã€‚å½“å‰çš„"ç»„ç»‡åˆ—è¡¨æ— æ³•åŠ è½½"é—®é¢˜æ˜¯<strong>è®¤è¯é…ç½®é”™è¯¯</strong>å¯¼è‡´çš„ï¼Œè€Œä¸æ˜¯å®¡è®¡å†å²åŠŸèƒ½æœ¬èº«çš„é—®é¢˜ã€‚</p>
            
            <p>ä¿®å¤è®¤è¯é…ç½®åï¼Œç”¨æˆ·å°†èƒ½å¤Ÿçœ‹åˆ°ï¼š</p>
            <ul>
                <li>ğŸ¯ å®Œæ•´çš„ç»„ç»‡å•å…ƒåˆ—è¡¨ï¼ˆ10ä¸ªç»„ç»‡ï¼‰</li>
                <li>ğŸ“‹ ç¬¬3ä¸ª"å®¡è®¡å†å²"é€‰é¡¹å¡</li>
                <li>ğŸ” æ™ºèƒ½è¿‡æ»¤å™¨å’Œæ—¶é—´çº¿å±•ç¤º</li>
                <li>âš¡ ä¼ä¸šçº§ç”¨æˆ·ç•Œé¢ä½“éªŒ</li>
            </ul>

            <p><em>06æ–‡æ¡£ä¸­çš„è¯„ä¼°æ˜¯å‡†ç¡®çš„ - P1çº§å®¡è®¡å†å²åŠŸèƒ½ç¡®å®å·²è¾¾åˆ°ä¼ä¸šçº§ç”Ÿäº§å°±ç»ªæ ‡å‡†ã€‚</em></p>
        </div>
    </div>
</body>
</html>