# Plan 18 — E2E 测试完善计划 评审报告

**评审日期**：2025-10-02
**评审人**：架构组（基于 QA 验证结果）
**文档版本**：v1.0（初始版本）
**评审结论**：✅ **通过（需修订）**

---

## 一、评审摘要

### 1.1 总体评价

Plan 18 文档结构完整、分析深入、方案可行，符合项目"诚实原则"与"悲观谨慎"指导思想。文档基于 2025-10-02 实际执行的 E2E 验证结果，提出了系统化的改进计划，可作为开发团队后续工作的指导文档。

**优点**：
- ✅ 问题分析基于真实测试证据（截图、视频、HAR 文件）
- ✅ 技术方案提供多种选择（方案 A/B），含代码示例
- ✅ 工作量估算合理，责任人明确，时间表清晰
- ✅ 验收标准可量化（通过率、性能指标）
- ✅ 风险识别充分，缓解措施具体

**需改进项**：
- ⚠️ 部分文档引用需更新（如 19号文档替代16号工作量复核）
- ⚠️ 缺少对现有 9 个 `test.skip` 的影响分析
- ⚠️ CI 工作流示例需补充环境变量配置

---

## 二、详细评审结果

### 2.1 文档结构与格式（✅ 通过）

| 检查项 | 状态 | 备注 |
|--------|------|------|
| **标题层级规范** | ✅ | 一级至四级标题使用正确 |
| **元信息完整** | ✅ | 包含创建日期、责任团队、状态、关联文档 |
| **章节逻辑清晰** | ✅ | 背景→现状→计划→时间表→验收→风险 |
| **中文沟通** | ✅ | 全文使用专业、准确、清晰的中文 |
| **代码示例格式** | ✅ | 使用 TypeScript/YAML 代码块，语法高亮正确 |
| **表格数据准确** | ✅ | 所有表格对齐，数据来源可追溯 |

**符合规范**：
- CLAUDE.md §2：中文沟通原则
- 文档治理指南：Reference vs Plans 边界清晰

---

### 2.2 技术方案可行性（✅ 通过）

#### 2.2.1 问题诊断准确性

**问题 1：数据一致性测试**
- ✅ 根因分析正确（前端添加 `✓` 标记）
- ✅ 方案 A（调整断言）可立即执行
- ✅ 方案 B（CSS 伪元素）为长期最佳实践
- ⚠️ **建议**：明确优先采用方案 A，方案 B 作为 Phase 5 长期优化

**问题 2：测试页面缺失**
- ✅ 快速方案（`test.skip`）符合项目实际
- ✅ 长期方案（修复页面）保留技术债务追踪
- ✅ 决策依据清晰（调试用途 vs 必需功能）

**问题 3：业务流程超时**
- ✅ 4 项可能原因覆盖全面
- ✅ 优化措施具体（超时配置 + 选择器 + 分段验证）
- ✅ 符合项目"悲观谨慎"原则（按最坏情况评估）

#### 2.2.2 技术方案验证

| 方案 | 可行性 | 验证方式 | 风险 |
|------|--------|---------|------|
| **调整断言逻辑** | ✅ 高 | 代码示例已验证语法 | 低 |
| **test.skip 标记** | ✅ 高 | Playwright 原生支持 | 无 |
| **增加超时配置** | ✅ 高 | 已有测试通过，仅需调整参数 | 低 |
| **data-testid 迁移** | ✅ 中 | 需前端配合添加属性 | 中（需协调） |
| **CI 门禁建立** | ✅ 中 | GitHub Actions 标准流程 | 中（需测试环境稳定性） |

**技术栈匹配度**：
- ✅ Playwright 配置方案符合官方最佳实践
- ✅ TypeScript 代码示例符合项目 ESLint 规范
- ✅ GitHub Actions 工作流语法正确

---

### 2.3 与项目原则一致性（✅ 通过）

#### 2.3.1 CLAUDE.md 核心原则对照

| 原则 | 体现方式 | 符合度 |
|------|---------|--------|
| **资源唯一性** | 引用单一事实来源（验证报告、测试文件） | ✅ |
| **诚实原则** | 基于实际测试结果，不夸大通过率 | ✅ |
| **悲观谨慎** | 风险识别充分，预留缓冲时间 | ✅ |
| **健壮优先** | 强调根因修复，配套测试与文档 | ✅ |
| **中文沟通** | 全文中文，术语准确 | ✅ |

#### 2.3.2 AGENTS.md 临时方案管控

- ✅ 文档提及 `TODO-TEMPORARY` 清理（第469行）
- ✅ test.skip 方案建议标注为临时（虽未明确，但符合精神）
- ⚠️ **建议**：在任务 1.2 中明确要求添加 `TODO-TEMPORARY` 注释

---

### 2.4 工作量与时间估算（✅ 合理）

#### 2.4.1 工期合理性分析

| 阶段 | 总工期 | 任务数 | 平均单任务 | 评估 |
|------|--------|--------|-----------|------|
| **Phase 1** | 1.75d | 3 | 0.58d | ✅ 合理 |
| **Phase 2** | 1d | 2 | 0.5d | ✅ 合理 |
| **Phase 3** | 1.5d | 2 | 0.75d | ✅ 合理 |
| **Phase 4** | 0.75d | 2 | 0.375d | ✅ 合理 |
| **总计** | **5d** | **9** | **0.56d** | ✅ 合理 |

**对比行业基准**：
- Playwright 配置优化：0.5d（估算 0.5d）✅
- 测试用例修复：0.25-0.5d/个（估算 0.5d）✅
- CI 工作流搭建：0.5-1d（估算 1d）✅
- 文档编写：0.25-0.5d（估算 0.5d）✅

#### 2.4.2 时间表可行性

**关键路径**：
1. Phase 1（1.75d）→ Phase 2（1d）→ Phase 3（1.5d）→ Phase 4（0.75d）
2. 总工期 5 天（串行），并行可压缩至 3-4 天

**潜在风险**：
- ⚠️ 任务 3.2（CI 门禁）依赖测试稳定性，可能需延期
- ⚠️ 任务 1.3（超时优化）可能需多次迭代

**缓解建议**：
- 预留 1-2 天缓冲时间
- Phase 1-2 优先完成，Phase 3-4 可延后

---

### 2.5 文档引用完整性（⚠️ 需修订）

#### 2.5.1 引用验证结果

| 引用文档 | 路径 | 状态 | 备注 |
|---------|------|------|------|
| **06号文档** | `docs/development-plans/06-integrated-teams-progress-log.md` | ✅ 存在 | 正确 |
| **16号文档** | `docs/archive/development-plans/16-code-smell-analysis-and-improvement-plan.md` | ✅ 存在 | 正确 |
| **验证报告** | `reports/iig-guardian/playwright-rs256-verification-20251002.md` | ✅ 存在 | 正确 |
| **19号文档** | ⚠️ 未引用 | ⚠️ 缺失 | 06号文档已更新为19号 |

#### 2.5.2 需补充的引用

- ⚠️ `docs/development-plans/19-phase0-workload-review.md`（Plan 16 工作量复核）
- ℹ️ `docs/reference/01-DEVELOPER-QUICK-REFERENCE.md`（Phase 4 需更新）
- ℹ️ `docs/development-tools/e2e-testing-guide.md`（Phase 4 需创建）

---

## 三、发现的问题与改进建议

### 3.1 必须修订项（P1）

#### 问题 1：文档引用不一致

**现状**：
- 06号文档第10行提及 `docs/development-plans/19-phase0-workload-review.md`
- 18号文档未引用19号文档

**影响**：可能导致读者查找工作量复核纪要时困惑

**建议**：
```markdown
**关联文档**：
- [06-integrated-teams-progress-log.md](./06-integrated-teams-progress-log.md)
- [16-code-smell-analysis-and-improvement-plan.md](../../docs/archive/development-plans/16-code-smell-analysis-and-improvement-plan.md)
- [19-phase0-workload-review.md](./19-phase0-workload-review.md)
```

---

#### 问题 2：test.skip 策略缺少临时标注说明

**现状**：任务 1.2 建议使用 `test.skip`，但未要求添加临时标注

**影响**：可能违反 AGENTS.md 临时方案管控原则

**建议**：
```typescript
// 在 basic-functionality-test.spec.ts 中标记为 skip
// TODO-TEMPORARY: 测试页面功能待确认是否需要（2025-10-05前决策）
//   - 若为调试用途，则永久跳过并移除
//   - 若为必需功能，需补充组件并启用测试
//   - 责任人：前端团队 + QA
test.skip('测试页面功能验证', async ({ page }) => {
  // 原测试逻辑
});
```

---

### 3.2 建议优化项（P2）

#### 建议 1：补充现有 test.skip 影响分析

**现状**：文档未提及现有 9 个 `test.skip`

**发现**：
```bash
$ grep -o "test\.skip" frontend/tests/e2e/*.spec.ts | wc -l
9
```

**建议**：在"现状分析"章节补充：
```markdown
### 2.4 现有跳过测试统计

当前代码库中存在 9 个 `test.skip`，需在 Phase 1 前评估：
- 哪些为临时跳过（需修复）
- 哪些为永久跳过（需文档说明原因）
- 是否存在未标注 `TODO-TEMPORARY` 的临时实现
```

---

#### 建议 2：CI 工作流补充环境变量配置

**现状**：任务 3.2 的 GitHub Actions 示例缺少 JWT 生成步骤

**建议**：
```yaml
- name: Generate JWT Token
  run: |
    curl -sf -X POST http://localhost:9090/auth/dev-token \
      -H 'Content-Type: application/json' \
      -d '{"userId":"ci-user","tenantId":"3b99930c-4dc6-4cc9-8e4d-7d960a931cb9","roles":["ADMIN"],"duration":"1h"}' \
      | jq -r '.data.token' > .cache/dev.jwt

- name: Run E2E Tests
  run: |
    PW_JWT=$(cat .cache/dev.jwt) \
    PW_TENANT_ID=3b99930c-4dc6-4cc9-8e4d-7d960a931cb9 \
    npm run test:e2e --prefix frontend
```

---

#### 建议 3：data-testid 迁移优先级排序

**现状**：文档建议"全面迁移到 `data-testid`"，但未说明优先级

**建议**：
1. **P1**：业务流程 CRUD 测试（任务 1.3 依赖）
2. **P2**：基础功能测试
3. **P3**：优化验证与回归测试

---

### 3.3 文档完善项（P3）

#### 完善 1：补充性能基线对比

**建议**：在验收标准中补充：
```markdown
### 5.2 性能指标

| 指标 | 当前基线 | 目标 | 数据来源 |
|------|---------|------|---------|
| 测试总耗时 | 未统计 | <5 分钟 | 需补充全量测试时间 |
| 页面加载（P50） | 614ms（chromium） | <1s | 验证报告 |
| API 响应（P95） | 73ms | <200ms | 验证报告 |
```

---

#### 完善 2：明确"持续观察"定义

**现状**：06号文档状态为"Playwright RS256 回归持续观察"

**建议**：在 Phase 4 后补充：
```markdown
## 八、后续观察计划

Plan 18 完成后，E2E 测试进入**持续观察期**（2周）：
- 每日执行回归测试，监控通过率
- 收集失败模式，识别不稳定测试
- 观察期结束后决定是否纳入正式 CI 门禁
```

---

## 四、评审结论

### 4.1 通过条件

✅ 文档已满足以下条件：
- 结构完整，逻辑清晰
- 技术方案可行，代码示例正确
- 符合项目核心原则（CLAUDE.md + AGENTS.md）
- 工作量估算合理，责任人明确
- 引用文档存在且可访问

### 4.2 修订要求

在启动 Plan 18 前，**必须**完成以下修订（P1）：
1. ✅ 补充19号文档引用
2. ✅ 在 test.skip 方案中添加 TODO-TEMPORARY 标注说明

**建议**完成以下优化（P2-P3）：
3. 补充现有 test.skip 影响分析
4. 完善 CI 工作流环境变量配置
5. 明确 data-testid 迁移优先级
6. 补充性能基线对比表格

### 4.3 最终评级

| 维度 | 评分 | 说明 |
|------|------|------|
| **文档质量** | ⭐⭐⭐⭐⭐ | 结构完整，分析深入 |
| **技术可行性** | ⭐⭐⭐⭐ | 方案可行，缺少部分细节 |
| **原则一致性** | ⭐⭐⭐⭐⭐ | 完全符合项目指导原则 |
| **可执行性** | ⭐⭐⭐⭐ | 清晰可执行，需补充细节 |
| **风险控制** | ⭐⭐⭐⭐⭐ | 风险识别充分，缓解措施具体 |

**总评**：⭐⭐⭐⭐☆（4.6/5.0）

---

## 五、后续行动

### 5.1 立即行动（2025-10-02）

- [x] ~~完成 Plan 18 评审报告~~
- [ ] 将评审报告提交团队评审
- [ ] 根据 P1 修订要求更新 Plan 18 文档

### 5.2 启动前准备（2025-10-03）

- [ ] 召开 Plan 18 启动会议
- [ ] 分配具体责任人与时间节点
- [ ] 在 06 号文档中登记 Plan 18 启动状态

### 5.3 执行监控（2025-10-04 起）

- [ ] 每日更新任务进度（使用 TodoWrite 工具）
- [ ] 关键里程碑完成后更新 06 号文档
- [ ] Phase 1-2 完成后进行中期评审

---

## 附录 A：评审检查清单

```markdown
## 文档结构
- [x] 标题层级规范（一级至四级）
- [x] 元信息完整（日期、责任人、状态、关联文档）
- [x] 章节逻辑清晰（背景→现状→计划→验收）
- [x] 使用中文沟通
- [x] 代码示例格式正确

## 技术方案
- [x] 问题诊断基于实际证据
- [x] 提供多种方案选择
- [x] 代码示例语法正确
- [x] 验收标准可量化
- [ ] 补充现有 test.skip 分析

## 项目原则
- [x] 符合资源唯一性原则
- [x] 符合诚实原则
- [x] 符合悲观谨慎原则
- [x] 符合健壮优先原则
- [ ] TODO-TEMPORARY 标注说明

## 工作量估算
- [x] 各任务工期合理
- [x] 责任人明确
- [x] 时间表可行
- [x] 预留缓冲时间

## 文档引用
- [x] 06号文档存在
- [x] 16号文档存在
- [x] 验证报告存在
- [ ] 补充19号文档引用
```

---

## 附录 B：修订前后对比

### 修订项 1：关联文档补充

**修订前**：
```markdown
**关联文档**：[06-integrated-teams-progress-log.md](./06-integrated-teams-progress-log.md)、[16-code-smell-analysis-and-improvement-plan.md](../../docs/archive/development-plans/16-code-smell-analysis-and-improvement-plan.md)
```

**修订后**：
```markdown
**关联文档**：
- [06-integrated-teams-progress-log.md](./06-integrated-teams-progress-log.md) — 集成团队推进记录
- [16-code-smell-analysis-and-improvement-plan.md](../../docs/archive/development-plans/16-code-smell-analysis-and-improvement-plan.md) — 代码异味治理
- [19-phase0-workload-review.md](./19-phase0-workload-review.md) — Phase 0 工作量复核
```

### 修订项 2：test.skip 标注完善

**修订前**：
```typescript
test.skip('测试页面功能验证', async ({ page }) => {
  // 原测试逻辑
});
```

**修订后**：
```typescript
// TODO-TEMPORARY: 测试页面功能待确认（2025-10-05前决策）
//   - 责任人：前端团队 + QA
//   - 若为调试用途，则永久跳过并移除
//   - 若为必需功能，需补充组件并启用测试
test.skip('测试页面功能验证', async ({ page }) => {
  // 原测试逻辑
});
```

---

**评审人签字**：架构组
**评审日期**：2025-10-02
**下次评审**：Plan 18 Phase 1-2 完成后（预计 2025-10-07）
