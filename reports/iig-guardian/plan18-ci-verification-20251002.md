# Plan 18 â€” CI ç¯å¢ƒéªŒè¯æŠ¥å‘Š

**éªŒè¯æ—¥æœŸ**ï¼š2025-10-02
**éªŒè¯ç›®æ ‡**ï¼šç¡®è®¤ GitHub Actions E2E workflows åœ¨ CI ç¯å¢ƒå¯ç”¨æ€§
**éªŒè¯äººå‘˜**ï¼šå¼€å‘å›¢é˜Ÿ
**å…³è”æ–‡æ¡£**ï¼š[18-e2e-test-improvement-plan.md](../../docs/development-plans/18-e2e-test-improvement-plan.md)

---

## ä¸€ã€éªŒè¯èƒŒæ™¯

æ ¹æ® Plan 18 ç¬¬ä¸ƒç« "å®æ–½æ¡ä»¶è¯„ä¼°"ï¼ŒCI ç¯å¢ƒé…ç½®ä¸ºå¯åŠ¨è®¡åˆ’çš„å…³é”®é˜»å¡é¡¹ï¼ˆä¼˜å…ˆçº§ P0ï¼‰ã€‚è™½ç„¶å·²åˆ›å»º 3 ä¸ª GitHub Actions workflowsï¼Œä½†å‡æœªåœ¨ç›®æ ‡ä»“åº“å®é™…è¿è¡ŒéªŒè¯ï¼Œå­˜åœ¨ä»¥ä¸‹é£é™©ï¼š

- Docker é•œåƒæ„å»ºå¯èƒ½å¤±è´¥
- GitHub Actions runner ç£ç›˜ç©ºé—´å¯èƒ½ä¸è¶³
- æœåŠ¡å¥åº·æ£€æŸ¥å¯èƒ½åœ¨ CI ç¯å¢ƒè¶…æ—¶
- JWT mint æµç¨‹å¯èƒ½åœ¨ CI ç¯å¢ƒå¤±è´¥
- Playwright æµè§ˆå™¨å®‰è£…å¯èƒ½é‡åˆ°æƒé™é—®é¢˜
- Artifact ä¸Šä¼ å¯èƒ½é…ç½®é”™è¯¯

**éªŒè¯ç›®æ ‡**ï¼šé€šè¿‡åœ¨ GitHub Actions å®é™…è¿è¡Œè‡³å°‘ 1 ä¸ª workflowï¼Œç¡®è®¤ä»¥ä¸Šé£é™©å¯æ§ã€‚

---

## äºŒã€éªŒè¯ç¯å¢ƒ

### 2.1 åŸºç¡€è®¾æ–½çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **GitHub Repository** | âœ… å°±ç»ª | `jacksonlee411/cube-castle` |
| **åˆ†æ”¯** | âœ… å·²æ¨é€ | `plan16-code-smell-implementation` (commit: 7cbba95d) |
| **Workflows** | âœ… å·²æäº¤ | 3 ä¸ª workflows å·²å­˜åœ¨äº `.github/workflows/` |
| **Docker é…ç½®** | âœ… å·²æäº¤ | `docker-compose.e2e.yml` (commit: ff383eb0) |

### 2.2 Workflows æ¸…å•

| Workflow æ–‡ä»¶ | æäº¤çŠ¶æ€ | è§¦å‘æ¡ä»¶ | è¯´æ˜ |
|--------------|---------|---------|------|
| `e2e-tests.yml` | âœ… å·²æäº¤ (7cbba95d) | PR to main/develop, workflow_dispatch | ç»¼åˆ E2E æµ‹è¯•ï¼ŒPlan 18 ä¸»è¦éªŒè¯ç›®æ ‡ |
| `frontend-e2e.yml` | âœ… å·²æäº¤ (7f1644eb) | push/PR to main/master/develop | å‰ç«¯ Playwright E2E æµ‹è¯• |
| `e2e-smoke.yml` | âœ… å·²æäº¤ (ff383eb0) | push/PR to main/master/develop | E2E å†’çƒŸæµ‹è¯•ï¼ˆCQRS ç«¯åˆ°ç«¯ï¼‰ |

---

## ä¸‰ã€éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»ºéªŒè¯ PR

**ç›®çš„**ï¼šè§¦å‘ GitHub Actions workflows è‡ªåŠ¨è¿è¡Œ

**æ“ä½œæŒ‡å—**ï¼š

ç”±äºæœ¬åœ°ç¯å¢ƒæœªå®‰è£… `gh` CLIï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€è§¦å‘ï¼š

#### æ–¹å¼ Aï¼šé€šè¿‡ GitHub Web UI åˆ›å»º PRï¼ˆæ¨èï¼‰

1. è®¿é—®ï¼šhttps://github.com/jacksonlee411/cube-castle/pull/new/plan16-code-smell-implementation
2. å¡«å†™ PR ä¿¡æ¯ï¼š
   - **æ ‡é¢˜**ï¼š`[CIéªŒè¯] Plan 18 E2E ç¯å¢ƒæµ‹è¯•`
   - **æè¿°**ï¼š
     ```markdown
     ## ç›®çš„
     éªŒè¯ Plan 18 çš„ GitHub Actions E2E workflows åœ¨ CI ç¯å¢ƒå¯ç”¨æ€§

     ## éªŒè¯èŒƒå›´
     - âœ… `e2e-tests.yml` workflow å®Œæ•´è¿è¡Œ
     - âœ… Docker Compose E2E æ ˆå¯åŠ¨æˆåŠŸ
     - âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
     - âœ… JWT mint æµç¨‹æ­£å¸¸
     - âœ… Playwright æµ‹è¯•æ‰§è¡Œï¼ˆä¸è¦æ±‚å…¨éƒ¨é€šè¿‡ï¼‰
     - âœ… Artifact ä¸Šä¼ æˆåŠŸ

     ## éªŒè¯æŠ¥å‘Š
     ç»“æœå°†è®°å½•åˆ° `reports/iig-guardian/plan18-ci-verification-20251002.md`

     ## æ³¨æ„
     æœ¬ PR ä¸ºéªŒè¯ç”¨é€”ï¼Œ**ä¸åº”åˆå¹¶åˆ°ä¸»åˆ†æ”¯**ã€‚éªŒè¯å®Œæˆåå°†å…³é—­æ­¤ PRã€‚
     ```
   - **é€‰æ‹©**ï¼šâœ… Create draft pull requestï¼ˆè‰ç¨¿ PRï¼‰
3. ç‚¹å‡»"Create pull request"

#### æ–¹å¼ Bï¼šæ‰‹åŠ¨è§¦å‘ workflowï¼ˆéœ€è¦ä»“åº“ Actions æƒé™ï¼‰

1. è®¿é—®ï¼šhttps://github.com/jacksonlee411/cube-castle/actions
2. é€‰æ‹© `E2E Tests` workflow
3. ç‚¹å‡»"Run workflow"
4. é€‰æ‹©åˆ†æ”¯ï¼š`plan16-code-smell-implementation`
5. ç‚¹å‡»"Run workflow"

---

### æ­¥éª¤ 2ï¼šç›‘æ§ Workflow è¿è¡Œ

**ç›‘æ§å…¥å£**ï¼š
- PR Checks é¡µç­¾ï¼ˆæ–¹å¼ Aï¼‰
- GitHub Actions é¡µé¢ï¼šhttps://github.com/jacksonlee411/cube-castle/actions

**å…³é”®éªŒè¯æŒ‡æ ‡**ï¼š

| éªŒè¯é¡¹ | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|--------|---------|------|
| **Docker Compose æ ˆå¯åŠ¨** | `docker compose -f docker-compose.e2e.yml up -d` æˆåŠŸ | â³ å¾…éªŒè¯ |
| **PostgreSQL å¥åº·æ£€æŸ¥** | `curl http://localhost:5432` æˆ– pg_isready é€šè¿‡ | â³ å¾…éªŒè¯ |
| **Redis å¥åº·æ£€æŸ¥** | `redis-cli ping` è¿”å› PONG | â³ å¾…éªŒè¯ |
| **å‘½ä»¤æœåŠ¡å¥åº·æ£€æŸ¥** | `curl http://localhost:9090/health` è¿”å› 200 | â³ å¾…éªŒè¯ |
| **æŸ¥è¯¢æœåŠ¡å¥åº·æ£€æŸ¥** | `curl http://localhost:8090/health` è¿”å› 200 | â³ å¾…éªŒè¯ |
| **å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥** | `curl http://localhost:3000/` è¿”å› 200 | â³ å¾…éªŒè¯ |
| **JWT Mint æˆåŠŸ** | `.cache/dev.jwt` æ–‡ä»¶ç”Ÿæˆä¸”éç©º | â³ å¾…éªŒè¯ |
| **Playwright æµ‹è¯•æ‰§è¡Œ** | `npm run test:e2e` è‡³å°‘å¯åŠ¨ï¼ˆä¸è¦æ±‚å…¨éƒ¨é€šè¿‡ï¼‰ | â³ å¾…éªŒè¯ |
| **Artifact ä¸Šä¼ ** | `playwright-report` å’Œ `test-results` ä¸Šä¼ æˆåŠŸ | â³ å¾…éªŒè¯ |
| **æ€»è€—æ—¶** | <45 åˆ†é’Ÿï¼ˆworkflow timeout é™åˆ¶ï¼‰ | â³ å¾…éªŒè¯ |

---

### æ­¥éª¤ 3ï¼šæ”¶é›†éªŒè¯è¯æ®

**éœ€è¦æ”¶é›†çš„ä¿¡æ¯**ï¼š

1. **Workflow è¿è¡Œ URL**ï¼š
   - æ ¼å¼ï¼š`https://github.com/jacksonlee411/cube-castle/actions/runs/{run_id}`
   - è®°å½•æ–¹å¼ï¼šä» GitHub Actions é¡µé¢å¤åˆ¶

2. **Workflow è¿è¡Œç»“æœ**ï¼š
   - âœ… æˆåŠŸ / âŒ å¤±è´¥ / âš ï¸ éƒ¨åˆ†æˆåŠŸ
   - æ€»è€—æ—¶ï¼š`___ åˆ†é’Ÿ ___ ç§’`

3. **å¤±è´¥æ­¥éª¤**ï¼ˆå¦‚æœ‰ï¼‰ï¼š
   - æ­¥éª¤åç§°ï¼š
   - é”™è¯¯ä¿¡æ¯ï¼š
   - æ—¥å¿—æˆªå›¾ï¼š

4. **Artifacts ä¸‹è½½éªŒè¯**ï¼š
   - Artifact åç§°ï¼š`playwright-report`
   - ä¸‹è½½ URLï¼š
   - å†…å®¹éªŒè¯ï¼šæ˜¯å¦åŒ…å« HTML æŠ¥å‘Šå’Œæˆªå›¾

---

## å››ã€éªŒè¯ç»“æœ

### 4.1 æ‰§è¡Œæ‘˜è¦

**çŠ¶æ€**ï¼šâ³ **å¾…æ‰§è¡Œ**

**Workflow è¿è¡Œä¿¡æ¯**ï¼š
- è¿è¡Œ IDï¼š`å¾…å¡«å†™`
- è¿è¡Œ URLï¼š`å¾…å¡«å†™`
- è§¦å‘æ–¹å¼ï¼š`å¾…å¡«å†™ï¼ˆPR / æ‰‹åŠ¨è§¦å‘ï¼‰`
- è¿è¡Œæ—¶é—´ï¼š`å¾…å¡«å†™`
- æ€»è€—æ—¶ï¼š`å¾…å¡«å†™`

**ç»“æœ**ï¼š
- [ ] âœ… éªŒè¯é€šè¿‡ï¼šæ‰€æœ‰å…³é”®æŒ‡æ ‡æ»¡è¶³éªŒæ”¶æ ‡å‡†
- [ ] âš ï¸ éƒ¨åˆ†é€šè¿‡ï¼šæ ¸å¿ƒæµç¨‹æ­£å¸¸ä½†æµ‹è¯•æœ‰å¤±è´¥
- [ ] âŒ éªŒè¯å¤±è´¥ï¼šå…³é”®æ­¥éª¤é˜»å¡ï¼Œéœ€è¦ä¿®å¤

---

### 4.2 è¯¦ç»†æŒ‡æ ‡éªŒè¯ç»“æœ

| éªŒè¯é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| Docker Compose æ ˆå¯åŠ¨ | â³ å¾…éªŒè¯ | |
| PostgreSQL å¥åº·æ£€æŸ¥ | â³ å¾…éªŒè¯ | |
| Redis å¥åº·æ£€æŸ¥ | â³ å¾…éªŒè¯ | |
| å‘½ä»¤æœåŠ¡å¥åº·æ£€æŸ¥ | â³ å¾…éªŒè¯ | |
| æŸ¥è¯¢æœåŠ¡å¥åº·æ£€æŸ¥ | â³ å¾…éªŒè¯ | |
| å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥ | â³ å¾…éªŒè¯ | |
| JWT Mint æˆåŠŸ | â³ å¾…éªŒè¯ | |
| Playwright æµ‹è¯•æ‰§è¡Œ | â³ å¾…éªŒè¯ | |
| Artifact ä¸Šä¼  | â³ å¾…éªŒè¯ | |
| æ€»è€—æ—¶ <45 åˆ†é’Ÿ | â³ å¾…éªŒè¯ | |

---

### 4.3 å‘ç°çš„é—®é¢˜

**é—®é¢˜æ¸…å•**ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š

| é—®é¢˜ ID | ä¼˜å…ˆçº§ | é—®é¢˜æè¿° | å½±å“èŒƒå›´ | ä¿®å¤æ–¹æ¡ˆ | çŠ¶æ€ |
|---------|--------|---------|---------|---------|------|
| - | - | å¾…éªŒè¯åå¡«å†™ | - | - | - |

---

### 4.4 ä¿®å¤æªæ–½

**å¦‚éªŒè¯å¤±è´¥ï¼Œéœ€è¦é‡‡å–çš„ä¿®å¤æªæ–½**ï¼š

1. **Docker ç›¸å…³é—®é¢˜**ï¼š
   - æ£€æŸ¥ `docker-compose.e2e.yml` é…ç½®
   - ç¡®è®¤ GitHub Actions runner ç£ç›˜ç©ºé—´å……è¶³
   - éªŒè¯é•œåƒæ„å»ºé…ç½®æ­£ç¡®

2. **æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥**ï¼š
   - å¢åŠ å¥åº·æ£€æŸ¥é‡è¯•æ¬¡æ•°
   - å»¶é•¿ `start_period` æ—¶é—´
   - æ£€æŸ¥æœåŠ¡å¯åŠ¨ä¾èµ–é¡ºåº

3. **JWT Mint å¤±è´¥**ï¼š
   - éªŒè¯ `make jwt-dev-mint` å‘½ä»¤åœ¨ CI ç¯å¢ƒå¯ç”¨
   - æ£€æŸ¥ `.cache/` ç›®å½•æƒé™
   - ç¡®è®¤ jq å·¥å…·å·²å®‰è£…

4. **Playwright å®‰è£…å¤±è´¥**ï¼š
   - ç¡®è®¤ `npx playwright install --with-deps` å‘½ä»¤æ‰§è¡Œ
   - æ£€æŸ¥ç³»ç»Ÿä¾èµ–æ˜¯å¦ç¼ºå¤±
   - éªŒè¯ Node.js ç‰ˆæœ¬å…¼å®¹æ€§

5. **Artifact ä¸Šä¼ å¤±è´¥**ï¼š
   - æ£€æŸ¥ `actions/upload-artifact@v4` é…ç½®
   - éªŒè¯è·¯å¾„æ­£ç¡®æ€§
   - ç¡®è®¤æ–‡ä»¶ç”ŸæˆæˆåŠŸ

---

## äº”ã€ç»“è®ºä¸å»ºè®®

### 5.1 éªŒè¯ç»“è®º

**â³ å¾…æ‰§è¡ŒéªŒè¯åå¡«å†™**

### 5.2 Plan 18 å¯åŠ¨å»ºè®®

**å¦‚éªŒè¯é€šè¿‡**ï¼š
- âœ… è§£é™¤ P0 é˜»å¡é¡¹"CI ç¯å¢ƒæœªéªŒè¯"
- âœ… æ›´æ–° Plan 18 æ–‡æ¡£ä¾èµ–é¡¹çŠ¶æ€ä¸º âœ…
- âœ… å¯ä»¥å¯åŠ¨ Phase 1 ä»»åŠ¡ï¼ˆä¿®å¤ç°æœ‰å¤±è´¥æµ‹è¯•ï¼‰

**å¦‚éªŒè¯å¤±è´¥**ï¼š
- âŒ ä¿æŒ Plan 18 é˜»å¡çŠ¶æ€
- âš ï¸ ä¼˜å…ˆä¿®å¤ CI ç¯å¢ƒé—®é¢˜
- âš ï¸ ä¿®å¤åé‡æ–°éªŒè¯

---

## å…­ã€åç»­è¡ŒåŠ¨

### 6.1 å¾…åŠäº‹é¡¹

- [ ] åˆ›å»ºéªŒè¯ PR æˆ–æ‰‹åŠ¨è§¦å‘ workflow
- [ ] ç›‘æ§ workflow è¿è¡Œå¹¶æ”¶é›†è¯æ®
- [ ] å¡«å†™"å››ã€éªŒè¯ç»“æœ"ç« èŠ‚
- [ ] ä¸‹è½½å¹¶æ£€æŸ¥ Artifacts
- [ ] æ›´æ–° Plan 18 æ–‡æ¡£ä¾èµ–é¡¹çŠ¶æ€
- [ ] å¦‚éªŒè¯é€šè¿‡ï¼Œå¯åŠ¨ Phase 1 ä»»åŠ¡

### 6.2 æ–‡æ¡£æ›´æ–°

éªŒè¯å®Œæˆåéœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **æœ¬æŠ¥å‘Š**ï¼šå¡«å†™éªŒè¯ç»“æœå’Œç»“è®º
2. **Plan 18 æ–‡æ¡£**ï¼ˆ`docs/development-plans/18-e2e-test-improvement-plan.md`ï¼‰ï¼š
   - æ›´æ–°"6.2 ä¾èµ–é¡¹"çŠ¶æ€
   - æ›´æ–°"ğŸ“Š æ‰§è¡Œæ‘˜è¦"ä¸­çš„é˜»å¡çŠ¶æ€
   - æ·»åŠ éªŒè¯æŠ¥å‘Šé“¾æ¥

---

## é™„å½• Aï¼šéªŒè¯å‘½ä»¤é€ŸæŸ¥

### æœ¬åœ°éªŒè¯ï¼ˆå¯é€‰ï¼Œç”¨äºå¯¹æ¯”ï¼‰

```bash
# 1. å¯åŠ¨ E2E æ ˆ
docker compose -f docker-compose.e2e.yml build
docker compose -f docker-compose.e2e.yml up -d

# 2. æ£€æŸ¥æœåŠ¡å¥åº·
curl -fsS http://localhost:9090/health
curl -fsS http://localhost:8090/health
curl -fsS http://localhost:3000/

# 3. ç”Ÿæˆ JWT
make jwt-dev-mint
cat .cache/dev.jwt

# 4. è¿è¡Œ E2E æµ‹è¯•
cd frontend
PW_JWT=$(cat ../.cache/dev.jwt) PW_TENANT_ID=3b99930c-4dc6-4cc9-8e4d-7d960a931cb9 \
  npm run test:e2e

# 5. æ¸…ç†
docker compose -f docker-compose.e2e.yml down -v --remove-orphans
```

---

## é™„å½• Bï¼šGitHub Actions Workflow é…ç½®

**éªŒè¯ç›®æ ‡ Workflow**ï¼š`.github/workflows/e2e-tests.yml`

**å…³é”®é…ç½®**ï¼š
- **Timeout**ï¼š45 åˆ†é’Ÿ
- **Runner**ï¼šubuntu-latest
- **Node.js**ï¼š20
- **Go**ï¼šè¯»å– go.mod
- **Docker Compose**ï¼šdocker-compose.e2e.yml

**è§¦å‘æ¡ä»¶**ï¼š
- PR to main/develop
- workflow_dispatchï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰

---

**æŠ¥å‘ŠçŠ¶æ€**ï¼šâ³ å¾…éªŒè¯æ‰§è¡Œ
**ä¸‹æ¬¡æ›´æ–°**ï¼šéªŒè¯å®Œæˆåå¡«å†™ç»“æœ
