# Plan 18 Phase 1.3 å¤æµ‹æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2025-10-05 10:31
**æ‰§è¡Œè„šæœ¬**: `scripts/plan18/run-business-flow-e2e.sh`
**è´Ÿè´£äºº**: Implementation Inventory Guardian

---

## ä¸€ã€æ‰§è¡Œæ¦‚è¦

### 1.1 è‡ªåŠ¨åŒ–è„šæœ¬æ‰§è¡Œ

âœ… **è„šæœ¬è·¯å¾„**: `scripts/plan18/run-business-flow-e2e.sh`
âœ… **æƒé™è®¾ç½®**: å·²æˆåŠŸèµ‹äºˆæ‰§è¡Œæƒé™ (`chmod +x`)
âœ… **æµç¨‹å°è£…**:
- Docker æœåŠ¡å¯åŠ¨ï¼ˆpostgres, redisï¼‰
- æ•°æ®åº“å…¨é‡è¿ç§»ï¼ˆ008â€“030ï¼‰
- RS256 JWT ä»¤ç‰Œç”Ÿæˆï¼ˆ/auth/dev-tokenï¼‰
- Playwright E2E æ‰§è¡Œï¼ˆbusiness-flow-e2e.spec.tsï¼‰

### 1.2 äº§ç‰©æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | å¤§å° | è¯´æ˜ |
|---------|------|------|------|
| `reports/iig-guardian/plan18-migration-20251005T103120.log` | è¿ç§»æ—¥å¿— | 7.1K | 008â€“030 è¿ç§»æ‰§è¡Œè®°å½• |
| `reports/iig-guardian/plan18-business-flow-20251005T102736.log` | E2E æ—¥å¿— | 9.6K | Playwright æµ‹è¯•è¾“å‡º |

---

## äºŒã€æ•°æ®åº“è¿ç§»éªŒè¯

### 2.1 è¿ç§»æ‰§è¡Œç»“æœ

âœ… **è¿ç§»èŒƒå›´**: `database/migrations/008â€“030`ï¼ˆå…± 23 ä¸ªè¿ç§»è„šæœ¬ï¼‰
âœ… **æ‰§è¡ŒçŠ¶æ€**: å…¨éƒ¨æˆåŠŸï¼ˆä¸²è¡Œå¯æ‰§è¡Œï¼‰
âœ… **å…³é”®è¿ç§»**:
- `008_temporal_management_schema.sql`: æ—¶æ€ç®¡ç†åŸºç¡€æ¶æ„
- `025a_temporal_timeline_consistency_indexes.sql`: æ—¶æ€æ—¶é—´è½´è¿è´¯æ€§ç´¢å¼•
- `026_unify_temporal_timezone_utc.sql`: ç»Ÿä¸€ UTC æ—¶åŒº
- `029_soft_delete_status_only.sql`: è½¯åˆ é™¤çŠ¶æ€ä¼˜åŒ–
- `030_fix_is_current_with_utc_alignment.sql`: is_current æ ‡å¿— UTC å¯¹é½ä¿®å¤

### 2.2 å…³é”®éªŒè¯ç‚¹

```sql
-- 025a è¿ç§»ç¡®è®¤ï¼ˆæ—¶æ€æ—¶é—´è½´è¿è´¯æ€§ç´¢å¼•ï¼‰
SELECT status, details, completed_at
FROM public.migration_status
WHERE migration_name = '025a_temporal_timeline_consistency_indexes';

-- ç»“æœï¼š
-- status: æ—¶æ€æ—¶é—´è½´è¿è´¯æ€§ç´¢å¼•éƒ¨ç½²å®Œæˆ
-- details: Temporal timeline consistency indexes deployed
-- completed_at: 2025-10-05 10:31:22.227264+08
```

```sql
-- 029 è¿ç§»ç¡®è®¤ï¼ˆè½¯åˆ é™¤çŠ¶æ€ä¼˜åŒ–ï¼‰
SELECT status, applied_at
FROM public.migration_status
WHERE migration_name = '029_soft_delete_status_only';

-- ç»“æœï¼š
-- status: 029_soft_delete_status_only applied
-- applied_at: 2025-10-05 10:31:22.475926+08
```

```sql
-- 030 è¿ç§»æ•ˆæœéªŒè¯ï¼ˆis_current ä¿®å¤ï¼‰
-- æ›´æ–°è®°å½•ç»Ÿè®¡ï¼š
-- - 025 æ¡è®°å½• is_current æ ‡å¿—ä¿®å¤
-- - 023 æ¡å•ç‰ˆæœ¬ç»„ç»‡ is_current è®¾ä¸º true
-- - 002 æ¡å¤šç‰ˆæœ¬ç»„ç»‡æœ€æ–°è®°å½• is_current è®¾ä¸º true
```

### 2.3 è¿ç§»è­¦å‘Šåˆ†æ

**NOTICE è­¦å‘Š**ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰:
- `column "effective_from" already exists, skipping`: å­—æ®µå·²å­˜åœ¨ï¼Œå¹‚ç­‰æ€§ä¿æŠ¤
- `relation "idx_organization_units_effective_from" already exists, skipping`: ç´¢å¼•å·²å­˜åœ¨ï¼Œå¹‚ç­‰æ€§ä¿æŠ¤

**ç¡®è®¤**: æ‰€æœ‰ NOTICE å‡ä¸ºå¹‚ç­‰æ€§æ£€æŸ¥ï¼Œéé”™è¯¯çŠ¶æ€ã€‚

---

## ä¸‰ã€E2E æµ‹è¯•æ‰§è¡Œç»“æœ

### 3.1 æµ‹è¯•ç»Ÿè®¡

**æ€»æµ‹è¯•æ•°**: 10 ä¸ª
**é€šè¿‡**: 8 ä¸ª (80%)
**å¤±è´¥**: 2 ä¸ª (20%)
**æµè§ˆå™¨**: Chromium + Firefox
**å¹¶å‘ Worker**: 4
**æ€»è€—æ—¶**: 43.0 ç§’

### 3.2 å¤±è´¥æµ‹è¯•è¯¦æƒ…

#### å¤±è´¥ 1: [chromium] å®Œæ•´CRUDä¸šåŠ¡æµç¨‹æµ‹è¯• â†’ åˆ›å»ºæ–°ç»„ç»‡

**é”™è¯¯ç±»å‹**: `TimeoutError`
**å¤±è´¥ä½ç½®**: `tests/e2e/business-flow-e2e.spec.ts:61:18`
**æ ¹æœ¬åŸå› **:

```typescript
// åˆ›å»ºç»„ç»‡åç­‰å¾…å¯¼èˆªè‡³æ—¶æ€è¯¦æƒ…é¡µ
await page.waitForURL(/\/organizations\/[0-9]{7}\/temporal$/);
// âŒ Timeout 30000ms exceeded
```

**é¡µé¢å¿«ç…§åˆ†æ**:
```yaml
- heading "æ–°å»ºç»„ç»‡ - ç¼–è¾‘ç»„ç»‡ä¿¡æ¯"
- textbox "è¯·è¾“å…¥ç»„ç»‡åç§°": æµ‹è¯•éƒ¨é—¨E2E-mgd30qjw
- textbox "æœç´¢å¹¶é€‰æ‹©ä¸Šçº§ç»„ç»‡...": 1000000 - é«˜è°·é›†å›¢
- combobox: éƒ¨é—¨ [selected]
- button "åˆ›å»ºç»„ç»‡"
```

**é—®é¢˜æ¨æ–­**:
1. âœ… è¡¨å•å·²æ­£ç¡®å¡«å†™ï¼ˆç»„ç»‡åç§°ã€ä¸Šçº§ç»„ç»‡ã€ç±»å‹ï¼‰
2. âŒ ç‚¹å‡»"åˆ›å»ºç»„ç»‡"æŒ‰é’®åæœªè§¦å‘è·¯ç”±å¯¼èˆª
3. å¯èƒ½åŸå› ï¼š
   - åç«¯ API è°ƒç”¨å¤±è´¥ï¼ˆå‘½ä»¤æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼‰
   - å‰ç«¯æœªæ­£ç¡®å¤„ç†å“åº”/è·¯ç”±è·³è½¬
   - ç»„ç»‡ç¼–ç ç”Ÿæˆ/è¿”å›å¼‚å¸¸

#### å¤±è´¥ 2: [firefox] å®Œæ•´CRUDä¸šåŠ¡æµç¨‹æµ‹è¯• â†’ åˆ›å»ºæ–°ç»„ç»‡

**é”™è¯¯ç±»å‹**: `TimeoutError`ï¼ˆåŒä¸Šï¼‰
**å¤±è´¥ä½ç½®**: åŒ Chromium æµ‹è¯•
**ç»“è®º**: è·¨æµè§ˆå™¨ä¸€è‡´æ€§å¤±è´¥ï¼Œéæµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œç¡®è®¤ä¸ºåŠŸèƒ½ç¼ºé™·ã€‚

### 3.3 é€šè¿‡æµ‹è¯•æ¸…å•

âœ… **[chromium] åˆ†é¡µå’Œç­›é€‰åŠŸèƒ½æµ‹è¯•**
âœ… **[chromium] æ€§èƒ½å’Œå“åº”æ—¶é—´æµ‹è¯•**
âœ… **[chromium] é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•**
âœ… **[chromium] æ•°æ®ä¸€è‡´æ€§éªŒè¯æµ‹è¯•**
âœ… **[firefox] åˆ†é¡µå’Œç­›é€‰åŠŸèƒ½æµ‹è¯•**
âœ… **[firefox] æ€§èƒ½å’Œå“åº”æ—¶é—´æµ‹è¯•**
âœ… **[firefox] é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•**
âœ… **[firefox] æ•°æ®ä¸€è‡´æ€§éªŒè¯æµ‹è¯•**

---

## å››ã€æœåŠ¡å¥åº·æ£€æŸ¥

### 4.1 Docker å®¹å™¨çŠ¶æ€

| å®¹å™¨åç§° | çŠ¶æ€ | å¥åº·æ£€æŸ¥ |
|---------|------|---------|
| `cube_castle_postgres` | Up 3 hours | healthy |
| `cube_castle_redis` | Up 3 hours | healthy |

### 4.2 åº”ç”¨æœåŠ¡çŠ¶æ€

| æœåŠ¡ | è¿›ç¨‹çŠ¶æ€ | ç«¯å£ | å¥åº·ç«¯ç‚¹ |
|------|---------|------|---------|
| `organization-command-service` | âœ… Running | 8080 | âŒ `/health` å¤±è´¥ |
| `organization-query-service` | âœ… Running | 8081 | âŒ `/health` å¤±è´¥ |

**ä¸¥é‡é—®é¢˜**: å‘½ä»¤/æŸ¥è¯¢æœåŠ¡è¿›ç¨‹è™½åœ¨è¿è¡Œï¼Œä½†å¥åº·ç«¯ç‚¹æ— å“åº”ï¼Œå¯èƒ½å¯¼è‡´ E2E æµ‹è¯•ä¸­åˆ›å»ºç»„ç»‡ API è°ƒç”¨å¤±è´¥ã€‚

---

## äº”ã€æ ¹å› åˆ†æä¸å»ºè®®

### 5.1 å…³é”®é˜»å¡é—®é¢˜

#### é—®é¢˜ 1: å‘½ä»¤/æŸ¥è¯¢æœåŠ¡å¥åº·ç«¯ç‚¹å¤±è´¥

**ä¸¥é‡æ€§**: ğŸ”´ é«˜
**å½±å“**: å¯¼è‡´ E2E æµ‹è¯•ä¸­æ‰€æœ‰éœ€è¦åç«¯ API çš„æ“ä½œå¤±è´¥
**å»ºè®®**:
1. æ£€æŸ¥æœåŠ¡æ—¥å¿—ï¼ˆ`journalctl` æˆ–åº”ç”¨æ—¥å¿—æ–‡ä»¶ï¼‰
2. ç¡®è®¤ç«¯å£ç›‘å¬çŠ¶æ€ï¼ˆ`netstat -tlnp | grep -E "8080|8081"`ï¼‰
3. éªŒè¯æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼ˆå¯èƒ½å› è¿ç§»åè¿æ¥æ•°è€—å°½ï¼‰
4. æ£€æŸ¥ RS256 JWT å¯†é’¥é…ç½®ï¼ˆå¯èƒ½å¯¼è‡´è®¤è¯ä¸­é—´ä»¶é˜»å¡ï¼‰

#### é—®é¢˜ 2: åˆ›å»ºç»„ç»‡è·¯ç”±å¯¼èˆªå¤±è´¥

**ä¸¥é‡æ€§**: ğŸ”´ é«˜
**å½±å“**: ä¸šåŠ¡æµç¨‹æ ¸å¿ƒåŠŸèƒ½ï¼ˆCRUDï¼‰ä¸å¯ç”¨
**å»ºè®®**:
1. æŸ¥çœ‹æµè§ˆå™¨ DevTools Network é¢æ¿ï¼ˆæ£€æŸ¥ API å“åº”çŠ¶æ€ç ï¼‰
2. ç¡®è®¤å‰ç«¯è·¯ç”±é…ç½®ï¼ˆ`/organizations/{code}/temporal` è·¯å¾„ï¼‰
3. éªŒè¯ç»„ç»‡ç¼–ç ç”Ÿæˆé€»è¾‘ï¼ˆæ˜¯å¦è¿”å›ä¸ƒä½æ•°å­—ç¼–ç ï¼‰
4. æ£€æŸ¥å‰ç«¯é”™è¯¯å¤„ç†ï¼ˆæ˜¯å¦æ•è·å¹¶æ˜¾ç¤º API é”™è¯¯ï¼‰

### 5.2 åç»­è¡ŒåŠ¨è®¡åˆ’

#### å³åˆ»æ‰§è¡Œï¼ˆP0ï¼‰

1. **ä¿®å¤æœåŠ¡å¥åº·ç«¯ç‚¹**
   ```bash
   # æ£€æŸ¥æœåŠ¡è¿›ç¨‹è¯¦ç»†çŠ¶æ€
   ps aux | grep organization-command-service
   lsof -i :8080

   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   tail -100 logs/command-service.log
   ```

2. **éªŒè¯åˆ›å»ºç»„ç»‡ API**
   ```bash
   # æ‰‹åŠ¨è°ƒç”¨åˆ›å»ºç»„ç»‡ API
   curl -X POST http://localhost:8080/api/organizations \
     -H "Authorization: Bearer $(scripts/plan18/get-dev-token.sh)" \
     -H "Content-Type: application/json" \
     -d '{
       "name": "æ‰‹åŠ¨æµ‹è¯•éƒ¨é—¨",
       "parentCode": "1000000",
       "unitType": "DEPARTMENT",
       "effectiveDate": "2025-10-05",
       "description": "æ‰‹åŠ¨ API æµ‹è¯•"
     }'
   ```

3. **é‡æ–°æ‰§è¡Œ E2E æµ‹è¯•**
   ```bash
   # åœ¨æœåŠ¡ä¿®å¤åé‡æ–°è¿è¡Œ
   scripts/plan18/run-business-flow-e2e.sh
   ```

#### çŸ­æœŸä¼˜åŒ–ï¼ˆP1ï¼‰

1. **å¢å¼ºè„šæœ¬å¥åº·æ£€æŸ¥**
   - åœ¨ `run-business-flow-e2e.sh` ä¸­æ·»åŠ æœåŠ¡å¥åº·è½®è¯¢
   - è¶…æ—¶åè¾“å‡ºæœåŠ¡æ—¥å¿—ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

2. **å®Œå–„æµ‹è¯•æŠ¥å‘Š**
   - è‡ªåŠ¨æˆªå›¾å¤±è´¥åœºæ™¯ï¼ˆå·²æœ‰ trace.zipï¼‰
   - ç”Ÿæˆå¯è¯»æ€§æ›´å¼ºçš„å¤±è´¥æ‘˜è¦

3. **æ–‡æ¡£åŒæ­¥**
   - æ›´æ–° `docs/development-plans/18-e2e-test-improvement-plan.md` Phase 1.3 çŠ¶æ€
   - åœ¨ `docs/development-plans/06-integrated-teams-progress-log.md` è®°å½•æ­¤æ¬¡å¤æµ‹ç»“æœ

---

## å…­ã€ç»“è®º

### 6.1 å¤æµ‹è¾¾æˆç›®æ ‡

âœ… **è‡ªåŠ¨åŒ–æµç¨‹**: è„šæœ¬ `run-business-flow-e2e.sh` æˆåŠŸå°è£… Docker â†’ è¿ç§» â†’ è®¤è¯ â†’ E2E å…¨æµç¨‹
âœ… **è¿ç§»å¯æ‰§è¡Œæ€§**: 008â€“030 è¿ç§»è„šæœ¬å…¨éƒ¨é€šè¿‡ï¼Œè¯æ˜ä¸²è¡Œå¯æ‰§è¡Œä¸”å¹‚ç­‰
âœ… **æ—¥å¿—å¯è¿½æº¯æ€§**: ç”Ÿæˆæ—¶é—´æˆ³æ—¥å¿—æ–‡ä»¶ï¼Œæ»¡è¶³å®¡è®¡éœ€æ±‚

### 6.2 é˜»å¡é—®é¢˜

âŒ **æœåŠ¡å¥åº·ç«¯ç‚¹**: å‘½ä»¤/æŸ¥è¯¢æœåŠ¡è™½åœ¨è¿è¡Œä½†æ— å“åº”ï¼Œé˜»å¡æ‰€æœ‰åç«¯ä¾èµ–æµ‹è¯•
âŒ **E2E æ ¸å¿ƒæµç¨‹**: åˆ›å»ºç»„ç»‡åŠŸèƒ½å¤±è´¥ï¼ˆ80% é€šè¿‡ç‡æœªè¾¾æ ‡ï¼‰ï¼Œéœ€æ ¹å› ä¿®å¤

### 6.3 åç»­é‡Œç¨‹ç¢‘

| é˜¶æ®µ | ç›®æ ‡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| **Phase 1.3-Hotfix** | ä¿®å¤æœåŠ¡å¥åº·ç«¯ç‚¹ + åˆ›å»ºç»„ç»‡ API | 1-2 å°æ—¶ |
| **Phase 1.3-Retest** | é‡æ–°æ‰§è¡Œ E2E ç¡®ä¿ 100% é€šè¿‡ | 30 åˆ†é’Ÿ |
| **Phase 1.4** | å‡†å¤‡ CI/CD é›†æˆï¼ˆGitHub Actionsï¼‰ | å¾…å®š |

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-05 10:35
**æ–‡ä»¶è·¯å¾„**: `reports/iig-guardian/plan18-phase1.3-retest-20251005.md`
**å…³è”æ—¥å¿—**:
- `reports/iig-guardian/plan18-migration-20251005T103120.log`
- `reports/iig-guardian/plan18-business-flow-20251005T102736.log`
